<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-TQKP5TGHJ8"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TQKP5TGHJ8")</script><title>Transaction Management With Mediator Pipelines in ASP.NET Core | code-corner.dev</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="google-adsense-account" content="ca-pub-4671230649342120"><meta name="description" content="When implementing a simplified CQRS service, which usually has a single database but still separates commands from queries, the mediator pipeline can be used to manage transactions when processing com"><meta property="og:type" content="article"><meta property="og:title" content="Transaction Management With Mediator Pipelines in ASP.NET Core"><meta property="og:url" content="https://code-corner.dev/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/index.html"><meta property="og:site_name" content="code-corner.dev"><meta property="og:description" content="When implementing a simplified CQRS service, which usually has a single database but still separates commands from queries, the mediator pipeline can be used to manage transactions when processing com"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://code-corner.dev/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/00_header.png"><meta property="article:published_time" content="2020-11-07T00:00:00.000Z"><meta property="article:modified_time" content="2024-04-16T17:31:21.754Z"><meta property="article:author" content="João Simões"><meta property="article:tag" content="dotnetcore"><meta property="article:tag" content="aspnetcore"><meta property="article:tag" content="csharp"><meta property="article:tag" content="patterns"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://code-corner.dev/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/00_header.png"><meta name="twitter:creator" content="@JoaoPRSimoes"><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css"><link rel="canonical" href="https://code-corner.dev/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/"><meta name="generator" content="Hexo 7.1.1"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml,sitemap.txt"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">code-corner.dev</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">The place to learn about programming</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/gravity00"><span class="fa fa-github"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://twitter.com/JoaoPRSimoes"><span class="fa fa-twitter"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://joaoprsimoes.medium.com/"><span class="fa fa-medium"></span></a> <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a> <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://code-corner.dev"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-meta"><a href="/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/" class="article-date"><time class="dt-published" datetime="2020-11-07T00:00:00.000Z" itemprop="datePublished">2020-11-07</time></a><div class="article-category"><a class="article-category-link" href="/categories/tutorial/">tutorial</a></div></div><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">Transaction Management With Mediator Pipelines in ASP.NET Core</h1><h2 class="p-name article-subtitle">Manage Entity Framework Core transactions when handling commands</h2></header><div class="e-content article-entry" itemprop="articleBody"><a href="https://code-corner.dev/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/00_header.png" data-fancybox="gallery" data-caption><img src="https://code-corner.dev/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/00_header.png"></a><p>When implementing a <strong>simplified CQRS</strong> service, which usually has a single database but still separates commands from queries, the mediator pipeline can be used to manage transactions when processing commands, ensuring changes will be implicitly committed unless an exception is thrown.</p><p>Implementing a pipeline for transactions has some key advantages even when using Entity Framework Core or other ORM that tracks and flushes changes at a single point in time.</p><p>Because the command handler is executing inside an implicit transaction, the developer is free to flush their changes as it sees fit knowing that any exception will rollback the changes. This is very helpful when it wants to cancel the flow when some business rules aren’t meet and could only be checked after changing the system state. Optimistic concurrency is a good example where you may want to flush your changes before leaving the handler so you know exactly what entity failed and can send a more detailed message to the user, which is the usual approach when implementing a dedicated <strong>Backend for Frontend</strong> service.</p><p>Also, ORMs are very good at abstracting database access but can’t solve more edge cases, specially when performance is a requirement. Being able to use a more lightweight library (e.g. <a target="_blank" rel="noopener" href="https://github.com/StackExchange/Dapper">Dapper</a>) to do some bulk operations and using the ORM context connection inside the same transaction will remove the need to use the <code>TransactionScope</code> and reduce some application complexity.</p><p>Ensuring transactions are properly managed around the handler execution ensure the application architecture is be more robust and will be able to handle more edge cases.</p><hr><h1 id="The-project"><a href="#The-project" class="headerlink" title="The project"></a>The project</h1><p>This article will be based on my previous ones that explained how to use the mediator and implement transversal behavior with pipelines. As a reminder, we implemented an endpoint to manage products with the following:</p><ul><li>GET &#x2F;products — search for products using some filters (<code>SearchProductsQuery</code>);</li><li>GET &#x2F;products&#x2F;{id} — get a product by its unique identifier (<code>GetProductByIdQuery</code>);</li><li>POST &#x2F;products — create a product (<code>CreateProductCommand</code> and <code>CreatedProductEvent</code>);</li><li>PUT &#x2F;products&#x2F;{id} — update a product by its unique identifier (<code>UpdateProductCommand</code> and <code>UpdatedProductEvent</code>);</li><li>DELETE &#x2F;products&#x2F;{id} — delete a product by its unique identifier (<code>DeleteProductCommand</code> and <code>DeletedProductEvent</code>);</li></ul><p>You can check them out here:</p><ul><li><a href="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/" title="Mediator Pattern in ASP.NET Core Applications">Mediator Pattern in ASP.NET Core Applications</a></li><li><a href="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/" title="Using Mediator Pipelines in ASP.NET Core Applications">Using Mediator Pipelines in ASP.NET Core Applications</a></li><li><a href="/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/" title="Validation with Mediator Pipelines in ASP.NET Core Applications">Validation with Mediator Pipelines in ASP.NET Core Applications</a></li></ul><p>The source code is available on <a target="_blank" rel="noopener" href="https://github.com/gravity00/IntroductionMediatorCQRS">GitHub</a>, feel free to give it a look.</p><h1 id="Entity-Framework-Core-transactions"><a href="#Entity-Framework-Core-transactions" class="headerlink" title="Entity Framework Core transactions"></a>Entity Framework Core transactions</h1><p>Entity Framework Core has support for explicit transaction management, which works in a similar way to ADO.NET or the <code>TransactionScope</code> class.</p><p>You can get a disposable instance of <code>IDbContextTransaction</code> by invoking the method <code>BeginTransactionAsync</code>, available from the database property. The transaction can be either committed or rolled back, either by explicit invocation or by disposing the instance before any commit.</p><p>As stated before, this can be very helpful if <code>SaveChanges</code> must be invoked multiple times inside the <em>unit of work</em> operation and you want to ensure exceptions will rollback data changes.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="keyword">using</span> <span class="keyword">var</span> tx = <span class="keyword">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> products.Where(p =&gt; p.Code.StartsWith(<span class="string">&#x27;9&#x27;</span>)).ForEachAsync(product =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    product.Name += <span class="string">&quot; [DEPRECATED]&quot;</span>;</span><br><span class="line">&#125;, ct);</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> _context.SaveChangesAsync(ct);</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> products.ForEachAsync(product =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    product.Price /= <span class="number">2</span>;</span><br><span class="line">&#125;, ct);</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> _context.SaveChangesAsync(ct);</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> tx.CommitAsync(ct);</span><br></pre></td></tr></table></figure><p>In the example above if an exception was thrown after the first <code>SaveChangesAsync</code> every changes would be reverted because the transaction would be disposed without an explicit call to commit.</p><p>We are going to leverage on this behavior to implement the pipeline.</p><h1 id="The-pipeline"><a href="#The-pipeline" class="headerlink" title="The pipeline"></a>The pipeline</h1><p>Since only commands mutate system state, we are going to use the command pipeline to enforce a transaction for the next pipelines in the chain up until the handler.</p><p>The pipeline behavior will be:</p><ol><li>Intercept any command;</li><li>Create a new <code>IDbContextTransaction</code> with <code>BeginTransactionAsync</code>;</li><li>Invoke the next pipeline inside the <code>using</code> scope;</li><li>If no exception is thrown, flush all changes and commit;</li><li>Dispose the transaction;</li></ol><p>I’ll also include some commented code incase you want to be sure the queries never mutate the system state. Prevention is better than cure…</p><p>Inside the <code>Pipelines</code> folder create a <code>TransactionPipeline</code> class extending <code>Pipeline</code> (because we only need some of the methods):</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TransactionPipeline</span> : <span class="title">Pipeline</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ApiDbContext _context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TransactionPipeline</span>(<span class="params">ApiDbContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">OnCommandAsync</span>&lt;<span class="title">TCommand</span>&gt;(<span class="params">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">using</span> <span class="keyword">var</span> tx = <span class="keyword">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next(cmd, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> _context.SaveChangesAsync(ct);</span><br><span class="line">        <span class="keyword">await</span> tx.CommitAsync(ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TResult</span>&gt; <span class="title">OnCommandAsync</span>&lt;<span class="title">TCommand</span>, <span class="title">TResult</span>&gt;(<span class="params">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">using</span> <span class="keyword">var</span> tx = <span class="keyword">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> next(cmd, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> _context.SaveChangesAsync(ct);</span><br><span class="line">        <span class="keyword">await</span> tx.CommitAsync(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public override async Task&lt;TResult&gt; OnQueryAsync&lt;TQuery, TResult&gt;(Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, TQuery query, CancellationToken ct)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    await using var tx = await _context.Database.BeginTransactionAsync(ct);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    var result = await next(query, ct);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    await tx.RollbackAsync(ct);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    return result;</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>Startup.cs</code> file and add the <code>TransactionPipeline</code> after the <code>ValidationPipeline</code>, preventing the opening of transactions that could be immediately closed if the command had invalid data.</p><p>Since this examples are using the in-memory database provider for Entity Framework Core, which does not support explicit transactions, we are also going to ignore them for test purposes.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        services.AddMvc();</span><br><span class="line"></span><br><span class="line">        services.AddSwaggerGen();</span><br><span class="line"></span><br><span class="line">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.UseInMemoryDatabase(<span class="string">&quot;ApiDbContext&quot;</span>).ConfigureWarnings(warn =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                warn.Ignore(InMemoryEventId.TransactionIgnoredWarning);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        services.AddMediator(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class="line">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class="line">            o.AddPipeline&lt;ValidationPipeline&gt;();</span><br><span class="line">            o.AddPipeline&lt;TransactionPipeline&gt;();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> implementationType <span class="keyword">in</span> <span class="title">typeof</span>(<span class="params">Startup</span>)</span></span><br><span class="line"><span class="function">                .Assembly</span></span><br><span class="line"><span class="function">                .ExportedTypes</span></span><br><span class="line"><span class="function">                .<span class="title">Where</span>(<span class="params">t =&gt; t.IsClass &amp;&amp; !t.IsAbstract</span>))</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> serviceType <span class="keyword">in</span> implementationType</span><br><span class="line">                    .GetInterfaces()</span><br><span class="line">                    .Where(i =&gt; i.IsGenericType &amp;&amp; i.GetGenericTypeDefinition() == <span class="keyword">typeof</span>(IValidator&lt;&gt;)))</span><br><span class="line">                &#123;</span><br><span class="line">                    o.Services.Add(<span class="keyword">new</span> ServiceDescriptor(serviceType, implementationType, ServiceLifetime.Transient));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now that we have a transversal behavior that manages transactions and flushes all context changes to the database, we can remove from all command handlers the explicit calls to <code>SaveChangesAsync</code>:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DeleteProductCommandHandler</span> : <span class="title">ICommandHandler</span>&lt;<span class="title">DeleteProductCommand</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ApiDbContext _context;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IMediator _mediator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DeleteProductCommandHandler</span>(<span class="params">ApiDbContext context, IMediator mediator</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = context;</span><br><span class="line">        _mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">HandleAsync</span>(<span class="params">DeleteProductCommand cmd, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> product = <span class="keyword">await</span> products.SingleOrDefaultAsync(p =&gt; p.ExternalId == cmd.ProductId, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (product == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;Product &#x27;<span class="subst">&#123;cmd.ProductId&#125;</span>&#x27; not found&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        products.Remove(product);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//await _context.SaveChangesAsync(ct);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> _mediator.BroadcastAsync(<span class="keyword">new</span> DeletedProductEvent</span><br><span class="line">        &#123;</span><br><span class="line">            ProductId = cmd.ProductId</span><br><span class="line">        &#125;, ct);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Speeding-things-up"><a href="#Speeding-things-up" class="headerlink" title="Speeding things up!"></a>Speeding things up!</h1><p>Because this is a pipeline we use very often in most of our APIs, there is already a <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/simplesoft.mediator.microsoft.extensions.efcoretransactionpipeline">NuGet available that allows to open an explicit Entity Framework Core transaction for commands, events or queries</a>, depending your needs.</p><p>To use it, just open the NuGet package manager and install the package <code>SimpleSoft.Mediator.Microsoft.Extensions.EFCoreTransactionPipeline</code>:</p><img src="/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/01_nuget_mediator_transaction_pipeline.png"><p>Open the <code>Startup.cs</code> file and register the pipeline with the extension method <code>AddPipelineForEFCoreTransaction&lt;TContext&gt;</code>. Explicit transactions are disabled by default, so you only need to enable them for commands.</p><p>When using all the NuGets mentioned on my previous articles, the <code>Startup.cs</code> file should be similar to this:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        services.AddMvc();</span><br><span class="line"></span><br><span class="line">        services.AddSwaggerGen();</span><br><span class="line"></span><br><span class="line">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.UseInMemoryDatabase(<span class="string">&quot;ApiDbContext&quot;</span>).ConfigureWarnings(warn =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// since InMemoryDatabase does not support transactions</span></span><br><span class="line">                <span class="comment">// for test purposes we are going to ignore this exception</span></span><br><span class="line">                warn.Ignore(InMemoryEventId.TransactionIgnoredWarning);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        services.AddMediator(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.AddPipelineForLogging(options =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                options.LogCommandResult = <span class="literal">true</span>;</span><br><span class="line">                options.LogQueryResult = <span class="literal">true</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class="line">            o.AddPipelineForValidation(options =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                options.ValidateCommand = <span class="literal">true</span>;</span><br><span class="line">                options.ValidateEvent = <span class="literal">true</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            o.AddPipelineForEFCoreTransaction&lt;ApiDbContext&gt;(options =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                options.BeginTransactionOnCommand = <span class="literal">true</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            o.AddValidatorsFromAssemblyOf&lt;Startup&gt;();</span><br><span class="line">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use mediator pipelines to simplify the management of Entity Framework Core transactions, making the implementation of command handlers less error prone since developers won’t forget to flush changes to the database (that behavior will be implicit unless an exception is thrown).</p><p>Even if your application is using another ORM or other lightweight libraries (e.g. <a target="_blank" rel="noopener" href="https://github.com/StackExchange/Dapper">Dapper</a>), you can easily implement your own pipeline.</p><p>I also made an article about <a href="/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/" title="Auditing with Mediator Pipelines in ASP.NET Core">auditing user actions with pipelines</a>, you may also find it helpful.</p></div><footer class="article-footer"><a data-url="https://code-corner.dev/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/" data-id="clv2o3yct0013jojh5uco2wp7" data-title="Transaction Management With Mediator Pipelines in ASP.NET Core" class="article-share-link"><span class="fa fa-share">Share</span></a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/patterns/" rel="tag">patterns</a></li></ul></footer></div><nav id="article-nav"><a href="/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">Auditing with Mediator Pipelines in ASP.NET Core</div></a><a href="/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Validation with Mediator Pipelines in ASP.NET Core Applications</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/concepts/">concepts</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/performance/">performance</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tutorial/">tutorial</a><span class="category-list-count">9</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dapper/" rel="tag">dapper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/efcore/" rel="tag">efcore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hangfire/" rel="tag">hangfire</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linq/" rel="tag">linq</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/patterns/" rel="tag">patterns</a><span class="tag-list-count">6</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/aspnetcore/" style="font-size:15.71px">aspnetcore</a> <a href="/tags/csharp/" style="font-size:18.57px">csharp</a> <a href="/tags/dapper/" style="font-size:10px">dapper</a> <a href="/tags/dotnet/" style="font-size:17.14px">dotnet</a> <a href="/tags/dotnetcore/" style="font-size:20px">dotnetcore</a> <a href="/tags/efcore/" style="font-size:12.86px">efcore</a> <a href="/tags/hangfire/" style="font-size:10px">hangfire</a> <a href="/tags/linq/" style="font-size:11.43px">linq</a> <a href="/tags/patterns/" style="font-size:14.29px">patterns</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/05/25/NET-IAsyncEnumerable-utility-extensions/">.NET - IAsyncEnumerable utility extensions</a></li><li><a href="/2024/04/14/NET-9-%E2%80%94-Exception-handling-performance/">.NET 9 — Exception handling performance</a></li><li><a href="/2024/02/29/NET-Hangfire/">.NET - Hangfire</a></li><li><a href="/2024/02/05/NET-%E2%80%94-LinkedList-vs-ToArray/">.NET — LinkedList vs ToArray</a></li><li><a href="/2024/01/19/NET-%E2%80%94-TaskCompletionSource-and-CancellationTokenSource/">.NET — TaskCompletionSource and CancellationTokenSource</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png"></a><br>All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a><br>&copy; 2024 João Simões<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="/js/jquery-3.6.4.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></div></body></html>