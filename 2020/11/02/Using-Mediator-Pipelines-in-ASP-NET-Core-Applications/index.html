<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-TQKP5TGHJ8"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TQKP5TGHJ8")</script><title>Using Mediator Pipelines in ASP.NET Core Applications | code-corner.dev</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="google-adsense-account" content="ca-pub-4671230649342120"><meta name="description" content="In my previous article I explained how you could implement Command Query Responsibility Segregation (CQRS) and Event Sourcing (ES) patterns using a mediator instance from SimpleSoft.Mediator in ASP.NE"><meta property="og:type" content="article"><meta property="og:title" content="Using Mediator Pipelines in ASP.NET Core Applications"><meta property="og:url" content="https://code-corner.dev/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/index.html"><meta property="og:site_name" content="code-corner.dev"><meta property="og:description" content="In my previous article I explained how you could implement Command Query Responsibility Segregation (CQRS) and Event Sourcing (ES) patterns using a mediator instance from SimpleSoft.Mediator in ASP.NE"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://code-corner.dev/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/00_header.png"><meta property="article:published_time" content="2020-11-02T00:00:00.000Z"><meta property="article:modified_time" content="2024-04-16T17:31:21.759Z"><meta property="article:author" content="João Simões"><meta property="article:tag" content="dotnetcore"><meta property="article:tag" content="aspnetcore"><meta property="article:tag" content="csharp"><meta property="article:tag" content="patterns"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://code-corner.dev/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/00_header.png"><meta name="twitter:creator" content="@JoaoPRSimoes"><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css"><link rel="canonical" href="https://code-corner.dev/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/"><meta name="generator" content="Hexo 7.1.1"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml,sitemap.txt"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">code-corner.dev</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">The place to learn about programming</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/gravity00"><span class="fa fa-github"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://twitter.com/JoaoPRSimoes"><span class="fa fa-twitter"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://joaoprsimoes.medium.com/"><span class="fa fa-medium"></span></a> <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a> <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://code-corner.dev"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-Using-Mediator-Pipelines-in-ASP-NET-Core-Applications" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-meta"><a href="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/" class="article-date"><time class="dt-published" datetime="2020-11-02T00:00:00.000Z" itemprop="datePublished">2020-11-02</time></a><div class="article-category"><a class="article-category-link" href="/categories/tutorial/">tutorial</a></div></div><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">Using Mediator Pipelines in ASP.NET Core Applications</h1><h2 class="p-name article-subtitle">Intercept commands, queries and events to apply transversal behavior</h2></header><div class="e-content article-entry" itemprop="articleBody"><a href="https://code-corner.dev/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/00_header.png" data-fancybox="gallery" data-caption><img src="https://code-corner.dev/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/00_header.png"></a><p>In my <a href="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/" title="Mediator Pattern in ASP.NET Core Applications">previous article</a> I explained how you could implement <strong>Command Query Responsibility Segregation (CQRS)</strong> and <strong>Event Sourcing (ES)</strong> patterns using a mediator instance from <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/simplesoft.mediator">SimpleSoft.Mediator</a> in ASP.NET Core applications.</p><p>This time I’m going to explain how to intercept commands, queries and events, making it possible to apply transversal behavior before they reach the handlers, reducing significantly the amount of boilerplate and duplicated code.</p><p>Transaction management, logging, auditing, caching or validations are some of the good examples where pipelines can be very helpful. Imagine the following chains:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Commands:</span><br><span class="line">  Mediator</span><br><span class="line">    LoggingPipeline</span><br><span class="line">      ValidationPipeline</span><br><span class="line">        TransactionPipeline</span><br><span class="line">          AuditPipeline</span><br><span class="line">            Handler</span><br><span class="line"></span><br><span class="line">Queries:</span><br><span class="line">  Mediator</span><br><span class="line">    LoggingPipeline</span><br><span class="line">      Handler</span><br><span class="line"></span><br><span class="line">Events:</span><br><span class="line">  Mediator</span><br><span class="line">    LoggingPipeline</span><br><span class="line">      StoragePipeline</span><br><span class="line">        Handler(s)</span><br></pre></td></tr></table></figure><p>Not only you can plugin any pipeline at will without changing the handlers implementation, you can also be specific to the entities each pipeline is interested.</p><h1 id="Pipelines"><a href="#Pipelines" class="headerlink" title="Pipelines"></a>Pipelines</h1><p>Mediator pipelines are represented by the interface <code>IPipeline</code> (or the abstract class <code>Pipeline</code>) with methods to intercept each entity type:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPipeline</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">Task <span class="title">OnCommandAsync</span>&lt;<span class="title">TCommand</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        Func&lt;TCommand, CancellationToken, Task&gt; next, </span></span></span><br><span class="line"><span class="params"><span class="function">        TCommand cmd, </span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) <span class="keyword">where</span> TCommand : <span class="keyword">class</span>, ICommand</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">Task</span>&lt;<span class="title">TResult</span>&gt; <span class="title">OnCommandAsync</span>&lt;<span class="title">TCommand</span>, <span class="title">TResult</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, </span></span></span><br><span class="line"><span class="params"><span class="function">        TCommand cmd, </span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) <span class="keyword">where</span> TCommand : <span class="keyword">class</span>, <span class="title">ICommand</span>&lt;<span class="title">TResult</span>&gt;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Task <span class="title">OnEventAsync</span>&lt;<span class="title">TEvent</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        Func&lt;TEvent, CancellationToken, Task&gt; next, </span></span></span><br><span class="line"><span class="params"><span class="function">        TEvent evt, </span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) <span class="keyword">where</span> TEvent : <span class="keyword">class</span>, IEvent</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="title">Task</span>&lt;<span class="title">TResult</span>&gt; <span class="title">OnQueryAsync</span>&lt;<span class="title">TQuery</span>, <span class="title">TResult</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, </span></span></span><br><span class="line"><span class="params"><span class="function">        TQuery query, </span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) <span class="keyword">where</span> TQuery : <span class="keyword">class</span>, IQuery&lt;TResult&gt;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>You receive a delegate for the next pipe and the entity, so the concept is very simple: either do some work before or after invoking the next pipe, or break the chain by returning or throwing an exception.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IsItMondayAlreadyPipeline</span> : <span class="title">Pipeline</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TResult</span>&gt; <span class="title">OnQueryAsync</span>&lt;<span class="title">TQuery</span>, <span class="title">TResult</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, </span></span></span><br><span class="line"><span class="params"><span class="function">        TQuery query, </span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(DateTime.Now.DayOfWeek == DayOfWeek.Monday)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">&quot;Today is monday, no data for you!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> next(query, ct);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>Pipelines are executed by the same order they are added to the container so, to be deterministic, don’t scan the assemblies for classes implementing <code>IPipeline</code>.</em></p><h2 id="Commands-pipeline"><a href="#Commands-pipeline" class="headerlink" title="Commands pipeline"></a>Commands pipeline</h2><p>Intercept commands sent into the mediator by implementing the methods <code>OnCommandAsync</code>:</p><img src="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/01_pipeline_command.png"><h2 id="Queries-pipeline"><a href="#Queries-pipeline" class="headerlink" title="Queries pipeline"></a>Queries pipeline</h2><p>Intercept queries being fetched from the mediator by implementing the methods <code>OnQueryAsync</code>:</p><img src="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/02_pipeline_query.png"><h2 id="Events-pipeline"><a href="#Events-pipeline" class="headerlink" title="Events pipeline"></a>Events pipeline</h2><p>Intercept events before being broadcasted by the mediator into all the handlers by implementing the method <code>OnEventAsync</code>:</p><img src="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/03_pipeline_event.png"><hr><h1 id="The-project"><a href="#The-project" class="headerlink" title="The project"></a>The project</h1><p>To make it easier, we are going to leverage on the <a href="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/" title="Mediator Pattern in ASP.NET Core Applications">previous article</a> and continue from there. As a reminder, we implemented an endpoint to manage products with the following:</p><ul><li>GET &#x2F;products — search for products using some filters (<code>SearchProductsQuery</code>);</li><li>GET &#x2F;products&#x2F;{id} — get a product by its unique identifier (<code>GetProductByIdQuery</code>);</li><li>POST &#x2F;products — create a product (<code>CreateProductCommand</code> and <code>CreatedProductEvent</code>);</li><li>PUT &#x2F;products&#x2F;{id} — update a product by its unique identifier (<code>UpdateProductCommand</code> and <code>UpdatedProductEvent</code>);</li><li>DELETE &#x2F;products&#x2F;{id} — delete a product by its unique identifier (<code>DeleteProductCommand</code> and <code>DeletedProductEvent</code>);</li></ul><p>The complete source code can be found on <a target="_blank" rel="noopener" href="https://github.com/gravity00/IntroductionMediatorCQRS">GitHub</a>.</p><h1 id="The-pipelines"><a href="#The-pipelines" class="headerlink" title="The pipelines"></a>The pipelines</h1><p>Since the objective of this article is to show how to implement pipelines in the mediator, the following should be enough:</p><ul><li><strong>LoggingPipeline</strong> — serializes every command, queries, events and results as JSON into the log if <code>Trace</code> is enabled;</li><li><strong>TimeoutPipeline</strong> — cancels the handler execution if it takes more than a given set of time;</li></ul><p>Start by creating a <code>Pipelines</code> folder at the project root level.</p><img src="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/04_project_structure_pipelines.png"><h2 id="LoggingPipeline"><a href="#LoggingPipeline" class="headerlink" title="LoggingPipeline"></a>LoggingPipeline</h2><p>Because we don’t want logging to affect the timeout, this will be the first pipeline to be added to the chain.</p><p>Inside the <code>Pipelines</code> folder, create a <code>LoggingPipeline</code> class implementing <code>IPipeline</code>. This pipeline will receive an <code>ILogger</code> instance and use <code>System.Text.Json</code> to serialize the objects:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LoggingPipeline</span> : <span class="title">IPipeline</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;LoggingPipeline&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> JsonSerializerOptions _serializerOptions = <span class="keyword">new</span> JsonSerializerOptions</span><br><span class="line">    &#123;</span><br><span class="line">        WriteIndented = <span class="literal">true</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingPipeline</span>(<span class="params">ILogger&lt;LoggingPipeline&gt; logger</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnCommandAsync</span>&lt;<span class="title">TCommand</span>&gt;(<span class="params">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>) </span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TCommand : <span class="keyword">class</span>, ICommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        Log(<span class="string">&quot;Command: &#123;command&#125;&quot;</span>, cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next(cmd, ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TResult</span>&gt; <span class="title">OnCommandAsync</span>&lt;<span class="title">TCommand</span>, <span class="title">TResult</span>&gt;(<span class="params">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>) </span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TCommand : <span class="keyword">class</span>, ICommand&lt;TResult&gt;</span></span><br><span class="line">    &#123;</span><br><span class="line">        Log(<span class="string">&quot;Command: &#123;command&#125;&quot;</span>, cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> next(cmd, ct);</span><br><span class="line"></span><br><span class="line">        Log(<span class="string">&quot;Command.Result: &#123;commandResult&#125;&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnEventAsync</span>&lt;<span class="title">TEvent</span>&gt;(<span class="params">Func&lt;TEvent, CancellationToken, Task&gt; next, TEvent evt, CancellationToken ct</span>) </span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TEvent : <span class="keyword">class</span>, IEvent</span></span><br><span class="line">    &#123;</span><br><span class="line">        Log(<span class="string">&quot;Event: &#123;event&#125;&quot;</span>, evt);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next(evt, ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TResult</span>&gt; <span class="title">OnQueryAsync</span>&lt;<span class="title">TQuery</span>, <span class="title">TResult</span>&gt;(<span class="params">Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, TQuery query, CancellationToken ct</span>) </span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TQuery : <span class="keyword">class</span>, IQuery&lt;TResult&gt;</span></span><br><span class="line">    &#123;</span><br><span class="line">        Log(<span class="string">&quot;Query: &#123;query&#125;&quot;</span>, query);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> next(query, ct);</span><br><span class="line"></span><br><span class="line">        Log(<span class="string">&quot;Query.Result: &#123;queryResult&#125;&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Log</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> message, T instance</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_logger.IsEnabled(LogLevel.Trace))</span><br><span class="line">            _logger.LogTrace(message, JsonSerializer.Serialize(instance, _serializerOptions));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>Startup.cs</code> file and register the pipeline into the mediator:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">services.AddMediator(o =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class="line">    </span><br><span class="line">    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Open the <code>appsettings.development.json</code> file and set the default log level to <code>Trace</code>:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Trace&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Microsoft&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Microsoft.Hosting.Lifetime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>If you now start the server and do some actions in the API, like creating or searching for products, you should start seeing your objects being serialized:</p><img src="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/05_pipeline_logging_logs.png"><p><em>As a note, if you find this helpful for your APIs, you can use the NuGet <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/simplesoft.mediator.microsoft.extensions.loggingpipeline">SimpleSoft.Mediator.Microsoft.Extensions.LoggingPipeline</a>. Just give a look at the <code>Startup.cs</code> file in <a target="_blank" rel="noopener" href="https://github.com/simplesoft-pt/Mediator/blob/master/work/SimpleSoft.Mediator.Example.Api/Startup.cs">the example API</a>.</em></p><h2 id="TimeoutPipeline"><a href="#TimeoutPipeline" class="headerlink" title="TimeoutPipeline"></a>TimeoutPipeline</h2><p>Inside the <code>Pipelines</code> folder, create a <code>TimeoutPipeline</code> class implementing <code>IPipeline</code>. For simplicity, the timeout value will be fixed, but could be received as an options from the container.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TimeoutPipeline</span> : <span class="title">IPipeline</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> TimeSpan Timeout = TimeSpan.FromMilliseconds(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnCommandAsync</span>&lt;<span class="title">TCommand</span>&gt;(<span class="params">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>) </span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TCommand : <span class="keyword">class</span>, ICommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> cts = CreateCancellationTokenSource(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next(cmd, cts.Token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TResult</span>&gt; <span class="title">OnCommandAsync</span>&lt;<span class="title">TCommand</span>, <span class="title">TResult</span>&gt;(<span class="params">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>) </span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TCommand : <span class="keyword">class</span>, ICommand&lt;TResult&gt;</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> cts = CreateCancellationTokenSource(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> next(cmd, cts.Token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnEventAsync</span>&lt;<span class="title">TEvent</span>&gt;(<span class="params">Func&lt;TEvent, CancellationToken, Task&gt; next, TEvent evt, CancellationToken ct</span>) </span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TEvent : <span class="keyword">class</span>, IEvent</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> cts = CreateCancellationTokenSource(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next(evt, cts.Token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TResult</span>&gt; <span class="title">OnQueryAsync</span>&lt;<span class="title">TQuery</span>, <span class="title">TResult</span>&gt;(<span class="params">Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, TQuery query, CancellationToken ct</span>) </span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TQuery : <span class="keyword">class</span>, IQuery&lt;TResult&gt;</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> cts = CreateCancellationTokenSource(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> next(query, cts.Token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CancellationTokenSource <span class="title">CreateCancellationTokenSource</span>(<span class="params">CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> cts = CancellationTokenSource.CreateLinkedTokenSource(ct);</span><br><span class="line">        cts.CancelAfter(Timeout);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cts;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Once again, open the <code>Startup.cs</code> file and register the pipeline into the mediator <strong>after</strong> the logging pipe:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">services.AddMediator(o =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class="line">    o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class="line">    </span><br><span class="line">    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>If you now open any of your handlers and add an <code>Task.Delay(1000, ct)</code> into the <code>HandleAsync</code> methods you should receive a <code>TaskCanceledException</code>. I added one when searching for products:</p><img src="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/06_pipeline_timeout_stacktrace_response.png"><p>If you look at the stack trace, you’ll see the invocation order was kept:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ProductsController</span><br><span class="line">    MicrosoftFetcher (internal class used by the mediator)</span><br><span class="line">        LoggingPipeline</span><br><span class="line">            TimeoutPipeline</span><br><span class="line">                SearchProductsQueryHandler</span><br></pre></td></tr></table></figure><p>The project structure with pipeline classes:</p><img src="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/07_project_structure_pipelines_impl.png"><p>The final <code>Startup.cs</code> file:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        services.AddMvc();</span><br><span class="line"></span><br><span class="line">        services.AddSwaggerGen();</span><br><span class="line"></span><br><span class="line">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.UseInMemoryDatabase(<span class="string">&quot;ApiDbContext&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        services.AddMediator(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class="line">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class="line">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        app.UseDeveloperExceptionPage();</span><br><span class="line"></span><br><span class="line">        app.UseSwagger();</span><br><span class="line"></span><br><span class="line">        app.UseSwaggerUI(c =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            c.SwaggerEndpoint(<span class="string">&quot;/swagger/v1/swagger.json&quot;</span>, <span class="string">&quot;Mediator ExampleApi V1&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        app.UseRouting();</span><br><span class="line"></span><br><span class="line">        app.UseEndpoints(endpoints =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            endpoints.MapControllers();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope this article gave you a good idea about mediator pipelines and how you can use them to empower your solutions, making them more resilient to developer mistakes (like forgetting to save changes into the database).</p><p>For me, this is one of the strongest aspects of the mediator pattern and one of the main reason I always use this pattern even when implementing <strong>minimum viable products</strong>.</p></div><footer class="article-footer"><a data-url="https://code-corner.dev/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/" data-id="clv2o3yd40038jojh9shq1q4w" data-title="Using Mediator Pipelines in ASP.NET Core Applications" class="article-share-link"><span class="fa fa-share">Share</span></a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/patterns/" rel="tag">patterns</a></li></ul></footer></div><nav id="article-nav"><a href="/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">Validation with Mediator Pipelines in ASP.NET Core Applications</div></a><a href="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Mediator Pattern in ASP.NET Core Applications</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/concepts/">concepts</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/performance/">performance</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tutorial/">tutorial</a><span class="category-list-count">9</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dapper/" rel="tag">dapper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/efcore/" rel="tag">efcore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hangfire/" rel="tag">hangfire</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linq/" rel="tag">linq</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/patterns/" rel="tag">patterns</a><span class="tag-list-count">6</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/aspnetcore/" style="font-size:16.67px">aspnetcore</a> <a href="/tags/csharp/" style="font-size:18.33px">csharp</a> <a href="/tags/dapper/" style="font-size:10px">dapper</a> <a href="/tags/dotnet/" style="font-size:16.67px">dotnet</a> <a href="/tags/dotnetcore/" style="font-size:20px">dotnetcore</a> <a href="/tags/efcore/" style="font-size:13.33px">efcore</a> <a href="/tags/hangfire/" style="font-size:10px">hangfire</a> <a href="/tags/linq/" style="font-size:11.67px">linq</a> <a href="/tags/patterns/" style="font-size:15px">patterns</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/04/14/NET-9-%E2%80%94-Exception-handling-performance/">.NET 9 — Exception handling performance</a></li><li><a href="/2024/02/29/NET-Hangfire/">.NET - Hangfire</a></li><li><a href="/2024/02/05/NET-%E2%80%94-LinkedList-vs-ToArray/">.NET — LinkedList vs ToArray</a></li><li><a href="/2024/01/19/NET-%E2%80%94-TaskCompletionSource-and-CancellationTokenSource/">.NET — TaskCompletionSource and CancellationTokenSource</a></li><li><a href="/2024/01/08/Dispose-pattern-in-NET/">Dispose pattern in .NET</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png"></a><br>All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a><br>&copy; 2024 João Simões<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="/js/jquery-3.6.4.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></div></body></html>