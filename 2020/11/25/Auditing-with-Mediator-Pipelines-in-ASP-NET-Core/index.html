<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-TQKP5TGHJ8"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TQKP5TGHJ8")</script><title>Auditing with Mediator Pipelines in ASP.NET Core | code-corner.dev</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="google-adsense-account" content="ca-pub-4671230649342120"><meta name="description" content="When implementing a web application, it can be a good idea to enforce some kind of auditing to all of your client interactions, either to track their behavior over time, to ensure any security breach"><meta property="og:type" content="article"><meta property="og:title" content="Auditing with Mediator Pipelines in ASP.NET Core"><meta property="og:url" content="https://code-corner.dev/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/index.html"><meta property="og:site_name" content="code-corner.dev"><meta property="og:description" content="When implementing a web application, it can be a good idea to enforce some kind of auditing to all of your client interactions, either to track their behavior over time, to ensure any security breach"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://code-corner.dev/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/00_header.png"><meta property="article:published_time" content="2020-11-25T00:00:00.000Z"><meta property="article:modified_time" content="2024-04-16T17:31:21.688Z"><meta property="article:author" content="João Simões"><meta property="article:tag" content="dotnetcore"><meta property="article:tag" content="aspnetcore"><meta property="article:tag" content="csharp"><meta property="article:tag" content="patterns"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://code-corner.dev/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/00_header.png"><meta name="twitter:creator" content="@JoaoPRSimoes"><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css"><link rel="canonical" href="https://code-corner.dev/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/"><meta name="generator" content="Hexo 7.1.1"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml,sitemap.txt"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">code-corner.dev</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">The place to learn about programming</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/gravity00"><span class="fa fa-github"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://twitter.com/JoaoPRSimoes"><span class="fa fa-twitter"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://joaoprsimoes.medium.com/"><span class="fa fa-medium"></span></a> <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a> <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://code-corner.dev"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-Auditing-with-Mediator-Pipelines-in-ASP-NET-Core" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-meta"><a href="/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/" class="article-date"><time class="dt-published" datetime="2020-11-25T00:00:00.000Z" itemprop="datePublished">2020-11-25</time></a><div class="article-category"><a class="article-category-link" href="/categories/tutorial/">tutorial</a></div></div><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">Auditing with Mediator Pipelines in ASP.NET Core</h1><h2 class="p-name article-subtitle">Audit commands and store events with transversal behavior</h2></header><div class="e-content article-entry" itemprop="articleBody"><a href="https://code-corner.dev/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/00_header.png" data-fancybox="gallery" data-caption><img src="https://code-corner.dev/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/00_header.png"></a><p>When implementing a web application, it can be a good idea to enforce some kind of auditing to all of your client interactions, either to track their behavior over time, to ensure any security breach will be properly logged, or just to help analyze system bugs.</p><p>Previously we talked about using the mediator pattern to implement the <strong>Command Query Responsibility Segregation (CQRS)</strong> and <strong>Event Sourcing (ES)</strong> and how pipelines could be used to implement transversal behavior to your application.</p><p>Since commands are responsible to mutate the system state, in this article I’m going to demonstrate how you could implement an audit pipeline to ensure all commands will be stored into a table. Because a variable number of events can be broadcasted when the state changes, the pipeline will also store them into another table and with a reference to the command, ensuring any correlation can be analyzed.</p><hr><h1 id="The-project"><a href="#The-project" class="headerlink" title="The project"></a>The project</h1><p>From my previous articles, were I explained how to use the mediator and implement transversal behavior with pipelines, we are going to continue and expand the source code to audit commands and store into the events table anything broadcasted by the mediator without having a specific handler for each event.</p><p>As a reminder, we implemented an endpoint to manage products with the following:</p><p>GET &#x2F;products — search for products using some filters (<code>SearchProductsQuery</code>);<br>GET &#x2F;products&#x2F;{id} — get a product by its unique identifier (<code>GetProductByIdQuery</code>);<br>POST &#x2F;products — create a product (<code>CreateProductCommand</code> and <code>CreatedProductEvent</code>);<br>PUT &#x2F;products&#x2F;{id} — update a product by its unique identifier (<code>UpdateProductCommand</code> and <code>UpdatedProductEvent</code>);<br>DELETE &#x2F;products&#x2F;{id} — delete a product by its unique identifier (<code>DeleteProductCommand</code> and <code>DeletedProductEvent</code>);</p><p>You can check them out here:</p><ul><li><a href="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/" title="Mediator Pattern in ASP.NET Core Applications">Mediator Pattern in ASP.NET Core Applications</a></li><li><a href="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/" title="Using Mediator Pipelines in ASP.NET Core Applications">Using Mediator Pipelines in ASP.NET Core Applications</a></li><li><a href="/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/" title="Validation with Mediator Pipelines in ASP.NET Core Applications">Validation with Mediator Pipelines in ASP.NET Core Applications</a></li><li><a href="/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/" title="Transaction Management With Mediator Pipelines in ASP.NET Core">Transaction Management With Mediator Pipelines in ASP.NET Core</a></li></ul><p>The source code is available on <a target="_blank" rel="noopener" href="https://github.com/gravity00/IntroductionMediatorCQRS">GitHub</a>, feel free to give it a look.</p><h1 id="Auditing"><a href="#Auditing" class="headerlink" title="Auditing"></a>Auditing</h1><p>Since in this article we will only audit API actions that mutate state, we are going to intercept commands and store information we find relevant into a specific table:</p><ul><li><strong>ExternalId</strong> — the unique identifier for each command, available via <code>Command.Id</code> or <code>Command&lt;TResult&gt;.Id</code>;</li><li><strong>Name</strong> — the command type name from <code>typeof(TCommand).Name</code>;</li><li><strong>Payload</strong> — the command serialized as JSON;</li><li><strong>Result</strong> — if available, the command result serialized as JSON;</li><li><strong>CreatedOn</strong> — date and time when the command was sent into the mediator, available via <code>Command.CreatedOn</code> or <code>Command&lt;TResult&gt;.CreatedOn</code>;</li><li><strong>CreatedBy</strong> — username from the current request user property, available via <code>Command.CreatedBy</code> or <code>Command&lt;TResult&gt;.CreatedBy</code>;</li><li><strong>ExecutionTime</strong> — elapsed time the handler spent processing the command;</li></ul><p>Because events are broadcasted by commands, which are now audited into the database, we are also going to extend the events table and introduce the foreign key <code>CommandId</code>, referencing the commands.</p><h1 id="The-Database-Model"><a href="#The-Database-Model" class="headerlink" title="The Database Model"></a>The Database Model</h1><p>Inside the <code>Database</code> folder create a <code>CommandEntity</code> class and add the new <code>CommandId</code> property to the existing <code>EventEntity</code>:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CommandEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> Guid ExternalId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Payload &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Result &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTimeOffset CreatedOn &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> CreatedBy &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> TimeSpan ExecutionTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> CommandId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// added property</span></span><br><span class="line">    <span class="keyword">public</span> Guid ExternalId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Payload &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTimeOffset CreatedOn &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> CreatedBy &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>ApiDbContext</code> file, configure the mappings for the <code>CommandEntity</code> and add a required one-to-many relation between this tables:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ApiDbContext</span> : <span class="title">DbContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder builder</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        builder.Entity&lt;CommandEntity&gt;(cfg =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            cfg.HasKey(e =&gt; e.Id);</span><br><span class="line">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class="line">            cfg.HasIndex(e =&gt; e.CreatedOn);</span><br><span class="line">            cfg.Property(e =&gt; e.Id)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .ValueGeneratedOnAdd();</span><br><span class="line">            cfg.Property(e =&gt; e.ExternalId)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.Name)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .HasMaxLength(<span class="number">128</span>);</span><br><span class="line">            cfg.Property(e =&gt; e.Payload)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.Result);</span><br><span class="line">            cfg.Property(e =&gt; e.CreatedOn)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.CreatedBy)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .HasMaxLength(<span class="number">128</span>);</span><br><span class="line">            cfg.Property(e =&gt; e.ExecutionTime)</span><br><span class="line">                .IsRequired();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        builder.Entity&lt;EventEntity&gt;(cfg =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            cfg.HasKey(e =&gt; e.Id);</span><br><span class="line">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class="line">            cfg.HasIndex(e =&gt; e.CreatedOn);</span><br><span class="line">            cfg.Property(e =&gt; e.Id)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .ValueGeneratedOnAdd();</span><br><span class="line">            cfg.HasOne&lt;CommandEntity&gt;()</span><br><span class="line">                .WithMany()</span><br><span class="line">                .HasForeignKey(e =&gt; e.CommandId)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.ExternalId)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.Name)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .HasMaxLength(<span class="number">128</span>);</span><br><span class="line">            cfg.Property(e =&gt; e.Payload)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.CreatedOn)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.CreatedBy)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .HasMaxLength(<span class="number">128</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="User-Information"><a href="#User-Information" class="headerlink" title="User Information"></a>User Information</h1><p>By design, all POCOs provided in this library are immutable and only provide a protected setter for the properties <code>Id</code>, <code>CreatedOn</code> and <code>CreatedBy</code>. This ensures the developer is free to decide either by immutable commands, queries and events, initializing all properties in the constructor, or to expose a public setter instead.</p><p>Since we haven’t made our POCOs immutable, and for demo purposes, we are going to expose a public setter for the <code>CreatedBy</code> property by implementing our own command, query and event classes.</p><p>Inside the <code>Handlers</code> folder create a <code>Command.cs</code>, <code>Query.cs</code> and <code>Event.cs</code> files and extend the corresponding <code>Command</code>, <code>Command&lt;TResult&gt;</code>, <code>Query&lt;TResult&gt;</code> and <code>Event</code> classes, creating a new setter ao getter for <code>CreatedBy</code>. Since your classes have the same name than the ones provided by <code>Simplesoft.Mediator</code>, your existing classes will automatically extend from them and expose the new setters without a single change:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Command</span> : <span class="title">SimpleSoft.Mediator.Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">new</span> <span class="built_in">string</span> CreatedBy</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> =&gt; <span class="keyword">base</span>.CreatedBy;</span><br><span class="line">        <span class="keyword">set</span> =&gt; <span class="keyword">base</span>.CreatedBy = <span class="keyword">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Command</span>&lt;<span class="title">TResult</span>&gt; : <span class="title">SimpleSoft.Mediator.Command</span>&lt;<span class="title">TResult</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">new</span> <span class="built_in">string</span> CreatedBy</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> =&gt; <span class="keyword">base</span>.CreatedBy;</span><br><span class="line">        <span class="keyword">set</span> =&gt; <span class="keyword">base</span>.CreatedBy = <span class="keyword">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Event</span> : <span class="title">SimpleSoft.Mediator.Event</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">new</span> <span class="built_in">string</span> CreatedBy</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> =&gt; <span class="keyword">base</span>.CreatedBy;</span><br><span class="line">        <span class="keyword">set</span> =&gt; <span class="keyword">base</span>.CreatedBy = <span class="keyword">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Query</span>&lt;<span class="title">TResult</span>&gt; : <span class="title">SimpleSoft.Mediator.Query</span>&lt;<span class="title">TResult</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">new</span> <span class="built_in">string</span> CreatedBy</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> =&gt; <span class="keyword">base</span>.CreatedBy;</span><br><span class="line">        <span class="keyword">set</span> =&gt; <span class="keyword">base</span>.CreatedBy = <span class="keyword">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The project solution should look like this:</p><img src="/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/01_project_structure_auditing.png"><p>Open your <code>ProductsController.cs</code> file and set the CreatedBy property of all the commands and queries with the property <code>User.Identity.Name</code>.</p><p>Please keep in your mind that, since we haven’t configured authentication in this API, the username value will always be null.</p><p>After changes, your controller actions should look as follows:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;products&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductsController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IMediator _mediator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProductsController</span>(<span class="params">IMediator mediator</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpGet</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IEnumerable&lt;ProductModel&gt;&gt; SearchAsync([FromQuery] <span class="built_in">string</span> filterQ, [FromQuery] <span class="built_in">int</span>? skip, [FromQuery] <span class="built_in">int</span>? take, CancellationToken ct)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> _mediator.FetchAsync(<span class="keyword">new</span> SearchProductsQuery</span><br><span class="line">        &#123;</span><br><span class="line">            FilterQ = filterQ,</span><br><span class="line">            Skip = skip,</span><br><span class="line">            Take = take,</span><br><span class="line">            CreatedBy = User.Identity.Name</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result.Select(r =&gt; <span class="keyword">new</span> ProductModel</span><br><span class="line">        &#123;</span><br><span class="line">            Id = r.Id,</span><br><span class="line">            Code = r.Code,</span><br><span class="line">            Name = r.Name,</span><br><span class="line">            Price = r.Price</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpGet(<span class="string">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ProductModel&gt; <span class="title">GetByIdAsync</span>(<span class="params">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> _mediator.FetchAsync(<span class="keyword">new</span> GetProductByIdQuery</span><br><span class="line">        &#123;</span><br><span class="line">            ProductId = id,</span><br><span class="line">            CreatedBy = User.Identity.Name</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProductModel</span><br><span class="line">        &#123;</span><br><span class="line">            Id = result.Id,</span><br><span class="line">            Code = result.Code,</span><br><span class="line">            Name = result.Name,</span><br><span class="line">            Price = result.Price</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpPost</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;CreateProductResultModel&gt; <span class="title">CreateAsync</span>(<span class="params">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> _mediator.SendAsync(<span class="keyword">new</span> CreateProductCommand</span><br><span class="line">        &#123;</span><br><span class="line">            Code = model.Code,</span><br><span class="line">            Name = model.Name,</span><br><span class="line">            Price = model.Price,</span><br><span class="line">            CreatedBy = User.Identity.Name</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CreateProductResultModel</span><br><span class="line">        &#123;</span><br><span class="line">            Id = result.Id</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpPut(<span class="string">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">UpdateAsync</span>(<span class="params">[FromRoute] Guid id, [FromBody] UpdateProductModel model, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> _mediator.SendAsync(<span class="keyword">new</span> UpdateProductCommand</span><br><span class="line">        &#123;</span><br><span class="line">            ProductId = id,</span><br><span class="line">            Code = model.Code,</span><br><span class="line">            Name = model.Name,</span><br><span class="line">            Price = model.Price,</span><br><span class="line">            CreatedBy = User.Identity.Name</span><br><span class="line">        &#125;, ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpDelete(<span class="string">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DeleteAsync</span>(<span class="params">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> _mediator.SendAsync(<span class="keyword">new</span> DeleteProductCommand</span><br><span class="line">        &#123;</span><br><span class="line">            ProductId = id,</span><br><span class="line">            CreatedBy = User.Identity.Name</span><br><span class="line">        &#125;, ct);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>We also want to pass the same username to all of our events, so open the command handlers and set the event <code>CreatedBy</code> property with the same value from the command, as exemplified by the following handler:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateProductCommandHandler</span> : <span class="title">ICommandHandler</span>&lt;<span class="title">CreateProductCommand</span>, <span class="title">CreateProductResult</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ApiDbContext _context;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IMediator _mediator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreateProductCommandHandler</span>(<span class="params">ApiDbContext context, IMediator mediator</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = context;</span><br><span class="line">        _mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;CreateProductResult&gt; <span class="title">HandleAsync</span>(<span class="params">CreateProductCommand cmd, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">await</span> products.AnyAsync(p =&gt; p.Code == cmd.Code, ct))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;Product code &#x27;<span class="subst">&#123;cmd.Code&#125;</span>&#x27; already exists&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> externalId = Guid.NewGuid();</span><br><span class="line">        <span class="keyword">await</span> products.AddAsync(<span class="keyword">new</span> ProductEntity</span><br><span class="line">        &#123;</span><br><span class="line">            ExternalId = externalId,</span><br><span class="line">            Code = cmd.Code,</span><br><span class="line">            Name = cmd.Name,</span><br><span class="line">            Price = cmd.Price</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> _mediator.BroadcastAsync(<span class="keyword">new</span> CreatedProductEvent</span><br><span class="line">        &#123;</span><br><span class="line">            ExternalId = externalId,</span><br><span class="line">            Code = cmd.Code,</span><br><span class="line">            Name = cmd.Name,</span><br><span class="line">            Price = cmd.Price,</span><br><span class="line">            CreatedBy = cmd.CreatedBy  <span class="comment">// use the same value</span></span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CreateProductResult</span><br><span class="line">        &#123;</span><br><span class="line">            Id = externalId</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="The-Audit-Pipeline"><a href="#The-Audit-Pipeline" class="headerlink" title="The Audit Pipeline"></a>The Audit Pipeline</h1><p>Now that we are passing the user information into the mediator we can create the audit pipeline that will have the following behavior when intercepting commands:</p><ol><li>Serialize and insert a new entry into the commands table;</li><li>Add both the command and entry ids into an <code>AsyncLocal&lt;T&gt;</code> scope to be used if an event is broadcast;</li><li>Invoke the next pipe;</li><li>If available, serialize the result, calculate the execution time and update the table entry;</li></ol><p>When intercepting events, which are sent by commands, it will do the following:</p><ol><li>Get the command id from the current <code>AsyncLocal&lt;T&gt;</code> scope;</li><li>Serialize the event and insert a new entry into the events table, referencing the command entry;</li><li>Invoke the next pipe;</li></ol><p>Inside the <code>Pipelines</code> folder, create an <code>AuditPipeline</code> class extending <code>Pipeline</code>. The implementation should be similar to the following:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuditPipeline</span> : <span class="title">Pipeline</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> DbSet&lt;CommandEntity&gt; _commands;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> DbSet&lt;EventEntity&gt; _events;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AuditPipeline</span>(<span class="params">ApiDbContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _commands = context.Set&lt;CommandEntity&gt;();</span><br><span class="line">        _events = context.Set&lt;EventEntity&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">OnCommandAsync</span>&lt;<span class="title">TCommand</span>&gt;(<span class="params">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> command = (<span class="keyword">await</span> _commands.AddAsync(<span class="keyword">new</span> CommandEntity</span><br><span class="line">        &#123;</span><br><span class="line">            ExternalId = cmd.Id,</span><br><span class="line">            Name = <span class="keyword">typeof</span>(TCommand).Name,</span><br><span class="line">            Payload = JsonSerializer.Serialize(cmd),</span><br><span class="line">            Result = <span class="literal">null</span>,</span><br><span class="line">            CreatedOn = cmd.CreatedOn,</span><br><span class="line">            CreatedBy = cmd.CreatedBy,</span><br><span class="line">            ExecutionTime = TimeSpan.Zero</span><br><span class="line">        &#125;, ct)).Entity;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> (CommandScope.Begin(command.ExternalId, command.Id))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> next(cmd, ct);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        command.ExecutionTime = DateTimeOffset.UtcNow - cmd.CreatedOn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TResult</span>&gt; <span class="title">OnCommandAsync</span>&lt;<span class="title">TCommand</span>, <span class="title">TResult</span>&gt;(<span class="params">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> command = (<span class="keyword">await</span> _commands.AddAsync(<span class="keyword">new</span> CommandEntity</span><br><span class="line">        &#123;</span><br><span class="line">            ExternalId = cmd.Id,</span><br><span class="line">            Name = <span class="keyword">typeof</span>(TCommand).Name,</span><br><span class="line">            Payload = JsonSerializer.Serialize(cmd),</span><br><span class="line">            Result = <span class="literal">null</span>,</span><br><span class="line">            CreatedOn = cmd.CreatedOn,</span><br><span class="line">            CreatedBy = cmd.CreatedBy,</span><br><span class="line">            ExecutionTime = TimeSpan.Zero</span><br><span class="line">        &#125;, ct)).Entity;</span><br><span class="line"></span><br><span class="line">        TResult result;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> (CommandScope.Begin(command.ExternalId, command.Id))</span><br><span class="line">        &#123;</span><br><span class="line">            result = <span class="keyword">await</span> next(cmd, ct);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        command.Result = result == <span class="literal">null</span> ? <span class="literal">null</span> : JsonSerializer.Serialize(result);</span><br><span class="line">        command.ExecutionTime = DateTimeOffset.UtcNow - cmd.CreatedOn;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">OnEventAsync</span>&lt;<span class="title">TEvent</span>&gt;(<span class="params">Func&lt;TEvent, CancellationToken, Task&gt; next, TEvent evt, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> _events.AddAsync(<span class="keyword">new</span> EventEntity</span><br><span class="line">        &#123;</span><br><span class="line">            CommandId = CommandScope.Current.Id,</span><br><span class="line">            ExternalId = evt.Id,</span><br><span class="line">            Name = <span class="keyword">typeof</span>(TEvent).Name,</span><br><span class="line">            Payload = JsonSerializer.Serialize(evt),</span><br><span class="line">            CreatedOn = evt.CreatedOn,</span><br><span class="line">            CreatedBy = evt.CreatedBy,</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next(evt, ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title">CommandScope</span> : <span class="title">IDisposable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">CommandScope</span>(<span class="params">Guid externalId, <span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            ExternalId = externalId;</span><br><span class="line">            Id = id;</span><br><span class="line"></span><br><span class="line">            AsyncLocal.Value = <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Guid ExternalId &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            AsyncLocal.Value = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> AsyncLocal&lt;CommandScope&gt; AsyncLocal = <span class="keyword">new</span> AsyncLocal&lt;CommandScope&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> CommandScope Current =&gt; AsyncLocal.Value;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IDisposable <span class="title">Begin</span>(<span class="params">Guid externalId, <span class="built_in">long</span> id</span>)</span> =&gt; <span class="keyword">new</span> CommandScope(externalId, id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>Startup.cs</code> file and register this pipeline to be run after all the existing ones, right before the commands or events are handled.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        services.AddMvc();</span><br><span class="line"></span><br><span class="line">        services.AddSwaggerGen();</span><br><span class="line"></span><br><span class="line">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.UseInMemoryDatabase(<span class="string">&quot;ApiDbContext&quot;</span>).ConfigureWarnings(warn =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// since InMemoryDatabase does not support transactions</span></span><br><span class="line">                <span class="comment">// for test purposes we are going to ignore this exception</span></span><br><span class="line">                warn.Ignore(InMemoryEventId.TransactionIgnoredWarning);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        services.AddMediator(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class="line">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class="line">            o.AddPipeline&lt;ValidationPipeline&gt;();</span><br><span class="line">            o.AddPipeline&lt;TransactionPipeline&gt;();</span><br><span class="line">            o.AddPipeline&lt;AuditPipeline&gt;();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> implementationType <span class="keyword">in</span> <span class="title">typeof</span>(<span class="params">Startup</span>)</span></span><br><span class="line"><span class="function">                .Assembly</span></span><br><span class="line"><span class="function">                .ExportedTypes</span></span><br><span class="line"><span class="function">                .<span class="title">Where</span>(<span class="params">t =&gt; t.IsClass &amp;&amp; !t.IsAbstract</span>))</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> serviceType <span class="keyword">in</span> implementationType</span><br><span class="line">                    .GetInterfaces()</span><br><span class="line">                    .Where(i =&gt; i.IsGenericType &amp;&amp; i.GetGenericTypeDefinition() == <span class="keyword">typeof</span>(IValidator&lt;&gt;)))</span><br><span class="line">                &#123;</span><br><span class="line">                    o.Services.Add(<span class="keyword">new</span> ServiceDescriptor(serviceType, implementationType, ServiceLifetime.Transient));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// or, if using the SimpleSoft.Mediator.Microsoft.Extensions.* pipelines</span></span><br><span class="line">        <span class="comment">//services.AddMediator(o =&gt;</span></span><br><span class="line">        <span class="comment">//&#123;</span></span><br><span class="line">        <span class="comment">//    o.AddPipelineForLogging(options =&gt;</span></span><br><span class="line">        <span class="comment">//    &#123;</span></span><br><span class="line">        <span class="comment">//        options.LogCommandResult = true;</span></span><br><span class="line">        <span class="comment">//        options.LogQueryResult = true;</span></span><br><span class="line">        <span class="comment">//    &#125;);</span></span><br><span class="line">        <span class="comment">//    o.AddPipeline&lt;TimeoutPipeline&gt;();</span></span><br><span class="line">        <span class="comment">//    o.AddPipelineForValidation(options =&gt;</span></span><br><span class="line">        <span class="comment">//    &#123;</span></span><br><span class="line">        <span class="comment">//        options.ValidateCommand = true;</span></span><br><span class="line">        <span class="comment">//        options.ValidateEvent = true;</span></span><br><span class="line">        <span class="comment">//    &#125;);</span></span><br><span class="line">        <span class="comment">//    o.AddPipelineForEFCoreTransaction&lt;ApiDbContext&gt;(options =&gt;</span></span><br><span class="line">        <span class="comment">//    &#123;</span></span><br><span class="line">        <span class="comment">//        options.BeginTransactionOnCommand = true;</span></span><br><span class="line">        <span class="comment">//    &#125;);</span></span><br><span class="line">        <span class="comment">//    o.AddPipeline&lt;AuditPipeline&gt;();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//    o.AddValidatorsFromAssemblyOf&lt;Startup&gt;();</span></span><br><span class="line">        <span class="comment">//    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span></span><br><span class="line">        <span class="comment">//&#125;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Because this pipeline is also serializing all events, the existing handlers for <code>CreatedProductEvent</code>, <code>DeletedProductEvent</code> and <code>UpdatedProductEvent</code> can now either be deleted or stop storing their events into the table to prevent duplicated data:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreatedProductEventHandler</span> : <span class="title">IEventHandler</span>&lt;<span class="title">CreatedProductEvent</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ApiDbContext _context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreatedProductEventHandler</span>(<span class="params">ApiDbContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">HandleAsync</span>(<span class="params">CreatedProductEvent evt, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//await _context.Set&lt;EventEntity&gt;().AddAsync(new EventEntity</span></span><br><span class="line">        <span class="comment">//&#123;</span></span><br><span class="line">        <span class="comment">//    ExternalId = evt.Id,</span></span><br><span class="line">        <span class="comment">//    Name = nameof(CreatedProductEvent),</span></span><br><span class="line">        <span class="comment">//    Payload = JsonSerializer.Serialize(evt),</span></span><br><span class="line">        <span class="comment">//    CreatedOn = evt.CreatedOn,</span></span><br><span class="line">        <span class="comment">//    CreatedBy = evt.CreatedBy</span></span><br><span class="line">        <span class="comment">//&#125;, ct);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="AsyncLocal"><a href="#AsyncLocal" class="headerlink" title="AsyncLocal"></a>AsyncLocal<t></t></h1><p>When comparing the audit pipeline with the previous ones we implemented, the biggest difference is the usage of <code>AsyncLocal&lt;T&gt;</code> to store an instance of the <code>CommandScope</code> class holding both the command external id and the primary key value for the audit entry into the table.</p><p>If you aren’t familiar with this class, it is available since .NET Framework 4.6 and .NET standard 1.3, and was introduced to help sharing global flow state when implementing asynchronous code with Task Parallel Library (TPL). Because TPL relies on the thread pool and, by default, asynchronous code in ASP.NET Core applications can be resumed by any available thread, we can’t rely on mechanisms like the <code>ThreadLocal</code> class to store global state.</p><p>Simply put, the idea of <code>AsyncLocal&lt;T&gt;</code> is to create a static instance that can hold some <code>T</code> value and, as long you use the <code>async</code> and <code>await</code> keywords, the runtime will consider your code execution to be a logical flow, despite asynchronous, and will ensure the value is shared even if the flow has been resumed by a different thread.</p><p>Because we want to share data between the command and event interceptor code, the flow is asynchronous, and since only commands broadcast events, the <code>AsyncLocal&lt;T&gt;</code> class is an elegant solution to prevent changing all the events to include an <code>CommandId</code> property that has to be set on every broadcast.</p><p>As an example, this is usually the solution implemented by some logging frameworks to support the creation of scopes, enabling some information to be written on every log without having to pass it every time, like when the using Microsoft façade <code>Logger.BeginScope(&quot;X:&#123;x&#125; Y:&#123;y&#125;&quot;, x, y)</code>.</p><p>For more details and examples, give a look to the <code>AsyncLocal&lt;T&gt;</code> class <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.asynclocal-1?view=net-8.0">documentation</a>.</p><h1 id="Audits-Controller"><a href="#Audits-Controller" class="headerlink" title="Audits Controller"></a>Audits Controller</h1><p>To make it easier to test and check our system audits, we are going to implement the following endpoint:</p><p>GET &#x2F;audits — search for command audits using some filters (<code>SearchAuditsQuery</code>);<br>GET &#x2F;audits&#x2F;{id} — get a command audit by its unique identifier and all the associated events (<code>GetAuditByIdQuery</code>);</p><p>Inside the <code>Handlers</code> folder create an <code>Audits</code> folder and create the queries for searching or getting an audit by its external id:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SearchAuditsQueryHandler</span> : <span class="title">IQueryHandler</span>&lt;<span class="title">SearchAuditsQuery</span>, <span class="title">IEnumerable</span>&lt;<span class="title">AuditSearchItem</span>&gt;&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IQueryable&lt;CommandEntity&gt; _commands;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SearchAuditsQueryHandler</span>(<span class="params">ApiDbContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _commands = context.Set&lt;CommandEntity&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IEnumerable&lt;AuditSearchItem&gt;&gt; HandleAsync(SearchAuditsQuery query, CancellationToken ct)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> filter = _commands;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(query.FilterQ))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> filterQ = query.FilterQ.Trim();</span><br><span class="line"></span><br><span class="line">            filter = filter.Where(p =&gt;</span><br><span class="line">                p.Name.Contains(filterQ)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> skip = query.Skip ?? <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> take = query.Take ?? <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> filter</span><br><span class="line">            .OrderByDescending(c =&gt; c.CreatedOn)</span><br><span class="line">            .ThenByDescending(c =&gt; c.Id)</span><br><span class="line">            .Skip(skip)</span><br><span class="line">            .Take(take)</span><br><span class="line">            .Select(c =&gt; <span class="keyword">new</span> AuditSearchItem</span><br><span class="line">            &#123;</span><br><span class="line">                Id = c.ExternalId,</span><br><span class="line">                Name = c.Name,</span><br><span class="line">                CreatedOn = c.CreatedOn,</span><br><span class="line">                CreatedBy = c.CreatedBy,</span><br><span class="line">                ExecutionTimeInMs = (<span class="built_in">long</span>) c.ExecutionTime.TotalMilliseconds</span><br><span class="line">            &#125;).ToListAsync(ct);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SearchAuditsQuery</span> : <span class="title">Query</span>&lt;<span class="title">IEnumerable</span>&lt;<span class="title">AuditSearchItem</span>&gt;&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> FilterQ &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span>? Skip &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span>? Take &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuditSearchItem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTimeOffset CreatedOn &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> CreatedBy &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> ExecutionTimeInMs &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GetAuditByIdQueryHandler</span> : <span class="title">IQueryHandler</span>&lt;<span class="title">GetAuditByIdQuery</span>, <span class="title">Audit</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IQueryable&lt;CommandEntity&gt; _commands;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IQueryable&lt;EventEntity&gt; _events;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GetAuditByIdQueryHandler</span>(<span class="params">ApiDbContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _commands = context.Set&lt;CommandEntity&gt;();</span><br><span class="line">        _events = context.Set&lt;EventEntity&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Audit&gt; <span class="title">HandleAsync</span>(<span class="params">GetAuditByIdQuery query, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> command = <span class="keyword">await</span> _commands.SingleOrDefaultAsync(c =&gt; c.ExternalId == query.AuditId, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (command == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;Command audit &#x27;<span class="subst">&#123;query.AuditId&#125;</span>&#x27; not found&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> events = <span class="keyword">await</span> _events.Where(e =&gt; e.CommandId == command.Id).ToListAsync(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Audit</span><br><span class="line">        &#123;</span><br><span class="line">            Id = command.ExternalId,</span><br><span class="line">            Name = command.Name,</span><br><span class="line">            Payload = JsonSerializer.Deserialize&lt;<span class="built_in">dynamic</span>&gt;(command.Payload),</span><br><span class="line">            Result = <span class="built_in">string</span>.IsNullOrWhiteSpace(command.Result)</span><br><span class="line">                ? <span class="literal">null</span></span><br><span class="line">                : JsonSerializer.Deserialize&lt;<span class="built_in">dynamic</span>&gt;(command.Result),</span><br><span class="line">            CreatedOn = command.CreatedOn,</span><br><span class="line">            CreatedBy = command.CreatedBy,</span><br><span class="line">            ExecutionTimeInMs = (<span class="built_in">long</span>) command.ExecutionTime.TotalMilliseconds,</span><br><span class="line">            Events = events.Select(e =&gt; <span class="keyword">new</span> AuditEvent</span><br><span class="line">            &#123;</span><br><span class="line">                Id = e.ExternalId,</span><br><span class="line">                Name = e.Name,</span><br><span class="line">                Payload = JsonSerializer.Deserialize&lt;<span class="built_in">dynamic</span>&gt;(e.Payload),</span><br><span class="line">                CreatedOn = e.CreatedOn</span><br><span class="line">            &#125;).ToList()</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GetAuditByIdQuery</span> : <span class="title">Query</span>&lt;<span class="title">Audit</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid AuditId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Audit</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">object</span> Payload &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">object</span> Result &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTimeOffset CreatedOn &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> CreatedBy &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> ExecutionTimeInMs &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> IEnumerable&lt;AuditEvent&gt; Events &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuditEvent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">object</span> Payload &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTimeOffset CreatedOn &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Inside the <code>Controllers</code> folder create an <code>Audit</code> folder and an <code>AuditController</code> that will use the previous queries:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;audits&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuditsController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IMediator _mediator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AuditsController</span>(<span class="params">IMediator mediator</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpGet</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IEnumerable&lt;AuditSearchItemModel&gt;&gt; SearchAsync([FromQuery] <span class="built_in">string</span> filterQ, [FromQuery] <span class="built_in">int</span>? skip, [FromQuery] <span class="built_in">int</span>? take, CancellationToken ct)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> _mediator.FetchAsync(<span class="keyword">new</span> SearchAuditsQuery</span><br><span class="line">        &#123;</span><br><span class="line">            FilterQ = filterQ,</span><br><span class="line">            Skip = skip,</span><br><span class="line">            Take = take,</span><br><span class="line">            CreatedBy = User.Identity.Name</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result.Select(r =&gt; <span class="keyword">new</span> AuditSearchItemModel</span><br><span class="line">        &#123;</span><br><span class="line">            Id = r.Id,</span><br><span class="line">            Name = r.Name,</span><br><span class="line">            CreatedOn = r.CreatedOn,</span><br><span class="line">            CreatedBy = r.CreatedBy,</span><br><span class="line">            ExecutionTimeInMs = r.ExecutionTimeInMs</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpGet(<span class="string">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;AuditModel&gt; <span class="title">GetByIdAsync</span>(<span class="params">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> _mediator.FetchAsync(<span class="keyword">new</span> GetAuditByIdQuery</span><br><span class="line">        &#123;</span><br><span class="line">            AuditId = id,</span><br><span class="line">            CreatedBy = User.Identity.Name</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AuditModel</span><br><span class="line">        &#123;</span><br><span class="line">            Id = result.Id,</span><br><span class="line">            Name = result.Name,</span><br><span class="line">            Payload = result.Payload,</span><br><span class="line">            Result = result.Result,</span><br><span class="line">            CreatedOn = result.CreatedOn,</span><br><span class="line">            CreatedBy = result.CreatedBy,</span><br><span class="line">            ExecutionTimeInMs = result.ExecutionTimeInMs,</span><br><span class="line">            Events = result.Events.Select(e =&gt; <span class="keyword">new</span> AuditEventModel</span><br><span class="line">            &#123;</span><br><span class="line">                Id = e.Id,</span><br><span class="line">                Name = e.Name,</span><br><span class="line">                Payload = e.Payload,</span><br><span class="line">                CreatedOn = e.CreatedOn</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuditSearchItemModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTimeOffset CreatedOn &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> CreatedBy &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> ExecutionTimeInMs &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuditModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">object</span> Payload &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">object</span> Result &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTimeOffset CreatedOn &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> CreatedBy &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> ExecutionTimeInMs &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> IEnumerable&lt;AuditEventModel&gt; Events &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuditEventModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">object</span> Payload &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTimeOffset CreatedOn &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The project structure should look as follows:</p><img src="/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/02_project_structure_auditing_final.png"><p>Open the Swagger endpoint (ex: <a target="_blank" rel="noopener" href="https://localhost:44380/swagger">https://localhost:44380/swagger</a>) and you should see the audits endpoint:</p><img src="/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/03_swagger_audit.png"><p>Create, update or delete products with the help of Swagger UI and then check if all the commands and events have been properly audited:</p><img src="/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/04_swagger_audit_search.png"><p>And even get the details of a specific audit:</p><img src="/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/05_swagger_audit_get_by_id.png"><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use mediator pipelines to simplify the auditing of user actions without having to replicate code across all commands.</p><p>We also ensured events were always stored before being broadcasted and a reference to the command was kept without adding properties to our POCOs, providing a more clean approach.</p><p>Soon I’ll be explaining how we can inject more specialized interfaces, like the <code>ISender&lt;TCommand&gt;</code>, to make our dependencies more clearer and help with unit testing.</p></div><footer class="article-footer"><a data-url="https://code-corner.dev/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/" data-id="clv2o3ycb0000jojhc24s8bbc" data-title="Auditing with Mediator Pipelines in ASP.NET Core" class="article-share-link"><span class="fa fa-share">Share</span></a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/patterns/" rel="tag">patterns</a></li></ul></footer></div><nav id="article-nav"><a href="/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">Integrating Dapper with Entity Framework Core</div></a><a href="/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Transaction Management With Mediator Pipelines in ASP.NET Core</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/concepts/">concepts</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/performance/">performance</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tutorial/">tutorial</a><span class="category-list-count">9</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dapper/" rel="tag">dapper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/efcore/" rel="tag">efcore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hangfire/" rel="tag">hangfire</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linq/" rel="tag">linq</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/patterns/" rel="tag">patterns</a><span class="tag-list-count">6</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/aspnetcore/" style="font-size:15px">aspnetcore</a> <a href="/tags/csharp/" style="font-size:18.33px">csharp</a> <a href="/tags/dapper/" style="font-size:10px">dapper</a> <a href="/tags/dotnet/" style="font-size:16.67px">dotnet</a> <a href="/tags/dotnetcore/" style="font-size:20px">dotnetcore</a> <a href="/tags/efcore/" style="font-size:11.67px">efcore</a> <a href="/tags/hangfire/" style="font-size:10px">hangfire</a> <a href="/tags/linq/" style="font-size:11.67px">linq</a> <a href="/tags/patterns/" style="font-size:13.33px">patterns</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/06/19/NET-9-ToList-vs-ToArray/">.NET 9 — ToList vs ToArray</a></li><li><a href="/2024/05/25/NET-IAsyncEnumerable-utility-extensions/">.NET — IAsyncEnumerable utility extensions</a></li><li><a href="/2024/04/14/NET-9-%E2%80%94-Exception-handling-performance/">.NET 9 — Exception handling performance</a></li><li><a href="/2024/02/29/NET-Hangfire/">.NET — Hangfire</a></li><li><a href="/2024/02/05/NET-%E2%80%94-LinkedList-vs-ToArray/">.NET — LinkedList vs ToArray</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png"></a><br>All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a><br>&copy; 2024 João Simões<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="/js/jquery-3.6.4.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></div></body></html>