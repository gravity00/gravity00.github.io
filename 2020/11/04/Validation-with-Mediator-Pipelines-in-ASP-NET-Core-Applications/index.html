<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-TQKP5TGHJ8"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TQKP5TGHJ8")</script><title>Validation with Mediator Pipelines in ASP.NET Core Applications | code-corner.dev</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="google-adsense-account" content="ca-pub-4671230649342120"><meta name="description" content="When implementing web applications that manipulate information, there is always the need to validate data sent by the clients, ensuring business rules are properly implemented. Previously I talked abo"><meta property="og:type" content="article"><meta property="og:title" content="Validation with Mediator Pipelines in ASP.NET Core Applications"><meta property="og:url" content="https://code-corner.dev/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/index.html"><meta property="og:site_name" content="code-corner.dev"><meta property="og:description" content="When implementing web applications that manipulate information, there is always the need to validate data sent by the clients, ensuring business rules are properly implemented. Previously I talked abo"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://code-corner.dev/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/00_header.png"><meta property="article:published_time" content="2020-11-04T00:00:00.000Z"><meta property="article:modified_time" content="2024-04-16T17:31:21.768Z"><meta property="article:author" content="João Simões"><meta property="article:tag" content="dotnetcore"><meta property="article:tag" content="aspnetcore"><meta property="article:tag" content="csharp"><meta property="article:tag" content="patterns"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://code-corner.dev/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/00_header.png"><meta name="twitter:creator" content="@JoaoPRSimoes"><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css"><link rel="canonical" href="https://code-corner.dev/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/"><meta name="generator" content="Hexo 7.1.1"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml,sitemap.txt"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">code-corner.dev</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">The place to learn about programming</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/gravity00"><span class="fa fa-github"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://twitter.com/JoaoPRSimoes"><span class="fa fa-twitter"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://joaoprsimoes.medium.com/"><span class="fa fa-medium"></span></a> <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a> <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://code-corner.dev"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-meta"><a href="/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/" class="article-date"><time class="dt-published" datetime="2020-11-04T00:00:00.000Z" itemprop="datePublished">2020-11-04</time></a><div class="article-category"><a class="article-category-link" href="/categories/tutorial/">tutorial</a></div></div><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">Validation with Mediator Pipelines in ASP.NET Core Applications</h1><h2 class="p-name article-subtitle">Validate commands, events or queries with transversal behavior</h2></header><div class="e-content article-entry" itemprop="articleBody"><a href="https://code-corner.dev/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/00_header.png" data-fancybox="gallery" data-caption><img src="https://code-corner.dev/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/00_header.png"></a><p>When implementing web applications that manipulate information, there is always the need to validate data sent by the clients, ensuring business rules are properly implemented.</p><p>Previously I talked about the implementation of <strong>Command Query Responsibility Segregation (CQRS)</strong> and <strong>Event Sourcing (ES)</strong> using a mediator pattern and how to support transversal behavior via pipelines.</p><p>In this article I’m going to demonstrate how validation can be enforced into your commands and events before reaching the handlers, making sure that invalid data will be rejected by the API.</p><p>This approach not only reduces the amount of duplicated code, it also ensures validations won’t be forgotten, unless explicitly stated.</p><hr><h1 id="The-project"><a href="#The-project" class="headerlink" title="The project"></a>The project</h1><p>To make it faster to implement the validation pipeline, I’m going to leverage this example on both of my previous articles, in which we implemented an <a href="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/" title="Mediator Pattern in ASP.NET Core Applications">endpoint to manage products</a> and introduced both a <a href="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/" title="Using Mediator Pipelines in ASP.NET Core Applications">logging and timeout pipelines</a>.</p><p>The source code is available on <a target="_blank" rel="noopener" href="https://github.com/gravity00/IntroductionMediatorCQRS">GitHub</a>.</p><h1 id="The-validations"><a href="#The-validations" class="headerlink" title="The validations"></a>The validations</h1><p>To help us configure the rules we are going to use a very popular and one of my favorites libraries <a target="_blank" rel="noopener" href="https://fluentvalidation.net/">FluentValidation</a> by creating classes implementing the interface <code>IValidator&lt;T&gt;</code>.</p><p>These classes will be added to the dependency injection container and used by the pipeline to validate both the commands and events before reaching the handler.</p><p>Lets start by installing the NuGet <code>FluentValidation</code>:</p><img src="/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/01_nuget_fluentvalidation.png"><p>Create a <code>Validations</code> folder at the project root level, with a subfolder <code>Products</code>.</p><img src="/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/02_project_structure.png"><p>Inside the <code>Products</code> folder create both a validator for <code>CreateProductCommand</code> and <code>CreatedProductEvent</code> by extending the class <code>AbstractValidator&lt;T&gt;</code> (which itself implementes the interface <code>IValidator&lt;T&gt;</code>) and configure some rules in the constructors:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateProductCommandValidator</span> : <span class="title">AbstractValidator</span>&lt;<span class="title">CreateProductCommand</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreateProductCommandValidator</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        RuleFor(e =&gt; e.Code)</span><br><span class="line">            .NotEmpty()</span><br><span class="line">            .Length(<span class="number">8</span>)</span><br><span class="line">            .Matches(<span class="string">&quot;^[0-9a-zA-Z]*$&quot;</span>);</span><br><span class="line"></span><br><span class="line">        RuleFor(e =&gt; e.Name)</span><br><span class="line">            .NotEmpty()</span><br><span class="line">            .MaximumLength(<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">        RuleFor(e =&gt; e.Price)</span><br><span class="line">            .GreaterThanOrEqualTo(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreatedProductEventValidator</span> : <span class="title">AbstractValidator</span>&lt;<span class="title">CreatedProductEvent</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreatedProductEventValidator</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        RuleFor(e =&gt; e.ExternalId)</span><br><span class="line">            .NotEmpty();</span><br><span class="line"></span><br><span class="line">        RuleFor(e =&gt; e.Code)</span><br><span class="line">            .NotEmpty()</span><br><span class="line">            .Length(<span class="number">8</span>)</span><br><span class="line">            .Matches(<span class="string">&quot;^[0-9a-zA-Z]*$&quot;</span>);</span><br><span class="line"></span><br><span class="line">        RuleFor(e =&gt; e.Name)</span><br><span class="line">            .NotEmpty()</span><br><span class="line">            .MaximumLength(<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">        RuleFor(e =&gt; e.Price)</span><br><span class="line">            .GreaterThanOrEqualTo(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Feel free to create validators for all other commands and events, I’m just focusing on these for simplicity. You can also check the <a target="_blank" rel="noopener" href="https://docs.fluentvalidation.net/en/latest/">documentation for supported rules and detailed usage instructions</a>.</p><p>Open the <code>Startup.cs</code> file and register all classes implementing <code>IValidator&lt;T&gt;</code> into the container:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        services.AddMvc();</span><br><span class="line"></span><br><span class="line">        services.AddSwaggerGen();</span><br><span class="line"></span><br><span class="line">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.UseInMemoryDatabase(<span class="string">&quot;ApiDbContext&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        services.AddMediator(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class="line">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class="line">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> implementationType <span class="keyword">in</span> <span class="title">typeof</span>(<span class="params">Startup</span>)</span></span><br><span class="line"><span class="function">            .Assembly</span></span><br><span class="line"><span class="function">            .ExportedTypes</span></span><br><span class="line"><span class="function">            .<span class="title">Where</span>(<span class="params">t =&gt; t.IsClass &amp;&amp; !t.IsAbstract</span>))</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> serviceType <span class="keyword">in</span> implementationType</span><br><span class="line">                .GetInterfaces()</span><br><span class="line">                .Where(i =&gt; i.IsGenericType &amp;&amp; i.GetGenericTypeDefinition() == <span class="keyword">typeof</span>(IValidator&lt;&gt;)))</span><br><span class="line">            &#123;</span><br><span class="line">                services.Add(<span class="keyword">new</span> ServiceDescriptor(serviceType, implementationType, ServiceLifetime.Transient));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="The-pipeline"><a href="#The-pipeline" class="headerlink" title="The pipeline"></a>The pipeline</h1><p>Because for this example we are going to enforce validation only on commands and events, since they either mutate or represent the system state at a given point in time, the pipeline will be implemented as follows:</p><ol><li>Intercept any command or event;</li><li>Resolve a required instance of <code>IValidator&lt;TCommand&gt;</code> or <code>IValidator&lt;TEvent&gt;</code> from the container;</li><li>Invoke the method <code>ValidateAndThrowAsync</code>, failing with a <code>ValidationException</code> if something is invalid;</li></ol><p>Inside the <code>Pipelines</code> folder create a <code>ValidationPipeline</code> class extending <code>Pipeline</code> (because we only need some of the methods):</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ValidationPipeline</span> : <span class="title">Pipeline</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IServiceProvider _provider;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ValidationPipeline</span>(<span class="params">IServiceProvider provider</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _provider = provider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">OnCommandAsync</span>&lt;<span class="title">TCommand</span>&gt;(<span class="params">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> ValidateAndThrowAsync(cmd, ct);</span><br><span class="line">        <span class="keyword">await</span> next(cmd, ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TResult</span>&gt; <span class="title">OnCommandAsync</span>&lt;<span class="title">TCommand</span>, <span class="title">TResult</span>&gt;(<span class="params">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> ValidateAndThrowAsync(cmd, ct);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> next(cmd, ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">OnEventAsync</span>&lt;<span class="title">TEvent</span>&gt;(<span class="params">Func&lt;TEvent, CancellationToken, Task&gt; next, TEvent evt, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> ValidateAndThrowAsync(evt, ct);</span><br><span class="line">        <span class="keyword">await</span> next(evt, ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">ValidateAndThrowAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params">T instance, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> validator = _provider.GetRequiredService&lt;IValidator&lt;T&gt;&gt;();</span><br><span class="line">        <span class="keyword">await</span> validator.ValidateAndThrowAsync(instance, ct);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>Startup.cs</code> file and add the <code>ValidationPipeline</code> at least after the <code>LoggingPipeline</code> ensuring, in case invalid data is submitted, we can still see it in the logs:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">services.AddMediator(o =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class="line">    o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class="line">    o.AddPipeline&lt;ValidationPipeline();</span><br><span class="line">    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>If you now start the server and try to create a product with invalid data you will receive a <code>ValidationException</code>.</p><img src="/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/03_validation_exception.png"><p>Because returning an HTTP 500 due to invalid data would be confusing to the client, lets just finish this example by creating an ASP.NET Core middleware converting this exception into a more appropriate code, like HTTP 422.</p><p>Once again, open the <code>Startup.cs</code> file and register the middleware immediately after the developer exception page, catching this exception and returning HTTP 422 with a more detailed JSON representation:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        app.UseDeveloperExceptionPage();</span><br><span class="line"></span><br><span class="line">        app.Use(<span class="keyword">async</span> (ctx, next) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> next();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (ValidationException e)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> response = ctx.Response;</span><br><span class="line">                <span class="keyword">if</span> (response.HasStarted)</span><br><span class="line">                    <span class="keyword">throw</span>;</span><br><span class="line">                ctx.RequestServices</span><br><span class="line">                    .GetRequiredService&lt;ILogger&lt;Startup&gt;&gt;()</span><br><span class="line">                    .LogWarning(e, <span class="string">&quot;Invalid data has been submitted&quot;</span>);</span><br><span class="line">                response.Clear();</span><br><span class="line">                response.StatusCode = <span class="number">422</span>;</span><br><span class="line">                <span class="keyword">await</span> response.WriteAsync(JsonSerializer.Serialize(<span class="keyword">new</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Message = <span class="string">&quot;Invalid data has been submitted&quot;</span>,</span><br><span class="line">                    ModelState = e.Errors.ToDictionary(error =&gt; error.ErrorCode, error =&gt; error.ErrorMessage)</span><br><span class="line">                &#125;), Encoding.UTF8, ctx.RequestAborted);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        app.UseSwagger();</span><br><span class="line"></span><br><span class="line">        app.UseSwaggerUI(c =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            c.SwaggerEndpoint(<span class="string">&quot;/swagger/v1/swagger.json&quot;</span>, <span class="string">&quot;Mediator ExampleApi V1&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        app.UseRouting();</span><br><span class="line"></span><br><span class="line">        app.UseEndpoints(endpoints =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            endpoints.MapControllers();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Submit invalid data again and a more detailed message should be returned:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /products</span><br><span class="line">&#123;</span><br><span class="line">  &quot;code&quot;: &quot;-123456&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;&quot;,</span><br><span class="line">  &quot;price&quot;: -1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HTTP 422</span><br><span class="line">&#123;</span><br><span class="line">   &quot;Message&quot;:&quot;Invalid data has been submitted&quot;,</span><br><span class="line">   &quot;ModelState&quot;:&#123;</span><br><span class="line">      &quot;ExactLengthValidator&quot;:&quot;&#x27;Code&#x27; must be 8 characters in length. You entered 7 characters.&quot;,</span><br><span class="line">      &quot;RegularExpressionValidator&quot;:&quot;&#x27;Code&#x27; is not in the correct format.&quot;,</span><br><span class="line">      &quot;NotEmptyValidator&quot;:&quot;&#x27;Name&#x27; must not be empty.&quot;,</span><br><span class="line">      &quot;GreaterThanOrEqualValidator&quot;:&quot;&#x27;Price&#x27; must be greater than or equal to &#x27;0&#x27;.&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Speeding-things-up"><a href="#Speeding-things-up" class="headerlink" title="Speeding things up!"></a>Speeding things up!</h1><p>If just like me, you can see yourself using a pipeline for validation in most of your projects, there is already a <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/simplesoft.mediator.microsoft.extensions.validationpipeline">pipeline available via NuGet</a> that should be configurable to most use cases while also providing a simpler way to register the validators into the container.</p><p>Install <code>SimpleSoft.Mediator.Microsoft.Extensions.ValidationPipeline</code> via NuGet:</p><img src="/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/04_nuget_mediator_validation_pipeline.png"><p>Use the extension method <code>AddPipelineForValidation</code> and enforce both command and event validations and use the extension method <code>AddValidatorsFromAssemblyOf</code> to scan for all <code>IValidator&lt;T&gt;</code> classes and register them into the container.</p><p>For the current project, the <code>ConfigureServices</code> method would be similar to the following:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        services.AddMvc();</span><br><span class="line"></span><br><span class="line">        services.AddSwaggerGen();</span><br><span class="line"></span><br><span class="line">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.UseInMemoryDatabase(<span class="string">&quot;ApiDbContext&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        services.AddMediator(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class="line">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class="line">            o.AddPipelineForValidation(options =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                options.ValidateCommand = <span class="literal">true</span>;</span><br><span class="line">                options.ValidateEvent = <span class="literal">true</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            o.AddValidatorsFromAssemblyOf&lt;Startup&gt;();</span><br><span class="line">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use mediator pipelines to ensure that all your commands, events and even queries are initialized with proper data, either implementing your own pipeline or by using the existing <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/simplesoft.mediator.microsoft.extensions.validationpipeline">ValidationPipeline</a> NuGet.</p><p>I also made an article about <a href="/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/" title="Transaction Management With Mediator Pipelines in ASP.NET Core">transaction management with pipelines</a>, you may also find it helpful.</p></div><footer class="article-footer"><a data-url="https://code-corner.dev/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/" data-id="clv2o3yd4003ajojhhrc5gfv9" data-title="Validation with Mediator Pipelines in ASP.NET Core Applications" class="article-share-link"><span class="fa fa-share">Share</span></a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/patterns/" rel="tag">patterns</a></li></ul></footer></div><nav id="article-nav"><a href="/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">Transaction Management With Mediator Pipelines in ASP.NET Core</div></a><a href="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Using Mediator Pipelines in ASP.NET Core Applications</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/concepts/">concepts</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/performance/">performance</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tutorial/">tutorial</a><span class="category-list-count">9</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dapper/" rel="tag">dapper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/efcore/" rel="tag">efcore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hangfire/" rel="tag">hangfire</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linq/" rel="tag">linq</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/patterns/" rel="tag">patterns</a><span class="tag-list-count">6</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/aspnetcore/" style="font-size:16.67px">aspnetcore</a> <a href="/tags/csharp/" style="font-size:18.33px">csharp</a> <a href="/tags/dapper/" style="font-size:10px">dapper</a> <a href="/tags/dotnet/" style="font-size:16.67px">dotnet</a> <a href="/tags/dotnetcore/" style="font-size:20px">dotnetcore</a> <a href="/tags/efcore/" style="font-size:13.33px">efcore</a> <a href="/tags/hangfire/" style="font-size:10px">hangfire</a> <a href="/tags/linq/" style="font-size:11.67px">linq</a> <a href="/tags/patterns/" style="font-size:15px">patterns</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/04/14/NET-9-%E2%80%94-Exception-handling-performance/">.NET 9 — Exception handling performance</a></li><li><a href="/2024/02/29/NET-Hangfire/">.NET - Hangfire</a></li><li><a href="/2024/02/05/NET-%E2%80%94-LinkedList-vs-ToArray/">.NET — LinkedList vs ToArray</a></li><li><a href="/2024/01/19/NET-%E2%80%94-TaskCompletionSource-and-CancellationTokenSource/">.NET — TaskCompletionSource and CancellationTokenSource</a></li><li><a href="/2024/01/08/Dispose-pattern-in-NET/">Dispose pattern in .NET</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png"></a><br>All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a><br>&copy; 2024 João Simões<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="/js/jquery-3.6.4.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></div></body></html>