<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-TQKP5TGHJ8"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TQKP5TGHJ8")</script><title>Mediator Pattern in ASP.NET Core Applications | code-corner.dev</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="google-adsense-account" content="ca-pub-4671230649342120"><meta name="description" content="For the last few years, Command Query Responsibility Segregation (CQRS) and Event Sourcing (ES) emerged as patterns that can help implement large scale systems, with some risky complexity, by having d"><meta property="og:type" content="article"><meta property="og:title" content="Mediator Pattern in ASP.NET Core Applications"><meta property="og:url" content="https://code-corner.dev/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/index.html"><meta property="og:site_name" content="code-corner.dev"><meta property="og:description" content="For the last few years, Command Query Responsibility Segregation (CQRS) and Event Sourcing (ES) emerged as patterns that can help implement large scale systems, with some risky complexity, by having d"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://code-corner.dev/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/00_header.png"><meta property="article:published_time" content="2020-10-28T00:00:00.000Z"><meta property="article:modified_time" content="2024-04-16T17:31:21.720Z"><meta property="article:author" content="João Simões"><meta property="article:tag" content="dotnetcore"><meta property="article:tag" content="aspnetcore"><meta property="article:tag" content="csharp"><meta property="article:tag" content="patterns"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://code-corner.dev/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/00_header.png"><meta name="twitter:creator" content="@JoaoPRSimoes"><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css"><link rel="canonical" href="https://code-corner.dev/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/"><meta name="generator" content="Hexo 7.1.1"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml,sitemap.txt"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">code-corner.dev</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">The place to learn about programming</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/gravity00"><span class="fa fa-github"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://twitter.com/JoaoPRSimoes"><span class="fa fa-twitter"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://joaoprsimoes.medium.com/"><span class="fa fa-medium"></span></a> <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a> <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://code-corner.dev"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-Mediator-Pattern-in-ASP-NET-Core-Applications" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-meta"><a href="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/" class="article-date"><time class="dt-published" datetime="2020-10-28T00:00:00.000Z" itemprop="datePublished">2020-10-28</time></a><div class="article-category"><a class="article-category-link" href="/categories/tutorial/">tutorial</a></div></div><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">Mediator Pattern in ASP.NET Core Applications</h1><h2 class="p-name article-subtitle">Send commands, fetch queries, and broadcast events using a mediator pattern for CQRS+ES</h2></header><div class="e-content article-entry" itemprop="articleBody"><a href="https://code-corner.dev/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/00_header.png" data-fancybox="gallery" data-caption><img src="https://code-corner.dev/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/00_header.png"></a><p>For the last few years, <strong>Command Query Responsibility Segregation (CQRS)</strong> and <strong>Event Sourcing (ES)</strong> emerged as patterns that can help implement large scale systems, with some risky complexity, by having different models to read or mutate data while also using events as a single source of truth.</p><p>Since there are already great articles explaining <a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CQRS.html"><strong>CQRS</strong></a> or <a target="_blank" rel="noopener" href="https://martinfowler.com/eaaDev/EventSourcing.html"><strong>ES</strong></a> in great depth, I’m going to focus and show how you can decouple your application layers by only knowing POCOs and a mediator instance from <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/simplesoft.mediator">SimpleSoft.Mediator</a>.</p><p>Remember that, even if you are not using <strong>CQRS</strong> or <strong>ES</strong> to its full extend, just by ensuring a logical model segregation inside the project can make your life easier in the long run, even when implementing a simple <strong>Backend for Frontend (BFF)</strong> or a <strong>minimum viable product (MVP)</strong>.</p><h1 id="Commands-Queries-Events-Handlers-and-Mediator"><a href="#Commands-Queries-Events-Handlers-and-Mediator" class="headerlink" title="Commands, Queries, Events, Handlers and Mediator"></a>Commands, Queries, Events, Handlers and Mediator</h1><p>Before showing some code, lets make a simple review of some core concepts about these patterns and the library we are going to use:</p><ul><li><strong>Commands</strong> - each action intended to change the system state, by creating, updating or deleting information, should be represented by a class implementing either <code>ICommand</code> or <code>ICommand&lt;TResult&gt;</code>, if you are using the mediator just for in-process decoupling and want to return a result synchronously. Examples: <code>CreateProductCommand</code> or <code>DeleteUserCommand</code>;</li><li><strong>Queries</strong> - classes implementing <code>IQuery&lt;TResult&gt;</code> represent data reads that shouldn’t change the system state or else they must be considered commands. Examples: <code>GetProductByIdQuery</code> or <code>SearchUsersQuery</code>;</li><li><strong>Events</strong> — representing system changes over time, these classes implement <code>IEvent</code>. Examples: <code>ProductCreatedEvent</code> or <code>UpdatedUserEmailEvent</code>;</li><li><strong>Handlers</strong> — responsible for receiving the commands (<code>ICommandHandler</code>), queries (<code>IQueryHandler</code>) or events (<code>IEventHandler</code>), they implement the business behavior to be run. Examples: <code>CreateProductCommandHandler</code> or <code>GetProductByIdQueryHandler</code>;</li><li><strong>Mediator</strong> — decouples the caller from the executor exposing generic methods to send commands, fetch queries or broadcast events, being responsible for finding the correct handler (or handlers, in case of an event) and is represented by the interface <code>IMediator</code>;</li></ul><p>I also made articles <a href="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/" title="Using Mediator Pipelines in ASP.NET Core Applications">explaining how pipelines work</a>, how to enforce <a href="/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/" title="Validation with Mediator Pipelines in ASP.NET Core Applications">validations</a>, how to <a href="/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/" title="Transaction Management With Mediator Pipelines in ASP.NET Core">manage transactions</a> and how to <a href="/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/" title="Auditing with Mediator Pipelines in ASP.NET Core">audit user actions</a>.</p><hr><h1 id="The-project"><a href="#The-project" class="headerlink" title="The project"></a>The project</h1><p>The source code for this article can be found on <a target="_blank" rel="noopener" href="https://github.com/gravity00/IntroductionMediatorCQRS">GitHub</a>.</p><p>Start by opening Visual Studio and creating an <strong>ASP.NET Core 3.1 Web Application</strong> with a name and at any location.</p><img src="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/configure-project.png"><p>Choose an empty project since this is just a demo.</p><img src="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/configure-project-empty.png"><p>Install the Nuget <code>Swashbuckle.AspNetCore</code> so we can use Swagger to test the API:</p><img src="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/configure-project-nuget-swagger.png"><p>Open the file <code>Startup.cs</code> and configure both MVC and Swagger, making it easier to test our web API.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        services.AddMvc();</span><br><span class="line"></span><br><span class="line">        services.AddSwaggerGen();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        app.UseDeveloperExceptionPage();</span><br><span class="line"></span><br><span class="line">        app.UseSwagger();</span><br><span class="line"></span><br><span class="line">        app.UseSwaggerUI(c =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            c.SwaggerEndpoint(<span class="string">&quot;/swagger/v1/swagger.json&quot;</span>, <span class="string">&quot;Mediator ExampleApi V1&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        app.UseRouting();</span><br><span class="line"></span><br><span class="line">        app.UseEndpoints(endpoints =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            endpoints.MapControllers();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="The-web-API"><a href="#The-web-API" class="headerlink" title="The web API"></a>The web API</h1><p>Since the objective of this article is to show the mediator pattern, a simple endpoint to manage products should be enough:</p><ul><li>GET &#x2F;products — search for products using some filters;</li><li>GET &#x2F;products&#x2F;{id} — get a product by its unique identifier;</li><li>POST &#x2F;products — create a product;</li><li>PUT &#x2F;products&#x2F;{id} — update a product by its unique identifier;</li><li>DELETE &#x2F;products&#x2F;{id} — delete a product by its unique identifier;</li></ul><p>Create a <code>Controllers</code> folder with another <code>Products</code> folder inside, a <code>ProductsController</code> and the following models:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;products&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductsController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">HttpGet</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IEnumerable&lt;ProductModel&gt;&gt; SearchAsync([FromQuery] <span class="built_in">string</span> filterQ, [FromQuery] <span class="built_in">int</span>? skip, [FromQuery] <span class="built_in">int</span>? take, CancellationToken ct)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpGet(<span class="string">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ProductModel&gt; <span class="title">GetByIdAsync</span>(<span class="params">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpPost</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;CreateProductResultModel&gt; <span class="title">CreateAsync</span>(<span class="params">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpPut(<span class="string">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">UpdateAsync</span>(<span class="params">[FromRoute] Guid id, [FromBody] UpdateProductModel model, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpDelete(<span class="string">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DeleteAsync</span>(<span class="params">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateProductModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Code &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateProductResultModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Code &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UpdateProductModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Code &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The project should look as follows:</p><img src="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/web-api-project-structure.png"><p>Open the Swagger endpoint (ex: <a target="_blank" rel="noopener" href="https://localhost:44380/swagger/index.html">https://localhost:44380/swagger/index.html</a>) and you should see your products endpoint with all the actions:</p><img src="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/web-api-swagger.png"><h2 id="The-database-model"><a href="#The-database-model" class="headerlink" title="The database model"></a>The database model</h2><p>For demo purposes we are going to use <strong>Entity Framework Core</strong> with data stored in-memory.</p><p>Install the Nuget <code>Microsoft.EntityFrameworkCore.InMemory</code>:</p><img src="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/database-model-nuget-ef-core-inmemory.png"><p>Create a <code>Database</code> folder, the following database context and entities for products and events, to store both the business data and mutations history:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ApiDbContext</span> : <span class="title">DbContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApiDbContext</span>(<span class="params">DbContextOptions&lt;ApiDbContext&gt; options</span>) : <span class="title">base</span>(<span class="params">options</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder builder</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnModelCreating(builder);</span><br><span class="line"></span><br><span class="line">        builder.Entity&lt;ProductEntity&gt;(cfg =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            cfg.HasKey(e =&gt; e.Id);</span><br><span class="line">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class="line">            cfg.HasIndex(e =&gt; e.Code).IsUnique();</span><br><span class="line">            cfg.Property(e =&gt; e.ExternalId)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.Code)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .HasMaxLength(<span class="number">8</span>);</span><br><span class="line">            cfg.Property(e =&gt; e.Name)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .HasMaxLength(<span class="number">128</span>);</span><br><span class="line">            cfg.Property(e =&gt; e.Price)</span><br><span class="line">                .IsRequired();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        builder.Entity&lt;EventEntity&gt;(cfg =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            cfg.HasKey(e =&gt; e.Id);</span><br><span class="line">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class="line">            cfg.HasIndex(e =&gt; e.CreatedOn);</span><br><span class="line">            cfg.Property(e =&gt; e.Name)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .HasMaxLength(<span class="number">128</span>);</span><br><span class="line">            cfg.Property(e =&gt; e.Payload)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.CreatedOn)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.CreatedBy)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .HasMaxLength(<span class="number">128</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> Guid ExternalId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Payload &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTimeOffset CreatedOn &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> CreatedBy &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> Guid ExternalId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Code &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>Startup.cs</code> file and add the context into the container as an in-memory database:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    o.UseInMemoryDatabase(<span class="string">&quot;ApiDbContext&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>The project should look as follows:</p><img src="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/database-model-project-structure.png"><h1 id="The-mediator"><a href="#The-mediator" class="headerlink" title="The mediator"></a>The mediator</h1><p>Now that we have created the demo endpoint, models and database, its time to configure the mediator.</p><p>Install the Nuget <code>SimpleSoft.Mediator.Microsoft.Extensions</code> which is a specialized package for projects using <code>Microsoft.Extensions.*</code>:</p><img src="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/mediator-nuget.png"><p>Open the <code>Startup.cs</code> file and add the mediator into the container, scanning the current assembly for all classes implementing <code>ICommandHandler</code>, <code>IQueryHandler</code> and <code>IEventHandler</code>:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">services.AddMediator(o =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Open the <code>ProductsController.cs</code> file and inject into the constructor the <code>IMediator</code> instance:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> IMediator _mediator;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ProductsController</span>(<span class="params">IMediator mediator</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _mediator = mediator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="The-handlers"><a href="#The-handlers" class="headerlink" title="The handlers"></a>The handlers</h1><p>We now have everything we need to start implementing the business logic.</p><p>To keep it simple, we are not going to use the mediator pipelines, only focusing on commands, queries, events and their handlers. As stated before, I made <a href="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/" title="Using Mediator Pipelines in ASP.NET Core Applications">some articles more specific for those use cases</a>.</p><p>Start by creating a folder named <code>Handlers</code> with another inside <code>Products</code> in which we are going to put our POCOs and their handlers.</p><p><em>As a note, remember this is a demo article and this project structure <strong>should not be seen as a valid way to organize your solution</strong> in your private projects. Commands, queries, events and their handlers should be, at minimum, in different folders.</em></p><h2 id="CreateProductComand"><a href="#CreateProductComand" class="headerlink" title="CreateProductComand"></a>CreateProductComand</h2><p>We need data so lets create a command that allows that and will be sent when a request for POST &#x2F;products is received.</p><p>Create a class <code>CreateProductResult</code> that will be returned by the handler with the product unique identifier and a <code>CreateProductCommand</code>, implementing the class <code>Command&lt;CreateProductResult&gt;</code>:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateProductCommand</span> : <span class="title">Command</span>&lt;<span class="title">CreateProductResult</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Code &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateProductResult</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>ProductsController.cs</code> file and inside the method <code>CreateAsync</code> send the command into the mediator and map its result:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;products&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductsController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IMediator _mediator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProductsController</span>(<span class="params">IMediator mediator</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpPost</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;CreateProductResultModel&gt; <span class="title">CreateAsync</span>(<span class="params">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> _mediator.SendAsync(<span class="keyword">new</span> CreateProductCommand</span><br><span class="line">        &#123;</span><br><span class="line">            Code = model.Code,</span><br><span class="line">            Name = model.Name,</span><br><span class="line">            Price = model.Price</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CreateProductResultModel</span><br><span class="line">        &#123;</span><br><span class="line">            Id = result.Id</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If we now invoked the endpoint, we would receive an exception saying that no <code>ICommandHandler&lt;CreateProductCommand, CreateProductResult&gt;</code> was found by the container.</p><p>We will fix that by creating the class <code>CreateProductCommandHandler</code> with the business logic for this action. For this demo, an <code>InvalidOperationException</code> with a custom message will be thrown when a duplicated code is received:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateProductCommandHandler</span> : <span class="title">ICommandHandler</span>&lt;<span class="title">CreateProductCommand</span>, <span class="title">CreateProductResult</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ApiDbContext _context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreateProductCommandHandler</span>(<span class="params">ApiDbContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;CreateProductResult&gt; <span class="title">HandleAsync</span>(<span class="params">CreateProductCommand cmd, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">await</span> products.AnyAsync(p =&gt; p.Code == cmd.Code, ct))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;Product code &#x27;<span class="subst">&#123;cmd.Code&#125;</span>&#x27; already exists&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> externalId = Guid.NewGuid();</span><br><span class="line">        <span class="keyword">await</span> products.AddAsync(<span class="keyword">new</span> ProductEntity</span><br><span class="line">        &#123;</span><br><span class="line">            ExternalId = externalId,</span><br><span class="line">            Code = cmd.Code,</span><br><span class="line">            Name = cmd.Name,</span><br><span class="line">            Price = cmd.Price</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> _context.SaveChangesAsync(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CreateProductResult</span><br><span class="line">        &#123;</span><br><span class="line">            Id = externalId</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If you now try to create a product using the Swagger endpoint, you will receive the response with the unique identifier or an internal server error indicating a duplicated code.</p><p>The project should look as follows:</p><img src="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/handlers-project-structure-01.png"><h2 id="GetProductByIdQuery"><a href="#GetProductByIdQuery" class="headerlink" title="GetProductByIdQuery"></a>GetProductByIdQuery</h2><p>Time to return a product when a GET &#x2F;products&#x2F;:id is received by the web API.</p><p>Inside the <code>Handlers/Products</code> folder, create a <code>Product</code>, the <code>GetProductByIdQuery</code> and its corresponding handler, <code>GetProductByIdQueryHandler</code>. Like in the previous handler, for this demo, we are going to throw an <code>InvalidOperationException</code> if the id is unknown:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GetProductByIdQuery</span> : <span class="title">Query</span>&lt;<span class="title">Product</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid ProductId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Code &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GetProductByIdQueryHandler</span> : <span class="title">IQueryHandler</span>&lt;<span class="title">GetProductByIdQuery</span>, <span class="title">Product</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IQueryable&lt;ProductEntity&gt; _products;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GetProductByIdQueryHandler</span>(<span class="params">ApiDbContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _products = context.Set&lt;ProductEntity&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Product&gt; <span class="title">HandleAsync</span>(<span class="params">GetProductByIdQuery query, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> product = <span class="keyword">await</span> _products.SingleOrDefaultAsync(p =&gt; p.ExternalId == query.ProductId, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (product == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;Product &#x27;<span class="subst">&#123;query.ProductId&#125;</span>&#x27; not found&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Product</span><br><span class="line">        &#123;</span><br><span class="line">            Id = product.ExternalId,</span><br><span class="line">            Code = product.Code,</span><br><span class="line">            Name = product.Name,</span><br><span class="line">            Price = product.Price</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>ProductsController.cs</code> file and inside the method <code>GetByIdAsync</code> fetch the query from the mediator and map its result:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;products&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductsController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IMediator _mediator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProductsController</span>(<span class="params">IMediator mediator</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpGet(<span class="string">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ProductModel&gt; <span class="title">GetByIdAsync</span>(<span class="params">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> _mediator.FetchAsync(<span class="keyword">new</span> GetProductByIdQuery</span><br><span class="line">        &#123;</span><br><span class="line">            ProductId = id</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProductModel</span><br><span class="line">        &#123;</span><br><span class="line">            Id = result.Id,</span><br><span class="line">            Code = result.Code,</span><br><span class="line">            Name = result.Name,</span><br><span class="line">            Price = result.Price</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If you now try to get a product using the Swagger endpoint, you will receive the product or an internal server error indicating an unknown identifier.</p><h2 id="CreatedProductEvent"><a href="#CreatedProductEvent" class="headerlink" title="CreatedProductEvent"></a>CreatedProductEvent</h2><p>Finally, we are going to create an event that will be broadcast when a product is successfully created.</p><p>Just like the previous ones, create a <code>CreateProductEvent</code> and the handler <code>CreateProductEventHandler</code> that will serialize and store it into the events table.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreatedProductEvent</span> : <span class="title">Event</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid ExternalId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Code &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreatedProductEventHandler</span> : <span class="title">IEventHandler</span>&lt;<span class="title">CreatedProductEvent</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ApiDbContext _context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreatedProductEventHandler</span>(<span class="params">ApiDbContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">HandleAsync</span>(<span class="params">CreatedProductEvent evt, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> _context.Set&lt;EventEntity&gt;().AddAsync(<span class="keyword">new</span> EventEntity</span><br><span class="line">        &#123;</span><br><span class="line">            ExternalId = evt.Id,</span><br><span class="line">            Name = <span class="keyword">nameof</span>(CreatedProductEvent),</span><br><span class="line">            Payload = JsonSerializer.Serialize(evt),</span><br><span class="line">            CreatedOn = evt.CreatedOn,</span><br><span class="line">            CreatedBy = evt.CreatedBy</span><br><span class="line">        &#125;, ct);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>CreateProductCommandHandler</code> file, inject the <code>IMediator</code> instance and broadcast the event before saving flushing all changes into the database:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateProductCommandHandler</span> : <span class="title">ICommandHandler</span>&lt;<span class="title">CreateProductCommand</span>, <span class="title">CreateProductResult</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ApiDbContext _context;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IMediator _mediator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreateProductCommandHandler</span>(<span class="params">ApiDbContext context, IMediator mediator</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = context;</span><br><span class="line">        _mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;CreateProductResult&gt; <span class="title">HandleAsync</span>(<span class="params">CreateProductCommand cmd, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">await</span> products.AnyAsync(p =&gt; p.Code == cmd.Code, ct))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;Product code &#x27;<span class="subst">&#123;cmd.Code&#125;</span>&#x27; already exists&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> externalId = Guid.NewGuid();</span><br><span class="line">        <span class="keyword">await</span> products.AddAsync(<span class="keyword">new</span> ProductEntity</span><br><span class="line">        &#123;</span><br><span class="line">            ExternalId = externalId,</span><br><span class="line">            Code = cmd.Code,</span><br><span class="line">            Name = cmd.Name,</span><br><span class="line">            Price = cmd.Price</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> _mediator.BroadcastAsync(<span class="keyword">new</span> CreatedProductEvent</span><br><span class="line">        &#123;</span><br><span class="line">            ExternalId = externalId,</span><br><span class="line">            Code = cmd.Code,</span><br><span class="line">            Name = cmd.Name,</span><br><span class="line">            Price = cmd.Price</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> _context.SaveChangesAsync(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CreateProductResult</span><br><span class="line">        &#123;</span><br><span class="line">            Id = externalId</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The project should look as follows:</p><img src="/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/handlers-project-structure-02.png"><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use the mediator to implement the <strong>CQRS</strong> and <strong>ES</strong> patterns even if you are implementing an <strong>MVP</strong> and can’t spend much time thinking about the architecture but you still want something that can be maintained and extended for some time.</p><p>Soon I’ll be explaining more advanced scenarios, like using the mediator pipeline to validate commands before reaching the handler, managing database transactions or even implementing transversal auditing into you application.</p></div><footer class="article-footer"><a data-url="https://code-corner.dev/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/" data-id="clv2o3ycl000ajojh9ny958ag" data-title="Mediator Pattern in ASP.NET Core Applications" class="article-share-link"><span class="fa fa-share">Share</span></a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/patterns/" rel="tag">patterns</a></li></ul></footer></div><nav id="article-nav"><a href="/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">Using Mediator Pipelines in ASP.NET Core Applications</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/concepts/">concepts</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/performance/">performance</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tutorial/">tutorial</a><span class="category-list-count">9</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dapper/" rel="tag">dapper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/efcore/" rel="tag">efcore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hangfire/" rel="tag">hangfire</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linq/" rel="tag">linq</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/patterns/" rel="tag">patterns</a><span class="tag-list-count">6</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/aspnetcore/" style="font-size:16.67px">aspnetcore</a> <a href="/tags/csharp/" style="font-size:18.33px">csharp</a> <a href="/tags/dapper/" style="font-size:10px">dapper</a> <a href="/tags/dotnet/" style="font-size:16.67px">dotnet</a> <a href="/tags/dotnetcore/" style="font-size:20px">dotnetcore</a> <a href="/tags/efcore/" style="font-size:13.33px">efcore</a> <a href="/tags/hangfire/" style="font-size:10px">hangfire</a> <a href="/tags/linq/" style="font-size:11.67px">linq</a> <a href="/tags/patterns/" style="font-size:15px">patterns</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/04/14/NET-9-%E2%80%94-Exception-handling-performance/">.NET 9 — Exception handling performance</a></li><li><a href="/2024/02/29/NET-Hangfire/">.NET - Hangfire</a></li><li><a href="/2024/02/05/NET-%E2%80%94-LinkedList-vs-ToArray/">.NET — LinkedList vs ToArray</a></li><li><a href="/2024/01/19/NET-%E2%80%94-TaskCompletionSource-and-CancellationTokenSource/">.NET — TaskCompletionSource and CancellationTokenSource</a></li><li><a href="/2024/01/08/Dispose-pattern-in-NET/">Dispose pattern in .NET</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png"></a><br>All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a><br>&copy; 2024 João Simões<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="/js/jquery-3.6.4.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></div></body></html>