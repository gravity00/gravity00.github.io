<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-TQKP5TGHJ8"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TQKP5TGHJ8")</script><title>Dispose pattern in .NET | code-corner.dev</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="google-adsense-account" content="ca-pub-4671230649342120"><meta name="description" content="When working with .NET, you’ll often hear about the garbage collector and how it manages the allocation and release the application’s memory from the managed heap, making our life easier. This is true"><meta property="og:type" content="article"><meta property="og:title" content="Dispose pattern in .NET"><meta property="og:url" content="https://code-corner.dev/2024/01/08/Dispose-pattern-in-NET/index.html"><meta property="og:site_name" content="code-corner.dev"><meta property="og:description" content="When working with .NET, you’ll often hear about the garbage collector and how it manages the allocation and release the application’s memory from the managed heap, making our life easier. This is true"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://code-corner.dev/2024/01/08/Dispose-pattern-in-NET/00_header.png"><meta property="article:published_time" content="2024-01-08T00:00:00.000Z"><meta property="article:modified_time" content="2024-04-16T17:31:21.704Z"><meta property="article:author" content="João Simões"><meta property="article:tag" content="dotnetcore"><meta property="article:tag" content="csharp"><meta property="article:tag" content="dotnet"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://code-corner.dev/2024/01/08/Dispose-pattern-in-NET/00_header.png"><meta name="twitter:creator" content="@JoaoPRSimoes"><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css"><link rel="canonical" href="https://code-corner.dev/2024/01/08/Dispose-pattern-in-NET/"><meta name="generator" content="Hexo 7.1.1"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml,sitemap.txt"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">code-corner.dev</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">The place to learn about programming</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/gravity00"><span class="fa fa-github"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://twitter.com/JoaoPRSimoes"><span class="fa fa-twitter"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://joaoprsimoes.medium.com/"><span class="fa fa-medium"></span></a> <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a> <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://code-corner.dev"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-Dispose-pattern-in-NET" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-meta"><a href="/2024/01/08/Dispose-pattern-in-NET/" class="article-date"><time class="dt-published" datetime="2024-01-08T00:00:00.000Z" itemprop="datePublished">2024-01-08</time></a><div class="article-category"><a class="article-category-link" href="/categories/concepts/">concepts</a></div></div><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">Dispose pattern in .NET</h1><h2 class="p-name article-subtitle">Implementing IDisposable and IAsyncDisposable interfaces</h2></header><div class="e-content article-entry" itemprop="articleBody"><a href="https://code-corner.dev/2024/01/08/Dispose-pattern-in-NET/00_header.png" data-fancybox="gallery" data-caption><img src="https://code-corner.dev/2024/01/08/Dispose-pattern-in-NET/00_header.png"></a><p>When working with .NET, you’ll often hear about the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/">garbage collector</a> and how it manages the allocation and release the application’s memory from the managed heap, making our life easier.</p><p>This is true for the majority of objects but sometimes we have to work with unmanaged resources — files, network or database connections — that we must explicitly release since the garbage collector doesn’t know how to do the cleanup for us, despite being able to track the object that encapsulates the unmanaged resource.</p><p>To help preventing memory leaks, .NET provides a simple and standard way to cleanup unmanaged resources called <strong>dispose pattern</strong>, which consists in implementing the <code>IDisposable</code> interface and calling Dispose method when resources aren’t needed, which is usually done via the <code>using</code> keyword.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> file = File.OpenText(filePath))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> fileContent = file.ReadToEnd();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// equivalent code</span></span><br><span class="line"><span class="keyword">var</span> file = File.OpenText(filePath)</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> fileContent = file.ReadToEnd();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span></span><br><span class="line">&#123;</span><br><span class="line">    file.Dispose();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>When .NET Core 3.0 was released, Microsoft introduced the interface <code>IAsyncDisposable</code> to allow for asynchronous cleanup operations by calling the <code>DisposeAsync</code> method, usually done with <code>await using</code> keywords.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="keyword">using</span> (<span class="keyword">var</span> x = <span class="keyword">new</span> SomeAsyncDisposableClass())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// do stuff</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// equivalent code</span></span><br><span class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> SomeAsyncDisposableClass();</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// do stuff</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> x.DisposeAsync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If a class implements <code>IAsyncDisposable</code> it’s usually a good practice to also implement <code>IDisposable</code> despite not being a requirement. Not all code runs asynchronously, so this ensures the class is ready for both scenarios.</p><p>In this article I’m going to demonstrate and explain step by step how to properly implement the <strong>dispose pattern</strong> using both <code>IDisposable</code> and <code>IAsyncDisposable</code> interfaces.</p><h1 id="Example-scenario"><a href="#Example-scenario" class="headerlink" title="Example scenario"></a>Example scenario</h1><p>To use as an example, we are going to implement a class that wraps SQL Server connections and uses Dapper to simplify mappings and every time someone queries the database it will write the SQL instruction to the log. This provides a simple example of a class that holds both managed and unmanaged resources that can also be disposed asynchronously — SQL Server network connection.</p><p>The class without any disposable implementations:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlServerQueryRunner</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ILogger&lt;SqlServerQueryRunner&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> SqlConnection _connection;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SqlServerQueryRunner</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        ILogger&lt;SqlServerQueryRunner&gt; logger,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">string</span> connectionString</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ArgumentNullException.ThrowIfNull(logger);</span><br><span class="line">        ArgumentNullException.ThrowIfNull(connectionString);</span><br><span class="line"></span><br><span class="line">        _logger = logger;</span><br><span class="line">        _connection = <span class="keyword">new</span> SqlConnection(connectionString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">ValueTask</span>&lt;<span class="title">IEnumerable</span>&lt;<span class="title">T</span>&gt;&gt; <span class="title">QueryAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params">CancellationToken ct, <span class="built_in">string</span> sql, <span class="built_in">object</span> parameters = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Querying database: &#123;Sql&#125;&quot;</span>, sql);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// using Dapper for simplicity</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> _connection.QueryAsync&lt;T&gt;(<span class="keyword">new</span> CommandDefinition(</span><br><span class="line">            sql,</span><br><span class="line">            parameters,</span><br><span class="line">            cancellationToken: ct</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>As you can see, this class receives a connection string and creates a SQL Server connection. Because this class is the owner of the <code>SqlConnection</code> instance, it must dispose it or else resources won’t be released.</p><h1 id="IDisposable-interface"><a href="#IDisposable-interface" class="headerlink" title="IDisposable interface"></a>IDisposable interface</h1><p>Implement the <code>IDisposable</code> interface by disposing unmanaged resources inside the <code>Dispose</code> method, in this case the SQL Server connection:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlServerQueryRunner</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ILogger&lt;SqlServerQueryRunner&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> SqlConnection _connection;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _connection.Dispose();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This code looks good and will work as expected, but there are some scenarios to consider:</p><ol><li><strong>Will the class be sealed?</strong> If not, we must provide a way for extenders to cleanup their unmanaged resources, if any;</li><li><strong>Do I want to a safeguard from forgetting to dispose?</strong> If yes, we must implement a class finalizer that will try to cleanup resources when garbage collected;</li></ol><p>Both scenarios are solved by creating a virtual Dispose method, to be overridden by extenders, that receives a flag to indicate if it’s being called from a dispose or finalizer.</p><p>This usually means resources are explicitly disposed only when disposing, otherwise references are cleared and we assume unmanaged resources also have finalizers.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlServerQueryRunner</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ILogger&lt;SqlServerQueryRunner&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> SqlConnection _connection;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    ~SqlServerQueryRunner() =&gt; Dispose(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Dispose(<span class="literal">true</span>);</span><br><span class="line">        GC.SuppressFinalize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="built_in">bool</span> disposing</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (disposing)</span><br><span class="line">            _connection?.Dispose();</span><br><span class="line"></span><br><span class="line">        _connection = <span class="literal">null</span>;</span><br><span class="line">        _logger = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>You now may be asking: <em>But if we have finalizers that will be triggered when the class is garbage collected, why implement <code>IDisposable</code>?</em></p><p>That’s a fair question with a simple answer: <strong>You want garbage collection to be as fast as possible because it is a synchronous operation that stops all processes while it’s running.</strong></p><p><strong>This also means unmanaged resources wouldn’t be released until garbage collection happened, which may take some time</strong> — imagine a reference to a file that you didn’t need but the process would still be locking it, now you want to open it again but can’t, because the garbage collector haven’t run yet.</p><p>If you look at the <code>Dispose</code> method, you’ll realize there’s a call to <code>GC.SuppressFinalize</code>, which is a method that actually tells the garbage collector: <em>look, this class has a finalizer but you can ignore it because it is irrelevant, the developer already released resources using the dispose pattern.</em></p><h1 id="IAsyncDisposable-interface"><a href="#IAsyncDisposable-interface" class="headerlink" title="IAsyncDisposable interface"></a>IAsyncDisposable interface</h1><p>Implementing the <code>IAsyncDisposable</code> interface is very similar to <code>IDisposable</code> with a small difference, we call <code>Dispose(false)</code> inside the method <code>DisposeAsync</code> to keep functional equivalence with the synchronous dispose pattern and further ensuring that finalizer code paths are still invoked. There’s no need to dispose resources synchronously if they were already disposed asynchronously.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlServerQueryRunner</span> : <span class="title">IDisposable</span>, <span class="title">IAsyncDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ILogger&lt;SqlServerQueryRunner&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> SqlConnection _connection;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> ValueTask <span class="title">DisposeAsync</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> DisposeAsyncCore().ConfigureAwait(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        Dispose(<span class="literal">false</span>);</span><br><span class="line">        GC.SuppressFinalize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">async</span> ValueTask <span class="title">DisposeAsyncCore</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(_connection <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">await</span> _connection.DisposeAsync().ConfigureAwait(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>As a small note, if the class was sealed, the method <code>DisposeAsyncCore</code> wouldn’t be needed and all code could be inside the <code>DisposeAsync</code> method.</p><h1 id="ObjectDisposedException"><a href="#ObjectDisposedException" class="headerlink" title="ObjectDisposedException"></a>ObjectDisposedException</h1><p>When implementing a disposable class it’s also a good practice to throw an <code>ObjectDisposedException</code> when it’s been disposed but some code is still trying to use it.</p><p>This usually is as simple as creating a flag to be set by the <code>Dispose(bool)</code> method and checking for it on all methods that may apply.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlServerQueryRunner</span> : <span class="title">IDisposable</span>, <span class="title">IAsyncDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ILogger&lt;SqlServerQueryRunner&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> SqlConnection _connection;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> _disposed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="built_in">bool</span> disposing</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(_disposed)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (disposing)</span><br><span class="line">            _connection?.Dispose();</span><br><span class="line"></span><br><span class="line">        _connection = <span class="literal">null</span>;</span><br><span class="line">        _logger = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        _disposed = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">ValueTask</span>&lt;<span class="title">IEnumerable</span>&lt;<span class="title">T</span>&gt;&gt; <span class="title">QueryAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params">CancellationToken ct, <span class="built_in">string</span> sql, <span class="built_in">object</span> parameters = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ObjectDisposedException.ThrowIf(_disposed, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Querying database: &#123;Sql&#125;&quot;</span>, sql);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// using Dapper for simplicity</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> _connection.QueryAsync&lt;T&gt;(<span class="keyword">new</span> CommandDefinition(</span><br><span class="line">            sql,</span><br><span class="line">            parameters,</span><br><span class="line">            cancellationToken: ct</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>In this article I explained the <strong>dispose pattern</strong> in .NET, which is used to cleanup and release unmanaged resources from memory, either synchronously by implementing the <code>IDisposable</code> interface, or asynchronously with <code>IAsyncDisposable</code>.</p><p>For the example we used a simple wrapper for <code>SqlConnection</code> that holds references to both unmanaged and managed resources, making sure both were properly cleared and an <code>ObjectDisposedException</code> was thrown if the class was used after being disposed.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlServerQueryRunner</span> : <span class="title">IDisposable</span>, <span class="title">IAsyncDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ILogger&lt;SqlServerQueryRunner&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> SqlConnection _connection;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> _disposed;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SqlServerQueryRunner</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        ILogger&lt;SqlServerQueryRunner&gt; logger,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">string</span> connectionString</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ArgumentNullException.ThrowIfNull(logger);</span><br><span class="line">        ArgumentNullException.ThrowIfNull(connectionString);</span><br><span class="line"></span><br><span class="line">        _logger = logger;</span><br><span class="line">        _connection = <span class="keyword">new</span> SqlConnection(connectionString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> IDisposable</span></span><br><span class="line"></span><br><span class="line">    ~SqlServerQueryRunner() =&gt; Dispose(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Dispose(<span class="literal">true</span>);</span><br><span class="line">        GC.SuppressFinalize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="built_in">bool</span> disposing</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(_disposed)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (disposing)</span><br><span class="line">            _connection?.Dispose();</span><br><span class="line"></span><br><span class="line">        _connection = <span class="literal">null</span>;</span><br><span class="line">        _logger = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        _disposed = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> IAsyncDisposable</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> ValueTask <span class="title">DisposeAsync</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> DisposeAsyncCore().ConfigureAwait(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        Dispose(<span class="literal">false</span>);</span><br><span class="line">        GC.SuppressFinalize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">async</span> ValueTask <span class="title">DisposeAsyncCore</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_disposed)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_connection <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">await</span> _connection.DisposeAsync().ConfigureAwait(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">ValueTask</span>&lt;<span class="title">IEnumerable</span>&lt;<span class="title">T</span>&gt;&gt; <span class="title">QueryAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params">CancellationToken ct, <span class="built_in">string</span> sql, <span class="built_in">object</span> parameters = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ObjectDisposedException.ThrowIf(_disposed, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Querying database: &#123;Sql&#125;&quot;</span>, sql);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// using Dapper for simplicity</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> _connection.QueryAsync&lt;T&gt;(<span class="keyword">new</span> CommandDefinition(</span><br><span class="line">            sql,</span><br><span class="line">            parameters,</span><br><span class="line">            cancellationToken: ct</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><footer class="article-footer"><a data-url="https://code-corner.dev/2024/01/08/Dispose-pattern-in-NET/" data-id="clv2o3ycj0005jojhf025bwxd" data-title="Dispose pattern in .NET" class="article-share-link"><span class="fa fa-share">Share</span></a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a></li></ul></footer></div><nav id="article-nav"><a href="/2024/01/19/NET-%E2%80%94-TaskCompletionSource-and-CancellationTokenSource/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">.NET — TaskCompletionSource and CancellationTokenSource</div></a><a href="/2023/12/28/Syntax-sugar-we-don%E2%80%99t-even-think-about-in-C/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Syntax sugar we don’t even think about in C#</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/concepts/">concepts</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/performance/">performance</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tutorial/">tutorial</a><span class="category-list-count">9</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dapper/" rel="tag">dapper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/efcore/" rel="tag">efcore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hangfire/" rel="tag">hangfire</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linq/" rel="tag">linq</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/patterns/" rel="tag">patterns</a><span class="tag-list-count">6</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/aspnetcore/" style="font-size:15px">aspnetcore</a> <a href="/tags/csharp/" style="font-size:18.33px">csharp</a> <a href="/tags/dapper/" style="font-size:10px">dapper</a> <a href="/tags/dotnet/" style="font-size:16.67px">dotnet</a> <a href="/tags/dotnetcore/" style="font-size:20px">dotnetcore</a> <a href="/tags/efcore/" style="font-size:11.67px">efcore</a> <a href="/tags/hangfire/" style="font-size:10px">hangfire</a> <a href="/tags/linq/" style="font-size:11.67px">linq</a> <a href="/tags/patterns/" style="font-size:13.33px">patterns</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/06/19/NET-9-ToList-vs-ToArray/">.NET 9 - ToList vs ToArray</a></li><li><a href="/2024/05/25/NET-IAsyncEnumerable-utility-extensions/">.NET - IAsyncEnumerable utility extensions</a></li><li><a href="/2024/04/14/NET-9-%E2%80%94-Exception-handling-performance/">.NET 9 — Exception handling performance</a></li><li><a href="/2024/02/29/NET-Hangfire/">.NET - Hangfire</a></li><li><a href="/2024/02/05/NET-%E2%80%94-LinkedList-vs-ToArray/">.NET — LinkedList vs ToArray</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png"></a><br>All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a><br>&copy; 2024 João Simões<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="/js/jquery-3.6.4.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></div></body></html>