<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-TQKP5TGHJ8"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TQKP5TGHJ8")</script><title>.NET — Hangfire | code-corner.dev</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="google-adsense-account" content="ca-pub-4671230649342120"><meta name="description" content="One common scenario when developing applications is the need to perform background processing than can either be run only once (like sending an email) or scheduled to be run multiple times within a gi"><meta property="og:type" content="article"><meta property="og:title" content=".NET — Hangfire"><meta property="og:url" content="https://code-corner.dev/2024/02/29/NET-Hangfire/index.html"><meta property="og:site_name" content="code-corner.dev"><meta property="og:description" content="One common scenario when developing applications is the need to perform background processing than can either be run only once (like sending an email) or scheduled to be run multiple times within a gi"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://code-corner.dev/2024/02/29/NET-Hangfire/00_header.png"><meta property="article:published_time" content="2024-02-29T00:00:00.000Z"><meta property="article:modified_time" content="2024-06-19T22:37:37.943Z"><meta property="article:author" content="João Simões"><meta property="article:tag" content="dotnetcore"><meta property="article:tag" content="aspnetcore"><meta property="article:tag" content="csharp"><meta property="article:tag" content="hangfire"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://code-corner.dev/2024/02/29/NET-Hangfire/00_header.png"><meta name="twitter:creator" content="@JoaoPRSimoes"><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css"><link rel="canonical" href="https://code-corner.dev/2024/02/29/NET-Hangfire/"><meta name="generator" content="Hexo 7.1.1"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml,sitemap.txt"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">code-corner.dev</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">The place to learn about programming</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/gravity00"><span class="fa fa-github"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://twitter.com/JoaoPRSimoes"><span class="fa fa-twitter"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://joaoprsimoes.medium.com/"><span class="fa fa-medium"></span></a> <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a> <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://code-corner.dev"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-NET-Hangfire" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-meta"><a href="/2024/02/29/NET-Hangfire/" class="article-date"><time class="dt-published" datetime="2024-02-29T00:00:00.000Z" itemprop="datePublished">2024-02-29</time></a><div class="article-category"><a class="article-category-link" href="/categories/tutorial/">tutorial</a></div></div><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">.NET — Hangfire</h1><h2 class="p-name article-subtitle">Using Hangfire to recurrently trigger HTTP endpoints</h2></header><div class="e-content article-entry" itemprop="articleBody"><a href="https://code-corner.dev/2024/02/29/NET-Hangfire/00_header.png" data-fancybox="gallery" data-caption><img src="https://code-corner.dev/2024/02/29/NET-Hangfire/00_header.png"></a><p>One common scenario when developing applications is the need to perform background processing than can either be run only once (like sending an email) or scheduled to be run multiple times within a given interval (like doing database housekeeping), usually defined by a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cron">cron</a> expression.</p><p>When I need to implement such requirements my first choice for the last few years as always been <a target="_blank" rel="noopener" href="https://www.hangfire.io/">Hangfire</a>.</p><p>It integrates seamlessly with ASP.NET Core applications, it has a simple but very powerful dashboard to monitor and manually trigger recurring jobs and is open source and completely free for commercial use.</p><p>In this article I’m going to explain how to configure both Hangfire server and dashboard into an ASP.NET Core application and recurrently send requests to HTTP endpoints, which will be configured based on application settings without requiring a service restart to detect changes.</p><hr><h2 id="Why-use-Hangfire-to-trigger-HTTP-endpoints"><a href="#Why-use-Hangfire-to-trigger-HTTP-endpoints" class="headerlink" title="Why use Hangfire to trigger HTTP endpoints?"></a>Why use Hangfire to trigger HTTP endpoints?</h2><p>An extremely common approach I use when implementing schedulers that may run millions of jobs per day is to use Hangfire to trigger HTTP endpoints, offloading work to external APIs instead of in process.</p><img src="/2024/02/29/NET-Hangfire/01_http_architecture.png"><p>By design, Hangfire is implemented to be easily distributed on different machines by orchestrating the job execution using a persistent data storage shared across all servers.</p><p>The problem comes when some jobs need more processing power than others or millions of executions per day. You’ll have to maintain multiple nodes looking at different queues, code changes must be properly distributed to the relevant nodes, the database will probably become a bottleneck - even if using some message bus or in-memory cache.</p><p>To attenuate this problem I usually prefer to keep Hangfire instances as simple as possible, by recurrently doing simple HTTP requests that can be configured either by settings files or database providers (<a href="/2023/12/21/Configuration-providers-in-NET/" title="Configuration providers in .NET">like exemplified in this article I recently made</a>). This allows to offload the heavy work to external APIs that can be more easily scaled, tested, distributed and monitored and ensuring you’ll need much fewer Hangfire instances to run millions of jobs per day while using the dashboard to keep track of job executions.</p><h2 id="Solution-setup"><a href="#Solution-setup" class="headerlink" title="Solution setup"></a>Solution setup</h2><p>In this example, <a target="_blank" rel="noopener" href="https://github.com/gravity00/article-hangfire">which I have available on GitHub</a>, I’m going to setup an ASP.NET Core application with .NET 8 to host both Hangfire server and dashboard. For simplicity, the job storage will be in-memory but feel free to use any other of the supported ones (like SQL Server).</p><p>Start by creating an empty ASP.NET Core project and register the following NuGet packages:</p><ul><li><code>Hangfire.AspNetCore</code> - depends on <code>Hangfire.NetCore</code>, which is used to run the jobs server on <code>Microsoft.Extensions.Hosting</code> as a hosted service, but also brings a Web dashboard that can be used to manually trigger recurring jobs or check execution status;</li><li><code>Hangfire.InMemory</code> - in-memory job storage but you can swap for any other of your preference, like <code>Hangfire.SqlServer</code>;</li></ul><p>Open the <code>Program.cs</code> file, register both the server and dashboard services into the dependency injection container and configure the dashboard to listen on base address:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line"></span><br><span class="line">builder.Services.AddHangfire(config =&gt; config</span><br><span class="line">    .UseInMemoryStorage()</span><br><span class="line">);</span><br><span class="line">builder.Services.AddHangfireServer();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line">app.MapHangfireDashboard(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure><p>If you run the application, the Hangfire dashboard will be shown with a single server running but without recurring jobs.</p><img src="/2024/02/29/NET-Hangfire/02_setup.png"><p>As you can see, in just a few minutes you have Hangfire up and ready do run. As stated previously, this is one of the reasons I always use Hangfire for scheduling jobs, the simplicity of it!</p><h2 id="HTTP-job-options"><a href="#HTTP-job-options" class="headerlink" title="HTTP job options"></a>HTTP job options</h2><p>Now that we have both the server and dashboard running, let’s start by defining the recurring HTTP options that we’ll read from the application settings and dynamically configure endpoints to be recurrently triggered.</p><p>Let’s start by defining the options for requesting a single endpoint. To keep things simple, I’ll assume the need for an HTTP address, method, headers and a request timeout. It will also need a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cron">cron</a> expression, so we can define the recurrency interval, and a flag to enable it so you can manage per environment which jobs are enabled.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HttpJobEndpointOptions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Cron &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> Enabled &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Address &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Method &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IReadOnlyDictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; Headers &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> TimeSpan? Timeout &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IgnoreInvalidStatusCode &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>We could now load a collection of <code>HttpJobEndpointOptions</code> from the application settings but let’s try to organize the endpoints into categories and also give a name for each. This will be handy later to have a more readable job name when looking at the Hangfire dashboard.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HttpJobOptions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> TimeSpan DefaultTimeout &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125; = TimeSpan.FromSeconds(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IReadOnlyDictionary&lt;</span><br><span class="line">        <span class="built_in">string</span>, </span><br><span class="line">        IReadOnlyDictionary&lt;<span class="built_in">string</span>, HttpJobEndpointOptions&gt;</span><br><span class="line">    &gt; Endpoints &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>appsettings.json</code> file and configure an <code>IsAlive</code> job inside a <code>Core</code> category that’ll run every 5 minutes. This job will be used later for testing, so assume an HTTP request <code>GET /api/is-alive</code> to itself:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;HttpJobs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;DefaultTimeout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;00:00:05&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Endpoints&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Core&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;IsAlive&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;Cron&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*/5 * * * *&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://localhost:7076/api/is-alive&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;accept&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/json&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Timeout&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;IgnoreInvalidStatusCode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Microsoft.AspNetCore&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Open the <code>Program.cs</code> file and configure the <code>HttpJobOptions</code> from the <code>HttpJobs</code> section. Let’s also add the testing endpoint to be triggered later:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line"></span><br><span class="line">builder.Services.AddHangfire(config =&gt; config</span><br><span class="line">    .UseInMemoryStorage()</span><br><span class="line">);</span><br><span class="line">builder.Services.AddHangfireServer();</span><br><span class="line"></span><br><span class="line">builder.Services.Configure&lt;HttpJobOptions&gt;(</span><br><span class="line">    builder.Configuration.GetSection(<span class="string">&quot;HttpJobs&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line">app.MapGet(<span class="string">&quot;/api/is-alive&quot;</span>, () =&gt; <span class="string">&quot;I&#x27;m alive!&quot;</span>);</span><br><span class="line"></span><br><span class="line">app.MapHangfireDashboard(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure><h2 id="HTTP-job-runner"><a href="#HTTP-job-runner" class="headerlink" title="HTTP job runner"></a>HTTP job runner</h2><p>Now that we have defined the job options, let’s create the class that will be recurrently executed by the Hangfire server.</p><p>The core idea of this class is to be responsible to do a single HTTP request by receiving both the category and endpoint names as a parameter, looking up for the configuration in the <code>HttpJobOptions</code> instance and doing the expected HTTP request. It will also receive a <code>PerformContext</code> instance which is a special (but optional) class provided by Hangfire to give context to your methods.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HttpJobRunner</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    ILogger&lt;HttpJobRunner&gt; logger,</span></span></span><br><span class="line"><span class="params"><span class="function">    IOptionsMonitor&lt;HttpJobOptions&gt; options,</span></span></span><br><span class="line"><span class="params"><span class="function">    IHttpClientFactory clientFactory</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> HttpJobOptions Options =&gt; options.CurrentValue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">RunAsync</span>(<span class="params"><span class="built_in">string</span> category, <span class="built_in">string</span> name, PerformContext ctx</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> _ = logger.BeginScope(</span><br><span class="line">            <span class="string">&quot;Category:&#123;Category&#125; Name:&#123;Name&#125; JobId:&#123;JobId&#125;&quot;</span>,</span><br><span class="line">            category,</span><br><span class="line">            name,</span><br><span class="line">            ctx.BackgroundJob.Id</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Options.Endpoints.TryGetValue(category, <span class="keyword">out</span> <span class="keyword">var</span> endpoints))</span><br><span class="line">        &#123;</span><br><span class="line">            logger.LogWarning(<span class="string">&quot;Configuration for category not found&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!endpoints.TryGetValue(name, <span class="keyword">out</span> <span class="keyword">var</span> endpoint))</span><br><span class="line">        &#123;</span><br><span class="line">            logger.LogWarning(<span class="string">&quot;Configuration for endpoint not found&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!endpoint.Enabled)</span><br><span class="line">        &#123;</span><br><span class="line">            logger.LogWarning(<span class="string">&quot;Endpoint was disabled while still scheduled, nothing will be done&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> client = clientFactory.CreateClient(</span><br><span class="line">            <span class="string">$&quot;<span class="subst">&#123;<span class="keyword">nameof</span>(HttpJobRunner)&#125;</span>.<span class="subst">&#123;category&#125;</span>.<span class="subst">&#123;name&#125;</span>&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        client.Timeout = endpoint.Timeout ?? Options.DefaultTimeout;</span><br><span class="line"></span><br><span class="line">        logger.LogDebug(</span><br><span class="line">            <span class="string">&quot;Starting HTTP request &#x27;&#123;Method&#125; &#123;Address&#125;&#x27; [Timeout:&#123;Timeout&#125;]&quot;</span>,</span><br><span class="line">            endpoint.Method,</span><br><span class="line">            endpoint.Address,</span><br><span class="line">            client.Timeout</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> request = <span class="keyword">new</span> HttpRequestMessage(</span><br><span class="line">            <span class="keyword">new</span> HttpMethod(endpoint.Method),</span><br><span class="line">            endpoint.Address</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (endpoint.Headers?.Count &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> (key, <span class="keyword">value</span>) <span class="keyword">in</span> endpoint.Headers)</span><br><span class="line">                request.Headers.Add(key, <span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> ct = ctx.CancellationToken.ShutdownToken;</span><br><span class="line"></span><br><span class="line">        HttpResponseMessage response;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            response = <span class="keyword">await</span> client.SendAsync(request, ct);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (TaskCanceledException e) <span class="keyword">when</span> (!ct.IsCancellationRequested)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(<span class="string">&quot;Request timed out&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> (response)</span><br><span class="line">        &#123;</span><br><span class="line">            logger.LogInformation(</span><br><span class="line">                <span class="string">&quot;Completed HTTP request &#x27;&#123;Method&#125; &#123;Address&#125;&#x27; with status code &#123;StatusCode&#125;&quot;</span>,</span><br><span class="line">                endpoint.Method,</span><br><span class="line">                endpoint.Address,</span><br><span class="line">                response.StatusCode</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!endpoint.IgnoreInvalidStatusCode)</span><br><span class="line">                response.EnsureSuccessStatusCode();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Register into the DI container the HTTP client services (because we are using the <code>IHttpClientFactory</code>) and also this class as transient.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line"></span><br><span class="line">builder.Services.AddHangfire(config =&gt; config</span><br><span class="line">    .UseInMemoryStorage()</span><br><span class="line">);</span><br><span class="line">builder.Services.AddHangfireServer();</span><br><span class="line"></span><br><span class="line">builder.Services.Configure&lt;HttpJobOptions&gt;(</span><br><span class="line">    builder.Configuration.GetSection(<span class="string">&quot;HttpJobs&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">builder.Services.AddHttpClient();</span><br><span class="line">builder.Services.AddTransient&lt;HttpJobRunner&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line">app.MapGet(<span class="string">&quot;/api/is-alive&quot;</span>, () =&gt; <span class="string">&quot;I&#x27;m alive!&quot;</span>);</span><br><span class="line"></span><br><span class="line">app.MapHangfireDashboard(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure><h2 id="HTTP-hosted-service"><a href="#HTTP-hosted-service" class="headerlink" title="HTTP hosted service"></a>HTTP hosted service</h2><p>It is time to let Hangfire know that we have endpoints that must be requested on a recurrent basis. </p><p>To configure the class <code>HttpJobRunner</code> as a recurring job, we can use either the static method <code>RecurringJob.AddOrUpdate</code> or the equivalent methods provided by <code>IRecurringJobManager</code>.</p><p>A manual registration of the <code>HTTP:Core:IsAlive</code> job we defined in the application settings would be as follows:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// using static class RecurringJob</span></span><br><span class="line">RecurringJob.AddOrUpdate&lt;HttpJobRunner&gt;(</span><br><span class="line">    <span class="string">&quot;HTTP:Core:IsAlive&quot;</span>,</span><br><span class="line">    runner =&gt; runner.RunAsync(<span class="string">&quot;Core&quot;</span>, <span class="string">&quot;IsAlive&quot;</span>, <span class="literal">null</span>),</span><br><span class="line">    <span class="string">&quot;*/5 * * * *&quot;</span>,</span><br><span class="line">    <span class="keyword">new</span> RecurringJobOptions</span><br><span class="line">    &#123;</span><br><span class="line">        TimeZone = TimeZoneInfo.Utc</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// using IRecurringJobManager instance</span></span><br><span class="line">jobManager.AddOrUpdate&lt;HttpJobRunner&gt;(</span><br><span class="line">    <span class="string">&quot;HTTP:Core:IsAlive&quot;</span>,</span><br><span class="line">    runner =&gt; runner.RunAsync(<span class="string">&quot;Core&quot;</span>, <span class="string">&quot;IsAlive&quot;</span>, <span class="literal">null</span>),</span><br><span class="line">    <span class="string">&quot;*/5 * * * *&quot;</span>,</span><br><span class="line">    <span class="keyword">new</span> RecurringJobOptions</span><br><span class="line">    &#123;</span><br><span class="line">        TimeZone = TimeZoneInfo.Utc</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>As you can see, we pass an expression to the <code>AddOrUpdate</code> method that will be used by Hangfire to build dynamic code to call the <code>RunAsync</code> method of our <code>HttpJobRunner</code> class, including the parameters we specify. As stated before, the <code>PerformContext</code> parameter is special and despite we are passing null when defining the expression, Hangfire will actually create a context each time the method is run.</p><p>With this simple yet effective approach, Hangfire doesn’t impose any interface or abstract class that must be implemented, making our life much easier.</p><p>This registration could be done at application startup but since we want do detect changes to the application settings without restarting the server, let’s create a hosted service that will be running in the background and either add or remove scheduler jobs. As a note, since Hangfire doesn’t provide a way to get currently registered jobs so we can remove inexistent, we’ll register the hosted service as a singleton and have a collection in-memory to track registered job ids.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HttpJobHostedService</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    ILogger&lt;HttpJobHostedService&gt; logger,</span></span></span><br><span class="line"><span class="params"><span class="function">    IOptionsMonitor&lt;HttpJobOptions&gt; options,</span></span></span><br><span class="line"><span class="params"><span class="function">    IRecurringJobManager jobManager</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) : IHostedService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> HashSet&lt;<span class="built_in">string</span>&gt; _jobIds = <span class="keyword">new</span>();</span><br><span class="line">    <span class="keyword">private</span> IDisposable _onOptionsChange;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">StartAsync</span>(<span class="params">CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _onOptionsChange = options.OnChange(jobOptions =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            logger.LogDebug(<span class="string">&quot;Configuration changed, scheduling jobs&quot;</span>);</span><br><span class="line">            ScheduleJobs(jobOptions);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        logger.LogDebug(<span class="string">&quot;Initial configuration, scheduling jobs&quot;</span>);</span><br><span class="line">        ScheduleJobs(options.CurrentValue);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">StopAsync</span>(<span class="params">CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _onOptionsChange?.Dispose();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ScheduleJobs</span>(<span class="params">HttpJobOptions options</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> currentJobIds = <span class="keyword">new</span> HashSet&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (options.Endpoints <span class="keyword">is</span> &#123; Count: &gt; <span class="number">0</span> &#125;)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> (category, endpoints) <span class="keyword">in</span> options.Endpoints)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (endpoints <span class="keyword">is</span> <span class="keyword">not</span> &#123; Count: &gt; <span class="number">0</span> &#125;)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> (name, endpoint) <span class="keyword">in</span> endpoints)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!endpoint.Enabled)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> jobId = <span class="string">$&quot;HTTP:<span class="subst">&#123;category&#125;</span>:<span class="subst">&#123;name&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">                    jobManager.AddOrUpdate&lt;HttpJobRunner&gt;(</span><br><span class="line">                        jobId,</span><br><span class="line">                        runner =&gt; runner.RunAsync(category, name, <span class="literal">null</span>),</span><br><span class="line">                        endpoint.Cron,</span><br><span class="line">                        <span class="keyword">new</span> RecurringJobOptions</span><br><span class="line">                        &#123;</span><br><span class="line">                            TimeZone = TimeZoneInfo.Utc</span><br><span class="line">                        &#125;</span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">                    currentJobIds.Add(jobId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _jobIds.RemoveWhere(jobId =&gt; currentJobIds.Contains(jobId));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> jobId <span class="keyword">in</span> _jobIds) </span><br><span class="line">            jobManager.RemoveIfExists(jobId);</span><br><span class="line"></span><br><span class="line">        _jobIds.Clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> jobId <span class="keyword">in</span> currentJobIds)</span><br><span class="line">            _jobIds.Add(jobId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Register this class into the Dependency Injection container as a hosted service.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line"></span><br><span class="line">builder.Services.AddHangfire(config =&gt; config</span><br><span class="line">    .UseInMemoryStorage()</span><br><span class="line">);</span><br><span class="line">builder.Services.AddHangfireServer();</span><br><span class="line"></span><br><span class="line">builder.Services.Configure&lt;HttpJobOptions&gt;(</span><br><span class="line">    builder.Configuration.GetSection(<span class="string">&quot;HttpJobs&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">builder.Services.AddHttpClient();</span><br><span class="line">builder.Services.AddTransient&lt;HttpJobRunner&gt;();</span><br><span class="line"></span><br><span class="line">builder.Services.AddHostedService&lt;HttpJobHostedService&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line">app.MapGet(<span class="string">&quot;/api/is-alive&quot;</span>, () =&gt; <span class="string">&quot;I&#x27;m alive!&quot;</span>);</span><br><span class="line"></span><br><span class="line">app.MapHangfireDashboard(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure><p>If you now run the application, the Hangfire dashboard will show the <code>HTTP:Core:IsAlive</code> recurring job to be run every 5 minutes.</p><img src="/2024/02/29/NET-Hangfire/03_recurring_jobs_initial.png"><p>Try to change the application settings while the application is running, like changing the <em>cron</em> expression, disabling, removing or creating jobs, so you can see the recurring job list to change accordingly.</p><p>If you wait for the jobs to run (or manually trigger) and go to the <code>Jobs</code> tab, open the <code>Succeeded</code> status and you’ll see the list of all jobs that have run successfully.</p><img src="/2024/02/29/NET-Hangfire/04_jobs_initial.png"><p>If you open one of the jobs, you’ll see details about it’s execution, like the parameters that were passed, the execution time and, if it was failed, the exception details.</p><img src="/2024/02/29/NET-Hangfire/05_jobs_detail_initial.png"><h2 id="Job-filters"><a href="#Job-filters" class="headerlink" title="Job filters"></a>Job filters</h2><p>The code is looking nice and simple and seems to work very well but there’s still three problems that I think should be solved: </p><ol><li>If you have multiple HTTP endpoints you can’t tell just looking at the list which one was called without checking execution details. In this case every job is called <code>HttpJobRunner.RunAsync</code>, independently the endpoint;</li><li>Since this is a recurring and stateless job so, when it fails, there’s no point in keeping it in the failed state to be retried, we can move it to the deleted stated that would be automatically housekept by Hangfire;</li><li>If for some reason a job for a given endpoint takes more time to run than its <em>cron</em> interval, multiple executions will overlap and cause requests to happen concurrently, which may not be the expected behavior;</li></ol><p>To solve these problems we are going to use Hangfire filters, which are attributes that can be used to annotate methods (or registered globally) to add custom behavior when running a job, working similarly to ASP.NET Core MVC filters.</p><p>We are going to use the <code>JobDisplayName</code> filter to define the job name in the dashboard, the <code>AutomaticRetry</code> filter to mark the job as deleted when failed, and create a custom filter than will lock job executions per endpoint until the previous one has completed.</p><p>Starting by the custom filter, we must extend the <code>JobFilterAttribute</code> and because it’s changing the behavior of a job execution, it must also implement the <code>IServerFilter</code> interface. We are going to use both the category and endpoint name parameters to create a unique identifier per endpoint execution and use an Hangfire distributed lock feature to ensure a job for the same endpoint only runs after the lock is disposed by a previous execution.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnableDistributedMutexAttribute</span> : <span class="title">JobFilterAttribute</span>, <span class="title">IServerFilter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> Key = <span class="keyword">nameof</span>(EnableDistributedMutexAttribute);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">string</span> _nameFormat;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> TimeSpan _timeout;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EnableDistributedMutexAttribute</span>(<span class="params"><span class="built_in">string</span> nameFormat, <span class="built_in">int</span> timeoutInSeconds</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ArgumentNullException.ThrowIfNull(nameFormat);</span><br><span class="line">        ArgumentOutOfRangeException.ThrowIfLessThanOrEqual(timeoutInSeconds, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        _nameFormat = nameFormat;</span><br><span class="line">        _timeout = TimeSpan.FromSeconds(timeoutInSeconds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnPerforming</span>(<span class="params">PerformingContext ctx</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> distributedLockName = <span class="built_in">string</span>.Format(</span><br><span class="line">            _nameFormat,</span><br><span class="line">            ctx.BackgroundJob.Job.Args.ToArray()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> distributedLock = ctx.Connection.AcquireDistributedLock(</span><br><span class="line">            distributedLockName,</span><br><span class="line">            _timeout</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        ctx.Items[Key] = distributedLock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnPerformed</span>(<span class="params">PerformedContext ctx</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ctx.Items.TryGetValue(Key, <span class="keyword">out</span> <span class="keyword">var</span> distributedLock))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">&quot;Can not release a distributed lock: it was not acquired.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ((IDisposable)distributedLock).Dispose();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>HttpJobRunner</code> class and annotate the <code>RunAsync</code> method with a <code>JobDisplayName</code>, <code>EnableDistributedMutex</code> and <code>AutomaticRetry</code> attributes.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HttpJobRunner</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    ILogger&lt;HttpJobRunner&gt; logger,</span></span></span><br><span class="line"><span class="params"><span class="function">    IOptionsMonitor&lt;HttpJobOptions&gt; options,</span></span></span><br><span class="line"><span class="params"><span class="function">    IHttpClientFactory clientFactory</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> HttpJobOptions Options =&gt; options.CurrentValue;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">JobDisplayName(<span class="string">&quot;HTTP:&#123;0&#125;:&#123;1&#125;&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">EnableDistributedMutex(<span class="string">&quot;HTTP:&#123;0&#125;:&#123;1&#125;&quot;</span>, 15)</span>]</span><br><span class="line">    [<span class="meta">AutomaticRetry(OnAttemptsExceeded = AttemptsExceededAction.Delete, Attempts = 0)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">RunAsync</span>(<span class="params"><span class="built_in">string</span> category, <span class="built_in">string</span> name, PerformContext ctx</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If you now run the application and wait or manually trigger the <code>HTTP:Core:IsAlive</code> job you’ll see the new display name in the dashboard.</p><img src="/2024/02/29/NET-Hangfire/06_jobs_final.png"><p>Feel free to also force some exceptions to see the job in the deleted state instead of failed, or delaying the job execution for more time than the defined <em>cron</em> interval to see jobs waiting for the previous ones to complete.</p><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>In this article I explained how easy it is to configure the Hangfire server to run recurring jobs in the background of an ASP.NET Core application, and use its dashboard to manage and monitor job executions.</p><p>For simplicity we used the in-memory job storage and created the base architecture for jobs that recurrently trigger HTTP endpoints, everything configured using application settings.</p><p>As a reminder, this example is <a target="_blank" rel="noopener" href="https://github.com/gravity00/article-hangfire">available on GitHub</a> so feel free to give it a look.</p></div><footer class="article-footer"><a data-url="https://code-corner.dev/2024/02/29/NET-Hangfire/" data-id="clv2o3ycn000ejojh9up8etkz" data-title=".NET — Hangfire" class="article-share-link"><span class="fa fa-share">Share</span></a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hangfire/" rel="tag">hangfire</a></li></ul></footer></div><nav id="article-nav"><a href="/2024/04/14/NET-9-%E2%80%94-Exception-handling-performance/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">.NET 9 — Exception handling performance</div></a><a href="/2024/02/05/NET-%E2%80%94-LinkedList-vs-ToArray/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">.NET — LinkedList vs ToArray</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/concepts/">concepts</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/performance/">performance</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tutorial/">tutorial</a><span class="category-list-count">9</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dapper/" rel="tag">dapper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/efcore/" rel="tag">efcore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hangfire/" rel="tag">hangfire</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linq/" rel="tag">linq</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/patterns/" rel="tag">patterns</a><span class="tag-list-count">6</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/aspnetcore/" style="font-size:15px">aspnetcore</a> <a href="/tags/csharp/" style="font-size:18.33px">csharp</a> <a href="/tags/dapper/" style="font-size:10px">dapper</a> <a href="/tags/dotnet/" style="font-size:16.67px">dotnet</a> <a href="/tags/dotnetcore/" style="font-size:20px">dotnetcore</a> <a href="/tags/efcore/" style="font-size:11.67px">efcore</a> <a href="/tags/hangfire/" style="font-size:10px">hangfire</a> <a href="/tags/linq/" style="font-size:11.67px">linq</a> <a href="/tags/patterns/" style="font-size:13.33px">patterns</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/06/19/NET-9-ToList-vs-ToArray/">.NET 9 — ToList vs ToArray</a></li><li><a href="/2024/05/25/NET-IAsyncEnumerable-utility-extensions/">.NET — IAsyncEnumerable utility extensions</a></li><li><a href="/2024/04/14/NET-9-%E2%80%94-Exception-handling-performance/">.NET 9 — Exception handling performance</a></li><li><a href="/2024/02/29/NET-Hangfire/">.NET — Hangfire</a></li><li><a href="/2024/02/05/NET-%E2%80%94-LinkedList-vs-ToArray/">.NET — LinkedList vs ToArray</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png"></a><br>All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a><br>&copy; 2024 João Simões<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="/js/jquery-3.6.4.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></div></body></html>