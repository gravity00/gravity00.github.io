{
    "version": "https://jsonfeed.org/version/1",
    "title": "code-corner.dev • All posts by \"devops\" category",
    "description": "",
    "home_page_url": "https://code-corner.dev",
    "items": [
        {
            "id": "https://code-corner.dev/2023/12/04/NET-%E2%80%94-DevOps-and-Entity-Framework-Core/",
            "url": "https://code-corner.dev/2023/12/04/NET-%E2%80%94-DevOps-and-Entity-Framework-Core/",
            "title": ".NET — DevOps and Entity Framework Core",
            "date_published": "2023-12-04T00:00:00.000Z",
            "content_html": "<p>Most .NET developers either have used Entity Framework Core or eventually will, because it is one of the most known and flexible ORM frameworks to access databases in the .NET ecosystem, directly supported by Microsoft and the Open Source community.</p>\n<p>In this article I’m going to explain how you can create a console application that will check if migrations are missing from the database and apply them accordingly. This is an approach I’ve been using ever since Microsoft released .NET Core 1 RC 1 (<a href=\"https://medium.com/@joaoprsimoes/net-creating-advanced-console-applications-c99d58216d36\">at the time I even created an open-source library to facilitate console hosting</a>, now deprecated because we can use <code>Microsoft.Extensions.Hosting</code>).</p>\n<hr>\n<p>Ever since its inception, one of the main features supported by Entity Framework is the concept of <strong>database migrations</strong> in code-first scenarios which, in a simplified way, work as follows:</p>\n<ul>\n<li>Model entities representing tables are mapped into the <code>DbContext</code>, were table and column names, data sizes, foreign keys, indexes, and so on, are defined;</li>\n<li>Entity Framework tools are <a href=\"https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/?tabs=dotnet-core-cli#install-the-tools\">installed into the project</a> (either the .NET Core CLI tools for cross platform or Package Manager Console tools for Visual Studio integration);</li>\n<li>A class implementing <code>IDesignTimeDbContextFactory</code> is created and will configure the <code>DbContext</code> when Entity Framework tools are run — provider to use, connection string, etc. This reduces the number of parameters that need to be passed when using the CLI&#x2F;PMC tools.</li>\n<li>When adding a new migration, the tools are going to use the factory to create the <code>DbContext</code>, compare the mappings to the current database schema, see what’s different and create a migration class with a bunch of C# operations that will change the schema accordingly (like creating a new index, adding a new column, dropping a table). The migration will also have a method for the inverse operations (drop the index, remove the column, recreate the table) that can be used to revert changes;</li>\n<li>The tools can also be run to update the database schema, either to the most recent or revert to an older version, ensuring missing migrations are run sequentially in the required order.</li>\n</ul>\n<p>This is a very powerful feature offered by EF Core because it speeds up the development and evolution of the database schemas while ensuring a historic change log is kept and version controlled near the C# entity models. The application may have been developed for 10 years but any new team member can setup a local version of the database in just a few steps.</p>\n<p>But you are probably thinking: <em>this seems nice and all, but he’s talking about DevOps and I’m not sure how I can use this to evolve my production schemas? The company I work for does not allow any developer to connect to production databases and even if it did, certainly the user wouldn’t have permissions to change the database schema! I can’t run EF Core tools from my computer to do this!</em></p>\n<h1 id=\"Why-an-installer-for-EF-Core-migrations\"><a href=\"#Why-an-installer-for-EF-Core-migrations\" class=\"headerlink\" title=\"Why an installer for EF Core migrations?\"></a>Why an installer for EF Core migrations?</h1><p>Having a console application that applies migrations to a database has some advantages that will probably benefit the DevOps process your company currently implements:</p>\n<ul>\n<li>For <strong>cloud solutions</strong>, you can add steps into the Continuous Delivery pipeline that run the console before distributing the APIs or Websites, which may even require the approval of specific DevOps team members. Because the pipeline is tightly controlled, the production connection strings that can execute DDL instructions are properly secured. Even if you don’t have a DevOps team but the access to production is secured by the Infrastructure team, the console can be provided as a standalone executable and they decide how and where it should be run, manually or not.</li>\n<li>For <strong>on-prem solutions</strong>, the console can be packed with the application installer to be run every time a new version is released. If it fails, the installation process can either be halted or database changes reverted to a previous state by restoring a backup made at the start of the installation.</li>\n</ul>\n<p>In both scenarios this process is more reliable than, lets say, executing SQL scripts which are harder to read, maintain and debug in case of problems. If the console application has been configured with a good logging library (either to a file or command line output) there’s no reason someone can’t analyze what is happening.</p>\n<p>The use case scenario<br>To keep things simple and focusing in the migrations executable, let’s assume we are maintaining an API that manages a warehouse. This API is responsible for storing product information and stock movements and is implemented using a typical three-layer architecture, using Entity Framework Core to store and retrieve data from a SQL Server database.</p>\n<p>In this hypothetical scenario, we decided to improve our DevOps process by creating a console application to apply migrations into the database. This tool will be called migrator, which is a new console project inside the database layer.</p>\n<p>It will have a direct dependency from the database implementation, which holds the Entity Framework Core mappings for the database entities, defined in the database contracts layer.</p>\n<p>The diagram for projects and their dependencies inside the solution, after creating the migrator executable project, could look like this:</p>\n<img src=\"/2023/12/04/NET-%E2%80%94-DevOps-and-Entity-Framework-Core/01_solution_diagram.png\" class=\"\">\n\n<p>Since this API only manages products and stock movements, the database model could be represented by the following entity contracts (navigation properties won’t be used for simplicity):</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">StockMovementEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> ProductId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">int</span> Quantity &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset OccurredOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The Entity Framework Core database context could be mapped as follows:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">        .HasMaxLength(<span class=\"number\">8</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Name)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        modelBuilder.Entity&lt;StockMovementEntity&gt;(cfg =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            cfg.ToTable(<span class=\"string\">&quot;StockMovements&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            cfg.HasKey(e =&gt; e.Id);</span><br><span class=\"line\"></span><br><span class=\"line\">            cfg.Property(e =&gt; e.Id)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .ValueGeneratedOnAdd();</span><br><span class=\"line\">            cfg.HasOne&lt;ProductEntity&gt;()</span><br><span class=\"line\">                .WithMany()</span><br><span class=\"line\">                .HasForeignKey(e =&gt; e.ProductId)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Quantity)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.OccurredOn)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>As I said before, nothing fancy here, just a simple use-case with a database model we will use for creating our migrations and apply them using our console application.</p>\n<p><a href=\"https://github.com/gravity00/article-devops-efcore\">I have a working example showcasing this scenario on GitHub (only the database layer), so feel free to give it a good look</a>. I’m using .NET 8, but any previous .NET version will work without any code changes. If for some reason you need to support older framework versions like .NET Core App 2+ or .NET Framework 4.6.2+, just downgrade the nuggets to a previous versions that supports .NET Standard 2.0, like versions 2.x or 3.x, and do some small tweaks into the hosting setup.</p>\n<h1 id=\"Console-application-setup\"><a href=\"#Console-application-setup\" class=\"headerlink\" title=\"Console application setup\"></a>Console application setup</h1><p>Now that we have defined both models and mappings, let’s setup the console application, which is going to use <code>Microsoft.Extensions.Hosting</code> for an easier setup of logging, dependency injection and application settings configuration.</p>\n<p>Start by creating a console application project and create a <code>Program.cs</code> file with a simple “hello world!” output.</p>\n<p>Add a project reference to the database implementation and add both <code>Microsoft.Extensions.Hosting</code> and <code>Microsoft.EntityFrameworkCore.Tools</code> packages (we are going to use Visual Studio Package Manager Console for creating the migrations, but feel free to use .NET Core CLI tools).</p>\n<p>Inside the database layer, the projects should be similar to this:</p>\n<img src=\"/2023/12/04/NET-%E2%80%94-DevOps-and-Entity-Framework-Core/02_project_structure.png\" class=\"\">\n\n<h2 id=\"Migrations-setup\"><a href=\"#Migrations-setup\" class=\"headerlink\" title=\"Migrations setup\"></a>Migrations setup</h2><p>To prepare the project for creating EF Core migrations, start by adding an <code>appsettings.json</code> file with a connection string to an empty SQL Server database and, to be used in the future by the host, you can already make some logging configurations.</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;ConnectionStrings&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;ArticleDevOpsEfCore&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Data Source=localhost;Database=ArticleDevOpsEfCore;User Id=sa;Password=abcd1234;Encrypt=false;&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;Logging&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;LogLevel&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Default&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Trace&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Microsoft&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Information&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Console&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;IncludeScopes&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Debug&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;IncludeScopes&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;EventSource&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;IncludeScopes&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>Remember to tell the application that, when publishing, the configuration files must be copied to the output folder. This is done by adding an include property to the <em>csproj</em> file.</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">ItemGroup</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">None</span> <span class=\"attr\">Include</span>=<span class=\"string\">&quot;*.config;*.json&quot;</span> <span class=\"attr\">CopyToOutputDirectory</span>=<span class=\"string\">&quot;PreserveNewest&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">ItemGroup</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>Create a new class implementing <code>IDesignTimeDbContextFactory</code>. This class will be responsible for creating and configuring the database contexts when managing migrations via .NET Core CLI tools or Visual Studio Package Manager Console.</p>\n<p>To know which connection string must be used, we are going to use a <code>ConfigurationBuilder</code> to read the settings file and then register a SQL Server provider with a small detail — <strong>we must specify that the migrations are stored in the console application executable, not where the context is defined</strong>.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">DesignTimeDbContextFactory</span> : <span class=\"title\">IDesignTimeDbContextFactory</span>&lt;<span class=\"title\">DatabaseContext</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> DatabaseContext <span class=\"title\">CreateDbContext</span>(<span class=\"params\"><span class=\"built_in\">string</span>[] args</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> configuration = <span class=\"keyword\">new</span> ConfigurationBuilder()</span><br><span class=\"line\">            .SetBasePath(Directory.GetCurrentDirectory())</span><br><span class=\"line\">            .AddJsonFile(<span class=\"string\">&quot;appsettings.json&quot;</span>, <span class=\"literal\">false</span>)</span><br><span class=\"line\">            .Build();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> options = <span class=\"keyword\">new</span> DbContextOptionsBuilder&lt;DatabaseContext&gt;().UseSqlServer(</span><br><span class=\"line\">            configuration.GetConnectionString(<span class=\"string\">&quot;ArticleDevOpsEfCore&quot;</span>),</span><br><span class=\"line\">            o =&gt; o.MigrationsAssembly(<span class=\"keyword\">typeof</span>(Program).Assembly.FullName)</span><br><span class=\"line\">        ).Options;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> DatabaseContext(options);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Let’s test the setup and see if we can create some migrations. Open the Package Manager Console and run the following command:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add-migration InitialModelSetup</span><br></pre></td></tr></table></figure>\n\n<p>If everything went as expected, a new <code>Migrations</code> folder was created with a <code>InitialModelSetup</code> migration class that will setup the database model. If your database schema is empty, it should look like this:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;inheritdoc /&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">partial</span> <span class=\"keyword\">class</span> <span class=\"title\">InitialModelSetup</span> : <span class=\"title\">Migration</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;inheritdoc /&gt;</span></span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">Up</span>(<span class=\"params\">MigrationBuilder migrationBuilder</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        migrationBuilder.CreateTable(</span><br><span class=\"line\">            name: <span class=\"string\">&quot;Products&quot;</span>,</span><br><span class=\"line\">            columns: table =&gt; <span class=\"keyword\">new</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                Id = table.Column&lt;<span class=\"built_in\">long</span>&gt;(type: <span class=\"string\">&quot;bigint&quot;</span>, nullable: <span class=\"literal\">false</span>)</span><br><span class=\"line\">                    .Annotation(<span class=\"string\">&quot;SqlServer:Identity&quot;</span>, <span class=\"string\">&quot;1, 1&quot;</span>),</span><br><span class=\"line\">                Code = table.Column&lt;<span class=\"built_in\">string</span>&gt;(type: <span class=\"string\">&quot;nvarchar(8)&quot;</span>, maxLength: <span class=\"number\">8</span>, nullable: <span class=\"literal\">false</span>),</span><br><span class=\"line\">                Name = table.Column&lt;<span class=\"built_in\">string</span>&gt;(type: <span class=\"string\">&quot;nvarchar(128)&quot;</span>, maxLength: <span class=\"number\">128</span>, nullable: <span class=\"literal\">false</span>)</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            constraints: table =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                table.PrimaryKey(<span class=\"string\">&quot;PK_Products&quot;</span>, x =&gt; x.Id);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        migrationBuilder.CreateTable(</span><br><span class=\"line\">            name: <span class=\"string\">&quot;StockMovements&quot;</span>,</span><br><span class=\"line\">            columns: table =&gt; <span class=\"keyword\">new</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                Id = table.Column&lt;<span class=\"built_in\">long</span>&gt;(type: <span class=\"string\">&quot;bigint&quot;</span>, nullable: <span class=\"literal\">false</span>)</span><br><span class=\"line\">                    .Annotation(<span class=\"string\">&quot;SqlServer:Identity&quot;</span>, <span class=\"string\">&quot;1, 1&quot;</span>),</span><br><span class=\"line\">                ProductId = table.Column&lt;<span class=\"built_in\">long</span>&gt;(type: <span class=\"string\">&quot;bigint&quot;</span>, nullable: <span class=\"literal\">false</span>),</span><br><span class=\"line\">                Quantity = table.Column&lt;<span class=\"built_in\">int</span>&gt;(type: <span class=\"string\">&quot;int&quot;</span>, nullable: <span class=\"literal\">false</span>),</span><br><span class=\"line\">                OccurredOn = table.Column&lt;DateTimeOffset&gt;(type: <span class=\"string\">&quot;datetimeoffset&quot;</span>, nullable: <span class=\"literal\">false</span>)</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            constraints: table =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                table.PrimaryKey(<span class=\"string\">&quot;PK_StockMovements&quot;</span>, x =&gt; x.Id);</span><br><span class=\"line\">                table.ForeignKey(</span><br><span class=\"line\">                    name: <span class=\"string\">&quot;FK_StockMovements_Products_ProductId&quot;</span>,</span><br><span class=\"line\">                    column: x =&gt; x.ProductId,</span><br><span class=\"line\">                    principalTable: <span class=\"string\">&quot;Products&quot;</span>,</span><br><span class=\"line\">                    principalColumn: <span class=\"string\">&quot;Id&quot;</span>,</span><br><span class=\"line\">                    onDelete: ReferentialAction.Cascade);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        migrationBuilder.CreateIndex(</span><br><span class=\"line\">            name: <span class=\"string\">&quot;IX_Products_Code&quot;</span>,</span><br><span class=\"line\">            table: <span class=\"string\">&quot;Products&quot;</span>,</span><br><span class=\"line\">            column: <span class=\"string\">&quot;Code&quot;</span>,</span><br><span class=\"line\">            unique: <span class=\"literal\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        migrationBuilder.CreateIndex(</span><br><span class=\"line\">            name: <span class=\"string\">&quot;IX_StockMovements_ProductId&quot;</span>,</span><br><span class=\"line\">            table: <span class=\"string\">&quot;StockMovements&quot;</span>,</span><br><span class=\"line\">            column: <span class=\"string\">&quot;ProductId&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;inheritdoc /&gt;</span></span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">Down</span>(<span class=\"params\">MigrationBuilder migrationBuilder</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        migrationBuilder.DropTable(</span><br><span class=\"line\">            name: <span class=\"string\">&quot;StockMovements&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        migrationBuilder.DropTable(</span><br><span class=\"line\">            name: <span class=\"string\">&quot;Products&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Hosting-setup\"><a href=\"#Hosting-setup\" class=\"headerlink\" title=\"Hosting setup\"></a>Hosting setup</h2><p>Now that we know the project is ready to add or remove migrations based on our development database, let’s create all the required code to apply migrations when running the console.</p>\n<p>Open the launch profile, and in the environment variables, add a new <code>DOTNET_ENVIRONMENT</code> with the value <code>development</code>. This will be used by the host to know your current environment — development, stagging or production (default) — when running the application which is useful for loading different settings or executing code based on the environment, like creating test data.</p>\n<img src=\"/2023/12/04/NET-%E2%80%94-DevOps-and-Entity-Framework-Core/03_environment_setup.png\" class=\"\">\n\n<p>Open the <code>Program.cs</code> file and use <code>Host.CreateApplicationBuilder</code> to create a builder for setting up a new host. It will use pre-configured defaults, like loading settings from the <code>appsettings.json</code> file or from environment variables and output logging to console and debug windows, while supporting dependency injection.</p>\n<p>You can use the builder to register other logging providers, like NLog or Serilog, and register the Entity Framework Core context into the dependency injection container using a SQL Server provider. Because the migrations are going to be run by a console application, the context can be shared as a singleton (by default it is scoped, useful for ASP.NET Core apps), otherwise you must create a scope explicitly. Once again, don’t forget to specify the assembly were migrations are stored.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> builder = Host.CreateApplicationBuilder(args);</span><br><span class=\"line\"></span><br><span class=\"line\">ConfigureLogging(</span><br><span class=\"line\">    builder.Logging</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">ConfigureServices(</span><br><span class=\"line\">    builder.Services,</span><br><span class=\"line\">    builder.Configuration</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">var</span> host = builder.Build();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureLogging</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    ILoggingBuilder logging</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// configure other logging providers, like NLog, Serilog or even Application Insights</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IServiceCollection services,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IConfiguration configuration</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> connectionString = configuration.GetConnectionString(<span class=\"string\">&quot;ArticleDevOpsEfCore&quot;</span>);</span><br><span class=\"line\">    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt; options.UseSqlServer(</span><br><span class=\"line\">        connectionString,</span><br><span class=\"line\">        o =&gt; o.MigrationsAssembly(<span class=\"keyword\">typeof</span>(Program).Assembly.FullName)</span><br><span class=\"line\">    ), ServiceLifetime.Singleton);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Create a new class named <code>Migrator</code> with a <code>RunAsync</code> method (that will have the migrator implementation), register it as a singleton into the DI container and, after creating the host, resolve and run it. Because migrations can fail, it is also a good idea to implement some exception handling logic (because even host setup can fail, I also prefer to wrap it). Also, we should support the cancellation of this process when CTRL+C or exit is requested, so let’s use a <code>CancellationTokenSource</code> for that.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">var</span> cts = <span class=\"keyword\">new</span> CancellationTokenSource();</span><br><span class=\"line\">Console.CancelKeyPress += (_, eventArgs) =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    cts.Cancel();</span><br><span class=\"line\">    eventArgs.Cancel = <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">ILogger&lt;Program&gt; logger = <span class=\"literal\">null</span>;</span><br><span class=\"line\"><span class=\"keyword\">try</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> builder = Host.CreateApplicationBuilder(args);</span><br><span class=\"line\"></span><br><span class=\"line\">    ConfigureLogging(</span><br><span class=\"line\">        builder.Logging</span><br><span class=\"line\">    );</span><br><span class=\"line\"></span><br><span class=\"line\">    ConfigureServices(</span><br><span class=\"line\">        builder.Services,</span><br><span class=\"line\">        builder.Configuration</span><br><span class=\"line\">    );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> host = builder.Build();</span><br><span class=\"line\"></span><br><span class=\"line\">    logger = host.Services.GetRequiredService&lt;ILogger&lt;Program&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> migrator = host.Services.GetRequiredService&lt;Migrator&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    logger.LogDebug(<span class=\"string\">&quot;Running migrator&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">await</span> migrator.RunAsync(cts.Token);</span><br><span class=\"line\">    logger.LogInformation(<span class=\"string\">&quot;Migrator run successfully&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">catch</span> (Exception e)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (logger <span class=\"keyword\">is</span> <span class=\"literal\">null</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> Console.Error.WriteLineAsync(<span class=\"string\">&quot;Application failed with a fatal error&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> Console.Error.WriteLineAsync(e.ToString());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        logger.LogCritical(e, <span class=\"string\">&quot;Application failed with a fatal error&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">throw</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureLogging</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    ILoggingBuilder logging</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// configure other logging providers, like NLog, Serilog or even Application Insights</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IServiceCollection services,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IConfiguration configuration</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> connectionString = configuration.GetConnectionString(<span class=\"string\">&quot;ArticleDevOpsEfCore&quot;</span>);</span><br><span class=\"line\">    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt; options.UseSqlServer(</span><br><span class=\"line\">        connectionString,</span><br><span class=\"line\">        o =&gt; o.MigrationsAssembly(<span class=\"keyword\">typeof</span>(Program).Assembly.FullName)</span><br><span class=\"line\">    ), ServiceLifetime.Singleton);</span><br><span class=\"line\"></span><br><span class=\"line\">    services.AddSingleton&lt;Migrator&gt;();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Applying-migrations\"><a href=\"#Applying-migrations\" class=\"headerlink\" title=\"Applying migrations\"></a>Applying migrations</h2><p>With the host fully configured and ready to run the migrator, let’s implement the migrations logic.</p>\n<p>Open the <code>Migrator.cs</code> file and create a constructor receiving both a logger and a database context. Inside the <code>RunAsync</code> method add some helpful logging and use the <code>ctx.Database.MigrateAsync</code> to update the database schema to the latest available. Keep in mind this method will apply the missing migrations and it’s not the same as <code>EnsureCreatedAsync</code>, which just checks if the database exists and if it doesn’t, creates the database and schema without using any migration.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Migrator</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    ILogger&lt;Migrator&gt; _logger,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    DatabaseContext _context</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> ValueTask <span class=\"title\">RunAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Migrating database to the latest version&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.Database.MigrateAsync(ct);</span><br><span class=\"line\">        _logger.LogInformation(<span class=\"string\">&quot;Database migrated to latest version&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If you now run the console, you’ll see some output showing the DDL instructions that are being run and if everything went as expected the database should now list both the EF Core migration history (used to track which migrations are applied) and business tables.</p>\n<img src=\"/2023/12/04/NET-%E2%80%94-DevOps-and-Entity-Framework-Core/04_db_tables.png\" class=\"\">\n\n<h2 id=\"Seeding-data\"><a href=\"#Seeding-data\" class=\"headerlink\" title=\"Seeding data\"></a>Seeding data</h2><p>Despite Entity Framework Core supporting data seeds when applying migrations, I think it is limited for production scenarios, like seeding different data based on environment or need to run some business logic, you will face limitations if using what EF Core offers.</p>\n<p>To solve this problem I usually create a specialized interface for seeding data into the migrator project, so developers may implement how many seed logic they need and even decide the order by which they are run.</p>\n<p>In the migrator project, create a new <code>IDataSeed</code> interface, inside a <code>DataSeeds</code> folder, with a <code>SeedAsync</code> method. As a small note, I like to pass arguments that can be used for auditing so I can use them on metadata columns, but they aren’t a requirement — just pass what makes sense to you.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">IDataSeed</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\">ValueTask <span class=\"title\">SeedAsync</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"built_in\">string</span> seededBy,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        DateTimeOffset seededOn,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Let’s change the migrator to run all registered seeds after applying the migrations. Open the <code>Migrator.cs</code>, pass a collection of data seeds to the constructor and then, inside a transaction, execute each seed one by one. I recommend to flush changes after each seed to be sure they all see the data created by each other, even if some have to execute native SQL code for performance reasons.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Migrator</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    ILogger&lt;Migrator&gt; _logger,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    DatabaseContext _context,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IEnumerable&lt;IDataSeed&gt; _dataSeeds</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> ValueTask <span class=\"title\">RunAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Migrating database to the latest version&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.Database.MigrateAsync(ct);</span><br><span class=\"line\">        _logger.LogInformation(<span class=\"string\">&quot;Database migrated to latest version&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> seededOn = DateTimeOffset.UtcNow;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> tx = <span class=\"keyword\">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> dataSeed <span class=\"keyword\">in</span> _dataSeeds)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> _ = _logger.BeginScope(<span class=\"string\">&quot;DataSeed:&#123;DataSeed&#125;&quot;</span>, dataSeed.GetType().Name);</span><br><span class=\"line\"></span><br><span class=\"line\">            _logger.LogDebug(<span class=\"string\">&quot;Seeding data&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">await</span> dataSeed.SeedAsync(</span><br><span class=\"line\">                <span class=\"string\">&quot;Migrator&quot;</span>,</span><br><span class=\"line\">                seededOn,</span><br><span class=\"line\">                ct</span><br><span class=\"line\">            );</span><br><span class=\"line\">            <span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">            _logger.LogInformation(<span class=\"string\">&quot;Data was seeded&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> tx.CommitAsync(ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>To test the implemented data seed logic, let’s assume we wanted to create test products for development and staging environments, but not in production. Create a new <code>TestProductsDataSeed</code> inside the <code>DataSeeds</code> folder and implement the <code>SeedAsync</code> method creating a bunch of products if they don’t exist and the migrator isn’t running in production.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">TestProductsDataSeed</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    ILogger&lt;TestProductsDataSeed&gt; _logger,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IHostEnvironment _env,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    DatabaseContext _context</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>) : IDataSeed</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> ValueTask <span class=\"title\">SeedAsync</span>(<span class=\"params\"><span class=\"built_in\">string</span> seededBy, DateTimeOffset seededOn, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (_env.IsProduction())</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            _logger.LogInformation(<span class=\"string\">&quot;Running in production, no test data will be seeded&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> productsSet = _context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> testCodes = Enumerable.Range(<span class=\"number\">0</span>, <span class=\"number\">150</span>).Select(i =&gt; i.ToString(<span class=\"string\">&quot;D8&quot;</span>, NumberFormatInfo.InvariantInfo)).ToArray();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> existingCodes = <span class=\"keyword\">await</span> (</span><br><span class=\"line\">            <span class=\"keyword\">from</span> p <span class=\"keyword\">in</span> productsSet</span><br><span class=\"line\">            <span class=\"keyword\">where</span></span><br><span class=\"line\">                testCodes.Contains(p.Code)</span><br><span class=\"line\">            <span class=\"keyword\">select</span></span><br><span class=\"line\">                p.Code</span><br><span class=\"line\">        ).ToArrayAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> nonExistingProducts = testCodes.Where(c =&gt; !existingCodes.Contains(c)).Select(c =&gt; <span class=\"keyword\">new</span> ProductEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Code = c,</span><br><span class=\"line\">            Name = <span class=\"string\">$&quot;Test product &#x27;<span class=\"subst\">&#123;c&#125;</span>&#x27;&quot;</span></span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> productsSet.AddRangeAsync(nonExistingProducts, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Now open the <code>Program.cs</code> file and register the <code>TestProductsDataSeed</code> as a singleton. As a note, you can scan the assembly for classes implementing <code>IDataSeed</code> (with <a href=\"https://github.com/khellang/Scrutor\">Scrutor</a>, for example) but the order or registration will define the order by which they are run, and I’m assuming that will matter, but feel free to use an approach that works for your scenario.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IServiceCollection services,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IConfiguration configuration</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> connectionString = configuration.GetConnectionString(<span class=\"string\">&quot;ArticleDevOpsEfCore&quot;</span>);</span><br><span class=\"line\">    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt; options.UseSqlServer(</span><br><span class=\"line\">        connectionString,</span><br><span class=\"line\">        o =&gt; o.MigrationsAssembly(<span class=\"keyword\">typeof</span>(Program).Assembly.FullName)</span><br><span class=\"line\">    ), ServiceLifetime.Singleton);</span><br><span class=\"line\"></span><br><span class=\"line\">    services.AddSingleton&lt;Migrator&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    services.AddSingleton&lt;IDataSeed, TestProductsDataSeed&gt;();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If we now run the migrator the products table should have test data.</p>\n<img src=\"/2023/12/04/NET-%E2%80%94-DevOps-and-Entity-Framework-Core/05_db_seeded.png\" class=\"\">\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>In this article I explained how DevOps processes can be simplified by implementing a console application that knows how to apply Entity Framework Core migrations and seed initial data to a database, to be introduced into de Continuous Delivery pipeline.</p>\n<p>The implementation using <code>Microsoft.Extensions.Hosting</code> is very straightforward and simple while providing a more tight integration against the model definitions and with improved logging, so it certainly is an approach to consider.</p>\n<p>Even with small tweaks, in can be improved to whatever scenarios you may face, like forcing a backup before applying the migrations and reverting to it if something fails, perfect for on-prem solutions.</p>\n<p><a href=\"https://github.com/gravity00/article-devops-efcore\">Once again, I have a working example on GitHub, so feel free to give it a good look.</a></p>\n",
            "tags": [
                "dotnetcore",
                "csharp",
                "efcore"
            ]
        }
    ]
}