{
    "version": "https://jsonfeed.org/version/1",
    "title": "code-corner.dev • All posts by \"patterns\" tag",
    "description": "",
    "home_page_url": "https://code-corner.dev",
    "items": [
        {
            "id": "https://code-corner.dev/2022/08/13/Immutability-and-Entity-Framework-Core/",
            "url": "https://code-corner.dev/2022/08/13/Immutability-and-Entity-Framework-Core/",
            "title": "Immutability and Entity Framework Core",
            "date_published": "2022-08-12T23:00:00.000Z",
            "content_html": "<p>Nowadays, when implementing a .NET application that works directly with a database (relational or not), most developers will chose Entity Framework Core to abstract their data layer and work directly with entity classes.</p>\n<p>It has become an integral part of the .NET ecosystem, just like ASP.NET, and it is extremely rare finding someone that never worked with it. I’ve been using it myself ever since version 4 (along with other ORMs) and I must say that it <em><strong>aged like a fine wine</strong></em>.</p>\n<p>Fully open sourced, with support for multiple databases (not just SQL Server) while offering relatively optimized and extensible conversion from LINQ to database queries, accessing data from a .NET application never been easier. And when it doesn’t support something, <a href=\"/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/\" title=\"Integrating Dapper with Entity Framework Core\">just integrate with some micro ORM and go crazy on that SQL</a>!</p>\n<p>One core feature is the implementation of the unit of work pattern by supporting, what is usually called, a first level cache. Load a bunch of entities from the database, that will be tracked in memory by the context, mutate or delete them, create new ones and then flush everything in a single database access.</p>\n<p>The thing about this feature, despite working fine most of the time, is that it depends on managing internal state with mutable entities. After all, it was originally focused on C# developers that were used to work in a object-oriented way — get an entity, change some properties, request an update.</p>\n<p><strong>But what if you are a C# developer and prefer the advantages provided by immutability?</strong></p>\n<p>Lets look at the most used immutable class in the .NET world — the string.</p>\n<p>We all know that working with text can be memory inefficient if badly managed, but imagine a world were you could initialize a string with the name “Bruce Wayne”, pass it as an argument to some method that was supposed to count how many words were in it, and when you realize, your original string contains the name “Peter Parker” because the strings were mutable and nothing could prevent that?</p>\n<p>In this article I won’t enter into details about the advantages of immutable over mutable objects, and vice versa. There are great articles already explaining both visions and we all know no size fits all, so it kinda depends of your current needs.</p>\n<p>But I’m going to explain how you can use immutable entities directly with Entity Framework Core so you know that not only it is possible but also a viable option.</p>\n<hr>\n<h1 id=\"Immutable-entities-in-C\"><a href=\"#Immutable-entities-in-C\" class=\"headerlink\" title=\"Immutable entities in C#\"></a>Immutable entities in C#</h1><p>Before C# 9 the only way to create an immutable entity was to define a class or structure with <em>getter only properties</em> that were initialized during object construction, ensuring nothing could be changed afterwards.</p>\n<p>As an example, a <code>PersonEntity</code> would look like this:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">PersonEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PersonEntity</span>(<span class=\"params\"><span class=\"built_in\">string</span> forename, <span class=\"built_in\">string</span> surname, <span class=\"built_in\">string</span>? middleNames = <span class=\"literal\">null</span>, DateOnly? birthdate = <span class=\"literal\">null</span></span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Forename = forename;</span><br><span class=\"line\">        Surname = surname;</span><br><span class=\"line\">        MiddleNames = middleNames;</span><br><span class=\"line\">        Birthdate = birthdate;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Forename &#123; <span class=\"keyword\">get</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Surname &#123; <span class=\"keyword\">get</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span>? MiddleNames &#123; <span class=\"keyword\">get</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateOnly? Birthdate &#123; <span class=\"keyword\">get</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>It works as expected but there is one major problem: just by looking at the code, the developer cannot tell which properties are being set unless argument names are used and, if it wants to change something, it must copy every property by hand.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> person = <span class=\"keyword\">new</span> PersonEntity(</span><br><span class=\"line\">    <span class=\"string\">&quot;Bruce&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;Wayne&quot;</span></span><br><span class=\"line\">);</span><br><span class=\"line\">person = <span class=\"keyword\">new</span> PersonEntity(</span><br><span class=\"line\">    person.Forename,</span><br><span class=\"line\">    person.Surname,</span><br><span class=\"line\">    <span class=\"string\">&quot;Thomas&quot;</span>,</span><br><span class=\"line\">    <span class=\"keyword\">new</span> DateOnly(<span class=\"number\">1972</span>, <span class=\"number\">02</span>, <span class=\"number\">19</span>)</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n\n<p>For small POCOs this may not be a problem, but for bigger ones the chances of someone making a mistake increases.</p>\n<p>With this in mind, Microsoft implemented <a href=\"https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/init\">init only setters</a> supporting object initializers while still preventing changes afterwards. Couple this with <a href=\"https://docs.microsoft.com/en-us/dotnet/csharp/whats-new/tutorials/records\">record types</a>, and creating immutable entities has never been easier in C#.</p>\n<p>The same PersonEntity, but now using both of these features:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">record</span> <span class=\"title\">PersonEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Forename &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Surname &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span>? MiddleNames &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateOnly? Birthdate &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Not only the syntax is more concise by using auto-implemented properties, you can now easily tell which properties are being set during initialization and have a much easier life copying data by using the keyword with and only state which properties must change.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> person = <span class=\"keyword\">new</span> PersonEntity</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    Forename = <span class=\"string\">&quot;Bruce&quot;</span>,</span><br><span class=\"line\">    Surname = <span class=\"string\">&quot;Wayne&quot;</span>,</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">person = person <span class=\"keyword\">with</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    MiddleNames = <span class=\"string\">&quot;Thomas&quot;</span>,</span><br><span class=\"line\">    Birthdate = <span class=\"keyword\">new</span> DateOnly(<span class=\"number\">1972</span>, <span class=\"number\">02</span>, <span class=\"number\">19</span>),</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Change-Tracking-and-immutability\"><a href=\"#Change-Tracking-and-immutability\" class=\"headerlink\" title=\"Change Tracking and immutability\"></a>Change Tracking and immutability</h1><p>Every developer that uses Entity Framework knows it provides a lot of database abstractions to enable working directly with .NET objects.</p>\n<p><a href=\"https://docs.microsoft.com/en-us/ef/core/change-tracking\">One core feature is the automatic detection of changes made to entities</a>. This usually means interacting with the context to get an existing entity, change some properties and then invoke <code>SaveChangesAsync</code> which will generate a bunch of instructions and execute them into the database. Under the hood, when the entity is retrieved from the context it will keep a reference to the instance and original values from the database and when the developer requests the context to save changes, all properties of tracked entities will be compared and if anything changed, instructions will be generated and executed.</p>\n<p>This works well for mutable entities but we are implementing immutability, and since no changes will be made to tracked entities, will this cause any issues?</p>\n<p>Let’s imagine the following use case:</p>\n<ul>\n<li>You retrieve our <em>Bruce Wayne</em> from the database using an EF Core context, which internally will keep a reference to it;</li>\n<li>You want to change it’s birthdate, so you clone it while assigning a new date;</li>\n<li>If you invoke <code>SaveChangesAsync</code>, nothing will happen because no changes happened to the original entity;</li>\n<li>If you invoke <code>Update</code>, an <code>InvalidOperationException</code> will be thrown because the context is already tracking an entity with the same primary key;</li>\n</ul>\n<p>Certainly invoking <code>SaveChangesAsync</code> and nothing happening was expected, after all we created a copy of the original instance, which EF Core knows nothing about and would never automatically detect changes, but why the exception when trying to attach the entity to the context?</p>\n<p>This leads to another EF Core feature, called <a href=\"https://docs.microsoft.com/en-us/ef/core/change-tracking/identity-resolution\">Identity Resolution</a>, strongly correlated to our change tracking.</p>\n<p><em>Identity Resolution</em> ensures the same entity is retrieved for the same primary key while being tracked. This is a requirement when implementing the Unit of Work pattern because EF Core only flushes data when <code>SaveChangesAsync</code> is invoked.</p>\n<p>Again, let’s imagine our <code>PersonEntity</code> was a mutable class:</p>\n<ul>\n<li>You retrieve our <em>Bruce Wayne</em> from the database using an EF Core context, which internally will keep a reference to it, also identified by its primary key;</li>\n<li>You change its birthdate;</li>\n<li>You do some more work;</li>\n<li>You try to get it again from the EF Core context but since that primary key its already being tracked, it returns the same instance instead of going to the database and returning old data for your Unit of Work operation;</li>\n<li>You change more properties;</li>\n<li>Invoke <code>SaveChangesAsync</code>, flushing changes and now both the instance and database have the same data;</li>\n</ul>\n<p>As you can see, <em>Identity Resolution</em> is important for mutable entities, but not so much for our use case and it’s a problem we must solve.</p>\n<hr>\n<h1 id=\"The-project\"><a href=\"#The-project\" class=\"headerlink\" title=\"The project\"></a>The project</h1><p>It seems the only thing preventing an immutable approach to database access while using EF Core is not relying on <em>Change Tracking</em> for mutations while preventing <em>Identity Resolution</em> problems.</p>\n<p>Let’s create a C# console application that will use Entity Framework Core to store data into a SQLite database, using immutable <code>record</code> entities.</p>\n<p>The source code is available on <a href=\"https://github.com/gravity00/efcore-immutability\">GitHub</a>, feel free to give it a look.</p>\n<h2 id=\"Setup\"><a href=\"#Setup\" class=\"headerlink\" title=\"Setup\"></a>Setup</h2><p>Start by opening Visual Studio and creating a <strong>.NET 6.0 Console Application</strong> with a name at any location you prefer.</p>\n<img src=\"/2022/08/13/Immutability-and-Entity-Framework-Core/01_project_create.png\" class=\"\">\n\n<p>Install most recent versions of Entity Framework Core for SQLite and Microsoft hosting nugets:</p>\n<ul>\n<li><code>Microsoft.Extensions.Hosting</code></li>\n<li><code>Microsoft.EntityFrameworkCore.Sqlite</code></li>\n</ul>\n<img src=\"/2022/08/13/Immutability-and-Entity-Framework-Core/02_nugets.png\" class=\"\">\n\n<p>Create a <code>ProgramHost</code> class implementing <code>IHostedService</code>. This class will run our exemple code, but for now just inject a logger and write something inside the <code>StartAsync</code> method. We’ll do nothing in the <code>StopAsync</code> method, so just return a completed task.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProgramHost</span> : <span class=\"title\">IHostedService</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ILogger&lt;ProgramHost&gt; _logger;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProgramHost</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        ILogger&lt;ProgramHost&gt; logger</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger = logger;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">StartAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger.LogInformation(<span class=\"string\">&quot;I&#x27;m alive!&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Task <span class=\"title\">StopAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span> =&gt; Task.CompletedTask;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Program.cs</code> file, build an host with our <code>ProgramHost</code> class registered as a hosted service.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">var</span> host = Host.CreateDefaultBuilder()</span><br><span class=\"line\">    .ConfigureServices(services =&gt;</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddHostedService&lt;ProgramHost&gt;();</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    .Build();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> host.RunAsync();</span><br></pre></td></tr></table></figure>\n\n<p>If you configured everything correctly and run the application, you should see something like this:</p>\n<img src=\"/2022/08/13/Immutability-and-Entity-Framework-Core/03_setup_logs.png\" class=\"\">\n\n<h2 id=\"The-database-model\"><a href=\"#The-database-model\" class=\"headerlink\" title=\"The database model\"></a>The database model</h2><p>For simplicity, we’ll have a single Persons table:</p>\n<ul>\n<li><strong>Id</strong> — identity column to uniquely identify the row (required);</li>\n<li><strong>Forename</strong> — stores the first name (text, required);</li>\n<li><strong>Surname</strong> — stores the last name (text, required);</li>\n<li><strong>MiddleNames</strong> — stores the middle names (text, optional);</li>\n<li><strong>Birthdate</strong> — stores the date of birth (date, optional);</li>\n</ul>\n<p>When representing database entities, I always create a base class containing properties to be defined in all entities (like the unique identifier or some metadata columns), and for the rest I always use positional records syntax for required properties and auto-properties for optional ones, making clear to the developer which ones must be always provided (this also removes compiler warnings if the project is configured for nullable reference types).</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> Base class for all database entities</span></span><br><span class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">record</span> <span class=\"title\">Entity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></span><br><span class=\"line\">    <span class=\"comment\"><span class=\"doctag\">///</span> Unique identifier</span></span><br><span class=\"line\">    <span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> Representation of a person</span></span><br><span class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=&quot;Forename&quot;&gt;</span>Person first name<span class=\"doctag\">&lt;/param&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;param name=&quot;Surname&quot;&gt;</span>Person last name<span class=\"doctag\">&lt;/param&gt;</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">record</span> <span class=\"title\">PersonEntity</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    <span class=\"built_in\">string</span> Forename,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    <span class=\"built_in\">string</span> Surname</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>) : Entity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></span><br><span class=\"line\">    <span class=\"comment\"><span class=\"doctag\">///</span> Person middle names, separated by spaces</span></span><br><span class=\"line\">    <span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span>? MiddleNames &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;summary&gt;</span></span></span><br><span class=\"line\">    <span class=\"comment\"><span class=\"doctag\">///</span> Person date of birth</span></span><br><span class=\"line\">    <span class=\"comment\"><span class=\"doctag\">///</span> <span class=\"doctag\">&lt;/summary&gt;</span></span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateOnly? Birthdate &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If you prefer to keep everything more compact, feel free to use <em>positional records</em> with default values for optional properties.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">record</span> <span class=\"title\">PersonEntity</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    <span class=\"built_in\">string</span> Forename,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    <span class=\"built_in\">string</span> Surname,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    <span class=\"built_in\">string</span>? MiddleNames = <span class=\"literal\">null</span>,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    DateOnly? Birthdate = <span class=\"literal\">null</span></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>) : Entity</span>;</span><br></pre></td></tr></table></figure>\n\n<p>This is the most compact syntax, but be careful when adding new optional properties if your are sharing <em>records</em> across multiple applications. It will also be considered a breaking change unless you define both constructors, effectively losing this compact syntax. That’s the reason I don’t use <em>positional record syntax</em> for everything, but it kinda depends on your needs.</p>\n<p>Now, lets create our EF Core context with <code>Persons</code> table mappings.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SampleDbContext</span> : <span class=\"title\">DbContext</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SampleDbContext</span>(<span class=\"params\">DbContextOptions&lt;SampleDbContext&gt; options</span>)</span></span><br><span class=\"line\"><span class=\"function\">        : <span class=\"title\">base</span>(<span class=\"params\">options</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">OnModelCreating</span>(<span class=\"params\">ModelBuilder builder</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">base</span>.OnModelCreating(builder);</span><br><span class=\"line\"></span><br><span class=\"line\">        builder.Entity&lt;PersonEntity&gt;(cfg =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            cfg.ToTable(<span class=\"string\">&quot;Persons&quot;</span>);</span><br><span class=\"line\">            cfg.HasKey(e =&gt; e.Id);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Id)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .ValueGeneratedOnAdd();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Forename)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">64</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Surname)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">64</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.MiddleNames)</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">256</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Birthdate);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Program.cs</code> file and register the EF Core context into the container. This is a test console, so I’ll use the temporary folder to store the SQLite file but feel free to use any other location and file name.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">var</span> host = Host.CreateDefaultBuilder()</span><br><span class=\"line\">    .ConfigureServices(services =&gt;</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddDbContext&lt;SampleDbContext&gt;(options =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> connectionString = <span class=\"keyword\">new</span> SqliteConnectionStringBuilder</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                DataSource = Path.Combine(</span><br><span class=\"line\">                    Path.GetTempPath(),</span><br><span class=\"line\">                    <span class=\"string\">&quot;efcore-immutability-sample.sqlite3&quot;</span></span><br><span class=\"line\">                )</span><br><span class=\"line\">            &#125;.ConnectionString;</span><br><span class=\"line\">            options.UseSqlite(connectionString);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        services.AddHostedService&lt;ProgramHost&gt;();</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    .Build();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> host.RunAsync();</span><br></pre></td></tr></table></figure>\n\n<p>Now inject the context into the <code>ProgramHost</code> class and, since this is a test console and we want to freely modify our entities without much thought, change the <code>StartAsync</code> method to always drop and recreate the database on startup.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProgramHost</span> : <span class=\"title\">IHostedService</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ILogger&lt;ProgramHost&gt; _logger;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> SampleDbContext _context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProgramHost</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        ILogger&lt;ProgramHost&gt; logger,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        SampleDbContext context</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger = logger;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">StartAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Ensuring database is in a clean state&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.Database.EnsureDeletedAsync(ct);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.Database.EnsureCreatedAsync(ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Task <span class=\"title\">StopAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span> =&gt; Task.CompletedTask;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If you run the application and open the SQLite database file (using DB Browser for SQLite or equivalent), both a <code>Persons</code> and <code>sqlite_sequence</code> tables should be defined.</p>\n<img src=\"/2022/08/13/Immutability-and-Entity-Framework-Core/04_db_setup.png\" class=\"\">\n\n<h2 id=\"Configuring-for-immutability\"><a href=\"#Configuring-for-immutability\" class=\"headerlink\" title=\"Configuring for immutability\"></a>Configuring for immutability</h2><p>Now that we have a working solution lets recall what we need to achieve to support immutability:</p>\n<ul>\n<li>Not relying on <em>Change Tracking</em> to know which instructions must be executed when <code>SaveChangesAsync</code> is invoked;</li>\n<li>Preventing <em>Identity Resolution</em> exceptions;</li>\n</ul>\n<p>Because <em>Change Tracking</em> is such a core feature in Entity Framework Core, you can only disable it when querying for entities.</p>\n<p>As stated in Microsoft <a href=\"https://docs.microsoft.com/en-us/ef/core/querying/tracking\">documentation</a>, we can disable it in three ways:</p>\n<ul>\n<li>Using extension method <code>AsNoTracking</code> for each query;</li>\n<li>Setting context property <code>ChangeTracker.QueryTrackingBehavior</code> to <code>NoTracking</code>;</li>\n<li>Global configuration with method <code>UseQueryTrackingBehavior</code>;</li>\n</ul>\n<p>Open <code>Program.cs</code> file and disable it globally, ensuring will never be tracked when queried from the database.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">var</span> host = Host.CreateDefaultBuilder()</span><br><span class=\"line\">    .ConfigureServices(services =&gt;</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddDbContext&lt;SampleDbContext&gt;(options =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> connectionString = <span class=\"keyword\">new</span> SqliteConnectionStringBuilder</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                DataSource = Path.Combine(</span><br><span class=\"line\">                    Path.GetTempPath(),</span><br><span class=\"line\">                    <span class=\"string\">&quot;efcore-immutability-sample.sqlite3&quot;</span></span><br><span class=\"line\">                )</span><br><span class=\"line\">            &#125;.ConnectionString;</span><br><span class=\"line\">            options.UseSqlite(connectionString)</span><br><span class=\"line\">                .UseQueryTrackingBehavior(QueryTrackingBehavior.NoTracking);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        services.AddHostedService&lt;ProgramHost&gt;();</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    .Build();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> host.RunAsync();</span><br></pre></td></tr></table></figure>\n\n<p>In theory, if you only made a single entity operation per unit of work, like getting a person by unique identifier, changing its middle names and doing an update, this configuration would be enough.</p>\n<p>Sadly we all know development is far from perfect and more complex applications, due to business requirements, may lead to multiple updates to the same data in a single unit of work operation. That’s one of the major reasons behind <em>Change Tracking</em> in EF Core, to implement the unit of work pattern while not relying on database ACID implementations and reducing the time transactions stays open.</p>\n<p>This means every time an entity is added, updated or removed using the context, an internal reference will be kept and <em>Identity Resolution</em> exceptions will be thrown if someone tries to attach an entity with the same id.</p>\n<p>There are multiple ways to solve this problem but the easiest one is to enforce a transaction, flush changes to the database every time a create, update or delete is requested and then detach the entity.</p>\n<p>Since this is a proof of concept application, I’m going to implementing this behavior with extension methods over <code>DbContext</code> instances, but feel free to wrap it into a repository pattern or any way you prefer.</p>\n<p>Create a static class <code>DbContextExtensions</code> and implement a generic extension that will receive an entity and the state to be tracked, returning an updated entity.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title\">DbContextExtensions</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TEntity</span>&gt; <span class=\"title\">SaveEntityStateAsync</span>&lt;<span class=\"title\">TEntity</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"keyword\">this</span> DbContext context,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TEntity entity,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        EntityState state,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TEntity : Entity</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (context == <span class=\"literal\">null</span>) <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ArgumentNullException(<span class=\"keyword\">nameof</span>(context));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (entity == <span class=\"literal\">null</span>) <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ArgumentNullException(<span class=\"keyword\">nameof</span>(entity));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> entry = context.Entry(entity);</span><br><span class=\"line\">        entry.State = state;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> context.SaveChangesAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        entry.State = EntityState.Detached;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> entry.Entity;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The method creates an <code>EntityEntry&lt;TEntity&gt;</code>, changes the state to the one provided and immediately requests to flush changes. Because the context is now tracking the entity, it will execute a database instruction based on the entry state (<code>Added|Modified|Deleted</code>). Then, it detaches the entity right before returning to prevent <em>Identity Resolution</em> exceptions on future mutations and returns the entity with the most recent values (usefull to get values generated by the database, like an identity column).</p>\n<p>Open the <code>ProgramHost</code> class and create some test code using the extension method and the immutable <code>PersonEntity</code>. In this case I’m creating <em>Bruce Wayne</em> and then updating both birthdate and middle name.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProgramHost</span> : <span class=\"title\">IHostedService</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ILogger&lt;ProgramHost&gt; _logger;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> SampleDbContext _context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProgramHost</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        ILogger&lt;ProgramHost&gt; logger,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        SampleDbContext context</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger = logger;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">StartAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Setting database to a clean state&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.Database.EnsureDeletedAsync(ct);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.Database.EnsureCreatedAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Creating an explicit database transaction&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> tx = <span class=\"keyword\">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Adding person&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">var</span> person = <span class=\"keyword\">await</span> _context.SaveEntityStateAsync(<span class=\"keyword\">new</span> PersonEntity(</span><br><span class=\"line\">            Forename: <span class=\"string\">&quot;Bruce&quot;</span>,</span><br><span class=\"line\">            Surname: <span class=\"string\">&quot;Wayne&quot;</span></span><br><span class=\"line\">        ), EntityState.Added, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Updating person&#x27;s birthdate&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.SaveEntityStateAsync(person <span class=\"keyword\">with</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            MiddleNames = <span class=\"string\">&quot;Thomas&quot;</span>,</span><br><span class=\"line\">            Birthdate = <span class=\"keyword\">new</span> DateOnly(<span class=\"number\">1972</span>, <span class=\"number\">02</span>, <span class=\"number\">19</span>)</span><br><span class=\"line\">        &#125;, EntityState.Modified, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Commiting database transaction&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> tx.CommitAsync(ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Task <span class=\"title\">StopAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span> =&gt; Task.CompletedTask;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If you execute the code, you’ll see database instructions being sent to SQLite by Entity Framework Core to insert and then update the entity.</p>\n<img src=\"/2022/08/13/Immutability-and-Entity-Framework-Core/05_logs_entity_mutate.png\" class=\"\">\n\n<p>Open the SQLite file and you’ll see <em>Bruce Wayne</em> was both created and updated with a birthdate and middle name.</p>\n<img src=\"/2022/08/13/Immutability-and-Entity-Framework-Core/06_db_persons_table.png\" class=\"\">\n\n<p>Certainly you don’t want to be writing <code>EntityState.Added|Updated|Deleted</code> every time an entity needs to be manipulated, so lets create dedicated extensions for each operation and update your test code.</p>\n<p>Change the method to <code>private</code> and implement a <code>CreateAsync</code>, <code>UpdateAsync</code> and <code>DeleteAsync</code> extension methods that will reuse the existing one.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title\">DbContextExtensions</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TEntity</span>&gt; <span class=\"title\">CreateAsync</span>&lt;<span class=\"title\">TEntity</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"keyword\">this</span> DbContext context,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TEntity entity,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TEntity : Entity</span> =&gt; <span class=\"keyword\">await</span> context.SaveEntityStateAsync(</span><br><span class=\"line\">        entity,</span><br><span class=\"line\">        EntityState.Added,</span><br><span class=\"line\">        ct</span><br><span class=\"line\">    );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TEntity</span>&gt; <span class=\"title\">UpdateAsync</span>&lt;<span class=\"title\">TEntity</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"keyword\">this</span> DbContext context,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TEntity entity,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TEntity : Entity</span> =&gt; <span class=\"keyword\">await</span> context.SaveEntityStateAsync(</span><br><span class=\"line\">        entity,</span><br><span class=\"line\">        EntityState.Modified,</span><br><span class=\"line\">        ct</span><br><span class=\"line\">    );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">async</span> Task <span class=\"title\">DeleteAsync</span>&lt;<span class=\"title\">TEntity</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"keyword\">this</span> DbContext context,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TEntity entity,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TEntity : Entity</span> =&gt; <span class=\"keyword\">await</span> context.SaveEntityStateAsync(</span><br><span class=\"line\">        entity,</span><br><span class=\"line\">        EntityState.Deleted,</span><br><span class=\"line\">        ct</span><br><span class=\"line\">    );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TEntity</span>&gt; <span class=\"title\">SaveEntityStateAsync</span>&lt;<span class=\"title\">TEntity</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"keyword\">this</span> DbContext context,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TEntity entity,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        EntityState state,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TEntity : Entity</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (context == <span class=\"literal\">null</span>) <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ArgumentNullException(<span class=\"keyword\">nameof</span>(context));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (entity == <span class=\"literal\">null</span>) <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ArgumentNullException(<span class=\"keyword\">nameof</span>(entity));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> entry = context.Entry(entity);</span><br><span class=\"line\">        entry.State = state;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> context.SaveChangesAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        entry.State = EntityState.Detached;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> entry.Entity;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>Use the new methods in our <code>ProgramHost</code> class.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProgramHost</span> : <span class=\"title\">IHostedService</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ILogger&lt;ProgramHost&gt; _logger;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> SampleDbContext _context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProgramHost</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        ILogger&lt;ProgramHost&gt; logger,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        SampleDbContext context</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger = logger;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">StartAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Setting database to a clean state&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.Database.EnsureDeletedAsync(ct);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.Database.EnsureCreatedAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Creating an explicit database transaction&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> tx = <span class=\"keyword\">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Adding person&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">var</span> person = <span class=\"keyword\">await</span> _context.CreateAsync(<span class=\"keyword\">new</span> PersonEntity(</span><br><span class=\"line\">            Forename: <span class=\"string\">&quot;Bruce&quot;</span>,</span><br><span class=\"line\">            Surname: <span class=\"string\">&quot;Wayne&quot;</span></span><br><span class=\"line\">        ), ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Updating person&#x27;s birthdate&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.UpdateAsync(person <span class=\"keyword\">with</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            MiddleNames = <span class=\"string\">&quot;Thomas&quot;</span>,</span><br><span class=\"line\">            Birthdate = <span class=\"keyword\">new</span> DateOnly(<span class=\"number\">1972</span>, <span class=\"number\">02</span>, <span class=\"number\">19</span>)</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        _logger.LogDebug(<span class=\"string\">&quot;Commiting database transaction&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> tx.CommitAsync(ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Task <span class=\"title\">StopAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span> =&gt; Task.CompletedTask;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use Entity Framework Core to abstract your application from the database while still implementing the immutable design pattern to manage application state.</p>\n<p>There are both advantages and disadvantages of using immutable entities over mutable ones, after all no size fits all, but I think its nice to know you have the option to use it without sacrificing productivity by having to implement database access yourself. As long you ensure <em>Change Tracking</em> is disabled for all queries and every code uses your abstractions to create, update or delete entities, everything will work just fine.</p>\n<p>Just a small note about explicit database transactions. If you are implementing an ASP.NET Core application and using the mediator pattern, some time ago I created a bunch of articles and one of them provided an approach to <a href=\"/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/\" title=\"Transaction Management With Mediator Pipelines in ASP.NET Core\">manage Entity Framework Core transactions globally using a pipeline</a>. I use that approach all the time, you may find it helpful too.</p>\n",
            "tags": [
                "dotnetcore",
                "csharp",
                "patterns",
                "efcore"
            ]
        },
        {
            "id": "https://code-corner.dev/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/",
            "url": "https://code-corner.dev/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/",
            "title": "Auditing with Mediator Pipelines in ASP.NET Core",
            "date_published": "2020-11-25T00:00:00.000Z",
            "content_html": "<p>When implementing a web application, it can be a good idea to enforce some kind of auditing to all of your client interactions, either to track their behavior over time, to ensure any security breach will be properly logged, or just to help analyze system bugs.</p>\n<p>Previously we talked about using the mediator pattern to implement the <strong>Command Query Responsibility Segregation (CQRS)</strong> and <strong>Event Sourcing (ES)</strong> and how pipelines could be used to implement transversal behavior to your application.</p>\n<p>Since commands are responsible to mutate the system state, in this article I’m going to demonstrate how you could implement an audit pipeline to ensure all commands will be stored into a table. Because a variable number of events can be broadcasted when the state changes, the pipeline will also store them into another table and with a reference to the command, ensuring any correlation can be analyzed.</p>\n<hr>\n<h1 id=\"The-project\"><a href=\"#The-project\" class=\"headerlink\" title=\"The project\"></a>The project</h1><p>From my previous articles, were I explained how to use the mediator and implement transversal behavior with pipelines, we are going to continue and expand the source code to audit commands and store into the events table anything broadcasted by the mediator without having a specific handler for each event.</p>\n<p>As a reminder, we implemented an endpoint to manage products with the following:</p>\n<p>GET &#x2F;products — search for products using some filters (<code>SearchProductsQuery</code>);<br>GET &#x2F;products&#x2F;{id} — get a product by its unique identifier (<code>GetProductByIdQuery</code>);<br>POST &#x2F;products — create a product (<code>CreateProductCommand</code> and <code>CreatedProductEvent</code>);<br>PUT &#x2F;products&#x2F;{id} — update a product by its unique identifier (<code>UpdateProductCommand</code> and <code>UpdatedProductEvent</code>);<br>DELETE &#x2F;products&#x2F;{id} — delete a product by its unique identifier (<code>DeleteProductCommand</code> and <code>DeletedProductEvent</code>);</p>\n<p>You can check them out here:</p>\n<ul>\n<li><a href=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/\" title=\"Mediator Pattern in ASP.NET Core Applications\">Mediator Pattern in ASP.NET Core Applications</a></li>\n<li><a href=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Using Mediator Pipelines in ASP.NET Core Applications\">Using Mediator Pipelines in ASP.NET Core Applications</a></li>\n<li><a href=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Validation with Mediator Pipelines in ASP.NET Core Applications\">Validation with Mediator Pipelines in ASP.NET Core Applications</a></li>\n<li><a href=\"/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/\" title=\"Transaction Management With Mediator Pipelines in ASP.NET Core\">Transaction Management With Mediator Pipelines in ASP.NET Core</a></li>\n</ul>\n<p>The source code is available on <a href=\"https://github.com/gravity00/IntroductionMediatorCQRS\">GitHub</a>, feel free to give it a look.</p>\n<h1 id=\"Auditing\"><a href=\"#Auditing\" class=\"headerlink\" title=\"Auditing\"></a>Auditing</h1><p>Since in this article we will only audit API actions that mutate state, we are going to intercept commands and store information we find relevant into a specific table:</p>\n<ul>\n<li><strong>ExternalId</strong> — the unique identifier for each command, available via <code>Command.Id</code> or <code>Command&lt;TResult&gt;.Id</code>;</li>\n<li><strong>Name</strong> — the command type name from <code>typeof(TCommand).Name</code>;</li>\n<li><strong>Payload</strong> — the command serialized as JSON;</li>\n<li><strong>Result</strong> — if available, the command result serialized as JSON;</li>\n<li><strong>CreatedOn</strong> — date and time when the command was sent into the mediator, available via <code>Command.CreatedOn</code> or <code>Command&lt;TResult&gt;.CreatedOn</code>;</li>\n<li><strong>CreatedBy</strong> — username from the current request user property, available via <code>Command.CreatedBy</code> or <code>Command&lt;TResult&gt;.CreatedBy</code>;</li>\n<li><strong>ExecutionTime</strong> — elapsed time the handler spent processing the command;</li>\n</ul>\n<p>Because events are broadcasted by commands, which are now audited into the database, we are also going to extend the events table and introduce the foreign key <code>CommandId</code>, referencing the commands.</p>\n<h1 id=\"The-Database-Model\"><a href=\"#The-Database-Model\" class=\"headerlink\" title=\"The Database Model\"></a>The Database Model</h1><p>Inside the <code>Database</code> folder create a <code>CommandEntity</code> class and add the new <code>CommandId</code> property to the existing <code>EventEntity</code>:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CommandEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Result &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> TimeSpan ExecutionTime &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">EventEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> CommandId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125; <span class=\"comment\">// added property</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>ApiDbContext</code> file, configure the mappings for the <code>CommandEntity</code> and add a required one-to-many relation between this tables:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ApiDbContext</span> : <span class=\"title\">DbContext</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">OnModelCreating</span>(<span class=\"params\">ModelBuilder builder</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">        builder.Entity&lt;CommandEntity&gt;(cfg =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            cfg.HasKey(e =&gt; e.Id);</span><br><span class=\"line\">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class=\"line\">            cfg.HasIndex(e =&gt; e.CreatedOn);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Id)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .ValueGeneratedOnAdd();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.ExternalId)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Name)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Payload)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Result);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedOn)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedBy)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.ExecutionTime)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        builder.Entity&lt;EventEntity&gt;(cfg =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            cfg.HasKey(e =&gt; e.Id);</span><br><span class=\"line\">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class=\"line\">            cfg.HasIndex(e =&gt; e.CreatedOn);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Id)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .ValueGeneratedOnAdd();</span><br><span class=\"line\">            cfg.HasOne&lt;CommandEntity&gt;()</span><br><span class=\"line\">                .WithMany()</span><br><span class=\"line\">                .HasForeignKey(e =&gt; e.CommandId)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.ExternalId)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Name)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Payload)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedOn)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedBy)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"User-Information\"><a href=\"#User-Information\" class=\"headerlink\" title=\"User Information\"></a>User Information</h1><p>By design, all POCOs provided in this library are immutable and only provide a protected setter for the properties <code>Id</code>, <code>CreatedOn</code> and <code>CreatedBy</code>. This ensures the developer is free to decide either by immutable commands, queries and events, initializing all properties in the constructor, or to expose a public setter instead.</p>\n<p>Since we haven’t made our POCOs immutable, and for demo purposes, we are going to expose a public setter for the <code>CreatedBy</code> property by implementing our own command, query and event classes.</p>\n<p>Inside the <code>Handlers</code> folder create a <code>Command.cs</code>, <code>Query.cs</code> and <code>Event.cs</code> files and extend the corresponding <code>Command</code>, <code>Command&lt;TResult&gt;</code>, <code>Query&lt;TResult&gt;</code> and <code>Event</code> classes, creating a new setter ao getter for <code>CreatedBy</code>. Since your classes have the same name than the ones provided by <code>Simplesoft.Mediator</code>, your existing classes will automatically extend from them and expose the new setters without a single change:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Command</span> : <span class=\"title\">SimpleSoft.Mediator.Command</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">new</span> <span class=\"built_in\">string</span> CreatedBy</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">get</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy;</span><br><span class=\"line\">        <span class=\"keyword\">set</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy = <span class=\"keyword\">value</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Command</span>&lt;<span class=\"title\">TResult</span>&gt; : <span class=\"title\">SimpleSoft.Mediator.Command</span>&lt;<span class=\"title\">TResult</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">new</span> <span class=\"built_in\">string</span> CreatedBy</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">get</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy;</span><br><span class=\"line\">        <span class=\"keyword\">set</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy = <span class=\"keyword\">value</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Event</span> : <span class=\"title\">SimpleSoft.Mediator.Event</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">new</span> <span class=\"built_in\">string</span> CreatedBy</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">get</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy;</span><br><span class=\"line\">        <span class=\"keyword\">set</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy = <span class=\"keyword\">value</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Query</span>&lt;<span class=\"title\">TResult</span>&gt; : <span class=\"title\">SimpleSoft.Mediator.Query</span>&lt;<span class=\"title\">TResult</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">new</span> <span class=\"built_in\">string</span> CreatedBy</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">get</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy;</span><br><span class=\"line\">        <span class=\"keyword\">set</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy = <span class=\"keyword\">value</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The project solution should look like this:</p>\n<img src=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/01_project_structure_auditing.png\" class=\"\">\n\n<p>Open your <code>ProductsController.cs</code> file and set the CreatedBy property of all the commands and queries with the property <code>User.Identity.Name</code>.</p>\n<p>Please keep in your mind that, since we haven’t configured authentication in this API, the username value will always be null.</p>\n<p>After changes, your controller actions should look as follows:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;products&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProductsController</span>(<span class=\"params\">IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet</span>]</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;IEnumerable&lt;ProductModel&gt;&gt; SearchAsync([FromQuery] <span class=\"built_in\">string</span> filterQ, [FromQuery] <span class=\"built_in\">int</span>? skip, [FromQuery] <span class=\"built_in\">int</span>? take, CancellationToken ct)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.FetchAsync(<span class=\"keyword\">new</span> SearchProductsQuery</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            FilterQ = filterQ,</span><br><span class=\"line\">            Skip = skip,</span><br><span class=\"line\">            Take = take,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result.Select(r =&gt; <span class=\"keyword\">new</span> ProductModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = r.Id,</span><br><span class=\"line\">            Code = r.Code,</span><br><span class=\"line\">            Name = r.Name,</span><br><span class=\"line\">            Price = r.Price</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;ProductModel&gt; <span class=\"title\">GetByIdAsync</span>(<span class=\"params\">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.FetchAsync(<span class=\"keyword\">new</span> GetProductByIdQuery</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ProductId = id,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ProductModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = result.Id,</span><br><span class=\"line\">            Code = result.Code,</span><br><span class=\"line\">            Name = result.Name,</span><br><span class=\"line\">            Price = result.Price</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpPost</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResultModel&gt; <span class=\"title\">CreateAsync</span>(<span class=\"params\">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.SendAsync(<span class=\"keyword\">new</span> CreateProductCommand</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Code = model.Code,</span><br><span class=\"line\">            Name = model.Name,</span><br><span class=\"line\">            Price = model.Price,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CreateProductResultModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = result.Id</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpPut(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">UpdateAsync</span>(<span class=\"params\">[FromRoute] Guid id, [FromBody] UpdateProductModel model, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _mediator.SendAsync(<span class=\"keyword\">new</span> UpdateProductCommand</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ProductId = id,</span><br><span class=\"line\">            Code = model.Code,</span><br><span class=\"line\">            Name = model.Name,</span><br><span class=\"line\">            Price = model.Price,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpDelete(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">DeleteAsync</span>(<span class=\"params\">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _mediator.SendAsync(<span class=\"keyword\">new</span> DeleteProductCommand</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ProductId = id,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>We also want to pass the same username to all of our events, so open the command handlers and set the event <code>CreatedBy</code> property with the same value from the command, as exemplified by the following handler:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductCommandHandler</span> : <span class=\"title\">ICommandHandler</span>&lt;<span class=\"title\">CreateProductCommand</span>, <span class=\"title\">CreateProductResult</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreateProductCommandHandler</span>(<span class=\"params\">ApiDbContext context, IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResult&gt; <span class=\"title\">HandleAsync</span>(<span class=\"params\">CreateProductCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">await</span> products.AnyAsync(p =&gt; p.Code == cmd.Code, ct))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">$&quot;Product code &#x27;<span class=\"subst\">&#123;cmd.Code&#125;</span>&#x27; already exists&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> externalId = Guid.NewGuid();</span><br><span class=\"line\">        <span class=\"keyword\">await</span> products.AddAsync(<span class=\"keyword\">new</span> ProductEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId,</span><br><span class=\"line\">            Code = cmd.Code,</span><br><span class=\"line\">            Name = cmd.Name,</span><br><span class=\"line\">            Price = cmd.Price</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _mediator.BroadcastAsync(<span class=\"keyword\">new</span> CreatedProductEvent</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId,</span><br><span class=\"line\">            Code = cmd.Code,</span><br><span class=\"line\">            Name = cmd.Name,</span><br><span class=\"line\">            Price = cmd.Price,</span><br><span class=\"line\">            CreatedBy = cmd.CreatedBy  <span class=\"comment\">// use the same value</span></span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CreateProductResult</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = externalId</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"The-Audit-Pipeline\"><a href=\"#The-Audit-Pipeline\" class=\"headerlink\" title=\"The Audit Pipeline\"></a>The Audit Pipeline</h1><p>Now that we are passing the user information into the mediator we can create the audit pipeline that will have the following behavior when intercepting commands:</p>\n<ol>\n<li>Serialize and insert a new entry into the commands table;</li>\n<li>Add both the command and entry ids into an <code>AsyncLocal&lt;T&gt;</code> scope to be used if an event is broadcast;</li>\n<li>Invoke the next pipe;</li>\n<li>If available, serialize the result, calculate the execution time and update the table entry;</li>\n</ol>\n<p>When intercepting events, which are sent by commands, it will do the following:</p>\n<ol>\n<li>Get the command id from the current <code>AsyncLocal&lt;T&gt;</code> scope;</li>\n<li>Serialize the event and insert a new entry into the events table, referencing the command entry;</li>\n<li>Invoke the next pipe;</li>\n</ol>\n<p>Inside the <code>Pipelines</code> folder, create an <code>AuditPipeline</code> class extending <code>Pipeline</code>. The implementation should be similar to the following:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditPipeline</span> : <span class=\"title\">Pipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> DbSet&lt;CommandEntity&gt; _commands;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> DbSet&lt;EventEntity&gt; _events;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">AuditPipeline</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _commands = context.Set&lt;CommandEntity&gt;();</span><br><span class=\"line\">        _events = context.Set&lt;EventEntity&gt;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> command = (<span class=\"keyword\">await</span> _commands.AddAsync(<span class=\"keyword\">new</span> CommandEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = cmd.Id,</span><br><span class=\"line\">            Name = <span class=\"keyword\">typeof</span>(TCommand).Name,</span><br><span class=\"line\">            Payload = JsonSerializer.Serialize(cmd),</span><br><span class=\"line\">            Result = <span class=\"literal\">null</span>,</span><br><span class=\"line\">            CreatedOn = cmd.CreatedOn,</span><br><span class=\"line\">            CreatedBy = cmd.CreatedBy,</span><br><span class=\"line\">            ExecutionTime = TimeSpan.Zero</span><br><span class=\"line\">        &#125;, ct)).Entity;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">using</span> (CommandScope.Begin(command.ExternalId, command.Id))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        command.ExecutionTime = DateTimeOffset.UtcNow - cmd.CreatedOn;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> command = (<span class=\"keyword\">await</span> _commands.AddAsync(<span class=\"keyword\">new</span> CommandEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = cmd.Id,</span><br><span class=\"line\">            Name = <span class=\"keyword\">typeof</span>(TCommand).Name,</span><br><span class=\"line\">            Payload = JsonSerializer.Serialize(cmd),</span><br><span class=\"line\">            Result = <span class=\"literal\">null</span>,</span><br><span class=\"line\">            CreatedOn = cmd.CreatedOn,</span><br><span class=\"line\">            CreatedBy = cmd.CreatedBy,</span><br><span class=\"line\">            ExecutionTime = TimeSpan.Zero</span><br><span class=\"line\">        &#125;, ct)).Entity;</span><br><span class=\"line\"></span><br><span class=\"line\">        TResult result;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">using</span> (CommandScope.Begin(command.ExternalId, command.Id))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            result = <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        command.Result = result == <span class=\"literal\">null</span> ? <span class=\"literal\">null</span> : JsonSerializer.Serialize(result);</span><br><span class=\"line\">        command.ExecutionTime = DateTimeOffset.UtcNow - cmd.CreatedOn;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnEventAsync</span>&lt;<span class=\"title\">TEvent</span>&gt;(<span class=\"params\">Func&lt;TEvent, CancellationToken, Task&gt; next, TEvent evt, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _events.AddAsync(<span class=\"keyword\">new</span> EventEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            CommandId = CommandScope.Current.Id,</span><br><span class=\"line\">            ExternalId = evt.Id,</span><br><span class=\"line\">            Name = <span class=\"keyword\">typeof</span>(TEvent).Name,</span><br><span class=\"line\">            Payload = JsonSerializer.Serialize(evt),</span><br><span class=\"line\">            CreatedOn = evt.CreatedOn,</span><br><span class=\"line\">            CreatedBy = evt.CreatedBy,</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(evt, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">class</span> <span class=\"title\">CommandScope</span> : <span class=\"title\">IDisposable</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">CommandScope</span>(<span class=\"params\">Guid externalId, <span class=\"built_in\">long</span> id</span>)</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId;</span><br><span class=\"line\">            Id = id;</span><br><span class=\"line\"></span><br><span class=\"line\">            AsyncLocal.Value = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Dispose</span>()</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            AsyncLocal.Value = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">readonly</span> AsyncLocal&lt;CommandScope&gt; AsyncLocal = <span class=\"keyword\">new</span> AsyncLocal&lt;CommandScope&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> CommandScope Current =&gt; AsyncLocal.Value;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> IDisposable <span class=\"title\">Begin</span>(<span class=\"params\">Guid externalId, <span class=\"built_in\">long</span> id</span>)</span> =&gt; <span class=\"keyword\">new</span> CommandScope(externalId, id);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Startup.cs</code> file and register this pipeline to be run after all the existing ones, right before the commands or events are handled.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>).ConfigureWarnings(warn =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"comment\">// since InMemoryDatabase does not support transactions</span></span><br><span class=\"line\">                <span class=\"comment\">// for test purposes we are going to ignore this exception</span></span><br><span class=\"line\">                warn.Ignore(InMemoryEventId.TransactionIgnoredWarning);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddMediator(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;ValidationPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TransactionPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;AuditPipeline&gt;();</span><br><span class=\"line\">            <span class=\"keyword\">foreach</span> (<span class=\"function\"><span class=\"keyword\">var</span> implementationType <span class=\"keyword\">in</span> <span class=\"title\">typeof</span>(<span class=\"params\">Startup</span>)</span></span><br><span class=\"line\"><span class=\"function\">                .Assembly</span></span><br><span class=\"line\"><span class=\"function\">                .ExportedTypes</span></span><br><span class=\"line\"><span class=\"function\">                .<span class=\"title\">Where</span>(<span class=\"params\">t =&gt; t.IsClass &amp;&amp; !t.IsAbstract</span>))</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> serviceType <span class=\"keyword\">in</span> implementationType</span><br><span class=\"line\">                    .GetInterfaces()</span><br><span class=\"line\">                    .Where(i =&gt; i.IsGenericType &amp;&amp; i.GetGenericTypeDefinition() == <span class=\"keyword\">typeof</span>(IValidator&lt;&gt;)))</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    o.Services.Add(<span class=\"keyword\">new</span> ServiceDescriptor(serviceType, implementationType, ServiceLifetime.Transient));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// or, if using the SimpleSoft.Mediator.Microsoft.Extensions.* pipelines</span></span><br><span class=\"line\">        <span class=\"comment\">//services.AddMediator(o =&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">//&#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddPipelineForLogging(options =&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">//    &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//        options.LogCommandResult = true;</span></span><br><span class=\"line\">        <span class=\"comment\">//        options.LogQueryResult = true;</span></span><br><span class=\"line\">        <span class=\"comment\">//    &#125;);</span></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddPipeline&lt;TimeoutPipeline&gt;();</span></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddPipelineForValidation(options =&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">//    &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//        options.ValidateCommand = true;</span></span><br><span class=\"line\">        <span class=\"comment\">//        options.ValidateEvent = true;</span></span><br><span class=\"line\">        <span class=\"comment\">//    &#125;);</span></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddPipelineForEFCoreTransaction&lt;ApiDbContext&gt;(options =&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">//    &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//        options.BeginTransactionOnCommand = true;</span></span><br><span class=\"line\">        <span class=\"comment\">//    &#125;);</span></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddPipeline&lt;AuditPipeline&gt;();</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddValidatorsFromAssemblyOf&lt;Startup&gt;();</span></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span></span><br><span class=\"line\">        <span class=\"comment\">//&#125;);</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Because this pipeline is also serializing all events, the existing handlers for <code>CreatedProductEvent</code>, <code>DeletedProductEvent</code> and <code>UpdatedProductEvent</code> can now either be deleted or stop storing their events into the table to prevent duplicated data:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreatedProductEventHandler</span> : <span class=\"title\">IEventHandler</span>&lt;<span class=\"title\">CreatedProductEvent</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreatedProductEventHandler</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Task <span class=\"title\">HandleAsync</span>(<span class=\"params\">CreatedProductEvent evt, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">//await _context.Set&lt;EventEntity&gt;().AddAsync(new EventEntity</span></span><br><span class=\"line\">        <span class=\"comment\">//&#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//    ExternalId = evt.Id,</span></span><br><span class=\"line\">        <span class=\"comment\">//    Name = nameof(CreatedProductEvent),</span></span><br><span class=\"line\">        <span class=\"comment\">//    Payload = JsonSerializer.Serialize(evt),</span></span><br><span class=\"line\">        <span class=\"comment\">//    CreatedOn = evt.CreatedOn,</span></span><br><span class=\"line\">        <span class=\"comment\">//    CreatedBy = evt.CreatedBy</span></span><br><span class=\"line\">        <span class=\"comment\">//&#125;, ct);</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Task.CompletedTask;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"AsyncLocal\"><a href=\"#AsyncLocal\" class=\"headerlink\" title=\"AsyncLocal\"></a>AsyncLocal<T></h1><p>When comparing the audit pipeline with the previous ones we implemented, the biggest difference is the usage of <code>AsyncLocal&lt;T&gt;</code> to store an instance of the <code>CommandScope</code> class holding both the command external id and the primary key value for the audit entry into the table.</p>\n<p>If you aren’t familiar with this class, it is available since .NET Framework 4.6 and .NET standard 1.3, and was introduced to help sharing global flow state when implementing asynchronous code with Task Parallel Library (TPL). Because TPL relies on the thread pool and, by default, asynchronous code in ASP.NET Core applications can be resumed by any available thread, we can’t rely on mechanisms like the <code>ThreadLocal</code> class to store global state.</p>\n<p>Simply put, the idea of <code>AsyncLocal&lt;T&gt;</code> is to create a static instance that can hold some <code>T</code> value and, as long you use the <code>async</code> and <code>await</code> keywords, the runtime will consider your code execution to be a logical flow, despite asynchronous, and will ensure the value is shared even if the flow has been resumed by a different thread.</p>\n<p>Because we want to share data between the command and event interceptor code, the flow is asynchronous, and since only commands broadcast events, the <code>AsyncLocal&lt;T&gt;</code> class is an elegant solution to prevent changing all the events to include an <code>CommandId</code> property that has to be set on every broadcast.</p>\n<p>As an example, this is usually the solution implemented by some logging frameworks to support the creation of scopes, enabling some information to be written on every log without having to pass it every time, like when the using Microsoft façade <code>Logger.BeginScope(&quot;X:&#123;x&#125; Y:&#123;y&#125;&quot;, x, y)</code>.</p>\n<p>For more details and examples, give a look to the <code>AsyncLocal&lt;T&gt;</code> class <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.threading.asynclocal-1?view=net-8.0\">documentation</a>.</p>\n<h1 id=\"Audits-Controller\"><a href=\"#Audits-Controller\" class=\"headerlink\" title=\"Audits Controller\"></a>Audits Controller</h1><p>To make it easier to test and check our system audits, we are going to implement the following endpoint:</p>\n<p>GET &#x2F;audits — search for command audits using some filters (<code>SearchAuditsQuery</code>);<br>GET &#x2F;audits&#x2F;{id} — get a command audit by its unique identifier and all the associated events (<code>GetAuditByIdQuery</code>);</p>\n<p>Inside the <code>Handlers</code> folder create an <code>Audits</code> folder and create the queries for searching or getting an audit by its external id:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SearchAuditsQueryHandler</span> : <span class=\"title\">IQueryHandler</span>&lt;<span class=\"title\">SearchAuditsQuery</span>, <span class=\"title\">IEnumerable</span>&lt;<span class=\"title\">AuditSearchItem</span>&gt;&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IQueryable&lt;CommandEntity&gt; _commands;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SearchAuditsQueryHandler</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _commands = context.Set&lt;CommandEntity&gt;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;IEnumerable&lt;AuditSearchItem&gt;&gt; HandleAsync(SearchAuditsQuery query, CancellationToken ct)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> filter = _commands;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">string</span>.IsNullOrWhiteSpace(query.FilterQ))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> filterQ = query.FilterQ.Trim();</span><br><span class=\"line\"></span><br><span class=\"line\">            filter = filter.Where(p =&gt;</span><br><span class=\"line\">                p.Name.Contains(filterQ)</span><br><span class=\"line\">            );</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> skip = query.Skip ?? <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> take = query.Take ?? <span class=\"number\">20</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> filter</span><br><span class=\"line\">            .OrderByDescending(c =&gt; c.CreatedOn)</span><br><span class=\"line\">            .ThenByDescending(c =&gt; c.Id)</span><br><span class=\"line\">            .Skip(skip)</span><br><span class=\"line\">            .Take(take)</span><br><span class=\"line\">            .Select(c =&gt; <span class=\"keyword\">new</span> AuditSearchItem</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                Id = c.ExternalId,</span><br><span class=\"line\">                Name = c.Name,</span><br><span class=\"line\">                CreatedOn = c.CreatedOn,</span><br><span class=\"line\">                CreatedBy = c.CreatedBy,</span><br><span class=\"line\">                ExecutionTimeInMs = (<span class=\"built_in\">long</span>) c.ExecutionTime.TotalMilliseconds</span><br><span class=\"line\">            &#125;).ToListAsync(ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SearchAuditsQuery</span> : <span class=\"title\">Query</span>&lt;<span class=\"title\">IEnumerable</span>&lt;<span class=\"title\">AuditSearchItem</span>&gt;&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> FilterQ &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">int</span>? Skip &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">int</span>? Take &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditSearchItem</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> ExecutionTimeInMs &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">GetAuditByIdQueryHandler</span> : <span class=\"title\">IQueryHandler</span>&lt;<span class=\"title\">GetAuditByIdQuery</span>, <span class=\"title\">Audit</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IQueryable&lt;CommandEntity&gt; _commands;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IQueryable&lt;EventEntity&gt; _events;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">GetAuditByIdQueryHandler</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _commands = context.Set&lt;CommandEntity&gt;();</span><br><span class=\"line\">        _events = context.Set&lt;EventEntity&gt;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;Audit&gt; <span class=\"title\">HandleAsync</span>(<span class=\"params\">GetAuditByIdQuery query, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> command = <span class=\"keyword\">await</span> _commands.SingleOrDefaultAsync(c =&gt; c.ExternalId == query.AuditId, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (command == <span class=\"literal\">null</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">$&quot;Command audit &#x27;<span class=\"subst\">&#123;query.AuditId&#125;</span>&#x27; not found&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> events = <span class=\"keyword\">await</span> _events.Where(e =&gt; e.CommandId == command.Id).ToListAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Audit</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = command.ExternalId,</span><br><span class=\"line\">            Name = command.Name,</span><br><span class=\"line\">            Payload = JsonSerializer.Deserialize&lt;<span class=\"built_in\">dynamic</span>&gt;(command.Payload),</span><br><span class=\"line\">            Result = <span class=\"built_in\">string</span>.IsNullOrWhiteSpace(command.Result)</span><br><span class=\"line\">                ? <span class=\"literal\">null</span></span><br><span class=\"line\">                : JsonSerializer.Deserialize&lt;<span class=\"built_in\">dynamic</span>&gt;(command.Result),</span><br><span class=\"line\">            CreatedOn = command.CreatedOn,</span><br><span class=\"line\">            CreatedBy = command.CreatedBy,</span><br><span class=\"line\">            ExecutionTimeInMs = (<span class=\"built_in\">long</span>) command.ExecutionTime.TotalMilliseconds,</span><br><span class=\"line\">            Events = events.Select(e =&gt; <span class=\"keyword\">new</span> AuditEvent</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                Id = e.ExternalId,</span><br><span class=\"line\">                Name = e.Name,</span><br><span class=\"line\">                Payload = JsonSerializer.Deserialize&lt;<span class=\"built_in\">dynamic</span>&gt;(e.Payload),</span><br><span class=\"line\">                CreatedOn = e.CreatedOn</span><br><span class=\"line\">            &#125;).ToList()</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">GetAuditByIdQuery</span> : <span class=\"title\">Query</span>&lt;<span class=\"title\">Audit</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid AuditId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Audit</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">object</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">object</span> Result &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> ExecutionTimeInMs &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> IEnumerable&lt;AuditEvent&gt; Events &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditEvent</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">object</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Inside the <code>Controllers</code> folder create an <code>Audit</code> folder and an <code>AuditController</code> that will use the previous queries:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;audits&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">AuditsController</span>(<span class=\"params\">IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet</span>]</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;IEnumerable&lt;AuditSearchItemModel&gt;&gt; SearchAsync([FromQuery] <span class=\"built_in\">string</span> filterQ, [FromQuery] <span class=\"built_in\">int</span>? skip, [FromQuery] <span class=\"built_in\">int</span>? take, CancellationToken ct)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.FetchAsync(<span class=\"keyword\">new</span> SearchAuditsQuery</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            FilterQ = filterQ,</span><br><span class=\"line\">            Skip = skip,</span><br><span class=\"line\">            Take = take,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result.Select(r =&gt; <span class=\"keyword\">new</span> AuditSearchItemModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = r.Id,</span><br><span class=\"line\">            Name = r.Name,</span><br><span class=\"line\">            CreatedOn = r.CreatedOn,</span><br><span class=\"line\">            CreatedBy = r.CreatedBy,</span><br><span class=\"line\">            ExecutionTimeInMs = r.ExecutionTimeInMs</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;AuditModel&gt; <span class=\"title\">GetByIdAsync</span>(<span class=\"params\">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.FetchAsync(<span class=\"keyword\">new</span> GetAuditByIdQuery</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            AuditId = id,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AuditModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = result.Id,</span><br><span class=\"line\">            Name = result.Name,</span><br><span class=\"line\">            Payload = result.Payload,</span><br><span class=\"line\">            Result = result.Result,</span><br><span class=\"line\">            CreatedOn = result.CreatedOn,</span><br><span class=\"line\">            CreatedBy = result.CreatedBy,</span><br><span class=\"line\">            ExecutionTimeInMs = result.ExecutionTimeInMs,</span><br><span class=\"line\">            Events = result.Events.Select(e =&gt; <span class=\"keyword\">new</span> AuditEventModel</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                Id = e.Id,</span><br><span class=\"line\">                Name = e.Name,</span><br><span class=\"line\">                Payload = e.Payload,</span><br><span class=\"line\">                CreatedOn = e.CreatedOn</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditSearchItemModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> ExecutionTimeInMs &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">object</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">object</span> Result &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> ExecutionTimeInMs &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> IEnumerable&lt;AuditEventModel&gt; Events &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditEventModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">object</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The project structure should look as follows:</p>\n<img src=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/02_project_structure_auditing_final.png\" class=\"\">\n\n<p>Open the Swagger endpoint (ex: <a href=\"https://localhost:44380/swagger\">https://localhost:44380/swagger</a>) and you should see the audits endpoint:</p>\n<img src=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/03_swagger_audit.png\" class=\"\">\n\n<p>Create, update or delete products with the help of Swagger UI and then check if all the commands and events have been properly audited:</p>\n<img src=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/04_swagger_audit_search.png\" class=\"\">\n\n<p>And even get the details of a specific audit:</p>\n<img src=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/05_swagger_audit_get_by_id.png\" class=\"\">\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use mediator pipelines to simplify the auditing of user actions without having to replicate code across all commands.</p>\n<p>We also ensured events were always stored before being broadcasted and a reference to the command was kept without adding properties to our POCOs, providing a more clean approach.</p>\n<p>Soon I’ll be explaining how we can inject more specialized interfaces, like the <code>ISender&lt;TCommand&gt;</code>, to make our dependencies more clearer and help with unit testing.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp",
                "patterns"
            ]
        },
        {
            "id": "https://code-corner.dev/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/",
            "url": "https://code-corner.dev/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/",
            "title": "Transaction Management With Mediator Pipelines in ASP.NET Core",
            "date_published": "2020-11-07T00:00:00.000Z",
            "content_html": "<p>When implementing a <strong>simplified CQRS</strong> service, which usually has a single database but still separates commands from queries, the mediator pipeline can be used to manage transactions when processing commands, ensuring changes will be implicitly committed unless an exception is thrown.</p>\n<p>Implementing a pipeline for transactions has some key advantages even when using Entity Framework Core or other ORM that tracks and flushes changes at a single point in time.</p>\n<p>Because the command handler is executing inside an implicit transaction, the developer is free to flush their changes as it sees fit knowing that any exception will rollback the changes. This is very helpful when it wants to cancel the flow when some business rules aren’t meet and could only be checked after changing the system state. Optimistic concurrency is a good example where you may want to flush your changes before leaving the handler so you know exactly what entity failed and can send a more detailed message to the user, which is the usual approach when implementing a dedicated <strong>Backend for Frontend</strong> service.</p>\n<p>Also, ORMs are very good at abstracting database access but can’t solve more edge cases, specially when performance is a requirement. Being able to use a more lightweight library (e.g. <a href=\"https://github.com/StackExchange/Dapper\">Dapper</a>) to do some bulk operations and using the ORM context connection inside the same transaction will remove the need to use the <code>TransactionScope</code> and reduce some application complexity.</p>\n<p>Ensuring transactions are properly managed around the handler execution ensure the application architecture is be more robust and will be able to handle more edge cases.</p>\n<hr>\n<h1 id=\"The-project\"><a href=\"#The-project\" class=\"headerlink\" title=\"The project\"></a>The project</h1><p>This article will be based on my previous ones that explained how to use the mediator and implement transversal behavior with pipelines. As a reminder, we implemented an endpoint to manage products with the following:</p>\n<ul>\n<li>GET &#x2F;products — search for products using some filters (<code>SearchProductsQuery</code>);</li>\n<li>GET &#x2F;products&#x2F;{id} — get a product by its unique identifier (<code>GetProductByIdQuery</code>);</li>\n<li>POST &#x2F;products — create a product (<code>CreateProductCommand</code> and <code>CreatedProductEvent</code>);</li>\n<li>PUT &#x2F;products&#x2F;{id} — update a product by its unique identifier (<code>UpdateProductCommand</code> and <code>UpdatedProductEvent</code>);</li>\n<li>DELETE &#x2F;products&#x2F;{id} — delete a product by its unique identifier (<code>DeleteProductCommand</code> and <code>DeletedProductEvent</code>);</li>\n</ul>\n<p>You can check them out here:</p>\n<ul>\n<li><a href=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/\" title=\"Mediator Pattern in ASP.NET Core Applications\">Mediator Pattern in ASP.NET Core Applications</a></li>\n<li><a href=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Using Mediator Pipelines in ASP.NET Core Applications\">Using Mediator Pipelines in ASP.NET Core Applications</a></li>\n<li><a href=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Validation with Mediator Pipelines in ASP.NET Core Applications\">Validation with Mediator Pipelines in ASP.NET Core Applications</a></li>\n</ul>\n<p>The source code is available on <a href=\"https://github.com/gravity00/IntroductionMediatorCQRS\">GitHub</a>, feel free to give it a look.</p>\n<h1 id=\"Entity-Framework-Core-transactions\"><a href=\"#Entity-Framework-Core-transactions\" class=\"headerlink\" title=\"Entity Framework Core transactions\"></a>Entity Framework Core transactions</h1><p>Entity Framework Core has support for explicit transaction management, which works in a similar way to ADO.NET or the <code>TransactionScope</code> class.</p>\n<p>You can get a disposable instance of <code>IDbContextTransaction</code> by invoking the method <code>BeginTransactionAsync</code>, available from the database property. The transaction can be either committed or rolled back, either by explicit invocation or by disposing the instance before any commit.</p>\n<p>As stated before, this can be very helpful if <code>SaveChanges</code> must be invoked multiple times inside the <em>unit of work</em> operation and you want to ensure exceptions will rollback data changes.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">await</span> <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> tx = <span class=\"keyword\">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> products.Where(p =&gt; p.Code.StartsWith(<span class=\"string\">&#x27;9&#x27;</span>)).ForEachAsync(product =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    product.Name += <span class=\"string\">&quot; [DEPRECATED]&quot;</span>;</span><br><span class=\"line\">&#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> products.ForEachAsync(product =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    product.Price /= <span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> tx.CommitAsync(ct);</span><br></pre></td></tr></table></figure>\n\n<p>In the example above if an exception was thrown after the first <code>SaveChangesAsync</code> every changes would be reverted because the transaction would be disposed without an explicit call to commit.</p>\n<p>We are going to leverage on this behavior to implement the pipeline.</p>\n<h1 id=\"The-pipeline\"><a href=\"#The-pipeline\" class=\"headerlink\" title=\"The pipeline\"></a>The pipeline</h1><p>Since only commands mutate system state, we are going to use the command pipeline to enforce a transaction for the next pipelines in the chain up until the handler.</p>\n<p>The pipeline behavior will be:</p>\n<ol>\n<li>Intercept any command;</li>\n<li>Create a new <code>IDbContextTransaction</code> with <code>BeginTransactionAsync</code>;</li>\n<li>Invoke the next pipeline inside the <code>using</code> scope;</li>\n<li>If no exception is thrown, flush all changes and commit;</li>\n<li>Dispose the transaction;</li>\n</ol>\n<p>I’ll also include some commented code incase you want to be sure the queries never mutate the system state. Prevention is better than cure…</p>\n<p>Inside the <code>Pipelines</code> folder create a <code>TransactionPipeline</code> class extending <code>Pipeline</code> (because we only need some of the methods):</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">TransactionPipeline</span> : <span class=\"title\">Pipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TransactionPipeline</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> tx = <span class=\"keyword\">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> tx.CommitAsync(ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> tx = <span class=\"keyword\">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> tx.CommitAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//public override async Task&lt;TResult&gt; OnQueryAsync&lt;TQuery, TResult&gt;(Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, TQuery query, CancellationToken ct)</span></span><br><span class=\"line\">    <span class=\"comment\">//&#123;</span></span><br><span class=\"line\">    <span class=\"comment\">//    await using var tx = await _context.Database.BeginTransactionAsync(ct);</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//    var result = await next(query, ct);</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//    await tx.RollbackAsync(ct);</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//    return result;</span></span><br><span class=\"line\">    <span class=\"comment\">//&#125;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Startup.cs</code> file and add the <code>TransactionPipeline</code> after the <code>ValidationPipeline</code>, preventing the opening of transactions that could be immediately closed if the command had invalid data.</p>\n<p>Since this examples are using the in-memory database provider for Entity Framework Core, which does not support explicit transactions, we are also going to ignore them for test purposes.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>).ConfigureWarnings(warn =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                warn.Ignore(InMemoryEventId.TransactionIgnoredWarning);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddMediator(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;ValidationPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TransactionPipeline&gt;();</span><br><span class=\"line\">            <span class=\"keyword\">foreach</span> (<span class=\"function\"><span class=\"keyword\">var</span> implementationType <span class=\"keyword\">in</span> <span class=\"title\">typeof</span>(<span class=\"params\">Startup</span>)</span></span><br><span class=\"line\"><span class=\"function\">                .Assembly</span></span><br><span class=\"line\"><span class=\"function\">                .ExportedTypes</span></span><br><span class=\"line\"><span class=\"function\">                .<span class=\"title\">Where</span>(<span class=\"params\">t =&gt; t.IsClass &amp;&amp; !t.IsAbstract</span>))</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> serviceType <span class=\"keyword\">in</span> implementationType</span><br><span class=\"line\">                    .GetInterfaces()</span><br><span class=\"line\">                    .Where(i =&gt; i.IsGenericType &amp;&amp; i.GetGenericTypeDefinition() == <span class=\"keyword\">typeof</span>(IValidator&lt;&gt;)))</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    o.Services.Add(<span class=\"keyword\">new</span> ServiceDescriptor(serviceType, implementationType, ServiceLifetime.Transient));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Now that we have a transversal behavior that manages transactions and flushes all context changes to the database, we can remove from all command handlers the explicit calls to <code>SaveChangesAsync</code>:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">DeleteProductCommandHandler</span> : <span class=\"title\">ICommandHandler</span>&lt;<span class=\"title\">DeleteProductCommand</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DeleteProductCommandHandler</span>(<span class=\"params\">ApiDbContext context, IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">HandleAsync</span>(<span class=\"params\">DeleteProductCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> product = <span class=\"keyword\">await</span> products.SingleOrDefaultAsync(p =&gt; p.ExternalId == cmd.ProductId, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (product == <span class=\"literal\">null</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">$&quot;Product &#x27;<span class=\"subst\">&#123;cmd.ProductId&#125;</span>&#x27; not found&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        products.Remove(product);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//await _context.SaveChangesAsync(ct);</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _mediator.BroadcastAsync(<span class=\"keyword\">new</span> DeletedProductEvent</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ProductId = cmd.ProductId</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Speeding-things-up\"><a href=\"#Speeding-things-up\" class=\"headerlink\" title=\"Speeding things up!\"></a>Speeding things up!</h1><p>Because this is a pipeline we use very often in most of our APIs, there is already a <a href=\"https://www.nuget.org/packages/simplesoft.mediator.microsoft.extensions.efcoretransactionpipeline\">NuGet available that allows to open an explicit Entity Framework Core transaction for commands, events or queries</a>, depending your needs.</p>\n<p>To use it, just open the NuGet package manager and install the package <code>SimpleSoft.Mediator.Microsoft.Extensions.EFCoreTransactionPipeline</code>:</p>\n<img src=\"/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/01_nuget_mediator_transaction_pipeline.png\" class=\"\">\n\n<p>Open the <code>Startup.cs</code> file and register the pipeline with the extension method <code>AddPipelineForEFCoreTransaction&lt;TContext&gt;</code>. Explicit transactions are disabled by default, so you only need to enable them for commands.</p>\n<p>When using all the NuGets mentioned on my previous articles, the <code>Startup.cs</code> file should be similar to this:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>).ConfigureWarnings(warn =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"comment\">// since InMemoryDatabase does not support transactions</span></span><br><span class=\"line\">                <span class=\"comment\">// for test purposes we are going to ignore this exception</span></span><br><span class=\"line\">                warn.Ignore(InMemoryEventId.TransactionIgnoredWarning);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddMediator(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.AddPipelineForLogging(options =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                options.LogCommandResult = <span class=\"literal\">true</span>;</span><br><span class=\"line\">                options.LogQueryResult = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">            o.AddPipelineForValidation(options =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                options.ValidateCommand = <span class=\"literal\">true</span>;</span><br><span class=\"line\">                options.ValidateEvent = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            o.AddPipelineForEFCoreTransaction&lt;ApiDbContext&gt;(options =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                options.BeginTransactionOnCommand = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            o.AddValidatorsFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ..</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use mediator pipelines to simplify the management of Entity Framework Core transactions, making the implementation of command handlers less error prone since developers won’t forget to flush changes to the database (that behavior will be implicit unless an exception is thrown).</p>\n<p>Even if your application is using another ORM or other lightweight libraries (e.g. <a href=\"https://github.com/StackExchange/Dapper\">Dapper</a>), you can easily implement your own pipeline.</p>\n<p>I also made an article about <a href=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/\" title=\"Auditing with Mediator Pipelines in ASP.NET Core\">auditing user actions with pipelines</a>, you may also find it helpful.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp",
                "patterns"
            ]
        },
        {
            "id": "https://code-corner.dev/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/",
            "url": "https://code-corner.dev/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/",
            "title": "Validation with Mediator Pipelines in ASP.NET Core Applications",
            "date_published": "2020-11-04T00:00:00.000Z",
            "content_html": "<p>When implementing web applications that manipulate information, there is always the need to validate data sent by the clients, ensuring business rules are properly implemented.</p>\n<p>Previously I talked about the implementation of <strong>Command Query Responsibility Segregation (CQRS)</strong> and <strong>Event Sourcing (ES)</strong> using a mediator pattern and how to support transversal behavior via pipelines.</p>\n<p>In this article I’m going to demonstrate how validation can be enforced into your commands and events before reaching the handlers, making sure that invalid data will be rejected by the API.</p>\n<p>This approach not only reduces the amount of duplicated code, it also ensures validations won’t be forgotten, unless explicitly stated.</p>\n<hr>\n<h1 id=\"The-project\"><a href=\"#The-project\" class=\"headerlink\" title=\"The project\"></a>The project</h1><p>To make it faster to implement the validation pipeline, I’m going to leverage this example on both of my previous articles, in which we implemented an <a href=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/\" title=\"Mediator Pattern in ASP.NET Core Applications\">endpoint to manage products</a> and introduced both a <a href=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Using Mediator Pipelines in ASP.NET Core Applications\">logging and timeout pipelines</a>.</p>\n<p>The source code is available on <a href=\"https://github.com/gravity00/IntroductionMediatorCQRS\">GitHub</a>.</p>\n<h1 id=\"The-validations\"><a href=\"#The-validations\" class=\"headerlink\" title=\"The validations\"></a>The validations</h1><p>To help us configure the rules we are going to use a very popular and one of my favorites libraries <a href=\"https://fluentvalidation.net/\">FluentValidation</a> by creating classes implementing the interface <code>IValidator&lt;T&gt;</code>.</p>\n<p>These classes will be added to the dependency injection container and used by the pipeline to validate both the commands and events before reaching the handler.</p>\n<p>Lets start by installing the NuGet <code>FluentValidation</code>:</p>\n<img src=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/01_nuget_fluentvalidation.png\" class=\"\">\n\n<p>Create a <code>Validations</code> folder at the project root level, with a subfolder <code>Products</code>.</p>\n<img src=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/02_project_structure.png\" class=\"\">\n\n<p>Inside the <code>Products</code> folder create both a validator for <code>CreateProductCommand</code> and <code>CreatedProductEvent</code> by extending the class <code>AbstractValidator&lt;T&gt;</code> (which itself implementes the interface <code>IValidator&lt;T&gt;</code>) and configure some rules in the constructors:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductCommandValidator</span> : <span class=\"title\">AbstractValidator</span>&lt;<span class=\"title\">CreateProductCommand</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreateProductCommandValidator</span>()</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        RuleFor(e =&gt; e.Code)</span><br><span class=\"line\">            .NotEmpty()</span><br><span class=\"line\">            .Length(<span class=\"number\">8</span>)</span><br><span class=\"line\">            .Matches(<span class=\"string\">&quot;^[0-9a-zA-Z]*$&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        RuleFor(e =&gt; e.Name)</span><br><span class=\"line\">            .NotEmpty()</span><br><span class=\"line\">            .MaximumLength(<span class=\"number\">128</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        RuleFor(e =&gt; e.Price)</span><br><span class=\"line\">            .GreaterThanOrEqualTo(<span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreatedProductEventValidator</span> : <span class=\"title\">AbstractValidator</span>&lt;<span class=\"title\">CreatedProductEvent</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreatedProductEventValidator</span>()</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        RuleFor(e =&gt; e.ExternalId)</span><br><span class=\"line\">            .NotEmpty();</span><br><span class=\"line\"></span><br><span class=\"line\">        RuleFor(e =&gt; e.Code)</span><br><span class=\"line\">            .NotEmpty()</span><br><span class=\"line\">            .Length(<span class=\"number\">8</span>)</span><br><span class=\"line\">            .Matches(<span class=\"string\">&quot;^[0-9a-zA-Z]*$&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        RuleFor(e =&gt; e.Name)</span><br><span class=\"line\">            .NotEmpty()</span><br><span class=\"line\">            .MaximumLength(<span class=\"number\">128</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        RuleFor(e =&gt; e.Price)</span><br><span class=\"line\">            .GreaterThanOrEqualTo(<span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Feel free to create validators for all other commands and events, I’m just focusing on these for simplicity. You can also check the <a href=\"https://docs.fluentvalidation.net/en/latest/\">documentation for supported rules and detailed usage instructions</a>.</p>\n<p>Open the <code>Startup.cs</code> file and register all classes implementing <code>IValidator&lt;T&gt;</code> into the container:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddMediator(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> (<span class=\"function\"><span class=\"keyword\">var</span> implementationType <span class=\"keyword\">in</span> <span class=\"title\">typeof</span>(<span class=\"params\">Startup</span>)</span></span><br><span class=\"line\"><span class=\"function\">            .Assembly</span></span><br><span class=\"line\"><span class=\"function\">            .ExportedTypes</span></span><br><span class=\"line\"><span class=\"function\">            .<span class=\"title\">Where</span>(<span class=\"params\">t =&gt; t.IsClass &amp;&amp; !t.IsAbstract</span>))</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> serviceType <span class=\"keyword\">in</span> implementationType</span><br><span class=\"line\">                .GetInterfaces()</span><br><span class=\"line\">                .Where(i =&gt; i.IsGenericType &amp;&amp; i.GetGenericTypeDefinition() == <span class=\"keyword\">typeof</span>(IValidator&lt;&gt;)))</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                services.Add(<span class=\"keyword\">new</span> ServiceDescriptor(serviceType, implementationType, ServiceLifetime.Transient));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"The-pipeline\"><a href=\"#The-pipeline\" class=\"headerlink\" title=\"The pipeline\"></a>The pipeline</h1><p>Because for this example we are going to enforce validation only on commands and events, since they either mutate or represent the system state at a given point in time, the pipeline will be implemented as follows:</p>\n<ol>\n<li>Intercept any command or event;</li>\n<li>Resolve a required instance of <code>IValidator&lt;TCommand&gt;</code> or <code>IValidator&lt;TEvent&gt;</code> from the container;</li>\n<li>Invoke the method <code>ValidateAndThrowAsync</code>, failing with a <code>ValidationException</code> if something is invalid;</li>\n</ol>\n<p>Inside the <code>Pipelines</code> folder create a <code>ValidationPipeline</code> class extending <code>Pipeline</code> (because we only need some of the methods):</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ValidationPipeline</span> : <span class=\"title\">Pipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IServiceProvider _provider;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ValidationPipeline</span>(<span class=\"params\">IServiceProvider provider</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _provider = provider;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> ValidateAndThrowAsync(cmd, ct);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> ValidateAndThrowAsync(cmd, ct);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnEventAsync</span>&lt;<span class=\"title\">TEvent</span>&gt;(<span class=\"params\">Func&lt;TEvent, CancellationToken, Task&gt; next, TEvent evt, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> ValidateAndThrowAsync(evt, ct);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(evt, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">async</span> Task <span class=\"title\">ValidateAndThrowAsync</span>&lt;<span class=\"title\">T</span>&gt;(<span class=\"params\">T instance, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> validator = _provider.GetRequiredService&lt;IValidator&lt;T&gt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">await</span> validator.ValidateAndThrowAsync(instance, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Startup.cs</code> file and add the <code>ValidationPipeline</code> at least after the <code>LoggingPipeline</code> ensuring, in case invalid data is submitted, we can still see it in the logs:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">services.AddMediator(o =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">    o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">    o.AddPipeline&lt;ValidationPipeline();</span><br><span class=\"line\">    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>If you now start the server and try to create a product with invalid data you will receive a <code>ValidationException</code>.</p>\n<img src=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/03_validation_exception.png\" class=\"\">\n\n<p>Because returning an HTTP 500 due to invalid data would be confusing to the client, lets just finish this example by creating an ASP.NET Core middleware converting this exception into a more appropriate code, like HTTP 422.</p>\n<p>Once again, open the <code>Startup.cs</code> file and register the middleware immediately after the developer exception page, catching this exception and returning HTTP 422 with a more detailed JSON representation:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        app.UseDeveloperExceptionPage();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.Use(<span class=\"keyword\">async</span> (ctx, next) =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">await</span> next();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">catch</span> (ValidationException e)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">var</span> response = ctx.Response;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (response.HasStarted)</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span>;</span><br><span class=\"line\">                ctx.RequestServices</span><br><span class=\"line\">                    .GetRequiredService&lt;ILogger&lt;Startup&gt;&gt;()</span><br><span class=\"line\">                    .LogWarning(e, <span class=\"string\">&quot;Invalid data has been submitted&quot;</span>);</span><br><span class=\"line\">                response.Clear();</span><br><span class=\"line\">                response.StatusCode = <span class=\"number\">422</span>;</span><br><span class=\"line\">                <span class=\"keyword\">await</span> response.WriteAsync(JsonSerializer.Serialize(<span class=\"keyword\">new</span></span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    Message = <span class=\"string\">&quot;Invalid data has been submitted&quot;</span>,</span><br><span class=\"line\">                    ModelState = e.Errors.ToDictionary(error =&gt; error.ErrorCode, error =&gt; error.ErrorMessage)</span><br><span class=\"line\">                &#125;), Encoding.UTF8, ctx.RequestAborted);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwagger();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwaggerUI(c =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            c.SwaggerEndpoint(<span class=\"string\">&quot;/swagger/v1/swagger.json&quot;</span>, <span class=\"string\">&quot;Mediator ExampleApi V1&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseRouting();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseEndpoints(endpoints =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            endpoints.MapControllers();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Submit invalid data again and a more detailed message should be returned:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /products</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;code&quot;: &quot;-123456&quot;,</span><br><span class=\"line\">  &quot;name&quot;: &quot;&quot;,</span><br><span class=\"line\">  &quot;price&quot;: -1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">HTTP 422</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   &quot;Message&quot;:&quot;Invalid data has been submitted&quot;,</span><br><span class=\"line\">   &quot;ModelState&quot;:&#123;</span><br><span class=\"line\">      &quot;ExactLengthValidator&quot;:&quot;&#x27;Code&#x27; must be 8 characters in length. You entered 7 characters.&quot;,</span><br><span class=\"line\">      &quot;RegularExpressionValidator&quot;:&quot;&#x27;Code&#x27; is not in the correct format.&quot;,</span><br><span class=\"line\">      &quot;NotEmptyValidator&quot;:&quot;&#x27;Name&#x27; must not be empty.&quot;,</span><br><span class=\"line\">      &quot;GreaterThanOrEqualValidator&quot;:&quot;&#x27;Price&#x27; must be greater than or equal to &#x27;0&#x27;.&quot;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Speeding-things-up\"><a href=\"#Speeding-things-up\" class=\"headerlink\" title=\"Speeding things up!\"></a>Speeding things up!</h1><p>If just like me, you can see yourself using a pipeline for validation in most of your projects, there is already a <a href=\"https://www.nuget.org/packages/simplesoft.mediator.microsoft.extensions.validationpipeline\">pipeline available via NuGet</a> that should be configurable to most use cases while also providing a simpler way to register the validators into the container.</p>\n<p>Install <code>SimpleSoft.Mediator.Microsoft.Extensions.ValidationPipeline</code> via NuGet:</p>\n<img src=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/04_nuget_mediator_validation_pipeline.png\" class=\"\">\n\n<p>Use the extension method <code>AddPipelineForValidation</code> and enforce both command and event validations and use the extension method <code>AddValidatorsFromAssemblyOf</code> to scan for all <code>IValidator&lt;T&gt;</code> classes and register them into the container.</p>\n<p>For the current project, the <code>ConfigureServices</code> method would be similar to the following:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddMediator(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">            o.AddPipelineForValidation(options =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                options.ValidateCommand = <span class=\"literal\">true</span>;</span><br><span class=\"line\">                options.ValidateEvent = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            o.AddValidatorsFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use mediator pipelines to ensure that all your commands, events and even queries are initialized with proper data, either implementing your own pipeline or by using the existing <a href=\"https://www.nuget.org/packages/simplesoft.mediator.microsoft.extensions.validationpipeline\">ValidationPipeline</a> NuGet.</p>\n<p>I also made an article about <a href=\"/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/\" title=\"Transaction Management With Mediator Pipelines in ASP.NET Core\">transaction management with pipelines</a>, you may also find it helpful.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp",
                "patterns"
            ]
        },
        {
            "id": "https://code-corner.dev/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/",
            "url": "https://code-corner.dev/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/",
            "title": "Using Mediator Pipelines in ASP.NET Core Applications",
            "date_published": "2020-11-02T00:00:00.000Z",
            "content_html": "<p>In my <a href=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/\" title=\"Mediator Pattern in ASP.NET Core Applications\">previous article</a> I explained how you could implement <strong>Command Query Responsibility Segregation (CQRS)</strong> and <strong>Event Sourcing (ES)</strong> patterns using a mediator instance from <a href=\"https://www.nuget.org/packages/simplesoft.mediator\">SimpleSoft.Mediator</a> in ASP.NET Core applications.</p>\n<p>This time I’m going to explain how to intercept commands, queries and events, making it possible to apply transversal behavior before they reach the handlers, reducing significantly the amount of boilerplate and duplicated code.</p>\n<p>Transaction management, logging, auditing, caching or validations are some of the good examples where pipelines can be very helpful. Imagine the following chains:</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Commands:</span><br><span class=\"line\">  Mediator</span><br><span class=\"line\">    LoggingPipeline</span><br><span class=\"line\">      ValidationPipeline</span><br><span class=\"line\">        TransactionPipeline</span><br><span class=\"line\">          AuditPipeline</span><br><span class=\"line\">            Handler</span><br><span class=\"line\"></span><br><span class=\"line\">Queries:</span><br><span class=\"line\">  Mediator</span><br><span class=\"line\">    LoggingPipeline</span><br><span class=\"line\">      Handler</span><br><span class=\"line\"></span><br><span class=\"line\">Events:</span><br><span class=\"line\">  Mediator</span><br><span class=\"line\">    LoggingPipeline</span><br><span class=\"line\">      StoragePipeline</span><br><span class=\"line\">        Handler(s)</span><br></pre></td></tr></table></figure>\n\n<p>Not only you can plugin any pipeline at will without changing the handlers implementation, you can also be specific to the entities each pipeline is interested.</p>\n<h1 id=\"Pipelines\"><a href=\"#Pipelines\" class=\"headerlink\" title=\"Pipelines\"></a>Pipelines</h1><p>Mediator pipelines are represented by the interface <code>IPipeline</code> (or the abstract class <code>Pipeline</code>) with methods to intercept each entity type:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">IPipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\">Task <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        Func&lt;TCommand, CancellationToken, Task&gt; next, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TCommand cmd, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TCommand : <span class=\"keyword\">class</span>, ICommand</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TCommand cmd, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TCommand : <span class=\"keyword\">class</span>, <span class=\"title\">ICommand</span>&lt;<span class=\"title\">TResult</span>&gt;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">Task <span class=\"title\">OnEventAsync</span>&lt;<span class=\"title\">TEvent</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        Func&lt;TEvent, CancellationToken, Task&gt; next, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TEvent evt, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TEvent : <span class=\"keyword\">class</span>, IEvent</span>;</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"function\"><span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnQueryAsync</span>&lt;<span class=\"title\">TQuery</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TQuery query, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TQuery : <span class=\"keyword\">class</span>, IQuery&lt;TResult&gt;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>You receive a delegate for the next pipe and the entity, so the concept is very simple: either do some work before or after invoking the next pipe, or break the chain by returning or throwing an exception.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">IsItMondayAlreadyPipeline</span> : <span class=\"title\">Pipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnQueryAsync</span>&lt;<span class=\"title\">TQuery</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TQuery query, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(DateTime.Now.DayOfWeek == DayOfWeek.Monday)</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">&quot;Today is monday, no data for you!&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> next(query, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><em>Pipelines are executed by the same order they are added to the container so, to be deterministic, don’t scan the assemblies for classes implementing <code>IPipeline</code>.</em></p>\n<h2 id=\"Commands-pipeline\"><a href=\"#Commands-pipeline\" class=\"headerlink\" title=\"Commands pipeline\"></a>Commands pipeline</h2><p>Intercept commands sent into the mediator by implementing the methods <code>OnCommandAsync</code>:</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/01_pipeline_command.png\" class=\"\">\n\n<h2 id=\"Queries-pipeline\"><a href=\"#Queries-pipeline\" class=\"headerlink\" title=\"Queries pipeline\"></a>Queries pipeline</h2><p>Intercept queries being fetched from the mediator by implementing the methods <code>OnQueryAsync</code>:</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/02_pipeline_query.png\" class=\"\">\n\n<h2 id=\"Events-pipeline\"><a href=\"#Events-pipeline\" class=\"headerlink\" title=\"Events pipeline\"></a>Events pipeline</h2><p>Intercept events before being broadcasted by the mediator into all the handlers by implementing the method <code>OnEventAsync</code>:</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/03_pipeline_event.png\" class=\"\">\n\n<hr>\n<h1 id=\"The-project\"><a href=\"#The-project\" class=\"headerlink\" title=\"The project\"></a>The project</h1><p>To make it easier, we are going to leverage on the <a href=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/\" title=\"Mediator Pattern in ASP.NET Core Applications\">previous article</a> and continue from there. As a reminder, we implemented an endpoint to manage products with the following:</p>\n<ul>\n<li>GET &#x2F;products — search for products using some filters (<code>SearchProductsQuery</code>);</li>\n<li>GET &#x2F;products&#x2F;{id} — get a product by its unique identifier (<code>GetProductByIdQuery</code>);</li>\n<li>POST &#x2F;products — create a product (<code>CreateProductCommand</code> and <code>CreatedProductEvent</code>);</li>\n<li>PUT &#x2F;products&#x2F;{id} — update a product by its unique identifier (<code>UpdateProductCommand</code> and <code>UpdatedProductEvent</code>);</li>\n<li>DELETE &#x2F;products&#x2F;{id} — delete a product by its unique identifier (<code>DeleteProductCommand</code> and <code>DeletedProductEvent</code>);</li>\n</ul>\n<p>The complete source code can be found on <a href=\"https://github.com/gravity00/IntroductionMediatorCQRS\">GitHub</a>.</p>\n<h1 id=\"The-pipelines\"><a href=\"#The-pipelines\" class=\"headerlink\" title=\"The pipelines\"></a>The pipelines</h1><p>Since the objective of this article is to show how to implement pipelines in the mediator, the following should be enough:</p>\n<ul>\n<li><strong>LoggingPipeline</strong> — serializes every command, queries, events and results as JSON into the log if <code>Trace</code> is enabled;</li>\n<li><strong>TimeoutPipeline</strong> — cancels the handler execution if it takes more than a given set of time;</li>\n</ul>\n<p>Start by creating a <code>Pipelines</code> folder at the project root level.</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/04_project_structure_pipelines.png\" class=\"\">\n\n<h2 id=\"LoggingPipeline\"><a href=\"#LoggingPipeline\" class=\"headerlink\" title=\"LoggingPipeline\"></a>LoggingPipeline</h2><p>Because we don’t want logging to affect the timeout, this will be the first pipeline to be added to the chain.</p>\n<p>Inside the <code>Pipelines</code> folder, create a <code>LoggingPipeline</code> class implementing <code>IPipeline</code>. This pipeline will receive an <code>ILogger</code> instance and use <code>System.Text.Json</code> to serialize the objects:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">LoggingPipeline</span> : <span class=\"title\">IPipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ILogger&lt;LoggingPipeline&gt; _logger;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> JsonSerializerOptions _serializerOptions = <span class=\"keyword\">new</span> JsonSerializerOptions</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        WriteIndented = <span class=\"literal\">true</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LoggingPipeline</span>(<span class=\"params\">ILogger&lt;LoggingPipeline&gt; logger</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger = logger;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TCommand : <span class=\"keyword\">class</span>, ICommand</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Log(<span class=\"string\">&quot;Command: &#123;command&#125;&quot;</span>, cmd);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TCommand : <span class=\"keyword\">class</span>, ICommand&lt;TResult&gt;</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Log(<span class=\"string\">&quot;Command: &#123;command&#125;&quot;</span>, cmd);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        Log(<span class=\"string\">&quot;Command.Result: &#123;commandResult&#125;&quot;</span>, result);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnEventAsync</span>&lt;<span class=\"title\">TEvent</span>&gt;(<span class=\"params\">Func&lt;TEvent, CancellationToken, Task&gt; next, TEvent evt, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TEvent : <span class=\"keyword\">class</span>, IEvent</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Log(<span class=\"string\">&quot;Event: &#123;event&#125;&quot;</span>, evt);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(evt, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnQueryAsync</span>&lt;<span class=\"title\">TQuery</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, TQuery query, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TQuery : <span class=\"keyword\">class</span>, IQuery&lt;TResult&gt;</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Log(<span class=\"string\">&quot;Query: &#123;query&#125;&quot;</span>, query);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> next(query, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        Log(<span class=\"string\">&quot;Query.Result: &#123;queryResult&#125;&quot;</span>, result);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">Log</span>&lt;<span class=\"title\">T</span>&gt;(<span class=\"params\"><span class=\"built_in\">string</span> message, T instance</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (_logger.IsEnabled(LogLevel.Trace))</span><br><span class=\"line\">            _logger.LogTrace(message, JsonSerializer.Serialize(instance, _serializerOptions));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Startup.cs</code> file and register the pipeline into the mediator:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">services.AddMediator(o =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">    </span><br><span class=\"line\">    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>appsettings.development.json</code> file and set the default log level to <code>Trace</code>:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;Logging&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;LogLevel&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Default&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Trace&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Microsoft&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Warning&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Microsoft.Hosting.Lifetime&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Information&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>If you now start the server and do some actions in the API, like creating or searching for products, you should start seeing your objects being serialized:</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/05_pipeline_logging_logs.png\" class=\"\">\n\n<p><em>As a note, if you find this helpful for your APIs, you can use the NuGet <a href=\"https://www.nuget.org/packages/simplesoft.mediator.microsoft.extensions.loggingpipeline\">SimpleSoft.Mediator.Microsoft.Extensions.LoggingPipeline</a>. Just give a look at the <code>Startup.cs</code> file in <a href=\"https://github.com/simplesoft-pt/Mediator/blob/master/work/SimpleSoft.Mediator.Example.Api/Startup.cs\">the example API</a>.</em></p>\n<h2 id=\"TimeoutPipeline\"><a href=\"#TimeoutPipeline\" class=\"headerlink\" title=\"TimeoutPipeline\"></a>TimeoutPipeline</h2><p>Inside the <code>Pipelines</code> folder, create a <code>TimeoutPipeline</code> class implementing <code>IPipeline</code>. For simplicity, the timeout value will be fixed, but could be received as an options from the container.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">TimeoutPipeline</span> : <span class=\"title\">IPipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">readonly</span> TimeSpan Timeout = TimeSpan.FromMilliseconds(<span class=\"number\">500</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TCommand : <span class=\"keyword\">class</span>, ICommand</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> cts = CreateCancellationTokenSource(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(cmd, cts.Token);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TCommand : <span class=\"keyword\">class</span>, ICommand&lt;TResult&gt;</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> cts = CreateCancellationTokenSource(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> next(cmd, cts.Token);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnEventAsync</span>&lt;<span class=\"title\">TEvent</span>&gt;(<span class=\"params\">Func&lt;TEvent, CancellationToken, Task&gt; next, TEvent evt, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TEvent : <span class=\"keyword\">class</span>, IEvent</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> cts = CreateCancellationTokenSource(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(evt, cts.Token);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnQueryAsync</span>&lt;<span class=\"title\">TQuery</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, TQuery query, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TQuery : <span class=\"keyword\">class</span>, IQuery&lt;TResult&gt;</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> cts = CreateCancellationTokenSource(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> next(query, cts.Token);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> CancellationTokenSource <span class=\"title\">CreateCancellationTokenSource</span>(<span class=\"params\">CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> cts = CancellationTokenSource.CreateLinkedTokenSource(ct);</span><br><span class=\"line\">        cts.CancelAfter(Timeout);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> cts;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Once again, open the <code>Startup.cs</code> file and register the pipeline into the mediator <strong>after</strong> the logging pipe:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">services.AddMediator(o =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">    o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">    </span><br><span class=\"line\">    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>If you now open any of your handlers and add an <code>Task.Delay(1000, ct)</code> into the <code>HandleAsync</code> methods you should receive a <code>TaskCanceledException</code>. I added one when searching for products:</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/06_pipeline_timeout_stacktrace_response.png\" class=\"\">\n\n<p>If you look at the stack trace, you’ll see the invocation order was kept:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ProductsController</span><br><span class=\"line\">    MicrosoftFetcher (internal class used by the mediator)</span><br><span class=\"line\">        LoggingPipeline</span><br><span class=\"line\">            TimeoutPipeline</span><br><span class=\"line\">                SearchProductsQueryHandler</span><br></pre></td></tr></table></figure>\n\n<p>The project structure with pipeline classes:</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/07_project_structure_pipelines_impl.png\" class=\"\">\n\n<p>The final <code>Startup.cs</code> file:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddMediator(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        app.UseDeveloperExceptionPage();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwagger();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwaggerUI(c =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            c.SwaggerEndpoint(<span class=\"string\">&quot;/swagger/v1/swagger.json&quot;</span>, <span class=\"string\">&quot;Mediator ExampleApi V1&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseRouting();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseEndpoints(endpoints =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            endpoints.MapControllers();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>I hope this article gave you a good idea about mediator pipelines and how you can use them to empower your solutions, making them more resilient to developer mistakes (like forgetting to save changes into the database).</p>\n<p>For me, this is one of the strongest aspects of the mediator pattern and one of the main reason I always use this pattern even when implementing <strong>minimum viable products</strong>.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp",
                "patterns"
            ]
        },
        {
            "id": "https://code-corner.dev/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/",
            "url": "https://code-corner.dev/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/",
            "title": "Mediator Pattern in ASP.NET Core Applications",
            "date_published": "2020-10-28T00:00:00.000Z",
            "content_html": "<p>For the last few years, <strong>Command Query Responsibility Segregation (CQRS)</strong> and <strong>Event Sourcing (ES)</strong> emerged as patterns that can help implement large scale systems, with some risky complexity, by having different models to read or mutate data while also using events as a single source of truth.</p>\n<p>Since there are already great articles explaining <a href=\"https://martinfowler.com/bliki/CQRS.html\"><strong>CQRS</strong></a> or <a href=\"https://martinfowler.com/eaaDev/EventSourcing.html\"><strong>ES</strong></a> in great depth, I’m going to focus and show how you can decouple your application layers by only knowing POCOs and a mediator instance from <a href=\"https://www.nuget.org/packages/simplesoft.mediator\">SimpleSoft.Mediator</a>.</p>\n<p>Remember that, even if you are not using <strong>CQRS</strong> or <strong>ES</strong> to its full extend, just by ensuring a logical model segregation inside the project can make your life easier in the long run, even when implementing a simple <strong>Backend for Frontend (BFF)</strong> or a <strong>minimum viable product (MVP)</strong>.</p>\n<h1 id=\"Commands-Queries-Events-Handlers-and-Mediator\"><a href=\"#Commands-Queries-Events-Handlers-and-Mediator\" class=\"headerlink\" title=\"Commands, Queries, Events, Handlers and Mediator\"></a>Commands, Queries, Events, Handlers and Mediator</h1><p>Before showing some code, lets make a simple review of some core concepts about these patterns and the library we are going to use:</p>\n<ul>\n<li><strong>Commands</strong> - each action intended to change the system state, by creating, updating or deleting information, should be represented by a class implementing either <code>ICommand</code> or <code>ICommand&lt;TResult&gt;</code>, if you are using the mediator just for in-process decoupling and want to return a result synchronously. Examples: <code>CreateProductCommand</code> or <code>DeleteUserCommand</code>;</li>\n<li><strong>Queries</strong> - classes implementing <code>IQuery&lt;TResult&gt;</code> represent data reads that shouldn’t change the system state or else they must be considered commands. Examples: <code>GetProductByIdQuery</code> or <code>SearchUsersQuery</code>;</li>\n<li><strong>Events</strong> — representing system changes over time, these classes implement <code>IEvent</code>. Examples: <code>ProductCreatedEvent</code> or <code>UpdatedUserEmailEvent</code>;</li>\n<li><strong>Handlers</strong> — responsible for receiving the commands (<code>ICommandHandler</code>), queries (<code>IQueryHandler</code>) or events (<code>IEventHandler</code>), they implement the business behavior to be run. Examples: <code>CreateProductCommandHandler</code> or <code>GetProductByIdQueryHandler</code>;</li>\n<li><strong>Mediator</strong> — decouples the caller from the executor exposing generic methods to send commands, fetch queries or broadcast events, being responsible for finding the correct handler (or handlers, in case of an event) and is represented by the interface <code>IMediator</code>;</li>\n</ul>\n<p>I also made articles <a href=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Using Mediator Pipelines in ASP.NET Core Applications\">explaining how pipelines work</a>, how to enforce <a href=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Validation with Mediator Pipelines in ASP.NET Core Applications\">validations</a>, how to <a href=\"/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/\" title=\"Transaction Management With Mediator Pipelines in ASP.NET Core\">manage transactions</a> and how to <a href=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/\" title=\"Auditing with Mediator Pipelines in ASP.NET Core\">audit user actions</a>.</p>\n<hr>\n<h1 id=\"The-project\"><a href=\"#The-project\" class=\"headerlink\" title=\"The project\"></a>The project</h1><p>The source code for this article can be found on <a href=\"https://github.com/gravity00/IntroductionMediatorCQRS\">GitHub</a>.</p>\n<p>Start by opening Visual Studio and creating an <strong>ASP.NET Core 3.1 Web Application</strong> with a name and at any location.</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/configure-project.png\" class=\"\">\n\n<p>Choose an empty project since this is just a demo.</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/configure-project-empty.png\" class=\"\">\n\n<p>Install the Nuget <code>Swashbuckle.AspNetCore</code> so we can use Swagger to test the API:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/configure-project-nuget-swagger.png\" class=\"\">\n\n<p>Open the file <code>Startup.cs</code> and configure both MVC and Swagger, making it easier to test our web API.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        app.UseDeveloperExceptionPage();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwagger();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwaggerUI(c =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            c.SwaggerEndpoint(<span class=\"string\">&quot;/swagger/v1/swagger.json&quot;</span>, <span class=\"string\">&quot;Mediator ExampleApi V1&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseRouting();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseEndpoints(endpoints =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            endpoints.MapControllers();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"The-web-API\"><a href=\"#The-web-API\" class=\"headerlink\" title=\"The web API\"></a>The web API</h1><p>Since the objective of this article is to show the mediator pattern, a simple endpoint to manage products should be enough:</p>\n<ul>\n<li>GET &#x2F;products — search for products using some filters;</li>\n<li>GET &#x2F;products&#x2F;{id} — get a product by its unique identifier;</li>\n<li>POST &#x2F;products — create a product;</li>\n<li>PUT &#x2F;products&#x2F;{id} — update a product by its unique identifier;</li>\n<li>DELETE &#x2F;products&#x2F;{id} — delete a product by its unique identifier;</li>\n</ul>\n<p>Create a <code>Controllers</code> folder with another <code>Products</code> folder inside, a <code>ProductsController</code> and the following models:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;products&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    [<span class=\"meta\">HttpGet</span>]</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;IEnumerable&lt;ProductModel&gt;&gt; SearchAsync([FromQuery] <span class=\"built_in\">string</span> filterQ, [FromQuery] <span class=\"built_in\">int</span>? skip, [FromQuery] <span class=\"built_in\">int</span>? take, CancellationToken ct)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NotImplementedException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;ProductModel&gt; <span class=\"title\">GetByIdAsync</span>(<span class=\"params\">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NotImplementedException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpPost</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResultModel&gt; <span class=\"title\">CreateAsync</span>(<span class=\"params\">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NotImplementedException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpPut(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">UpdateAsync</span>(<span class=\"params\">[FromRoute] Guid id, [FromBody] UpdateProductModel model, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NotImplementedException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpDelete(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">DeleteAsync</span>(<span class=\"params\">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NotImplementedException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductResultModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">UpdateProductModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The project should look as follows:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/web-api-project-structure.png\" class=\"\">\n\n<p>Open the Swagger endpoint (ex: <a href=\"https://localhost:44380/swagger/index.html\">https://localhost:44380/swagger/index.html</a>) and you should see your products endpoint with all the actions:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/web-api-swagger.png\" class=\"\">\n\n<h2 id=\"The-database-model\"><a href=\"#The-database-model\" class=\"headerlink\" title=\"The database model\"></a>The database model</h2><p>For demo purposes we are going to use <strong>Entity Framework Core</strong> with data stored in-memory.</p>\n<p>Install the Nuget <code>Microsoft.EntityFrameworkCore.InMemory</code>:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/database-model-nuget-ef-core-inmemory.png\" class=\"\">\n\n<p>Create a <code>Database</code> folder, the following database context and entities for products and events, to store both the business data and mutations history:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ApiDbContext</span> : <span class=\"title\">DbContext</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ApiDbContext</span>(<span class=\"params\">DbContextOptions&lt;ApiDbContext&gt; options</span>) : <span class=\"title\">base</span>(<span class=\"params\">options</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">OnModelCreating</span>(<span class=\"params\">ModelBuilder builder</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">base</span>.OnModelCreating(builder);</span><br><span class=\"line\"></span><br><span class=\"line\">        builder.Entity&lt;ProductEntity&gt;(cfg =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            cfg.HasKey(e =&gt; e.Id);</span><br><span class=\"line\">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class=\"line\">            cfg.HasIndex(e =&gt; e.Code).IsUnique();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.ExternalId)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Code)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">8</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Name)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Price)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        builder.Entity&lt;EventEntity&gt;(cfg =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            cfg.HasKey(e =&gt; e.Id);</span><br><span class=\"line\">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class=\"line\">            cfg.HasIndex(e =&gt; e.CreatedOn);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Name)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Payload)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedOn)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedBy)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">EventEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Startup.cs</code> file and add the context into the container as an in-memory database:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>The project should look as follows:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/database-model-project-structure.png\" class=\"\">\n\n<h1 id=\"The-mediator\"><a href=\"#The-mediator\" class=\"headerlink\" title=\"The mediator\"></a>The mediator</h1><p>Now that we have created the demo endpoint, models and database, its time to configure the mediator.</p>\n<p>Install the Nuget <code>SimpleSoft.Mediator.Microsoft.Extensions</code> which is a specialized package for projects using <code>Microsoft.Extensions.*</code>:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/mediator-nuget.png\" class=\"\">\n\n<p>Open the <code>Startup.cs</code> file and add the mediator into the container, scanning the current assembly for all classes implementing <code>ICommandHandler</code>, <code>IQueryHandler</code> and <code>IEventHandler</code>:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">services.AddMediator(o =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>ProductsController.cs</code> file and inject into the constructor the <code>IMediator</code> instance:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProductsController</span>(<span class=\"params\">IMediator mediator</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    _mediator = mediator;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"The-handlers\"><a href=\"#The-handlers\" class=\"headerlink\" title=\"The handlers\"></a>The handlers</h1><p>We now have everything we need to start implementing the business logic.</p>\n<p>To keep it simple, we are not going to use the mediator pipelines, only focusing on commands, queries, events and their handlers. As stated before, I made <a href=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Using Mediator Pipelines in ASP.NET Core Applications\">some articles more specific for those use cases</a>.</p>\n<p>Start by creating a folder named <code>Handlers</code> with another inside <code>Products</code> in which we are going to put our POCOs and their handlers.</p>\n<p><em>As a note, remember this is a demo article and this project structure <strong>should not be seen as a valid way to organize your solution</strong> in your private projects. Commands, queries, events and their handlers should be, at minimum, in different folders.</em></p>\n<h2 id=\"CreateProductComand\"><a href=\"#CreateProductComand\" class=\"headerlink\" title=\"CreateProductComand\"></a>CreateProductComand</h2><p>We need data so lets create a command that allows that and will be sent when a request for POST &#x2F;products is received.</p>\n<p>Create a class <code>CreateProductResult</code> that will be returned by the handler with the product unique identifier and a <code>CreateProductCommand</code>, implementing the class <code>Command&lt;CreateProductResult&gt;</code>:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductCommand</span> : <span class=\"title\">Command</span>&lt;<span class=\"title\">CreateProductResult</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductResult</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>ProductsController.cs</code> file and inside the method <code>CreateAsync</code> send the command into the mediator and map its result:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;products&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProductsController</span>(<span class=\"params\">IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpPost</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResultModel&gt; <span class=\"title\">CreateAsync</span>(<span class=\"params\">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.SendAsync(<span class=\"keyword\">new</span> CreateProductCommand</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Code = model.Code,</span><br><span class=\"line\">            Name = model.Name,</span><br><span class=\"line\">            Price = model.Price</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CreateProductResultModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = result.Id</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If we now invoked the endpoint, we would receive an exception saying that no <code>ICommandHandler&lt;CreateProductCommand, CreateProductResult&gt;</code> was found by the container.</p>\n<p>We will fix that by creating the class <code>CreateProductCommandHandler</code> with the business logic for this action. For this demo, an <code>InvalidOperationException</code> with a custom message will be thrown when a duplicated code is received:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductCommandHandler</span> : <span class=\"title\">ICommandHandler</span>&lt;<span class=\"title\">CreateProductCommand</span>, <span class=\"title\">CreateProductResult</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreateProductCommandHandler</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResult&gt; <span class=\"title\">HandleAsync</span>(<span class=\"params\">CreateProductCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">await</span> products.AnyAsync(p =&gt; p.Code == cmd.Code, ct))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">$&quot;Product code &#x27;<span class=\"subst\">&#123;cmd.Code&#125;</span>&#x27; already exists&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> externalId = Guid.NewGuid();</span><br><span class=\"line\">        <span class=\"keyword\">await</span> products.AddAsync(<span class=\"keyword\">new</span> ProductEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId,</span><br><span class=\"line\">            Code = cmd.Code,</span><br><span class=\"line\">            Name = cmd.Name,</span><br><span class=\"line\">            Price = cmd.Price</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CreateProductResult</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = externalId</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If you now try to create a product using the Swagger endpoint, you will receive the response with the unique identifier or an internal server error indicating a duplicated code.</p>\n<p>The project should look as follows:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/handlers-project-structure-01.png\" class=\"\">\n\n<h2 id=\"GetProductByIdQuery\"><a href=\"#GetProductByIdQuery\" class=\"headerlink\" title=\"GetProductByIdQuery\"></a>GetProductByIdQuery</h2><p>Time to return a product when a GET &#x2F;products&#x2F;:id is received by the web API.</p>\n<p>Inside the <code>Handlers/Products</code> folder, create a <code>Product</code>, the <code>GetProductByIdQuery</code> and its corresponding handler, <code>GetProductByIdQueryHandler</code>. Like in the previous handler, for this demo, we are going to throw an <code>InvalidOperationException</code> if the id is unknown:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">GetProductByIdQuery</span> : <span class=\"title\">Query</span>&lt;<span class=\"title\">Product</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ProductId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Product</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">GetProductByIdQueryHandler</span> : <span class=\"title\">IQueryHandler</span>&lt;<span class=\"title\">GetProductByIdQuery</span>, <span class=\"title\">Product</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IQueryable&lt;ProductEntity&gt; _products;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">GetProductByIdQueryHandler</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _products = context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;Product&gt; <span class=\"title\">HandleAsync</span>(<span class=\"params\">GetProductByIdQuery query, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> product = <span class=\"keyword\">await</span> _products.SingleOrDefaultAsync(p =&gt; p.ExternalId == query.ProductId, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (product == <span class=\"literal\">null</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">$&quot;Product &#x27;<span class=\"subst\">&#123;query.ProductId&#125;</span>&#x27; not found&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Product</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = product.ExternalId,</span><br><span class=\"line\">            Code = product.Code,</span><br><span class=\"line\">            Name = product.Name,</span><br><span class=\"line\">            Price = product.Price</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>ProductsController.cs</code> file and inside the method <code>GetByIdAsync</code> fetch the query from the mediator and map its result:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;products&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProductsController</span>(<span class=\"params\">IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;ProductModel&gt; <span class=\"title\">GetByIdAsync</span>(<span class=\"params\">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.FetchAsync(<span class=\"keyword\">new</span> GetProductByIdQuery</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ProductId = id</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ProductModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = result.Id,</span><br><span class=\"line\">            Code = result.Code,</span><br><span class=\"line\">            Name = result.Name,</span><br><span class=\"line\">            Price = result.Price</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If you now try to get a product using the Swagger endpoint, you will receive the product or an internal server error indicating an unknown identifier.</p>\n<h2 id=\"CreatedProductEvent\"><a href=\"#CreatedProductEvent\" class=\"headerlink\" title=\"CreatedProductEvent\"></a>CreatedProductEvent</h2><p>Finally, we are going to create an event that will be broadcast when a product is successfully created.</p>\n<p>Just like the previous ones, create a <code>CreateProductEvent</code> and the handler <code>CreateProductEventHandler</code> that will serialize and store it into the events table.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreatedProductEvent</span> : <span class=\"title\">Event</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreatedProductEventHandler</span> : <span class=\"title\">IEventHandler</span>&lt;<span class=\"title\">CreatedProductEvent</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreatedProductEventHandler</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">HandleAsync</span>(<span class=\"params\">CreatedProductEvent evt, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.Set&lt;EventEntity&gt;().AddAsync(<span class=\"keyword\">new</span> EventEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = evt.Id,</span><br><span class=\"line\">            Name = <span class=\"keyword\">nameof</span>(CreatedProductEvent),</span><br><span class=\"line\">            Payload = JsonSerializer.Serialize(evt),</span><br><span class=\"line\">            CreatedOn = evt.CreatedOn,</span><br><span class=\"line\">            CreatedBy = evt.CreatedBy</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>CreateProductCommandHandler</code> file, inject the <code>IMediator</code> instance and broadcast the event before saving flushing all changes into the database:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductCommandHandler</span> : <span class=\"title\">ICommandHandler</span>&lt;<span class=\"title\">CreateProductCommand</span>, <span class=\"title\">CreateProductResult</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreateProductCommandHandler</span>(<span class=\"params\">ApiDbContext context, IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResult&gt; <span class=\"title\">HandleAsync</span>(<span class=\"params\">CreateProductCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">await</span> products.AnyAsync(p =&gt; p.Code == cmd.Code, ct))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">$&quot;Product code &#x27;<span class=\"subst\">&#123;cmd.Code&#125;</span>&#x27; already exists&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> externalId = Guid.NewGuid();</span><br><span class=\"line\">        <span class=\"keyword\">await</span> products.AddAsync(<span class=\"keyword\">new</span> ProductEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId,</span><br><span class=\"line\">            Code = cmd.Code,</span><br><span class=\"line\">            Name = cmd.Name,</span><br><span class=\"line\">            Price = cmd.Price</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _mediator.BroadcastAsync(<span class=\"keyword\">new</span> CreatedProductEvent</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId,</span><br><span class=\"line\">            Code = cmd.Code,</span><br><span class=\"line\">            Name = cmd.Name,</span><br><span class=\"line\">            Price = cmd.Price</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CreateProductResult</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = externalId</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The project should look as follows:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/handlers-project-structure-02.png\" class=\"\">\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use the mediator to implement the <strong>CQRS</strong> and <strong>ES</strong> patterns even if you are implementing an <strong>MVP</strong> and can’t spend much time thinking about the architecture but you still want something that can be maintained and extended for some time.</p>\n<p>Soon I’ll be explaining more advanced scenarios, like using the mediator pipeline to validate commands before reaching the handler, managing database transactions or even implementing transversal auditing into you application.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp",
                "patterns"
            ]
        }
    ]
}