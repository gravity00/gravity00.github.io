{
    "version": "https://jsonfeed.org/version/1",
    "title": "code-corner.dev • All posts by \"aspnetcore\" tag",
    "description": "",
    "home_page_url": "https://code-corner.dev",
    "items": [
        {
            "id": "https://code-corner.dev/2024/02/29/NET-Hangfire/",
            "url": "https://code-corner.dev/2024/02/29/NET-Hangfire/",
            "title": ".NET - Hangfire",
            "date_published": "2024-02-29T00:00:00.000Z",
            "content_html": "<p>One common scenario when developing applications is the need to perform background processing than can either be run only once (like sending an email) or scheduled to be run multiple times within a given interval (like doing database housekeeping), usually defined by a <a href=\"https://en.wikipedia.org/wiki/Cron\">cron</a> expression.</p>\n<p>When I need to implement such requirements my first choice for the last few years as always been <a href=\"https://www.hangfire.io/\">Hangfire</a>.</p>\n<p>It integrates seamlessly with ASP.NET Core applications, it has a simple but very powerful dashboard to monitor and manually trigger recurring jobs and is open source and completely free for commercial use.</p>\n<p>In this article I’m going to explain how to configure both Hangfire server and dashboard into an ASP.NET Core application and recurrently send requests to HTTP endpoints, which will be configured based on application settings without requiring a service restart to detect changes.</p>\n<hr>\n<h2 id=\"Why-use-Hangfire-to-trigger-HTTP-endpoints\"><a href=\"#Why-use-Hangfire-to-trigger-HTTP-endpoints\" class=\"headerlink\" title=\"Why use Hangfire to trigger HTTP endpoints?\"></a>Why use Hangfire to trigger HTTP endpoints?</h2><p>An extremely common approach I use when implementing schedulers that may run millions of jobs per day is to use Hangfire to trigger HTTP endpoints, offloading work to external APIs instead of in process.</p>\n<img src=\"/2024/02/29/NET-Hangfire/01_http_architecture.png\" class=\"\">\n\n<p>By design, Hangfire is implemented to be easily distributed on different machines by orchestrating the job execution using a persistent data storage shared across all servers.</p>\n<p>The problem comes when some jobs need more processing power than others or millions of executions per day. You’ll have to maintain multiple nodes looking at different queues, code changes must be properly distributed to the relevant nodes, the database will probably become a bottleneck - even if using some message bus or in-memory cache.</p>\n<p>To attenuate this problem I usually prefer to keep Hangfire instances as simple as possible, by recurrently doing simple HTTP requests that can be configured either by settings files or database providers (<a href=\"/2023/12/21/Configuration-providers-in-NET/\" title=\"Configuration providers in .NET\">like exemplified in this article I recently made</a>). This allows to offload the heavy work to external APIs that can be more easily scaled, tested, distributed and monitored and ensuring you’ll need much fewer Hangfire instances to run millions of jobs per day while using the dashboard to keep track of job executions.</p>\n<h2 id=\"Solution-setup\"><a href=\"#Solution-setup\" class=\"headerlink\" title=\"Solution setup\"></a>Solution setup</h2><p>In this example, <a href=\"https://github.com/gravity00/article-hangfire\">which I have available on GitHub</a>, I’m going to setup an ASP.NET Core application with .NET 8 to host both Hangfire server and dashboard. For simplicity, the job storage will be in-memory but feel free to use any other of the supported ones (like SQL Server).</p>\n<p>Start by creating an empty ASP.NET Core project and register the following NuGet packages:</p>\n<ul>\n<li><code>Hangfire.AspNetCore</code> - depends  on <code>Hangfire.NetCore</code>, which is used to run the jobs server on <code>Microsoft.Extensions.Hosting</code> as a hosted service, but also brings a Web dashboard that can be used to manually trigger recurring jobs or check execution status;</li>\n<li><code>Hangfire.InMemory</code> - in-memory job storage but you can swap for any other of your preference, like <code>Hangfire.SqlServer</code>;</li>\n</ul>\n<p>Open the <code>Program.cs</code> file, register both the server and dashboard services into the dependency injection container and configure the dashboard to listen on base address:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.AddHangfire(config =&gt; config</span><br><span class=\"line\">    .UseInMemoryStorage()</span><br><span class=\"line\">);</span><br><span class=\"line\">builder.Services.AddHangfireServer();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> app = builder.Build();</span><br><span class=\"line\"></span><br><span class=\"line\">app.MapHangfireDashboard(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">app.Run();</span><br></pre></td></tr></table></figure>\n\n<p>If you run the application, the Hangfire dashboard will be shown with a single server running but without recurring jobs.</p>\n<img src=\"/2024/02/29/NET-Hangfire/02_setup.png\" class=\"\">\n\n<p>As you can see, in just a few minutes you have Hangfire up and ready do run. As stated previously, this is one of the reasons I always use Hangfire for scheduling jobs, the simplicity of it!</p>\n<h2 id=\"HTTP-job-options\"><a href=\"#HTTP-job-options\" class=\"headerlink\" title=\"HTTP job options\"></a>HTTP job options</h2><p>Now that we have both the server and dashboard running, let’s start by defining the recurring HTTP options that we’ll read from the application settings and dynamically configure endpoints to be recurrently triggered.</p>\n<p>Let’s start by defining the options for requesting a single endpoint. To keep things simple, I’ll assume the need for an HTTP address, method, headers and a request timeout. It will also need a <a href=\"https://en.wikipedia.org/wiki/Cron\">cron</a> expression, so we can define the  recurrency interval, and a flag to enable it so you can manage per environment which jobs are enabled.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">HttpJobEndpointOptions</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Cron &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">bool</span> Enabled &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Address &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Method &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> IReadOnlyDictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">string</span>&gt; Headers &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> TimeSpan? Timeout &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">bool</span> IgnoreInvalidStatusCode &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>We could now load a collection of <code>HttpJobEndpointOptions</code> from the application settings but let’s try to organize the endpoints into categories and also give a name for each. This will be handy later to have a more readable job name when looking at the Hangfire dashboard.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">HttpJobOptions</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> TimeSpan DefaultTimeout &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125; = TimeSpan.FromSeconds(<span class=\"number\">5</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> IReadOnlyDictionary&lt;</span><br><span class=\"line\">        <span class=\"built_in\">string</span>, </span><br><span class=\"line\">        IReadOnlyDictionary&lt;<span class=\"built_in\">string</span>, HttpJobEndpointOptions&gt;</span><br><span class=\"line\">    &gt; Endpoints &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>appsettings.json</code> file and configure an <code>IsAlive</code> job inside a <code>Core</code> category that’ll run every 5 minutes. This job will be used later for testing, so assume an HTTP request <code>GET /api/is-alive</code> to itself:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;HttpJobs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;DefaultTimeout&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;00:00:05&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Endpoints&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Core&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;IsAlive&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;Cron&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;*/5 * * * *&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;Enabled&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;Address&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;https://localhost:7076/api/is-alive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;Method&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;GET&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;Headers&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;accept&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;application/json&quot;</span></span><br><span class=\"line\">          <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;Timeout&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">null</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;IgnoreInvalidStatusCode&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;Logging&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;LogLevel&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Default&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Information&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Microsoft.AspNetCore&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Warning&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;AllowedHosts&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;*&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Program.cs</code> file and configure the <code>HttpJobOptions</code> from the <code>HttpJobs</code> section. Let’s also add the testing endpoint to be triggered later:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.AddHangfire(config =&gt; config</span><br><span class=\"line\">    .UseInMemoryStorage()</span><br><span class=\"line\">);</span><br><span class=\"line\">builder.Services.AddHangfireServer();</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.Configure&lt;HttpJobOptions&gt;(</span><br><span class=\"line\">    builder.Configuration.GetSection(<span class=\"string\">&quot;HttpJobs&quot;</span>)</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> app = builder.Build();</span><br><span class=\"line\"></span><br><span class=\"line\">app.MapGet(<span class=\"string\">&quot;/api/is-alive&quot;</span>, () =&gt; <span class=\"string\">&quot;I&#x27;m alive!&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">app.MapHangfireDashboard(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">app.Run();</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"HTTP-job-runner\"><a href=\"#HTTP-job-runner\" class=\"headerlink\" title=\"HTTP job runner\"></a>HTTP job runner</h2><p>Now that we have defined the job options, let’s create the class that will be recurrently executed by the Hangfire server.</p>\n<p>The core idea of this class is to be responsible to do a single HTTP request by receiving both the category and endpoint names as a parameter, looking up for the configuration in the <code>HttpJobOptions</code> instance and doing the expected HTTP request. It will also receive a <code>PerformContext</code> instance which is a special (but optional) class provided by Hangfire to give context to your methods.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">HttpJobRunner</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    ILogger&lt;HttpJobRunner&gt; logger,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IOptionsMonitor&lt;HttpJobOptions&gt; options,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IHttpClientFactory clientFactory</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> HttpJobOptions Options =&gt; options.CurrentValue;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">RunAsync</span>(<span class=\"params\"><span class=\"built_in\">string</span> category, <span class=\"built_in\">string</span> name, PerformContext ctx</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> _ = logger.BeginScope(</span><br><span class=\"line\">            <span class=\"string\">&quot;Category:&#123;Category&#125; Name:&#123;Name&#125; JobId:&#123;JobId&#125;&quot;</span>,</span><br><span class=\"line\">            category,</span><br><span class=\"line\">            name,</span><br><span class=\"line\">            ctx.BackgroundJob.Id</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!Options.Endpoints.TryGetValue(category, <span class=\"keyword\">out</span> <span class=\"keyword\">var</span> endpoints))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            logger.LogWarning(<span class=\"string\">&quot;Configuration for category not found&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!endpoints.TryGetValue(name, <span class=\"keyword\">out</span> <span class=\"keyword\">var</span> endpoint))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            logger.LogWarning(<span class=\"string\">&quot;Configuration for endpoint not found&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!endpoint.Enabled)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            logger.LogWarning(<span class=\"string\">&quot;Endpoint was disabled while still scheduled, nothing will be done&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> client = clientFactory.CreateClient(</span><br><span class=\"line\">            <span class=\"string\">$&quot;<span class=\"subst\">&#123;<span class=\"keyword\">nameof</span>(HttpJobRunner)&#125;</span>.<span class=\"subst\">&#123;category&#125;</span>.<span class=\"subst\">&#123;name&#125;</span>&quot;</span></span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        client.Timeout = endpoint.Timeout ?? Options.DefaultTimeout;</span><br><span class=\"line\"></span><br><span class=\"line\">        logger.LogDebug(</span><br><span class=\"line\">            <span class=\"string\">&quot;Starting HTTP request &#x27;&#123;Method&#125; &#123;Address&#125;&#x27; [Timeout:&#123;Timeout&#125;]&quot;</span>,</span><br><span class=\"line\">            endpoint.Method,</span><br><span class=\"line\">            endpoint.Address,</span><br><span class=\"line\">            client.Timeout</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> request = <span class=\"keyword\">new</span> HttpRequestMessage(</span><br><span class=\"line\">            <span class=\"keyword\">new</span> HttpMethod(endpoint.Method),</span><br><span class=\"line\">            endpoint.Address</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (endpoint.Headers?.Count &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> (key, <span class=\"keyword\">value</span>) <span class=\"keyword\">in</span> endpoint.Headers)</span><br><span class=\"line\">                request.Headers.Add(key, <span class=\"keyword\">value</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> ct = ctx.CancellationToken.ShutdownToken;</span><br><span class=\"line\"></span><br><span class=\"line\">        HttpResponseMessage response;</span><br><span class=\"line\">        <span class=\"keyword\">try</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            response = <span class=\"keyword\">await</span> client.SendAsync(request, ct);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">catch</span> (TaskCanceledException e) <span class=\"keyword\">when</span> (!ct.IsCancellationRequested)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> TimeoutException(<span class=\"string\">&quot;Request timed out&quot;</span>, e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">using</span> (response)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            logger.LogInformation(</span><br><span class=\"line\">                <span class=\"string\">&quot;Completed HTTP request &#x27;&#123;Method&#125; &#123;Address&#125;&#x27; with status code &#123;StatusCode&#125;&quot;</span>,</span><br><span class=\"line\">                endpoint.Method,</span><br><span class=\"line\">                endpoint.Address,</span><br><span class=\"line\">                response.StatusCode</span><br><span class=\"line\">            );</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!endpoint.IgnoreInvalidStatusCode)</span><br><span class=\"line\">                response.EnsureSuccessStatusCode();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Register into the DI container the HTTP client services (because we are using the <code>IHttpClientFactory</code>) and also this class as transient.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.AddHangfire(config =&gt; config</span><br><span class=\"line\">    .UseInMemoryStorage()</span><br><span class=\"line\">);</span><br><span class=\"line\">builder.Services.AddHangfireServer();</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.Configure&lt;HttpJobOptions&gt;(</span><br><span class=\"line\">    builder.Configuration.GetSection(<span class=\"string\">&quot;HttpJobs&quot;</span>)</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.AddHttpClient();</span><br><span class=\"line\">builder.Services.AddTransient&lt;HttpJobRunner&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> app = builder.Build();</span><br><span class=\"line\"></span><br><span class=\"line\">app.MapGet(<span class=\"string\">&quot;/api/is-alive&quot;</span>, () =&gt; <span class=\"string\">&quot;I&#x27;m alive!&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">app.MapHangfireDashboard(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">app.Run();</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"HTTP-hosted-service\"><a href=\"#HTTP-hosted-service\" class=\"headerlink\" title=\"HTTP hosted service\"></a>HTTP hosted service</h2><p>It is time to let Hangfire know that we have endpoints that must be requested on a recurrent basis. </p>\n<p>To configure the class <code>HttpJobRunner</code> as a recurring job, we can use either the static method <code>RecurringJob.AddOrUpdate</code> or the equivalent methods provided by <code>IRecurringJobManager</code>.</p>\n<p>A manual registration of the <code>HTTP:Core:IsAlive</code> job we defined in the application settings would be as follows:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// using static class RecurringJob</span></span><br><span class=\"line\">RecurringJob.AddOrUpdate&lt;HttpJobRunner&gt;(</span><br><span class=\"line\">    <span class=\"string\">&quot;HTTP:Core:IsAlive&quot;</span>,</span><br><span class=\"line\">    runner =&gt; runner.RunAsync(<span class=\"string\">&quot;Core&quot;</span>, <span class=\"string\">&quot;IsAlive&quot;</span>, <span class=\"literal\">null</span>),</span><br><span class=\"line\">    <span class=\"string\">&quot;*/5 * * * *&quot;</span>,</span><br><span class=\"line\">    <span class=\"keyword\">new</span> RecurringJobOptions</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        TimeZone = TimeZoneInfo.Utc</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// using IRecurringJobManager instance</span></span><br><span class=\"line\">jobManager.AddOrUpdate&lt;HttpJobRunner&gt;(</span><br><span class=\"line\">    <span class=\"string\">&quot;HTTP:Core:IsAlive&quot;</span>,</span><br><span class=\"line\">    runner =&gt; runner.RunAsync(<span class=\"string\">&quot;Core&quot;</span>, <span class=\"string\">&quot;IsAlive&quot;</span>, <span class=\"literal\">null</span>),</span><br><span class=\"line\">    <span class=\"string\">&quot;*/5 * * * *&quot;</span>,</span><br><span class=\"line\">    <span class=\"keyword\">new</span> RecurringJobOptions</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        TimeZone = TimeZoneInfo.Utc</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n\n<p>As you can see, we pass an expression to the <code>AddOrUpdate</code> method that will be used by Hangfire to build dynamic code to call the <code>RunAsync</code> method of our <code>HttpJobRunner</code> class, including the parameters we specify. As stated before, the <code>PerformContext</code> parameter is special and despite we are passing  null when defining the expression, Hangfire will actually create a context each time the method is run.</p>\n<p>With this simple yet effective approach, Hangfire doesn’t impose any interface or abstract class that must be implemented, making our life much easier.</p>\n<p>This registration could be done at application startup but since we want do detect changes to the application settings without restarting the server, let’s create a hosted service that will be running in the background and either add or remove scheduler jobs. As a note, since Hangfire doesn’t provide a way to get currently registered jobs so we can remove inexistent, we’ll register the hosted service as a singleton and have a collection in-memory to track registered job ids.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">HttpJobHostedService</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    ILogger&lt;HttpJobHostedService&gt; logger,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IOptionsMonitor&lt;HttpJobOptions&gt; options,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IRecurringJobManager jobManager</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>) : IHostedService</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> HashSet&lt;<span class=\"built_in\">string</span>&gt; _jobIds = <span class=\"keyword\">new</span>();</span><br><span class=\"line\">    <span class=\"keyword\">private</span> IDisposable _onOptionsChange;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Task <span class=\"title\">StartAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _onOptionsChange = options.OnChange(jobOptions =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            logger.LogDebug(<span class=\"string\">&quot;Configuration changed, scheduling jobs&quot;</span>);</span><br><span class=\"line\">            ScheduleJobs(jobOptions);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        logger.LogDebug(<span class=\"string\">&quot;Initial configuration, scheduling jobs&quot;</span>);</span><br><span class=\"line\">        ScheduleJobs(options.CurrentValue);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Task.CompletedTask;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Task <span class=\"title\">StopAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _onOptionsChange?.Dispose();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Task.CompletedTask;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">ScheduleJobs</span>(<span class=\"params\">HttpJobOptions options</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> currentJobIds = <span class=\"keyword\">new</span> HashSet&lt;<span class=\"built_in\">string</span>&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (options.Endpoints <span class=\"keyword\">is</span> &#123; Count: &gt; <span class=\"number\">0</span> &#125;)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> (category, endpoints) <span class=\"keyword\">in</span> options.Endpoints)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (endpoints <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> &#123; Count: &gt; <span class=\"number\">0</span> &#125;)</span><br><span class=\"line\">                    <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> (name, endpoint) <span class=\"keyword\">in</span> endpoints)</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (!endpoint.Enabled)</span><br><span class=\"line\">                        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">var</span> jobId = <span class=\"string\">$&quot;HTTP:<span class=\"subst\">&#123;category&#125;</span>:<span class=\"subst\">&#123;name&#125;</span>&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                    jobManager.AddOrUpdate&lt;HttpJobRunner&gt;(</span><br><span class=\"line\">                        jobId,</span><br><span class=\"line\">                        runner =&gt; runner.RunAsync(category, name, <span class=\"literal\">null</span>),</span><br><span class=\"line\">                        endpoint.Cron,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> RecurringJobOptions</span><br><span class=\"line\">                        &#123;</span><br><span class=\"line\">                            TimeZone = TimeZoneInfo.Utc</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    );</span><br><span class=\"line\"></span><br><span class=\"line\">                    currentJobIds.Add(jobId);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        _jobIds.RemoveWhere(jobId =&gt; currentJobIds.Contains(jobId));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> jobId <span class=\"keyword\">in</span> _jobIds) </span><br><span class=\"line\">            jobManager.RemoveIfExists(jobId);</span><br><span class=\"line\"></span><br><span class=\"line\">        _jobIds.Clear();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> jobId <span class=\"keyword\">in</span> currentJobIds)</span><br><span class=\"line\">            _jobIds.Add(jobId);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Register this class into the Dependency Injection container as a hosted service.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.AddHangfire(config =&gt; config</span><br><span class=\"line\">    .UseInMemoryStorage()</span><br><span class=\"line\">);</span><br><span class=\"line\">builder.Services.AddHangfireServer();</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.Configure&lt;HttpJobOptions&gt;(</span><br><span class=\"line\">    builder.Configuration.GetSection(<span class=\"string\">&quot;HttpJobs&quot;</span>)</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.AddHttpClient();</span><br><span class=\"line\">builder.Services.AddTransient&lt;HttpJobRunner&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.AddHostedService&lt;HttpJobHostedService&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> app = builder.Build();</span><br><span class=\"line\"></span><br><span class=\"line\">app.MapGet(<span class=\"string\">&quot;/api/is-alive&quot;</span>, () =&gt; <span class=\"string\">&quot;I&#x27;m alive!&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">app.MapHangfireDashboard(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">app.Run();</span><br></pre></td></tr></table></figure>\n\n<p>If you now run the application, the Hangfire dashboard will show the <code>HTTP:Core:IsAlive</code> recurring job to be run every 5 minutes.</p>\n<img src=\"/2024/02/29/NET-Hangfire/03_recurring_jobs_initial.png\" class=\"\">\n\n<p>Try to change the application settings while the application is running, like changing the <em>cron</em> expression, disabling, removing or creating jobs, so you can see the recurring job list to change accordingly.</p>\n<p>If you wait for the jobs to run (or manually trigger) and go to the <code>Jobs</code> tab, open the <code>Succeeded</code> status and you’ll see the list of all jobs that have run successfully.</p>\n<img src=\"/2024/02/29/NET-Hangfire/04_jobs_initial.png\" class=\"\">\n\n<p>If you open one of the jobs, you’ll see details about it’s execution, like the parameters that were passed, the execution time and, if it was failed, the exception details.</p>\n<img src=\"/2024/02/29/NET-Hangfire/05_jobs_detail_initial.png\" class=\"\">\n\n<h2 id=\"Job-filters\"><a href=\"#Job-filters\" class=\"headerlink\" title=\"Job filters\"></a>Job filters</h2><p>The code is looking nice and simple and seems to work very well but there’s still three problems that I think should be solved: </p>\n<ol>\n<li>If you have multiple HTTP endpoints you can’t tell just looking at the list which one was called without checking execution details. In this case every job is called <code>HttpJobRunner.RunAsync</code>, independently the endpoint;</li>\n<li>Since this is a recurring and stateless job so, when it fails, there’s no point in keeping it in the failed state to be retried, we can move it to the deleted stated that would be automatically housekept by Hangfire;</li>\n<li>If for some reason a job for a given endpoint takes more time to run than its <em>cron</em> interval, multiple executions will overlap and cause requests to happen concurrently, which may not be the expected behavior;</li>\n</ol>\n<p>To solve these problems we are going to use Hangfire filters, which are attributes that can be used to annotate methods (or registered globally) to add custom behavior when running a job, working similarly to ASP.NET Core MVC filters.</p>\n<p>We are going to use the <code>JobDisplayName</code> filter to define the job name in the dashboard, the <code>AutomaticRetry</code> filter to mark the job as deleted when failed, and create a custom filter than will lock job executions per endpoint until the previous one has completed.</p>\n<p>Starting by the custom filter, we must extend the <code>JobFilterAttribute</code> and because it’s changing the behavior of a job execution, it must also implement the <code>IServerFilter</code> interface. We are going to use both the category and endpoint name parameters to create a unique identifier per endpoint execution and use an Hangfire distributed lock feature to ensure a job for the same endpoint only runs after the lock is disposed by a previous execution.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">EnableDistributedMutexAttribute</span> : <span class=\"title\">JobFilterAttribute</span>, <span class=\"title\">IServerFilter</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">const</span> <span class=\"built_in\">string</span> Key = <span class=\"keyword\">nameof</span>(EnableDistributedMutexAttribute);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> <span class=\"built_in\">string</span> _nameFormat;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> TimeSpan _timeout;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">EnableDistributedMutexAttribute</span>(<span class=\"params\"><span class=\"built_in\">string</span> nameFormat, <span class=\"built_in\">int</span> timeoutInSeconds</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        ArgumentNullException.ThrowIfNull(nameFormat);</span><br><span class=\"line\">        ArgumentOutOfRangeException.ThrowIfLessThanOrEqual(timeoutInSeconds, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        _nameFormat = nameFormat;</span><br><span class=\"line\">        _timeout = TimeSpan.FromSeconds(timeoutInSeconds);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">OnPerforming</span>(<span class=\"params\">PerformingContext ctx</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> distributedLockName = <span class=\"built_in\">string</span>.Format(</span><br><span class=\"line\">            _nameFormat,</span><br><span class=\"line\">            ctx.BackgroundJob.Job.Args.ToArray()</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> distributedLock = ctx.Connection.AcquireDistributedLock(</span><br><span class=\"line\">            distributedLockName,</span><br><span class=\"line\">            _timeout</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        ctx.Items[Key] = distributedLock;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">OnPerformed</span>(<span class=\"params\">PerformedContext ctx</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!ctx.Items.TryGetValue(Key, <span class=\"keyword\">out</span> <span class=\"keyword\">var</span> distributedLock))</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">&quot;Can not release a distributed lock: it was not acquired.&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        ((IDisposable)distributedLock).Dispose();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>HttpJobRunner</code> class and annotate the <code>RunAsync</code> method with a <code>JobDisplayName</code>, <code>EnableDistributedMutex</code> and <code>AutomaticRetry</code> attributes.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">HttpJobRunner</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    ILogger&lt;HttpJobRunner&gt; logger,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IOptionsMonitor&lt;HttpJobOptions&gt; options,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    IHttpClientFactory clientFactory</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> HttpJobOptions Options =&gt; options.CurrentValue;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">JobDisplayName(<span class=\"string\">&quot;HTTP:&#123;0&#125;:&#123;1&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    [<span class=\"meta\">EnableDistributedMutex(<span class=\"string\">&quot;HTTP:&#123;0&#125;:&#123;1&#125;&quot;</span>, 15)</span>]</span><br><span class=\"line\">    [<span class=\"meta\">AutomaticRetry(OnAttemptsExceeded = AttemptsExceededAction.Delete, Attempts = 0)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">RunAsync</span>(<span class=\"params\"><span class=\"built_in\">string</span> category, <span class=\"built_in\">string</span> name, PerformContext ctx</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If you now run the application and wait or manually trigger the <code>HTTP:Core:IsAlive</code> job you’ll see the new display name in the dashboard.</p>\n<img src=\"/2024/02/29/NET-Hangfire/06_jobs_final.png\" class=\"\">\n\n<p>Feel free to also force some exceptions to see the job in the deleted state instead of failed, or delaying the job execution for more time than the defined <em>cron</em> interval to see jobs waiting for the previous ones to complete.</p>\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>In this article I explained how easy it is to configure the Hangfire server to run recurring jobs in the background of an ASP.NET Core application, and use its dashboard to manage and monitor job executions.</p>\n<p>For simplicity we used the in-memory job storage and created the base architecture for jobs that recurrently trigger HTTP endpoints, everything configured using application settings.</p>\n<p>As a reminder, this example is <a href=\"https://github.com/gravity00/article-hangfire\">available on GitHub</a> so feel free to give it a look.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp",
                "hangfire"
            ]
        },
        {
            "id": "https://code-corner.dev/2023/12/21/Configuration-providers-in-NET/",
            "url": "https://code-corner.dev/2023/12/21/Configuration-providers-in-NET/",
            "title": "Configuration providers in .NET",
            "date_published": "2023-12-21T00:00:00.000Z",
            "content_html": "<p>One interesting feature of the .NET ecosystem is the ability to configure the application using <code>Microsoft.Extensions.Options</code> library. It allows developers to easily manage and inject application settings from different sources, such as <code>appsettings.json</code> files, environment variables, command-line arguments, or even custom sources.</p>\n<p>Using a SQL database as an example, in this article I’m going to explain how to create a custom provider for <code>Microsoft.Extensions.Options</code> that reads key-valued configurations from a table that also ensure values are refreshed in-memory if the table content changes.</p>\n<p>If you want to use an approach for which you don’t have a provider available, like getting configurations from some custom API inside your company, you can easily use this example as a template to implement whatever requirements you may have.</p>\n<h1 id=\"Solution-setup\"><a href=\"#Solution-setup\" class=\"headerlink\" title=\"Solution setup\"></a>Solution setup</h1><p>For starters, we’ll need a SQL database with a table to store the application settings. In this example, <a href=\"https://github.com/gravity00/article-dotnet-configuration\">which I have available on GitHub</a>, I’m going to use SQL Server (feel free to use your favorite database) and create an <code>ApplicationSettings</code> table with two columns to store the keys and corresponding values.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> ApplicationSettings(</span><br><span class=\"line\">  [Key] nvarchar(<span class=\"number\">256</span>) <span class=\"keyword\">not</span> <span class=\"keyword\">null</span> <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">  [<span class=\"keyword\">Value</span>] nvarchar(<span class=\"number\">256</span>) <span class=\"keyword\">not</span> <span class=\"keyword\">null</span></span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n\n<p>To keep things simple, we are going to create a console application and use the NuGet <code>Microsoft.Extensions.Hosting</code> to setup the host (dependency injection, logging and configurations) but this code is fully compatible with any application using ASP.NET Core 2 or later.</p>\n<p>Create a new console application and register the following NuGets:</p>\n<ul>\n<li><code>Microsoft.Extensions.Hosting</code> — for hosting setup;</li>\n<li><code>Microsoft.data.SqlClient</code> — to access our SQL Server database (or another provider if a different database);</li>\n<li><code>Dapper</code> — optional, just to make it easier to map SQL results to C# entities;</li>\n</ul>\n<p>You can also configure the <code>*.csproj</code> file to include the application settings files when publishing.</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Project</span> <span class=\"attr\">Sdk</span>=<span class=\"string\">&quot;Microsoft.NET.Sdk&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">PropertyGroup</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">OutputType</span>&gt;</span>Exe<span class=\"tag\">&lt;/<span class=\"name\">OutputType</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">TargetFramework</span>&gt;</span>net8.0<span class=\"tag\">&lt;/<span class=\"name\">TargetFramework</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImplicitUsings</span>&gt;</span>enable<span class=\"tag\">&lt;/<span class=\"name\">ImplicitUsings</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">PropertyGroup</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">ItemGroup</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">None</span> <span class=\"attr\">Include</span>=<span class=\"string\">&quot;*.config;*.json&quot;</span> <span class=\"attr\">CopyToOutputDirectory</span>=<span class=\"string\">&quot;PreserveNewest&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">ItemGroup</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">ItemGroup</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">PackageReference</span> <span class=\"attr\">Include</span>=<span class=\"string\">&quot;Dapper&quot;</span> <span class=\"attr\">Version</span>=<span class=\"string\">&quot;2.1.24&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">PackageReference</span> <span class=\"attr\">Include</span>=<span class=\"string\">&quot;Microsoft.Data.SqlClient&quot;</span> <span class=\"attr\">Version</span>=<span class=\"string\">&quot;5.1.2&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">PackageReference</span> <span class=\"attr\">Include</span>=<span class=\"string\">&quot;Microsoft.Extensions.Hosting&quot;</span> <span class=\"attr\">Version</span>=<span class=\"string\">&quot;8.0.0&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">ItemGroup</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Project</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>Add a new <code>appsettings.json</code> file to the project and include some options, like the connection string to the SQL Server database and some custom settings — in this example we are going to output a simple message to the console.</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;ConnectionStrings&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;ArticleDotNetConfiguration&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Data Source=localhost;Database=ArticleDotNetConfiguration;User Id=sa;Password=abcd1234;Encrypt=false;&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;Example&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;Message&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Hello world, from appsettings.json!&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>Create a class representing the example options.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">record</span> <span class=\"title\">ExampleOptions</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Message &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">init</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Program.cs</code> file, create a host with pre-configured defaults, configure the <code>ExampleOptions</code> and output the message that was loaded from the <code>appsettings.json</code> file.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> builder = Host.CreateApplicationBuilder(args);</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.Configure&lt;ExampleOptions&gt;(</span><br><span class=\"line\">    builder.Configuration.GetSection(<span class=\"string\">&quot;Example&quot;</span>)</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">var</span> host = builder.Build();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> options = host.Services.GetRequiredService&lt;IOptions&lt;ExampleOptions&gt;&gt;().Value;</span><br><span class=\"line\">Console.WriteLine(options.Message);</span><br></pre></td></tr></table></figure>\n\n<p>Running the application, the message stored in the <code>appsettings.json</code> file should be displayed.</p>\n<img src=\"/2023/12/21/Configuration-providers-in-NET/01_hello_world_appsettings_json.png\" class=\"\">\n\n<h1 id=\"Configuration-provider\"><a href=\"#Configuration-provider\" class=\"headerlink\" title=\"Configuration provider\"></a>Configuration provider</h1><p>To create a custom configuration provider you need to implement two interfaces:</p>\n<ul>\n<li><code>IConfigurationSource</code> — will be added to the configuration manager and is used to store options (like a connection string) and build provider instances.</li>\n<li><code>IConfigurationProvider</code> — knows how to load the application settings and has methods to get or set configuration values by a given key. Providers usually extend the class <code>ConfigurationProvider</code> which makes it easier to store settings in-memory.</li>\n</ul>\n<p>Create a new class <code>SqlServerConfigurationSource</code>, add a property for the connection string and implement the interface <code>IConfigurationSource</code> without any logic, for now.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SqlServerConfigurationSource</span> : <span class=\"title\">IConfigurationSource</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> ConnectionString &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> IConfigurationProvider <span class=\"title\">Build</span>(<span class=\"params\">IConfigurationBuilder builder</span>)</span> =&gt; <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NotImplementedException();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Create a new class <code>SqlServerConfigurationProvider</code>, passing the configuration source as a constructor parameter and extending the class <code>ConfigurationProvider</code>.</p>\n<p>Override the <code>Load</code> method, reading application settings from the SQL table and store the results into the <code>Data</code> dictionary.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SqlServerConfigurationProvider</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    SqlServerConfigurationSource source</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>) : ConfigurationProvider</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">Load</span>()</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> connection = <span class=\"keyword\">new</span> SqlConnection(source.ConnectionString);</span><br><span class=\"line\">        connection.Open();</span><br><span class=\"line\"></span><br><span class=\"line\">        Data = connection.Query&lt;(<span class=\"built_in\">string</span> Key, <span class=\"built_in\">string</span> Value)&gt;(<span class=\"string\">@&quot;</span></span><br><span class=\"line\"><span class=\"string\">select </span></span><br><span class=\"line\"><span class=\"string\">    [Key],</span></span><br><span class=\"line\"><span class=\"string\">    [Value]</span></span><br><span class=\"line\"><span class=\"string\">from ApplicationSettings&quot;</span>).ToDictionary(e =&gt; e.Key, e =&gt; e.Value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Reopen the <code>SqlServerConfigurationSource.cs</code> file and implement the <code>Build</code> method, returning a new instance of the provider.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SqlServerConfigurationSource</span> : <span class=\"title\">IConfigurationSource</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> ConnectionString &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> IConfigurationProvider <span class=\"title\">Build</span>(<span class=\"params\">IConfigurationBuilder builder</span>)</span> =&gt; <span class=\"keyword\">new</span> SqlServerConfigurationProvider(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Program.cs</code> file and add the SQL Server configuration source to the host builder. Don’t forget to read the connection string from the existing sources.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> builder = Host.CreateApplicationBuilder(args);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> connectionString = builder.Configuration.GetConnectionString(<span class=\"string\">&quot;ArticleDotNetConfiguration&quot;</span>);</span><br><span class=\"line\">builder.Configuration.Add&lt;SqlServerConfigurationSource&gt;(source =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    source.ConnectionString = connectionString;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.Configure&lt;ExampleOptions&gt;(</span><br><span class=\"line\">    builder.Configuration.GetSection(<span class=\"string\">&quot;Example&quot;</span>)</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure>\n\n<p>Since the SQL Server provider was the last source added to the configuration manager, it will have priority over the existing ones. Let’s try to override the message by adding the key <code>Example:Message</code> with a value like <code>Hello world, from database!</code>.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> ApplicationSettings <span class=\"keyword\">values</span> (</span><br><span class=\"line\">  <span class=\"string\">&#x27;Example:Message&#x27;</span>,</span><br><span class=\"line\">  <span class=\"string\">&#x27;Hello world, from database!&#x27;</span></span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n\n<p>Running the application, the message stored in the <code>ApplicationSettings</code> table should be displayed.</p>\n<img src=\"/2023/12/21/Configuration-providers-in-NET/02_hello_world_database.png\" class=\"\">\n\n<h1 id=\"Reloading-data\"><a href=\"#Reloading-data\" class=\"headerlink\" title=\"Reloading data\"></a>Reloading data</h1><p>In our previous code, we were getting an <code>IOptions</code> from the container to get the application settings. This is fine but what if the developer is using an <code>IOptionsMonitor</code> to always get the latest configurations?</p>\n<p>The current provider implementation never updates the <code>Data</code> property after the initial load, so we let’s change that.</p>\n<p>There are multiple ways to detect data changes from a SQL Server database, but for simplicity we are going to implement a simple worker that will be constantly loading application settings, compare what’s in memory and if changes are detected, invoke the base method <code>OnReload</code> that will trigger a refresh in all listeners.</p>\n<p>Let’s start by changing the <code>Program.cs</code> file and create a task that will be writing the message at intervals so we’ll see a different message when we update the table. Don’t forget to use an <code>IOptionsMonitor</code> instead of an <code>IOptions</code>.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> builder = Host.CreateApplicationBuilder(args);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> connectionString = builder.Configuration.GetConnectionString(<span class=\"string\">&quot;ArticleDotNetConfiguration&quot;</span>);</span><br><span class=\"line\">builder.Configuration.Add&lt;SqlServerConfigurationSource&gt;(source =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    source.ConnectionString = connectionString;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">builder.Services.Configure&lt;ExampleOptions&gt;(</span><br><span class=\"line\">    builder.Configuration.GetSection(<span class=\"string\">&quot;Example&quot;</span>)</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">var</span> host = builder.Build();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> appOptions = host.Services.GetRequiredService&lt;IOptionsMonitor&lt;ExampleOptions&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> Task.Run(<span class=\"keyword\">async</span> () =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">do</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> options = appOptions.CurrentValue;</span><br><span class=\"line\"></span><br><span class=\"line\">        Console.WriteLine(options.Message);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> Task.Delay(<span class=\"number\">5</span>_000);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>Open the provider class and do the following changes:</p>\n<ul>\n<li>Add a private <code>CancellationTokenSource</code> variable that will be used to cancel the worker execution;</li>\n<li>Add a private <code>Task</code> variable that will be the responsible to refresh the application settings when they change;</li>\n<li>Extract the logic that loads the data into a private method, so both Load method and worker can use that logic — change it to asynchronous code and do a comparison with previous loaded data, so method <code>OnReload</code> can be triggered;</li>\n<li>Change the <code>Load</code> method to use the extracted logic and create a worker that will refresh data at intervals — don’t forget to add some exception handling code;</li>\n<li>Implement the disposable pattern to release unmanaged resources;</li>\n</ul>\n<p>The <code>SqlServerConfigurationProvider</code> should now be as follows:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SqlServerConfigurationProvider</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    SqlServerConfigurationSource source</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>) : ConfigurationProvider, IDisposable</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> CancellationTokenSource _cts;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Task _refreshWorker;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">#<span class=\"keyword\">region</span> IDisposable</span></span><br><span class=\"line\"></span><br><span class=\"line\">    ~SqlServerConfigurationProvider() =&gt; Dispose(<span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Dispose</span>()</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Dispose(<span class=\"literal\">true</span>);</span><br><span class=\"line\">        GC.SuppressFinalize(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">Dispose</span>(<span class=\"params\"><span class=\"built_in\">bool</span> disposing</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (disposing)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            _cts?.Cancel();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (_refreshWorker <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> <span class=\"literal\">null</span>)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span></span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    _refreshWorker.ConfigureAwait(<span class=\"literal\">false</span>)</span><br><span class=\"line\">                        .GetAwaiter().GetResult();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">catch</span> (OperationCanceledException)</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// expected exception due to cancellation</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">catch</span> (Exception e)</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    Debug.WriteLine(<span class=\"string\">$&quot;Unhandled exception when waiting for the worker to stop: <span class=\"subst\">&#123;e&#125;</span>&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            _cts?.Dispose();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        _refreshWorker = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        _cts = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">#<span class=\"keyword\">endregion</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">Load</span>()</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        LoadAsync(CancellationToken.None).ConfigureAwait(<span class=\"literal\">false</span>)</span><br><span class=\"line\">            .GetAwaiter().GetResult();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (_cts <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> <span class=\"literal\">null</span>) </span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        _cts = <span class=\"keyword\">new</span> CancellationTokenSource();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> ct = _cts.Token;</span><br><span class=\"line\">        _refreshWorker ??= Task.Run(<span class=\"keyword\">async</span> () =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">do</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">await</span> Task.Delay(<span class=\"number\">15</span>_000, ct);</span><br><span class=\"line\">                <span class=\"keyword\">try</span></span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">await</span> LoadAsync(ct);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">catch</span> (Exception e)</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    Debug.WriteLine(<span class=\"string\">$&quot;Unhandled exception when refreshing database settings: <span class=\"subst\">&#123;e&#125;</span>&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">while</span> (!ct.IsCancellationRequested);</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">async</span> Task <span class=\"title\">LoadAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Dictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">string</span>&gt; currentData;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> <span class=\"keyword\">using</span> (<span class=\"keyword\">var</span> connection = <span class=\"keyword\">new</span> SqlConnection(source.ConnectionString))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">await</span> connection.OpenAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">            currentData = (<span class=\"keyword\">await</span> connection.QueryAsync&lt;(<span class=\"built_in\">string</span> Key, <span class=\"built_in\">string</span> Value)&gt;(<span class=\"keyword\">new</span> CommandDefinition(<span class=\"string\">@&quot;</span></span><br><span class=\"line\"><span class=\"string\">select </span></span><br><span class=\"line\"><span class=\"string\">    [Key],</span></span><br><span class=\"line\"><span class=\"string\">    [Value]</span></span><br><span class=\"line\"><span class=\"string\">from ApplicationSettings&quot;</span>, cancellationToken: ct))).ToDictionary(e =&gt; e.Key, e =&gt; e.Value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (HasSameData(currentData))</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        Data = currentData;</span><br><span class=\"line\"></span><br><span class=\"line\">        OnReload();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"built_in\">bool</span> <span class=\"title\">HasSameData</span>(<span class=\"params\">Dictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">string</span>&gt; currentData</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (Data.Count != currentData.Count)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> (key, <span class=\"keyword\">value</span>) <span class=\"keyword\">in</span> currentData)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!Data.TryGetValue(key, <span class=\"keyword\">out</span> <span class=\"keyword\">var</span> previousValue) || previousValue != <span class=\"keyword\">value</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If you now start the application and update or delete the value while running, you should see the task writing different messages.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- update the settings</span></span><br><span class=\"line\"><span class=\"keyword\">update</span> ApplicationSettings</span><br><span class=\"line\"><span class=\"keyword\">set</span></span><br><span class=\"line\">  [<span class=\"keyword\">Value</span>] <span class=\"operator\">=</span> <span class=\"string\">&#x27;Hello world, from DB!&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">where</span></span><br><span class=\"line\">  [Key] <span class=\"operator\">=</span> <span class=\"string\">&#x27;Example:Message&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- or delete them</span></span><br><span class=\"line\"><span class=\"keyword\">delete</span> ApplicationSettings</span><br><span class=\"line\"><span class=\"keyword\">where</span></span><br><span class=\"line\">  [Key] <span class=\"operator\">=</span> <span class=\"string\">&#x27;Example:Message&#x27;</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/2023/12/21/Configuration-providers-in-NET/03_hell_world_final.png\" class=\"\">\n\n<h1 id=\"Reusing-the-provider\"><a href=\"#Reusing-the-provider\" class=\"headerlink\" title=\"Reusing the provider\"></a>Reusing the provider</h1><p>We now have a provider ready to read application settings from a SQL Server database, but I’m sure you are thinking it clearly could be more generic and just work with any SQL database.</p>\n<p>Your line of thought is correct, we can easily do that just by changing the options from a connection string to having a connection factory, adding a property for the SQL code and even a <code>TimeSpan</code> for refresh interval. We should also add an exception handling callback (instead of writing into the debugger) and create extension methods to make registration into the configuration manager more readable.</p>\n<p>The final code, <a href=\"https://github.com/gravity00/article-dotnet-configuration\">which is available on GitHub</a>, could be the as follows:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SqlExceptionContext</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Exception Exception &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> SqlConfigurationProvider Provider &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title\">SqlConfigurationBuilderExtensions</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">const</span> <span class=\"built_in\">string</span> SqlExceptionHandlerKey = <span class=\"string\">&quot;SqlExceptionHandler&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> IConfigurationBuilder <span class=\"title\">AddSql</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"keyword\">this</span> IConfigurationBuilder builder,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        Func&lt;DbConnection&gt; connectionFactory,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"built_in\">string</span> sql = <span class=\"literal\">null</span>,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TimeSpan? refreshInterval = <span class=\"literal\">null</span></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        ArgumentNullException.ThrowIfNull(builder);</span><br><span class=\"line\">        ArgumentNullException.ThrowIfNull(connectionFactory);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> builder.Add&lt;SqlConfigurationSource&gt;(source =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            source.ConnectionFactory = connectionFactory;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(sql <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> <span class=\"literal\">null</span>)</span><br><span class=\"line\">                source.Sql = sql;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (refreshInterval <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> <span class=\"literal\">null</span>)</span><br><span class=\"line\">                source.RefreshInterval = refreshInterval.Value;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> IConfigurationBuilder <span class=\"title\">SetSqlExceptionHandler</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"keyword\">this</span> IConfigurationBuilder builder,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        Action&lt;SqlExceptionContext&gt; handler</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        ArgumentNullException.ThrowIfNull(builder);</span><br><span class=\"line\"></span><br><span class=\"line\">        builder.Properties[SqlExceptionHandlerKey] = handler;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> builder;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Action&lt;SqlExceptionContext&gt; <span class=\"title\">GetSqlExceptionHandler</span>(<span class=\"params\"><span class=\"keyword\">this</span> IConfigurationBuilder builder</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        ArgumentNullException.ThrowIfNull(builder);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> builder.Properties.TryGetValue(SqlExceptionHandlerKey, <span class=\"keyword\">out</span> <span class=\"keyword\">var</span> <span class=\"keyword\">value</span>)</span><br><span class=\"line\">            ? <span class=\"keyword\">value</span> <span class=\"keyword\">as</span> Action&lt;SqlExceptionContext&gt;</span><br><span class=\"line\">            : <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SqlConfigurationSource</span> : <span class=\"title\">IConfigurationSource</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Func&lt;DbConnection&gt; ConnectionFactory &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Sql &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125; = <span class=\"string\">@&quot;</span></span><br><span class=\"line\"><span class=\"string\">select </span></span><br><span class=\"line\"><span class=\"string\">    [Key],</span></span><br><span class=\"line\"><span class=\"string\">    [Value]</span></span><br><span class=\"line\"><span class=\"string\">from ApplicationSettings&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> TimeSpan RefreshInterval &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125; = TimeSpan.FromSeconds(<span class=\"number\">15</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> IConfigurationProvider <span class=\"title\">Build</span>(<span class=\"params\">IConfigurationBuilder builder</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> exceptionHandler = builder.GetSqlExceptionHandler() ?? (ctx =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Debug.WriteLine(<span class=\"string\">$&quot;Unhandled SQL exception: <span class=\"subst\">&#123;ctx.Exception&#125;</span>&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> SqlConfigurationProvider(<span class=\"keyword\">this</span>, exceptionHandler);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SqlConfigurationProvider</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    SqlConfigurationSource source,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    Action&lt;SqlExceptionContext&gt; exceptionHandler</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span>) : ConfigurationProvider, IDisposable</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> CancellationTokenSource _cts;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Task _refreshWorker;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">#<span class=\"keyword\">region</span> IDisposable</span></span><br><span class=\"line\"></span><br><span class=\"line\">    ~SqlConfigurationProvider() =&gt; Dispose(<span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Dispose</span>()</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Dispose(<span class=\"literal\">true</span>);</span><br><span class=\"line\">        GC.SuppressFinalize(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">Dispose</span>(<span class=\"params\"><span class=\"built_in\">bool</span> disposing</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (disposing)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            _cts?.Cancel();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (_refreshWorker <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> <span class=\"literal\">null</span>)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span></span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    _refreshWorker.ConfigureAwait(<span class=\"literal\">false</span>)</span><br><span class=\"line\">                        .GetAwaiter().GetResult();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">catch</span> (OperationCanceledException)</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// expected exception due to cancellation</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">catch</span> (Exception e)</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    exceptionHandler(<span class=\"keyword\">new</span> SqlExceptionContext</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        Exception = e,</span><br><span class=\"line\">                        Provider = <span class=\"keyword\">this</span></span><br><span class=\"line\">                    &#125;);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            _cts?.Dispose();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        _refreshWorker = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        _cts = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">#<span class=\"keyword\">endregion</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">Load</span>()</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        LoadAsync(CancellationToken.None).ConfigureAwait(<span class=\"literal\">false</span>)</span><br><span class=\"line\">            .GetAwaiter().GetResult();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (_cts <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> <span class=\"literal\">null</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        _cts = <span class=\"keyword\">new</span> CancellationTokenSource();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> ct = _cts.Token;</span><br><span class=\"line\">        _refreshWorker ??= Task.Run(<span class=\"keyword\">async</span> () =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">do</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">await</span> Task.Delay(source.RefreshInterval, ct);</span><br><span class=\"line\">                <span class=\"keyword\">try</span></span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">await</span> LoadAsync(ct);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">catch</span> (Exception e)</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    exceptionHandler(<span class=\"keyword\">new</span> SqlExceptionContext</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        Exception = e,</span><br><span class=\"line\">                        Provider = <span class=\"keyword\">this</span></span><br><span class=\"line\">                    &#125;);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">while</span> (!ct.IsCancellationRequested);</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">async</span> Task <span class=\"title\">LoadAsync</span>(<span class=\"params\">CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Dictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">string</span>&gt; currentData;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> <span class=\"keyword\">using</span> (<span class=\"keyword\">var</span> connection = source.ConnectionFactory())</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">await</span> connection.OpenAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">            currentData = (<span class=\"keyword\">await</span> connection.QueryAsync&lt;(<span class=\"built_in\">string</span> Key, <span class=\"built_in\">string</span> Value)&gt;(</span><br><span class=\"line\">                <span class=\"keyword\">new</span> CommandDefinition(source.Sql, cancellationToken: ct)</span><br><span class=\"line\">            )).ToDictionary(e =&gt; e.Key, e =&gt; e.Value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (HasSameData(currentData))</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        Data = currentData;</span><br><span class=\"line\"></span><br><span class=\"line\">        OnReload();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"built_in\">bool</span> <span class=\"title\">HasSameData</span>(<span class=\"params\">Dictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">string</span>&gt; currentData</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (Data.Count != currentData.Count)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> (key, <span class=\"keyword\">value</span>) <span class=\"keyword\">in</span> currentData)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!Data.TryGetValue(key, <span class=\"keyword\">out</span> <span class=\"keyword\">var</span> previousValue) || previousValue != <span class=\"keyword\">value</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>In this article I explained how to create a custom configuration provider for the <code>Microsoft.Extensions.Options</code> library, that could be used in any .NET application that uses <code>Microsoft.Extensions.Hosting</code>, including ASP.NET Core applications.</p>\n<p>I used a SQL Server database as an example, but could be easily anything, like getting settings from an internal API and even Windows registry.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp"
            ]
        },
        {
            "id": "https://code-corner.dev/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/",
            "url": "https://code-corner.dev/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/",
            "title": "Integrating Dapper with Entity Framework Core",
            "date_published": "2021-03-09T00:00:00.000Z",
            "content_html": "<p>Nowadays it is extremely rare to implement an application without using any sort of library for <em>Object-Relational Mapping (ORM)</em> to reduce development time by removing the need to implement a lot of boilerplate code to access a database. In the .NET world that usually means using <a href=\"https://docs.microsoft.com/en-us/ef/core/\">Entity Framework Core</a> or <a href=\"https://nhibernate.info/\">NHibernate</a> both offering strong tooling for CRUD operations, data type conversions, strong typed queries using LINQ with <code>IQueryable</code> and so on.</p>\n<p>Despite the pros of using an ORM there are also some cons that, while may not prevent them to be widely used inside an application, they may need to be replaced in some areas either for performance reasons or limitations. This usually means working directly with <a href=\"https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/ado-net-overview\">ADO.NET</a> (oh hell no!) or use Micro ORM libraries, like <a href=\"https://github.com/StackExchange/Dapper\">Dapper</a>, that are focused on performance and providing a simpler way to map database queries into objects.</p>\n<p>In this article I’m going to demonstrate how Dapper can easily be integrated with Entity Framework Core (and probably with any other ORM) without using <code>TransactionScope</code>, while trying to keep the same contracts via extension methods to <code>DbContext</code> instances and ensuring the SQL is properly logged in a similar way to what EF Core usually does.</p>\n<h1 id=\"Dapper-Requirements\"><a href=\"#Dapper-Requirements\" class=\"headerlink\" title=\"Dapper Requirements\"></a>Dapper Requirements</h1><p>To work with Dapper, the only requirements are a <code>DbConnection</code>, the SQL text, and some optional parameters, like a <code>DbTransaction</code>, command timeout, query parameters and so on. Sometimes is is also necessary to globally register some custom <code>TypeHandler&lt;T&gt;</code> for the when it can’t convert a given database type to its CLR representation.</p>\n<p>Assuming we want to execute a simple <code>SELECT @SomeParameter</code> statement via Dapper, what code we must implement to get everything we need from a <code>DbContext</code>?</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// get the underline DbConnection</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> connection = context.Database.GetDbConnection();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// get the underline DbTransaction, if any</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> transaction = context.Database.CurrentTransaction?.GetDbTransaction();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// get the currently configured command timeout</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> commandTimeout = context.Database.GetCommandTimeout();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// create a Dapper CommandDefinition</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> command = <span class=\"keyword\">new</span> CommandDefinition(</span><br><span class=\"line\">    <span class=\"string\">&quot;SELECT @SomeParameter&quot;</span>,</span><br><span class=\"line\">    <span class=\"keyword\">new</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        SomeParameter = <span class=\"number\">1</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    transaction,</span><br><span class=\"line\">    commandTimeout,</span><br><span class=\"line\">    cancellationToken: ct</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> _ = <span class=\"keyword\">await</span> connection.QueryAsync&lt;<span class=\"built_in\">int</span>&gt;(command);</span><br></pre></td></tr></table></figure>\n\n<p>As shown, the database facade has everything we need to make Dapper work but there is a caveat that must be properly addressed:</p>\n<p><strong>Dapper always executes the SQL immediately into the database</strong>, which means it won’t detect changes made on tracked entities before <code>SaveChanges</code> is invoked and it won’t wait to flush changes either, so be very careful when managing database access.</p>\n<p>My recommendation is to always open a transaction explicitly via <code>context.Database.BeginTransactionAsync</code> before running any mutation.</p>\n<p>If you are using the mediator pattern, I recommend my previous article that explains <a href=\"/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/\" title=\"Transaction Management With Mediator Pipelines in ASP.NET Core\">how to create a mediator pipeline that enforces database transactions when handling commands</a>.</p>\n<p>With all of this in mind, lets implement an example project that showcases what we just talked about.</p>\n<hr>\n<h1 id=\"The-project\"><a href=\"#The-project\" class=\"headerlink\" title=\"The project\"></a>The project</h1><p>The source code for this article can be found on <a href=\"https://github.com/gravity00/EntityFrameworkCoreWithDapper\">GitHub</a>.</p>\n<p>Start by opening Visual Studio and creating an <strong>ASP.NET Core Web Application</strong> with a name and a location at your preference.</p>\n<img src=\"/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/01_project_create.png\" class=\"\">\n\n<p>Choose an <strong>empty project</strong> since this is just a demo and we are going to setup only the required dependencies.</p>\n<img src=\"/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/02_project_create_aspnet.png\" class=\"\">\n\n<p>Install the Nuget <code>Swashbuckle.AspNetCore</code>:</p>\n<img src=\"/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/03_nuget_swagger.png\" class=\"\">\n\n<p>Open the <code>Startup.cs</code> file and configure both MVC and Swagger so we can use its UI to test our endpoints more easily.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        app.UseDeveloperExceptionPage();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwagger();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwaggerUI(c =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            c.SwaggerEndpoint(<span class=\"string\">&quot;/swagger/v1/swagger.json&quot;</span>, <span class=\"string\">&quot;EF Core with Dapper Example Api V1&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseRouting();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseEndpoints(endpoints =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            endpoints.MapControllers();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"The-Web-API\"><a href=\"#The-Web-API\" class=\"headerlink\" title=\"The Web API\"></a>The Web API</h1><p>Since the objective of this article is to show how Dapper can be integrated with Entity Framework Core, we are going to create a simple endpoint to manage products:</p>\n<ul>\n<li>GET &#x2F;products — lists products, including their current price and last date when it has changed;</li>\n<li>POST &#x2F;products — creates a product with a given price;</li>\n</ul>\n<h2 id=\"The-Database-Model\"><a href=\"#The-Database-Model\" class=\"headerlink\" title=\"The Database Model\"></a>The Database Model</h2><p>We need a SQL database to run our queries so, to simplify our setup, we are going to use the SQLite provider for Entity Framework Core and configure it as an in-memory instance.</p>\n<p>Install the Nuget <code>Microsoft.EntityFrameworkCore.Sqlite</code>:</p>\n<img src=\"/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/04_nuget_efcore_sqlite.png\" class=\"\">\n\n<p>Create a <code>Database</code> folder and inside create entities for products and price history, both mapped into an Entity Framework context:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ApiDbContext</span> : <span class=\"title\">DbContext</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ApiDbContext</span>(<span class=\"params\">DbContextOptions&lt;ApiDbContext&gt; options</span>) : <span class=\"title\">base</span>(<span class=\"params\">options</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">OnModelCreating</span>(<span class=\"params\">ModelBuilder builder</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">base</span>.OnModelCreating(builder);</span><br><span class=\"line\"></span><br><span class=\"line\">        builder.Entity&lt;ProductEntity&gt;(cfg =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            cfg.ToTable(<span class=\"string\">&quot;Product&quot;</span>);</span><br><span class=\"line\">            cfg.HasKey(e =&gt; e.Id);</span><br><span class=\"line\">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class=\"line\">            cfg.HasIndex(e =&gt; e.Code).IsUnique();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Id)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .ValueGeneratedOnAdd();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.ExternalId)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Code)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">8</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Name)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        builder.Entity&lt;PriceHistoryEntity&gt;(cfg =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            cfg.ToTable(<span class=\"string\">&quot;PriceHistory&quot;</span>);</span><br><span class=\"line\">            cfg.HasKey(e =&gt; e.Id);</span><br><span class=\"line\">            cfg.HasIndex(e =&gt; e.CreatedOn);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Id)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .ValueGeneratedOnAdd();</span><br><span class=\"line\">            cfg.HasOne(e =&gt; e.Product)</span><br><span class=\"line\">                .WithMany(p =&gt; p.PricesHistory)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Price)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedOn)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">virtual</span> ICollection&lt;PriceHistoryEntity&gt; PricesHistory &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProductEntity</span>()</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        PricesHistory = <span class=\"keyword\">new</span> HashSet&lt;PriceHistoryEntity&gt;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">PriceHistoryEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">virtual</span> ProductEntity Product &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTime CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Startup.cs</code> file and add the database context to the container. Because the database is stored in-memory, we must ensure all tables are created when the application starts and at least one connection is always open so the SQLite provider won’t discard it from memory:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">const</span> <span class=\"built_in\">string</span> ConnectionString = <span class=\"string\">&quot;Data Source=EntityFrameworkCoreWithDapper;Mode=Memory;Cache=Shared&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> SqliteConnection _keepAliveConnection;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseSqlite(ConnectionString);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">// this ensures at least one connection is open and the database is kept in-memory while the application is running</span></span><br><span class=\"line\">        _keepAliveConnection = <span class=\"keyword\">new</span> SqliteConnection(ConnectionString);</span><br><span class=\"line\">        keepAliveConnection.Open();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">using</span> (<span class=\"keyword\">var</span> scope = app.ApplicationServices.GetRequiredService&lt;IServiceScopeFactory&gt;().CreateScope())</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> ctx = scope.ServiceProvider.GetRequiredService&lt;ApiDbContext&gt;();</span><br><span class=\"line\">            ctx.Database.EnsureCreated();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"The-Products-Controller\"><a href=\"#The-Products-Controller\" class=\"headerlink\" title=\"The Products Controller\"></a>The Products Controller</h2><p>Now that we have configured the database, create a <code>Controllers</code> folder, the <code>ProductsController</code> class and its models. For now, we are going to implement our logic using only the Entity Framework context.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;products&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProductsController</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">IEnumerable</span>&lt;<span class=\"title\">ProductModel</span>&gt;&gt; <span class=\"title\">GetAllAsync</span>(<span class=\"params\">[FromQuery] <span class=\"built_in\">int</span>? skip, [FromQuery] <span class=\"built_in\">int</span>? take, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> (</span><br><span class=\"line\">                <span class=\"keyword\">from</span> p <span class=\"keyword\">in</span> _context.Set&lt;ProductEntity&gt;()</span><br><span class=\"line\">                <span class=\"keyword\">select</span> <span class=\"keyword\">new</span></span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    Id = p.ExternalId,</span><br><span class=\"line\">                    p.Code,</span><br><span class=\"line\">                    p.Name,</span><br><span class=\"line\">                    MostRecentPriceHistory = p</span><br><span class=\"line\">                        .PricesHistory</span><br><span class=\"line\">                        .OrderByDescending(ph =&gt; ph.CreatedOn)</span><br><span class=\"line\">                        .First()</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            )</span><br><span class=\"line\">            .OrderBy(p =&gt; p.Code)</span><br><span class=\"line\">            .Skip(skip ?? <span class=\"number\">0</span>)</span><br><span class=\"line\">            .Take(take ?? <span class=\"number\">20</span>)</span><br><span class=\"line\">            .Select(p =&gt; <span class=\"keyword\">new</span> ProductModel</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                Id = p.Id,</span><br><span class=\"line\">                Code = p.Code,</span><br><span class=\"line\">                Name = p.Name,</span><br><span class=\"line\">                Price = p.MostRecentPriceHistory.Price,</span><br><span class=\"line\">                PriceChangedOn = p.MostRecentPriceHistory.CreatedOn</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">            .ToListAsync(ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpPost</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResultModel&gt; <span class=\"title\">CreateAsync</span>(<span class=\"params\">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> externalId = Guid.NewGuid();</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">await</span> <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> tx = <span class=\"keyword\">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> product = <span class=\"keyword\">new</span> ProductEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId,</span><br><span class=\"line\">            Code = model.Code,</span><br><span class=\"line\">            Name = model.Name,</span><br><span class=\"line\">            PricesHistory =</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">new</span> PriceHistoryEntity</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    Price = model.Price,</span><br><span class=\"line\">                    CreatedOn = DateTime.UtcNow</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.Set&lt;ProductEntity&gt;().AddAsync(product, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">await</span> tx.CommitAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CreateProductResultModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = externalId</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTime PriceChangedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductResultModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Right now, the project content should look as follows:</p>\n<img src=\"/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/05_project_structure.png\" class=\"\">\n\n<h1 id=\"Dapper-Integration\"><a href=\"#Dapper-Integration\" class=\"headerlink\" title=\"Dapper Integration\"></a>Dapper Integration</h1><p>Now that we have a running API that manages products and their prices using Entity Framework Core, we can now integrate Dapper into the solution and apply what we learned at the start of this article.</p>\n<p>Install the Nuget <code>Dapper</code>:</p>\n<img src=\"/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/06_nuget_dapper.png\" class=\"\">\n\n<p>Since Dapper uses extension methods over <code>IDbConnection</code> and we can extract everything needed from a <code>DbContext</code> instance (even an <code>ILogger</code> to log our raw SQL), lets keep that philosophy and replicate those extension methods but this time to an Entity Framework Core context.</p>\n<p>Inside the <code>Database</code> folder create a static <code>DapperDbContextExtensions</code> class, that will containing all the extension methods, and a <code>DapperEFCoreCommand</code> structure, used to wrap both logging and Dapper’s <code>CommandDefinition</code>.</p>\n<p>For demo purposes we are only going to expose methods to query a collection of items and to execute commands but feel free to add your owns (like <code>FirstAsync</code>). I also put the <code>CancellationToken</code> at the start since all other parameters are optional and I have my fair share of cancellation tokens being passed as the <code>object parameters</code>, but change them in a way that makes more sense to you.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title\">DapperDbContextExtensions</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">IEnumerable</span>&lt;<span class=\"title\">T</span>&gt;&gt; <span class=\"title\">QueryAsync</span>&lt;<span class=\"title\">T</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"keyword\">this</span> DbContext context,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"built_in\">string</span> text,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"built_in\">object</span> parameters = <span class=\"literal\">null</span>,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"built_in\">int</span>? timeout = <span class=\"literal\">null</span>,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CommandType? type = <span class=\"literal\">null</span></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> command = <span class=\"keyword\">new</span> DapperEFCoreCommand(</span><br><span class=\"line\">            context,</span><br><span class=\"line\">            text,</span><br><span class=\"line\">            parameters,</span><br><span class=\"line\">            timeout,</span><br><span class=\"line\">            type,</span><br><span class=\"line\">            ct</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> connection = context.Database.GetDbConnection();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> connection.QueryAsync&lt;T&gt;(command.Definition);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">async</span> Task&lt;<span class=\"built_in\">int</span>&gt; <span class=\"title\">ExecuteAsync</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"keyword\">this</span> DbContext context,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"built_in\">string</span> text,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"built_in\">object</span> parameters = <span class=\"literal\">null</span>,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"built_in\">int</span>? timeout = <span class=\"literal\">null</span>,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CommandType? type = <span class=\"literal\">null</span></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> command = <span class=\"keyword\">new</span> DapperEFCoreCommand(</span><br><span class=\"line\">            context,</span><br><span class=\"line\">            text,</span><br><span class=\"line\">            parameters,</span><br><span class=\"line\">            timeout,</span><br><span class=\"line\">            type,</span><br><span class=\"line\">            ct</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> connection = context.Database.GetDbConnection();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> connection.ExecuteAsync(command.Definition);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">readonly</span> <span class=\"keyword\">struct</span> DapperEFCoreCommand : IDisposable</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ILogger&lt;DapperEFCoreCommand&gt; _logger;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DapperEFCoreCommand</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        DbContext context,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"built_in\">string</span> text,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"built_in\">object</span> parameters,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        <span class=\"built_in\">int</span>? timeout,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CommandType? type,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger = context.GetService&lt;ILogger&lt;DapperEFCoreCommand&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> transaction = context.Database.CurrentTransaction?.GetDbTransaction();</span><br><span class=\"line\">        <span class=\"keyword\">var</span> commandType = type ?? CommandType.Text;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> commandTimeout = timeout ?? context.Database.GetCommandTimeout() ?? <span class=\"number\">30</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        Definition = <span class=\"keyword\">new</span> CommandDefinition(</span><br><span class=\"line\">            text,</span><br><span class=\"line\">            parameters,</span><br><span class=\"line\">            transaction,</span><br><span class=\"line\">            commandTimeout,</span><br><span class=\"line\">            commandType,</span><br><span class=\"line\">            cancellationToken: ct</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (_logger.IsEnabled(LogLevel.Debug))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            _logger.LogDebug(</span><br><span class=\"line\">                <span class=\"string\">@&quot;Executing DbCommand [CommandType=&#x27;&#123;commandType&#125;&#x27;, CommandTimeout=&#x27;&#123;commandTimeout&#125;&#x27;]</span></span><br><span class=\"line\"><span class=\"string\">&#123;commandText&#125;&quot;</span>, Definition.CommandType, Definition.CommandTimeout, Definition.CommandText);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> CommandDefinition Definition &#123; <span class=\"keyword\">get</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Dispose</span>()</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (_logger.IsEnabled(LogLevel.Information))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            _logger.LogInformation(</span><br><span class=\"line\">                <span class=\"string\">@&quot;Executed DbCommand [CommandType=&#x27;&#123;commandType&#125;&#x27;, CommandTimeout=&#x27;&#123;commandTimeout&#125;&#x27;]</span></span><br><span class=\"line\"><span class=\"string\">&#123;commandText&#125;&quot;</span>, Definition.CommandType, Definition.CommandTimeout, Definition.CommandText);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Since we are using <code>Guid</code> properties in our models but they are stored as <code>TEXT</code> and Dapper doesn’t know how to do the conversion when reading from a SQLite database, we also need to add a global type handler.</p>\n<p>Open the <code>Startup.cs</code> file, create an inner class <code>GuidTypeHandler</code>, that will parse the string into a <code>Guid</code>, and register the handler on application startup:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        SqlMapper.AddTypeHandler(<span class=\"keyword\">new</span> GuidTypeHandler());</span><br><span class=\"line\">        </span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseSqlite(ConnectionString);</span><br><span class=\"line\">        &#125;).AddTransient&lt;ApiDbSqlRunner&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">class</span> <span class=\"title\">GuidTypeHandler</span> : <span class=\"title\">SqlMapper.TypeHandler</span>&lt;<span class=\"title\">Guid</span>&gt;</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">SetValue</span>(<span class=\"params\">IDbDataParameter parameter, Guid <span class=\"keyword\">value</span></span>)</span> =&gt; parameter.Value = <span class=\"keyword\">value</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> Guid <span class=\"title\">Parse</span>(<span class=\"params\"><span class=\"built_in\">object</span> <span class=\"keyword\">value</span></span>)</span> =&gt; Guid.Parse((<span class=\"built_in\">string</span>) <span class=\"keyword\">value</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Optimizations-with-Dapper\"><a href=\"#Optimizations-with-Dapper\" class=\"headerlink\" title=\"Optimizations with Dapper\"></a>Optimizations with Dapper</h1><p>As stated before, Entity Framework will usually make it easier to access the database and remove some of the boilerplate code but, like most advanced frameworks, it has some drawbacks, specially performance degradation that sometimes can’t be ignored in critical paths.</p>\n<p>Lets analyse each endpoint and see if we can improve both the generated SQL and the total of database interactions.</p>\n<h2 id=\"POST-products\"><a href=\"#POST-products\" class=\"headerlink\" title=\"POST &#x2F;products\"></a>POST &#x2F;products</h2><p>This endpoint is responsible to create a product with a given initial price. Because prices are stored in a history table, being the most recent entry the current product price, this action has to insert both a line in the products and price history tables.</p>\n<p>If we look at the logs we can see two commands being executed by the Entity Framework with a total of four operations:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">info: Microsoft.EntityFrameworkCore.Database.Command[20101]</span><br><span class=\"line\">      Executed DbCommand (6ms) [Parameters=[@p0=&#x27;?&#x27; (Size = 8), @p1=&#x27;?&#x27;, @p2=&#x27;?&#x27; (Size = 16)], CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class=\"line\">      INSERT INTO &quot;Product&quot; (&quot;Code&quot;, &quot;ExternalId&quot;, &quot;Name&quot;)</span><br><span class=\"line\">      VALUES (@p0, @p1, @p2);</span><br><span class=\"line\">      SELECT &quot;Id&quot;</span><br><span class=\"line\">      FROM &quot;Product&quot;</span><br><span class=\"line\">      WHERE changes() = 1 AND &quot;rowid&quot; = last_insert_rowid();</span><br><span class=\"line\">info: Microsoft.EntityFrameworkCore.Database.Command[20101]</span><br><span class=\"line\">      Executed DbCommand (1ms) [Parameters=[@p3=&#x27;?&#x27;, @p4=&#x27;?&#x27;, @p5=&#x27;?&#x27;], CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class=\"line\">      INSERT INTO &quot;PriceHistory&quot; (&quot;CreatedOn&quot;, &quot;Price&quot;, &quot;ProductId&quot;)</span><br><span class=\"line\">      VALUES (@p3, @p4, @p5);</span><br><span class=\"line\">      SELECT &quot;Id&quot;</span><br><span class=\"line\">      FROM &quot;PriceHistory&quot;</span><br><span class=\"line\">      WHERE changes() = 1 AND &quot;rowid&quot; = last_insert_rowid();</span><br></pre></td></tr></table></figure>\n\n<p>This happens because Entity Framework and the SQLite provider don’t know what our code needs from each entity after an insert, so the only option is to execute a command that does the insert, selects database generated columns, and update properties of the tracked instances, in this case, the primary keys.</p>\n<p>Since we know our code doesn’t need anything from the database, because we are only returning the product external id that was calculated inside the controller, we can execute a single SQL statement containing both inserts:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INSERT INTO Product (ExternalId, Code, Name)</span><br><span class=\"line\">VALUES (@ExternalId, @Code, @Name);</span><br><span class=\"line\">INSERT INTO PriceHistory (Price, CreatedOn, ProductId)</span><br><span class=\"line\">SELECT @Price, @CreatedOn, Id</span><br><span class=\"line\">FROM Product</span><br><span class=\"line\">WHERE</span><br><span class=\"line\">    rowid = last_insert_rowid();</span><br></pre></td></tr></table></figure>\n\n<p>Change the <code>CreateAsync</code> action to use the extension method <code>ExecuteAsync</code> with this statement, passing the arguments. Keep in mind that SQLite is case sensitive when parsing the parameter name, so you must ensure the anonymous object property names match with the ones inside the statement:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;products&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpPost</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResultModel&gt; <span class=\"title\">CreateAsync</span>(<span class=\"params\">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> externalId = Guid.NewGuid();</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">await</span> <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> tx = <span class=\"keyword\">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.ExecuteAsync(ct, <span class=\"string\">@&quot;</span></span><br><span class=\"line\"><span class=\"string\">INSERT INTO Product (ExternalId, Code, Name)</span></span><br><span class=\"line\"><span class=\"string\">VALUES (@ExternalId, @Code, @Name);</span></span><br><span class=\"line\"><span class=\"string\">INSERT INTO PriceHistory (Price, CreatedOn, ProductId)</span></span><br><span class=\"line\"><span class=\"string\">SELECT @Price, @CreatedOn, Id</span></span><br><span class=\"line\"><span class=\"string\">FROM Product</span></span><br><span class=\"line\"><span class=\"string\">WHERE</span></span><br><span class=\"line\"><span class=\"string\">    rowid = last_insert_rowid();&quot;</span>, <span class=\"keyword\">new</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId,</span><br><span class=\"line\">            model.Code,</span><br><span class=\"line\">            model.Name,</span><br><span class=\"line\">            model.Price,</span><br><span class=\"line\">            CreatedOn = DateTime.UtcNow</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">await</span> tx.CommitAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CreateProductResultModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = externalId</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><em>Remember that, even if we are executing a single command in the database, it contains two instructions so it still must be wrapped by an explicit database transaction.</em></p>\n<p>When creating a new product using the Swagger UI endpoint (<a href=\"https://localhost:44310/swagger/index.html\">https://localhost:44310/swagger/index.html</a>), if you look at your Visual Studio output console, a log similar to the following should appear showing the custom SQL:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dbug: EntityFrameworkCoreWithDapper.Database.DapperEFCoreCommand[0]</span><br><span class=\"line\">      Executing DbCommand [CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class=\"line\">      </span><br><span class=\"line\">      INSERT INTO Product (ExternalId, Code, Name)</span><br><span class=\"line\">      VALUES (@ExternalId, @Code, @Name);</span><br><span class=\"line\">      </span><br><span class=\"line\">      INSERT INTO PriceHistory (Price, CreatedOn, ProductId)</span><br><span class=\"line\">      SELECT @Price, @CreatedOn, Id</span><br><span class=\"line\">      FROM Product</span><br><span class=\"line\">      WHERE</span><br><span class=\"line\">          rowid = last_insert_rowid();</span><br><span class=\"line\">info: EntityFrameworkCoreWithDapper.Database.DapperEFCoreCommand[0]</span><br><span class=\"line\">      Executed DbCommand [CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class=\"line\">      </span><br><span class=\"line\">      INSERT INTO Product (ExternalId, Code, Name)</span><br><span class=\"line\">      VALUES (@ExternalId, @Code, @Name);</span><br><span class=\"line\">      </span><br><span class=\"line\">      INSERT INTO PriceHistory (Price, CreatedOn, ProductId)</span><br><span class=\"line\">      SELECT @Price, @CreatedOn, Id</span><br><span class=\"line\">      FROM Product</span><br><span class=\"line\">      WHERE</span><br><span class=\"line\">          rowid = last_insert_rowid();</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"GET-products\"><a href=\"#GET-products\" class=\"headerlink\" title=\"GET &#x2F;products\"></a>GET &#x2F;products</h2><p>This endpoint is responsible for returning a paginated collections of products with their current price and the timestamp when it was last updated, ordered by product code.</p>\n<p>Lets extract the SQL statement generated by the Entity Framework Core from the logs:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">info: Microsoft.EntityFrameworkCore.Database.Command[20101]</span><br><span class=\"line\">      Executed DbCommand (3ms) [Parameters=[@__p_1=&#x27;?&#x27;, @__p_0=&#x27;?&#x27;], CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class=\"line\">      SELECT &quot;p1&quot;.&quot;ExternalId&quot; AS &quot;Id&quot;, &quot;p1&quot;.&quot;Code&quot;, &quot;p1&quot;.&quot;Name&quot;, (</span><br><span class=\"line\">          SELECT &quot;p&quot;.&quot;Price&quot;</span><br><span class=\"line\">          FROM &quot;PriceHistory&quot; AS &quot;p&quot;</span><br><span class=\"line\">          WHERE &quot;p1&quot;.&quot;Id&quot; = &quot;p&quot;.&quot;ProductId&quot;</span><br><span class=\"line\">          ORDER BY &quot;p&quot;.&quot;CreatedOn&quot; DESC</span><br><span class=\"line\">          LIMIT 1) AS &quot;Price&quot;, (</span><br><span class=\"line\">          SELECT &quot;p0&quot;.&quot;CreatedOn&quot;</span><br><span class=\"line\">          FROM &quot;PriceHistory&quot; AS &quot;p0&quot;</span><br><span class=\"line\">          WHERE &quot;p1&quot;.&quot;Id&quot; = &quot;p0&quot;.&quot;ProductId&quot;</span><br><span class=\"line\">          ORDER BY &quot;p0&quot;.&quot;CreatedOn&quot; DESC</span><br><span class=\"line\">          LIMIT 1) AS &quot;PriceChangedOn&quot;</span><br><span class=\"line\">      FROM &quot;Product&quot; AS &quot;p1&quot;</span><br><span class=\"line\">      ORDER BY &quot;p1&quot;.&quot;Code&quot;</span><br><span class=\"line\">      LIMIT @__p_1 OFFSET @__p_0</span><br></pre></td></tr></table></figure>\n\n<p>As we can see, because we need both the Price and CreatedOn columns from the most recent price history entry, the SQLite provider decided to create two sub-queries. The database engine is relatively smart to know how to optimize them but lets ensure the engine optimizes the access as follows:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. order products by code</span><br><span class=\"line\">2. filter products by skip and take</span><br><span class=\"line\">3. join with latest price history entry, grouped by product, using the ROWID for fast access</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT p.ExternalId as Id, p.Code, p.Name, lph.Price, lph.CreatedOn as PriceChangedOn</span><br><span class=\"line\">FROM (</span><br><span class=\"line\">    SELECT Id, ExternalId, Code, Name, RowId</span><br><span class=\"line\">    FROM Product</span><br><span class=\"line\">    ORDER BY Code DESC</span><br><span class=\"line\">    LIMIT @Take OFFSET @Skip</span><br><span class=\"line\">) p</span><br><span class=\"line\">INNER JOIN (</span><br><span class=\"line\">    SELECT ph.ProductId, ph.Price, ph.CreatedOn</span><br><span class=\"line\">    FROM PriceHistory ph</span><br><span class=\"line\">    INNER JOIN (</span><br><span class=\"line\">        SELECT MAX(RowId) RowId</span><br><span class=\"line\">        FROM PriceHistory</span><br><span class=\"line\">        GROUP BY ProductId</span><br><span class=\"line\">    ) phLatest ON ph.RowId = phLatest.RowId</span><br><span class=\"line\">) lph ON p.Id = lph.ProductId</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><em>Note: this may not be the most optimized access but remember, this is for demo purposes.</em></p>\n<p>Change the <code>GetAllAsync</code> action to use the <code>QueryAsync&lt;T&gt;</code> extension method, passing this SQL and both the skip and take as arguments.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;products&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">IEnumerable</span>&lt;<span class=\"title\">ProductModel</span>&gt;&gt; <span class=\"title\">GetAllAsync</span>(<span class=\"params\">[FromQuery] <span class=\"built_in\">int</span>? skip, [FromQuery] <span class=\"built_in\">int</span>? take, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> _context.QueryAsync&lt;ProductModel&gt;(ct, <span class=\"string\">@&quot;</span></span><br><span class=\"line\"><span class=\"string\">SELECT p.ExternalId as Id, p.Code, p.Name, lph.Price, lph.CreatedOn as PriceChangedOn</span></span><br><span class=\"line\"><span class=\"string\">FROM (</span></span><br><span class=\"line\"><span class=\"string\">    SELECT Id, ExternalId, Code, Name, RowId</span></span><br><span class=\"line\"><span class=\"string\">    FROM Product</span></span><br><span class=\"line\"><span class=\"string\">    ORDER BY Code DESC</span></span><br><span class=\"line\"><span class=\"string\">    LIMIT @Take OFFSET @Skip</span></span><br><span class=\"line\"><span class=\"string\">) p</span></span><br><span class=\"line\"><span class=\"string\">INNER JOIN (</span></span><br><span class=\"line\"><span class=\"string\">    SELECT ph.ProductId, ph.Price, ph.CreatedOn</span></span><br><span class=\"line\"><span class=\"string\">    FROM PriceHistory ph</span></span><br><span class=\"line\"><span class=\"string\">    INNER JOIN (</span></span><br><span class=\"line\"><span class=\"string\">        SELECT MAX(RowId) RowId</span></span><br><span class=\"line\"><span class=\"string\">        FROM PriceHistory</span></span><br><span class=\"line\"><span class=\"string\">        GROUP BY ProductId</span></span><br><span class=\"line\"><span class=\"string\">    ) phLatest ON ph.RowId = phLatest.RowId</span></span><br><span class=\"line\"><span class=\"string\">) lph ON p.Id = lph.ProductId&quot;</span>, <span class=\"keyword\">new</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Skip = skip ?? <span class=\"number\">0</span>,</span><br><span class=\"line\">            Take = take ?? <span class=\"number\">20</span></span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Because we globally registered our <code>GuidTypeHandler</code>, Dapper will know how to convert the column <code>ExternalId [TEXT]</code> as a <code>Guid</code> so we can map our result directly as a <code>ProductModel</code> type.</p>\n<p>Once again, if you invoke the endpoint using the Swagger UI, the folowing log should be visible:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dbug: EntityFrameworkCoreWithDapper.Database.DapperEFCoreCommand[0]</span><br><span class=\"line\">      Executing DbCommand [CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class=\"line\">      </span><br><span class=\"line\">      SELECT p.ExternalId as Id, p.Code, p.Name, lph.Price, lph.CreatedOn as PriceChangedOn</span><br><span class=\"line\">      FROM (</span><br><span class=\"line\">          SELECT Id, ExternalId, Code, Name, RowId</span><br><span class=\"line\">          FROM Product</span><br><span class=\"line\">          ORDER BY Code DESC</span><br><span class=\"line\">          LIMIT @Take OFFSET @Skip</span><br><span class=\"line\">      ) p</span><br><span class=\"line\">      INNER JOIN (</span><br><span class=\"line\">          SELECT ph.ProductId, ph.Price, ph.CreatedOn</span><br><span class=\"line\">          FROM PriceHistory ph</span><br><span class=\"line\">          INNER JOIN (</span><br><span class=\"line\">              SELECT MAX(RowId) RowId</span><br><span class=\"line\">              FROM PriceHistory</span><br><span class=\"line\">              GROUP BY ProductId</span><br><span class=\"line\">          ) phLatest ON ph.RowId = phLatest.RowId</span><br><span class=\"line\">      ) lph ON p.Id = lph.ProductId</span><br><span class=\"line\">info: EntityFrameworkCoreWithDapper.Database.DapperEFCoreCommand[0]</span><br><span class=\"line\">      Executed DbCommand [CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class=\"line\">      </span><br><span class=\"line\">      SELECT p.ExternalId as Id, p.Code, p.Name, lph.Price, lph.CreatedOn as PriceChangedOn</span><br><span class=\"line\">      FROM (</span><br><span class=\"line\">          SELECT Id, ExternalId, Code, Name, RowId</span><br><span class=\"line\">          FROM Product</span><br><span class=\"line\">          ORDER BY Code DESC</span><br><span class=\"line\">          LIMIT @Take OFFSET @Skip</span><br><span class=\"line\">      ) p</span><br><span class=\"line\">      INNER JOIN (</span><br><span class=\"line\">          SELECT ph.ProductId, ph.Price, ph.CreatedOn</span><br><span class=\"line\">          FROM PriceHistory ph</span><br><span class=\"line\">          INNER JOIN (</span><br><span class=\"line\">              SELECT MAX(RowId) RowId</span><br><span class=\"line\">              FROM PriceHistory</span><br><span class=\"line\">              GROUP BY ProductId</span><br><span class=\"line\">          ) phLatest ON ph.RowId = phLatest.RowId</span><br><span class=\"line\">      ) lph ON p.Id = lph.ProductId</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to easily integrate Dapper with Entity Framework Core, either to optimize critical paths or to workaround limitations while removing the need to use <code>TransactionScope</code>, usually needed for these use cases.</p>\n<p>Remember that I only implemented a few set of operations, but feel free to extend your own, like <code>FirstOrDefaultAsync</code>, <code>SingleAsync</code> and even their synchronous operations.</p>\n<p>As an extended note, this approach can also be easily applied to any other ORM, like NHibernate, as long you can access the underline <code>DbConnection</code> and current <code>DbTransaction</code> from the context.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp",
                "efcore",
                "dapper"
            ]
        },
        {
            "id": "https://code-corner.dev/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/",
            "url": "https://code-corner.dev/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/",
            "title": "Auditing with Mediator Pipelines in ASP.NET Core",
            "date_published": "2020-11-25T00:00:00.000Z",
            "content_html": "<p>When implementing a web application, it can be a good idea to enforce some kind of auditing to all of your client interactions, either to track their behavior over time, to ensure any security breach will be properly logged, or just to help analyze system bugs.</p>\n<p>Previously we talked about using the mediator pattern to implement the <strong>Command Query Responsibility Segregation (CQRS)</strong> and <strong>Event Sourcing (ES)</strong> and how pipelines could be used to implement transversal behavior to your application.</p>\n<p>Since commands are responsible to mutate the system state, in this article I’m going to demonstrate how you could implement an audit pipeline to ensure all commands will be stored into a table. Because a variable number of events can be broadcasted when the state changes, the pipeline will also store them into another table and with a reference to the command, ensuring any correlation can be analyzed.</p>\n<hr>\n<h1 id=\"The-project\"><a href=\"#The-project\" class=\"headerlink\" title=\"The project\"></a>The project</h1><p>From my previous articles, were I explained how to use the mediator and implement transversal behavior with pipelines, we are going to continue and expand the source code to audit commands and store into the events table anything broadcasted by the mediator without having a specific handler for each event.</p>\n<p>As a reminder, we implemented an endpoint to manage products with the following:</p>\n<p>GET &#x2F;products — search for products using some filters (<code>SearchProductsQuery</code>);<br>GET &#x2F;products&#x2F;{id} — get a product by its unique identifier (<code>GetProductByIdQuery</code>);<br>POST &#x2F;products — create a product (<code>CreateProductCommand</code> and <code>CreatedProductEvent</code>);<br>PUT &#x2F;products&#x2F;{id} — update a product by its unique identifier (<code>UpdateProductCommand</code> and <code>UpdatedProductEvent</code>);<br>DELETE &#x2F;products&#x2F;{id} — delete a product by its unique identifier (<code>DeleteProductCommand</code> and <code>DeletedProductEvent</code>);</p>\n<p>You can check them out here:</p>\n<ul>\n<li><a href=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/\" title=\"Mediator Pattern in ASP.NET Core Applications\">Mediator Pattern in ASP.NET Core Applications</a></li>\n<li><a href=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Using Mediator Pipelines in ASP.NET Core Applications\">Using Mediator Pipelines in ASP.NET Core Applications</a></li>\n<li><a href=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Validation with Mediator Pipelines in ASP.NET Core Applications\">Validation with Mediator Pipelines in ASP.NET Core Applications</a></li>\n<li><a href=\"/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/\" title=\"Transaction Management With Mediator Pipelines in ASP.NET Core\">Transaction Management With Mediator Pipelines in ASP.NET Core</a></li>\n</ul>\n<p>The source code is available on <a href=\"https://github.com/gravity00/IntroductionMediatorCQRS\">GitHub</a>, feel free to give it a look.</p>\n<h1 id=\"Auditing\"><a href=\"#Auditing\" class=\"headerlink\" title=\"Auditing\"></a>Auditing</h1><p>Since in this article we will only audit API actions that mutate state, we are going to intercept commands and store information we find relevant into a specific table:</p>\n<ul>\n<li><strong>ExternalId</strong> — the unique identifier for each command, available via <code>Command.Id</code> or <code>Command&lt;TResult&gt;.Id</code>;</li>\n<li><strong>Name</strong> — the command type name from <code>typeof(TCommand).Name</code>;</li>\n<li><strong>Payload</strong> — the command serialized as JSON;</li>\n<li><strong>Result</strong> — if available, the command result serialized as JSON;</li>\n<li><strong>CreatedOn</strong> — date and time when the command was sent into the mediator, available via <code>Command.CreatedOn</code> or <code>Command&lt;TResult&gt;.CreatedOn</code>;</li>\n<li><strong>CreatedBy</strong> — username from the current request user property, available via <code>Command.CreatedBy</code> or <code>Command&lt;TResult&gt;.CreatedBy</code>;</li>\n<li><strong>ExecutionTime</strong> — elapsed time the handler spent processing the command;</li>\n</ul>\n<p>Because events are broadcasted by commands, which are now audited into the database, we are also going to extend the events table and introduce the foreign key <code>CommandId</code>, referencing the commands.</p>\n<h1 id=\"The-Database-Model\"><a href=\"#The-Database-Model\" class=\"headerlink\" title=\"The Database Model\"></a>The Database Model</h1><p>Inside the <code>Database</code> folder create a <code>CommandEntity</code> class and add the new <code>CommandId</code> property to the existing <code>EventEntity</code>:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CommandEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Result &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> TimeSpan ExecutionTime &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">EventEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> CommandId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125; <span class=\"comment\">// added property</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>ApiDbContext</code> file, configure the mappings for the <code>CommandEntity</code> and add a required one-to-many relation between this tables:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ApiDbContext</span> : <span class=\"title\">DbContext</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">OnModelCreating</span>(<span class=\"params\">ModelBuilder builder</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">        builder.Entity&lt;CommandEntity&gt;(cfg =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            cfg.HasKey(e =&gt; e.Id);</span><br><span class=\"line\">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class=\"line\">            cfg.HasIndex(e =&gt; e.CreatedOn);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Id)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .ValueGeneratedOnAdd();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.ExternalId)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Name)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Payload)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Result);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedOn)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedBy)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.ExecutionTime)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        builder.Entity&lt;EventEntity&gt;(cfg =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            cfg.HasKey(e =&gt; e.Id);</span><br><span class=\"line\">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class=\"line\">            cfg.HasIndex(e =&gt; e.CreatedOn);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Id)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .ValueGeneratedOnAdd();</span><br><span class=\"line\">            cfg.HasOne&lt;CommandEntity&gt;()</span><br><span class=\"line\">                .WithMany()</span><br><span class=\"line\">                .HasForeignKey(e =&gt; e.CommandId)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.ExternalId)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Name)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Payload)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedOn)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedBy)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"User-Information\"><a href=\"#User-Information\" class=\"headerlink\" title=\"User Information\"></a>User Information</h1><p>By design, all POCOs provided in this library are immutable and only provide a protected setter for the properties <code>Id</code>, <code>CreatedOn</code> and <code>CreatedBy</code>. This ensures the developer is free to decide either by immutable commands, queries and events, initializing all properties in the constructor, or to expose a public setter instead.</p>\n<p>Since we haven’t made our POCOs immutable, and for demo purposes, we are going to expose a public setter for the <code>CreatedBy</code> property by implementing our own command, query and event classes.</p>\n<p>Inside the <code>Handlers</code> folder create a <code>Command.cs</code>, <code>Query.cs</code> and <code>Event.cs</code> files and extend the corresponding <code>Command</code>, <code>Command&lt;TResult&gt;</code>, <code>Query&lt;TResult&gt;</code> and <code>Event</code> classes, creating a new setter ao getter for <code>CreatedBy</code>. Since your classes have the same name than the ones provided by <code>Simplesoft.Mediator</code>, your existing classes will automatically extend from them and expose the new setters without a single change:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Command</span> : <span class=\"title\">SimpleSoft.Mediator.Command</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">new</span> <span class=\"built_in\">string</span> CreatedBy</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">get</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy;</span><br><span class=\"line\">        <span class=\"keyword\">set</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy = <span class=\"keyword\">value</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Command</span>&lt;<span class=\"title\">TResult</span>&gt; : <span class=\"title\">SimpleSoft.Mediator.Command</span>&lt;<span class=\"title\">TResult</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">new</span> <span class=\"built_in\">string</span> CreatedBy</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">get</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy;</span><br><span class=\"line\">        <span class=\"keyword\">set</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy = <span class=\"keyword\">value</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Event</span> : <span class=\"title\">SimpleSoft.Mediator.Event</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">new</span> <span class=\"built_in\">string</span> CreatedBy</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">get</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy;</span><br><span class=\"line\">        <span class=\"keyword\">set</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy = <span class=\"keyword\">value</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Query</span>&lt;<span class=\"title\">TResult</span>&gt; : <span class=\"title\">SimpleSoft.Mediator.Query</span>&lt;<span class=\"title\">TResult</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">new</span> <span class=\"built_in\">string</span> CreatedBy</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">get</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy;</span><br><span class=\"line\">        <span class=\"keyword\">set</span> =&gt; <span class=\"keyword\">base</span>.CreatedBy = <span class=\"keyword\">value</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The project solution should look like this:</p>\n<img src=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/01_project_structure_auditing.png\" class=\"\">\n\n<p>Open your <code>ProductsController.cs</code> file and set the CreatedBy property of all the commands and queries with the property <code>User.Identity.Name</code>.</p>\n<p>Please keep in your mind that, since we haven’t configured authentication in this API, the username value will always be null.</p>\n<p>After changes, your controller actions should look as follows:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;products&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProductsController</span>(<span class=\"params\">IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet</span>]</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;IEnumerable&lt;ProductModel&gt;&gt; SearchAsync([FromQuery] <span class=\"built_in\">string</span> filterQ, [FromQuery] <span class=\"built_in\">int</span>? skip, [FromQuery] <span class=\"built_in\">int</span>? take, CancellationToken ct)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.FetchAsync(<span class=\"keyword\">new</span> SearchProductsQuery</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            FilterQ = filterQ,</span><br><span class=\"line\">            Skip = skip,</span><br><span class=\"line\">            Take = take,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result.Select(r =&gt; <span class=\"keyword\">new</span> ProductModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = r.Id,</span><br><span class=\"line\">            Code = r.Code,</span><br><span class=\"line\">            Name = r.Name,</span><br><span class=\"line\">            Price = r.Price</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;ProductModel&gt; <span class=\"title\">GetByIdAsync</span>(<span class=\"params\">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.FetchAsync(<span class=\"keyword\">new</span> GetProductByIdQuery</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ProductId = id,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ProductModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = result.Id,</span><br><span class=\"line\">            Code = result.Code,</span><br><span class=\"line\">            Name = result.Name,</span><br><span class=\"line\">            Price = result.Price</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpPost</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResultModel&gt; <span class=\"title\">CreateAsync</span>(<span class=\"params\">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.SendAsync(<span class=\"keyword\">new</span> CreateProductCommand</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Code = model.Code,</span><br><span class=\"line\">            Name = model.Name,</span><br><span class=\"line\">            Price = model.Price,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CreateProductResultModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = result.Id</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpPut(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">UpdateAsync</span>(<span class=\"params\">[FromRoute] Guid id, [FromBody] UpdateProductModel model, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _mediator.SendAsync(<span class=\"keyword\">new</span> UpdateProductCommand</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ProductId = id,</span><br><span class=\"line\">            Code = model.Code,</span><br><span class=\"line\">            Name = model.Name,</span><br><span class=\"line\">            Price = model.Price,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpDelete(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">DeleteAsync</span>(<span class=\"params\">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _mediator.SendAsync(<span class=\"keyword\">new</span> DeleteProductCommand</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ProductId = id,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>We also want to pass the same username to all of our events, so open the command handlers and set the event <code>CreatedBy</code> property with the same value from the command, as exemplified by the following handler:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductCommandHandler</span> : <span class=\"title\">ICommandHandler</span>&lt;<span class=\"title\">CreateProductCommand</span>, <span class=\"title\">CreateProductResult</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreateProductCommandHandler</span>(<span class=\"params\">ApiDbContext context, IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResult&gt; <span class=\"title\">HandleAsync</span>(<span class=\"params\">CreateProductCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">await</span> products.AnyAsync(p =&gt; p.Code == cmd.Code, ct))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">$&quot;Product code &#x27;<span class=\"subst\">&#123;cmd.Code&#125;</span>&#x27; already exists&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> externalId = Guid.NewGuid();</span><br><span class=\"line\">        <span class=\"keyword\">await</span> products.AddAsync(<span class=\"keyword\">new</span> ProductEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId,</span><br><span class=\"line\">            Code = cmd.Code,</span><br><span class=\"line\">            Name = cmd.Name,</span><br><span class=\"line\">            Price = cmd.Price</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _mediator.BroadcastAsync(<span class=\"keyword\">new</span> CreatedProductEvent</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId,</span><br><span class=\"line\">            Code = cmd.Code,</span><br><span class=\"line\">            Name = cmd.Name,</span><br><span class=\"line\">            Price = cmd.Price,</span><br><span class=\"line\">            CreatedBy = cmd.CreatedBy  <span class=\"comment\">// use the same value</span></span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CreateProductResult</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = externalId</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"The-Audit-Pipeline\"><a href=\"#The-Audit-Pipeline\" class=\"headerlink\" title=\"The Audit Pipeline\"></a>The Audit Pipeline</h1><p>Now that we are passing the user information into the mediator we can create the audit pipeline that will have the following behavior when intercepting commands:</p>\n<ol>\n<li>Serialize and insert a new entry into the commands table;</li>\n<li>Add both the command and entry ids into an <code>AsyncLocal&lt;T&gt;</code> scope to be used if an event is broadcast;</li>\n<li>Invoke the next pipe;</li>\n<li>If available, serialize the result, calculate the execution time and update the table entry;</li>\n</ol>\n<p>When intercepting events, which are sent by commands, it will do the following:</p>\n<ol>\n<li>Get the command id from the current <code>AsyncLocal&lt;T&gt;</code> scope;</li>\n<li>Serialize the event and insert a new entry into the events table, referencing the command entry;</li>\n<li>Invoke the next pipe;</li>\n</ol>\n<p>Inside the <code>Pipelines</code> folder, create an <code>AuditPipeline</code> class extending <code>Pipeline</code>. The implementation should be similar to the following:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditPipeline</span> : <span class=\"title\">Pipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> DbSet&lt;CommandEntity&gt; _commands;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> DbSet&lt;EventEntity&gt; _events;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">AuditPipeline</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _commands = context.Set&lt;CommandEntity&gt;();</span><br><span class=\"line\">        _events = context.Set&lt;EventEntity&gt;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> command = (<span class=\"keyword\">await</span> _commands.AddAsync(<span class=\"keyword\">new</span> CommandEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = cmd.Id,</span><br><span class=\"line\">            Name = <span class=\"keyword\">typeof</span>(TCommand).Name,</span><br><span class=\"line\">            Payload = JsonSerializer.Serialize(cmd),</span><br><span class=\"line\">            Result = <span class=\"literal\">null</span>,</span><br><span class=\"line\">            CreatedOn = cmd.CreatedOn,</span><br><span class=\"line\">            CreatedBy = cmd.CreatedBy,</span><br><span class=\"line\">            ExecutionTime = TimeSpan.Zero</span><br><span class=\"line\">        &#125;, ct)).Entity;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">using</span> (CommandScope.Begin(command.ExternalId, command.Id))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        command.ExecutionTime = DateTimeOffset.UtcNow - cmd.CreatedOn;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> command = (<span class=\"keyword\">await</span> _commands.AddAsync(<span class=\"keyword\">new</span> CommandEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = cmd.Id,</span><br><span class=\"line\">            Name = <span class=\"keyword\">typeof</span>(TCommand).Name,</span><br><span class=\"line\">            Payload = JsonSerializer.Serialize(cmd),</span><br><span class=\"line\">            Result = <span class=\"literal\">null</span>,</span><br><span class=\"line\">            CreatedOn = cmd.CreatedOn,</span><br><span class=\"line\">            CreatedBy = cmd.CreatedBy,</span><br><span class=\"line\">            ExecutionTime = TimeSpan.Zero</span><br><span class=\"line\">        &#125;, ct)).Entity;</span><br><span class=\"line\"></span><br><span class=\"line\">        TResult result;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">using</span> (CommandScope.Begin(command.ExternalId, command.Id))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            result = <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        command.Result = result == <span class=\"literal\">null</span> ? <span class=\"literal\">null</span> : JsonSerializer.Serialize(result);</span><br><span class=\"line\">        command.ExecutionTime = DateTimeOffset.UtcNow - cmd.CreatedOn;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnEventAsync</span>&lt;<span class=\"title\">TEvent</span>&gt;(<span class=\"params\">Func&lt;TEvent, CancellationToken, Task&gt; next, TEvent evt, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _events.AddAsync(<span class=\"keyword\">new</span> EventEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            CommandId = CommandScope.Current.Id,</span><br><span class=\"line\">            ExternalId = evt.Id,</span><br><span class=\"line\">            Name = <span class=\"keyword\">typeof</span>(TEvent).Name,</span><br><span class=\"line\">            Payload = JsonSerializer.Serialize(evt),</span><br><span class=\"line\">            CreatedOn = evt.CreatedOn,</span><br><span class=\"line\">            CreatedBy = evt.CreatedBy,</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(evt, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">class</span> <span class=\"title\">CommandScope</span> : <span class=\"title\">IDisposable</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">CommandScope</span>(<span class=\"params\">Guid externalId, <span class=\"built_in\">long</span> id</span>)</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId;</span><br><span class=\"line\">            Id = id;</span><br><span class=\"line\"></span><br><span class=\"line\">            AsyncLocal.Value = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Dispose</span>()</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            AsyncLocal.Value = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">readonly</span> AsyncLocal&lt;CommandScope&gt; AsyncLocal = <span class=\"keyword\">new</span> AsyncLocal&lt;CommandScope&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> CommandScope Current =&gt; AsyncLocal.Value;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> IDisposable <span class=\"title\">Begin</span>(<span class=\"params\">Guid externalId, <span class=\"built_in\">long</span> id</span>)</span> =&gt; <span class=\"keyword\">new</span> CommandScope(externalId, id);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Startup.cs</code> file and register this pipeline to be run after all the existing ones, right before the commands or events are handled.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>).ConfigureWarnings(warn =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"comment\">// since InMemoryDatabase does not support transactions</span></span><br><span class=\"line\">                <span class=\"comment\">// for test purposes we are going to ignore this exception</span></span><br><span class=\"line\">                warn.Ignore(InMemoryEventId.TransactionIgnoredWarning);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddMediator(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;ValidationPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TransactionPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;AuditPipeline&gt;();</span><br><span class=\"line\">            <span class=\"keyword\">foreach</span> (<span class=\"function\"><span class=\"keyword\">var</span> implementationType <span class=\"keyword\">in</span> <span class=\"title\">typeof</span>(<span class=\"params\">Startup</span>)</span></span><br><span class=\"line\"><span class=\"function\">                .Assembly</span></span><br><span class=\"line\"><span class=\"function\">                .ExportedTypes</span></span><br><span class=\"line\"><span class=\"function\">                .<span class=\"title\">Where</span>(<span class=\"params\">t =&gt; t.IsClass &amp;&amp; !t.IsAbstract</span>))</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> serviceType <span class=\"keyword\">in</span> implementationType</span><br><span class=\"line\">                    .GetInterfaces()</span><br><span class=\"line\">                    .Where(i =&gt; i.IsGenericType &amp;&amp; i.GetGenericTypeDefinition() == <span class=\"keyword\">typeof</span>(IValidator&lt;&gt;)))</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    o.Services.Add(<span class=\"keyword\">new</span> ServiceDescriptor(serviceType, implementationType, ServiceLifetime.Transient));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// or, if using the SimpleSoft.Mediator.Microsoft.Extensions.* pipelines</span></span><br><span class=\"line\">        <span class=\"comment\">//services.AddMediator(o =&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">//&#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddPipelineForLogging(options =&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">//    &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//        options.LogCommandResult = true;</span></span><br><span class=\"line\">        <span class=\"comment\">//        options.LogQueryResult = true;</span></span><br><span class=\"line\">        <span class=\"comment\">//    &#125;);</span></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddPipeline&lt;TimeoutPipeline&gt;();</span></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddPipelineForValidation(options =&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">//    &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//        options.ValidateCommand = true;</span></span><br><span class=\"line\">        <span class=\"comment\">//        options.ValidateEvent = true;</span></span><br><span class=\"line\">        <span class=\"comment\">//    &#125;);</span></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddPipelineForEFCoreTransaction&lt;ApiDbContext&gt;(options =&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">//    &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//        options.BeginTransactionOnCommand = true;</span></span><br><span class=\"line\">        <span class=\"comment\">//    &#125;);</span></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddPipeline&lt;AuditPipeline&gt;();</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddValidatorsFromAssemblyOf&lt;Startup&gt;();</span></span><br><span class=\"line\">        <span class=\"comment\">//    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span></span><br><span class=\"line\">        <span class=\"comment\">//&#125;);</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Because this pipeline is also serializing all events, the existing handlers for <code>CreatedProductEvent</code>, <code>DeletedProductEvent</code> and <code>UpdatedProductEvent</code> can now either be deleted or stop storing their events into the table to prevent duplicated data:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreatedProductEventHandler</span> : <span class=\"title\">IEventHandler</span>&lt;<span class=\"title\">CreatedProductEvent</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreatedProductEventHandler</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Task <span class=\"title\">HandleAsync</span>(<span class=\"params\">CreatedProductEvent evt, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">//await _context.Set&lt;EventEntity&gt;().AddAsync(new EventEntity</span></span><br><span class=\"line\">        <span class=\"comment\">//&#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//    ExternalId = evt.Id,</span></span><br><span class=\"line\">        <span class=\"comment\">//    Name = nameof(CreatedProductEvent),</span></span><br><span class=\"line\">        <span class=\"comment\">//    Payload = JsonSerializer.Serialize(evt),</span></span><br><span class=\"line\">        <span class=\"comment\">//    CreatedOn = evt.CreatedOn,</span></span><br><span class=\"line\">        <span class=\"comment\">//    CreatedBy = evt.CreatedBy</span></span><br><span class=\"line\">        <span class=\"comment\">//&#125;, ct);</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Task.CompletedTask;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"AsyncLocal\"><a href=\"#AsyncLocal\" class=\"headerlink\" title=\"AsyncLocal\"></a>AsyncLocal<T></h1><p>When comparing the audit pipeline with the previous ones we implemented, the biggest difference is the usage of <code>AsyncLocal&lt;T&gt;</code> to store an instance of the <code>CommandScope</code> class holding both the command external id and the primary key value for the audit entry into the table.</p>\n<p>If you aren’t familiar with this class, it is available since .NET Framework 4.6 and .NET standard 1.3, and was introduced to help sharing global flow state when implementing asynchronous code with Task Parallel Library (TPL). Because TPL relies on the thread pool and, by default, asynchronous code in ASP.NET Core applications can be resumed by any available thread, we can’t rely on mechanisms like the <code>ThreadLocal</code> class to store global state.</p>\n<p>Simply put, the idea of <code>AsyncLocal&lt;T&gt;</code> is to create a static instance that can hold some <code>T</code> value and, as long you use the <code>async</code> and <code>await</code> keywords, the runtime will consider your code execution to be a logical flow, despite asynchronous, and will ensure the value is shared even if the flow has been resumed by a different thread.</p>\n<p>Because we want to share data between the command and event interceptor code, the flow is asynchronous, and since only commands broadcast events, the <code>AsyncLocal&lt;T&gt;</code> class is an elegant solution to prevent changing all the events to include an <code>CommandId</code> property that has to be set on every broadcast.</p>\n<p>As an example, this is usually the solution implemented by some logging frameworks to support the creation of scopes, enabling some information to be written on every log without having to pass it every time, like when the using Microsoft façade <code>Logger.BeginScope(&quot;X:&#123;x&#125; Y:&#123;y&#125;&quot;, x, y)</code>.</p>\n<p>For more details and examples, give a look to the <code>AsyncLocal&lt;T&gt;</code> class <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.threading.asynclocal-1?view=net-8.0\">documentation</a>.</p>\n<h1 id=\"Audits-Controller\"><a href=\"#Audits-Controller\" class=\"headerlink\" title=\"Audits Controller\"></a>Audits Controller</h1><p>To make it easier to test and check our system audits, we are going to implement the following endpoint:</p>\n<p>GET &#x2F;audits — search for command audits using some filters (<code>SearchAuditsQuery</code>);<br>GET &#x2F;audits&#x2F;{id} — get a command audit by its unique identifier and all the associated events (<code>GetAuditByIdQuery</code>);</p>\n<p>Inside the <code>Handlers</code> folder create an <code>Audits</code> folder and create the queries for searching or getting an audit by its external id:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SearchAuditsQueryHandler</span> : <span class=\"title\">IQueryHandler</span>&lt;<span class=\"title\">SearchAuditsQuery</span>, <span class=\"title\">IEnumerable</span>&lt;<span class=\"title\">AuditSearchItem</span>&gt;&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IQueryable&lt;CommandEntity&gt; _commands;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SearchAuditsQueryHandler</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _commands = context.Set&lt;CommandEntity&gt;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;IEnumerable&lt;AuditSearchItem&gt;&gt; HandleAsync(SearchAuditsQuery query, CancellationToken ct)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> filter = _commands;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">string</span>.IsNullOrWhiteSpace(query.FilterQ))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> filterQ = query.FilterQ.Trim();</span><br><span class=\"line\"></span><br><span class=\"line\">            filter = filter.Where(p =&gt;</span><br><span class=\"line\">                p.Name.Contains(filterQ)</span><br><span class=\"line\">            );</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> skip = query.Skip ?? <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> take = query.Take ?? <span class=\"number\">20</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> filter</span><br><span class=\"line\">            .OrderByDescending(c =&gt; c.CreatedOn)</span><br><span class=\"line\">            .ThenByDescending(c =&gt; c.Id)</span><br><span class=\"line\">            .Skip(skip)</span><br><span class=\"line\">            .Take(take)</span><br><span class=\"line\">            .Select(c =&gt; <span class=\"keyword\">new</span> AuditSearchItem</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                Id = c.ExternalId,</span><br><span class=\"line\">                Name = c.Name,</span><br><span class=\"line\">                CreatedOn = c.CreatedOn,</span><br><span class=\"line\">                CreatedBy = c.CreatedBy,</span><br><span class=\"line\">                ExecutionTimeInMs = (<span class=\"built_in\">long</span>) c.ExecutionTime.TotalMilliseconds</span><br><span class=\"line\">            &#125;).ToListAsync(ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SearchAuditsQuery</span> : <span class=\"title\">Query</span>&lt;<span class=\"title\">IEnumerable</span>&lt;<span class=\"title\">AuditSearchItem</span>&gt;&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> FilterQ &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">int</span>? Skip &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">int</span>? Take &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditSearchItem</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> ExecutionTimeInMs &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">GetAuditByIdQueryHandler</span> : <span class=\"title\">IQueryHandler</span>&lt;<span class=\"title\">GetAuditByIdQuery</span>, <span class=\"title\">Audit</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IQueryable&lt;CommandEntity&gt; _commands;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IQueryable&lt;EventEntity&gt; _events;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">GetAuditByIdQueryHandler</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _commands = context.Set&lt;CommandEntity&gt;();</span><br><span class=\"line\">        _events = context.Set&lt;EventEntity&gt;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;Audit&gt; <span class=\"title\">HandleAsync</span>(<span class=\"params\">GetAuditByIdQuery query, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> command = <span class=\"keyword\">await</span> _commands.SingleOrDefaultAsync(c =&gt; c.ExternalId == query.AuditId, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (command == <span class=\"literal\">null</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">$&quot;Command audit &#x27;<span class=\"subst\">&#123;query.AuditId&#125;</span>&#x27; not found&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> events = <span class=\"keyword\">await</span> _events.Where(e =&gt; e.CommandId == command.Id).ToListAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Audit</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = command.ExternalId,</span><br><span class=\"line\">            Name = command.Name,</span><br><span class=\"line\">            Payload = JsonSerializer.Deserialize&lt;<span class=\"built_in\">dynamic</span>&gt;(command.Payload),</span><br><span class=\"line\">            Result = <span class=\"built_in\">string</span>.IsNullOrWhiteSpace(command.Result)</span><br><span class=\"line\">                ? <span class=\"literal\">null</span></span><br><span class=\"line\">                : JsonSerializer.Deserialize&lt;<span class=\"built_in\">dynamic</span>&gt;(command.Result),</span><br><span class=\"line\">            CreatedOn = command.CreatedOn,</span><br><span class=\"line\">            CreatedBy = command.CreatedBy,</span><br><span class=\"line\">            ExecutionTimeInMs = (<span class=\"built_in\">long</span>) command.ExecutionTime.TotalMilliseconds,</span><br><span class=\"line\">            Events = events.Select(e =&gt; <span class=\"keyword\">new</span> AuditEvent</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                Id = e.ExternalId,</span><br><span class=\"line\">                Name = e.Name,</span><br><span class=\"line\">                Payload = JsonSerializer.Deserialize&lt;<span class=\"built_in\">dynamic</span>&gt;(e.Payload),</span><br><span class=\"line\">                CreatedOn = e.CreatedOn</span><br><span class=\"line\">            &#125;).ToList()</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">GetAuditByIdQuery</span> : <span class=\"title\">Query</span>&lt;<span class=\"title\">Audit</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid AuditId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Audit</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">object</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">object</span> Result &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> ExecutionTimeInMs &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> IEnumerable&lt;AuditEvent&gt; Events &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditEvent</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">object</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Inside the <code>Controllers</code> folder create an <code>Audit</code> folder and an <code>AuditController</code> that will use the previous queries:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;audits&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">AuditsController</span>(<span class=\"params\">IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet</span>]</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;IEnumerable&lt;AuditSearchItemModel&gt;&gt; SearchAsync([FromQuery] <span class=\"built_in\">string</span> filterQ, [FromQuery] <span class=\"built_in\">int</span>? skip, [FromQuery] <span class=\"built_in\">int</span>? take, CancellationToken ct)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.FetchAsync(<span class=\"keyword\">new</span> SearchAuditsQuery</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            FilterQ = filterQ,</span><br><span class=\"line\">            Skip = skip,</span><br><span class=\"line\">            Take = take,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result.Select(r =&gt; <span class=\"keyword\">new</span> AuditSearchItemModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = r.Id,</span><br><span class=\"line\">            Name = r.Name,</span><br><span class=\"line\">            CreatedOn = r.CreatedOn,</span><br><span class=\"line\">            CreatedBy = r.CreatedBy,</span><br><span class=\"line\">            ExecutionTimeInMs = r.ExecutionTimeInMs</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;AuditModel&gt; <span class=\"title\">GetByIdAsync</span>(<span class=\"params\">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.FetchAsync(<span class=\"keyword\">new</span> GetAuditByIdQuery</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            AuditId = id,</span><br><span class=\"line\">            CreatedBy = User.Identity.Name</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AuditModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = result.Id,</span><br><span class=\"line\">            Name = result.Name,</span><br><span class=\"line\">            Payload = result.Payload,</span><br><span class=\"line\">            Result = result.Result,</span><br><span class=\"line\">            CreatedOn = result.CreatedOn,</span><br><span class=\"line\">            CreatedBy = result.CreatedBy,</span><br><span class=\"line\">            ExecutionTimeInMs = result.ExecutionTimeInMs,</span><br><span class=\"line\">            Events = result.Events.Select(e =&gt; <span class=\"keyword\">new</span> AuditEventModel</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                Id = e.Id,</span><br><span class=\"line\">                Name = e.Name,</span><br><span class=\"line\">                Payload = e.Payload,</span><br><span class=\"line\">                CreatedOn = e.CreatedOn</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditSearchItemModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> ExecutionTimeInMs &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">object</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">object</span> Result &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> ExecutionTimeInMs &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> IEnumerable&lt;AuditEventModel&gt; Events &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuditEventModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">object</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The project structure should look as follows:</p>\n<img src=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/02_project_structure_auditing_final.png\" class=\"\">\n\n<p>Open the Swagger endpoint (ex: <a href=\"https://localhost:44380/swagger\">https://localhost:44380/swagger</a>) and you should see the audits endpoint:</p>\n<img src=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/03_swagger_audit.png\" class=\"\">\n\n<p>Create, update or delete products with the help of Swagger UI and then check if all the commands and events have been properly audited:</p>\n<img src=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/04_swagger_audit_search.png\" class=\"\">\n\n<p>And even get the details of a specific audit:</p>\n<img src=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/05_swagger_audit_get_by_id.png\" class=\"\">\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use mediator pipelines to simplify the auditing of user actions without having to replicate code across all commands.</p>\n<p>We also ensured events were always stored before being broadcasted and a reference to the command was kept without adding properties to our POCOs, providing a more clean approach.</p>\n<p>Soon I’ll be explaining how we can inject more specialized interfaces, like the <code>ISender&lt;TCommand&gt;</code>, to make our dependencies more clearer and help with unit testing.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp",
                "patterns"
            ]
        },
        {
            "id": "https://code-corner.dev/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/",
            "url": "https://code-corner.dev/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/",
            "title": "Transaction Management With Mediator Pipelines in ASP.NET Core",
            "date_published": "2020-11-07T00:00:00.000Z",
            "content_html": "<p>When implementing a <strong>simplified CQRS</strong> service, which usually has a single database but still separates commands from queries, the mediator pipeline can be used to manage transactions when processing commands, ensuring changes will be implicitly committed unless an exception is thrown.</p>\n<p>Implementing a pipeline for transactions has some key advantages even when using Entity Framework Core or other ORM that tracks and flushes changes at a single point in time.</p>\n<p>Because the command handler is executing inside an implicit transaction, the developer is free to flush their changes as it sees fit knowing that any exception will rollback the changes. This is very helpful when it wants to cancel the flow when some business rules aren’t meet and could only be checked after changing the system state. Optimistic concurrency is a good example where you may want to flush your changes before leaving the handler so you know exactly what entity failed and can send a more detailed message to the user, which is the usual approach when implementing a dedicated <strong>Backend for Frontend</strong> service.</p>\n<p>Also, ORMs are very good at abstracting database access but can’t solve more edge cases, specially when performance is a requirement. Being able to use a more lightweight library (e.g. <a href=\"https://github.com/StackExchange/Dapper\">Dapper</a>) to do some bulk operations and using the ORM context connection inside the same transaction will remove the need to use the <code>TransactionScope</code> and reduce some application complexity.</p>\n<p>Ensuring transactions are properly managed around the handler execution ensure the application architecture is be more robust and will be able to handle more edge cases.</p>\n<hr>\n<h1 id=\"The-project\"><a href=\"#The-project\" class=\"headerlink\" title=\"The project\"></a>The project</h1><p>This article will be based on my previous ones that explained how to use the mediator and implement transversal behavior with pipelines. As a reminder, we implemented an endpoint to manage products with the following:</p>\n<ul>\n<li>GET &#x2F;products — search for products using some filters (<code>SearchProductsQuery</code>);</li>\n<li>GET &#x2F;products&#x2F;{id} — get a product by its unique identifier (<code>GetProductByIdQuery</code>);</li>\n<li>POST &#x2F;products — create a product (<code>CreateProductCommand</code> and <code>CreatedProductEvent</code>);</li>\n<li>PUT &#x2F;products&#x2F;{id} — update a product by its unique identifier (<code>UpdateProductCommand</code> and <code>UpdatedProductEvent</code>);</li>\n<li>DELETE &#x2F;products&#x2F;{id} — delete a product by its unique identifier (<code>DeleteProductCommand</code> and <code>DeletedProductEvent</code>);</li>\n</ul>\n<p>You can check them out here:</p>\n<ul>\n<li><a href=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/\" title=\"Mediator Pattern in ASP.NET Core Applications\">Mediator Pattern in ASP.NET Core Applications</a></li>\n<li><a href=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Using Mediator Pipelines in ASP.NET Core Applications\">Using Mediator Pipelines in ASP.NET Core Applications</a></li>\n<li><a href=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Validation with Mediator Pipelines in ASP.NET Core Applications\">Validation with Mediator Pipelines in ASP.NET Core Applications</a></li>\n</ul>\n<p>The source code is available on <a href=\"https://github.com/gravity00/IntroductionMediatorCQRS\">GitHub</a>, feel free to give it a look.</p>\n<h1 id=\"Entity-Framework-Core-transactions\"><a href=\"#Entity-Framework-Core-transactions\" class=\"headerlink\" title=\"Entity Framework Core transactions\"></a>Entity Framework Core transactions</h1><p>Entity Framework Core has support for explicit transaction management, which works in a similar way to ADO.NET or the <code>TransactionScope</code> class.</p>\n<p>You can get a disposable instance of <code>IDbContextTransaction</code> by invoking the method <code>BeginTransactionAsync</code>, available from the database property. The transaction can be either committed or rolled back, either by explicit invocation or by disposing the instance before any commit.</p>\n<p>As stated before, this can be very helpful if <code>SaveChanges</code> must be invoked multiple times inside the <em>unit of work</em> operation and you want to ensure exceptions will rollback data changes.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">await</span> <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> tx = <span class=\"keyword\">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> products.Where(p =&gt; p.Code.StartsWith(<span class=\"string\">&#x27;9&#x27;</span>)).ForEachAsync(product =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    product.Name += <span class=\"string\">&quot; [DEPRECATED]&quot;</span>;</span><br><span class=\"line\">&#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> products.ForEachAsync(product =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    product.Price /= <span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">await</span> tx.CommitAsync(ct);</span><br></pre></td></tr></table></figure>\n\n<p>In the example above if an exception was thrown after the first <code>SaveChangesAsync</code> every changes would be reverted because the transaction would be disposed without an explicit call to commit.</p>\n<p>We are going to leverage on this behavior to implement the pipeline.</p>\n<h1 id=\"The-pipeline\"><a href=\"#The-pipeline\" class=\"headerlink\" title=\"The pipeline\"></a>The pipeline</h1><p>Since only commands mutate system state, we are going to use the command pipeline to enforce a transaction for the next pipelines in the chain up until the handler.</p>\n<p>The pipeline behavior will be:</p>\n<ol>\n<li>Intercept any command;</li>\n<li>Create a new <code>IDbContextTransaction</code> with <code>BeginTransactionAsync</code>;</li>\n<li>Invoke the next pipeline inside the <code>using</code> scope;</li>\n<li>If no exception is thrown, flush all changes and commit;</li>\n<li>Dispose the transaction;</li>\n</ol>\n<p>I’ll also include some commented code incase you want to be sure the queries never mutate the system state. Prevention is better than cure…</p>\n<p>Inside the <code>Pipelines</code> folder create a <code>TransactionPipeline</code> class extending <code>Pipeline</code> (because we only need some of the methods):</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">TransactionPipeline</span> : <span class=\"title\">Pipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TransactionPipeline</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> tx = <span class=\"keyword\">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> tx.CommitAsync(ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> tx = <span class=\"keyword\">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> tx.CommitAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//public override async Task&lt;TResult&gt; OnQueryAsync&lt;TQuery, TResult&gt;(Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, TQuery query, CancellationToken ct)</span></span><br><span class=\"line\">    <span class=\"comment\">//&#123;</span></span><br><span class=\"line\">    <span class=\"comment\">//    await using var tx = await _context.Database.BeginTransactionAsync(ct);</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//    var result = await next(query, ct);</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//    await tx.RollbackAsync(ct);</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//    return result;</span></span><br><span class=\"line\">    <span class=\"comment\">//&#125;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Startup.cs</code> file and add the <code>TransactionPipeline</code> after the <code>ValidationPipeline</code>, preventing the opening of transactions that could be immediately closed if the command had invalid data.</p>\n<p>Since this examples are using the in-memory database provider for Entity Framework Core, which does not support explicit transactions, we are also going to ignore them for test purposes.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>).ConfigureWarnings(warn =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                warn.Ignore(InMemoryEventId.TransactionIgnoredWarning);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddMediator(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;ValidationPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TransactionPipeline&gt;();</span><br><span class=\"line\">            <span class=\"keyword\">foreach</span> (<span class=\"function\"><span class=\"keyword\">var</span> implementationType <span class=\"keyword\">in</span> <span class=\"title\">typeof</span>(<span class=\"params\">Startup</span>)</span></span><br><span class=\"line\"><span class=\"function\">                .Assembly</span></span><br><span class=\"line\"><span class=\"function\">                .ExportedTypes</span></span><br><span class=\"line\"><span class=\"function\">                .<span class=\"title\">Where</span>(<span class=\"params\">t =&gt; t.IsClass &amp;&amp; !t.IsAbstract</span>))</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> serviceType <span class=\"keyword\">in</span> implementationType</span><br><span class=\"line\">                    .GetInterfaces()</span><br><span class=\"line\">                    .Where(i =&gt; i.IsGenericType &amp;&amp; i.GetGenericTypeDefinition() == <span class=\"keyword\">typeof</span>(IValidator&lt;&gt;)))</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    o.Services.Add(<span class=\"keyword\">new</span> ServiceDescriptor(serviceType, implementationType, ServiceLifetime.Transient));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Now that we have a transversal behavior that manages transactions and flushes all context changes to the database, we can remove from all command handlers the explicit calls to <code>SaveChangesAsync</code>:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">DeleteProductCommandHandler</span> : <span class=\"title\">ICommandHandler</span>&lt;<span class=\"title\">DeleteProductCommand</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DeleteProductCommandHandler</span>(<span class=\"params\">ApiDbContext context, IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">HandleAsync</span>(<span class=\"params\">DeleteProductCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> product = <span class=\"keyword\">await</span> products.SingleOrDefaultAsync(p =&gt; p.ExternalId == cmd.ProductId, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (product == <span class=\"literal\">null</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">$&quot;Product &#x27;<span class=\"subst\">&#123;cmd.ProductId&#125;</span>&#x27; not found&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        products.Remove(product);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//await _context.SaveChangesAsync(ct);</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _mediator.BroadcastAsync(<span class=\"keyword\">new</span> DeletedProductEvent</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ProductId = cmd.ProductId</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Speeding-things-up\"><a href=\"#Speeding-things-up\" class=\"headerlink\" title=\"Speeding things up!\"></a>Speeding things up!</h1><p>Because this is a pipeline we use very often in most of our APIs, there is already a <a href=\"https://www.nuget.org/packages/simplesoft.mediator.microsoft.extensions.efcoretransactionpipeline\">NuGet available that allows to open an explicit Entity Framework Core transaction for commands, events or queries</a>, depending your needs.</p>\n<p>To use it, just open the NuGet package manager and install the package <code>SimpleSoft.Mediator.Microsoft.Extensions.EFCoreTransactionPipeline</code>:</p>\n<img src=\"/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/01_nuget_mediator_transaction_pipeline.png\" class=\"\">\n\n<p>Open the <code>Startup.cs</code> file and register the pipeline with the extension method <code>AddPipelineForEFCoreTransaction&lt;TContext&gt;</code>. Explicit transactions are disabled by default, so you only need to enable them for commands.</p>\n<p>When using all the NuGets mentioned on my previous articles, the <code>Startup.cs</code> file should be similar to this:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>).ConfigureWarnings(warn =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"comment\">// since InMemoryDatabase does not support transactions</span></span><br><span class=\"line\">                <span class=\"comment\">// for test purposes we are going to ignore this exception</span></span><br><span class=\"line\">                warn.Ignore(InMemoryEventId.TransactionIgnoredWarning);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddMediator(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.AddPipelineForLogging(options =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                options.LogCommandResult = <span class=\"literal\">true</span>;</span><br><span class=\"line\">                options.LogQueryResult = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">            o.AddPipelineForValidation(options =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                options.ValidateCommand = <span class=\"literal\">true</span>;</span><br><span class=\"line\">                options.ValidateEvent = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            o.AddPipelineForEFCoreTransaction&lt;ApiDbContext&gt;(options =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                options.BeginTransactionOnCommand = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            o.AddValidatorsFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ..</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use mediator pipelines to simplify the management of Entity Framework Core transactions, making the implementation of command handlers less error prone since developers won’t forget to flush changes to the database (that behavior will be implicit unless an exception is thrown).</p>\n<p>Even if your application is using another ORM or other lightweight libraries (e.g. <a href=\"https://github.com/StackExchange/Dapper\">Dapper</a>), you can easily implement your own pipeline.</p>\n<p>I also made an article about <a href=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/\" title=\"Auditing with Mediator Pipelines in ASP.NET Core\">auditing user actions with pipelines</a>, you may also find it helpful.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp",
                "patterns"
            ]
        },
        {
            "id": "https://code-corner.dev/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/",
            "url": "https://code-corner.dev/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/",
            "title": "Validation with Mediator Pipelines in ASP.NET Core Applications",
            "date_published": "2020-11-04T00:00:00.000Z",
            "content_html": "<p>When implementing web applications that manipulate information, there is always the need to validate data sent by the clients, ensuring business rules are properly implemented.</p>\n<p>Previously I talked about the implementation of <strong>Command Query Responsibility Segregation (CQRS)</strong> and <strong>Event Sourcing (ES)</strong> using a mediator pattern and how to support transversal behavior via pipelines.</p>\n<p>In this article I’m going to demonstrate how validation can be enforced into your commands and events before reaching the handlers, making sure that invalid data will be rejected by the API.</p>\n<p>This approach not only reduces the amount of duplicated code, it also ensures validations won’t be forgotten, unless explicitly stated.</p>\n<hr>\n<h1 id=\"The-project\"><a href=\"#The-project\" class=\"headerlink\" title=\"The project\"></a>The project</h1><p>To make it faster to implement the validation pipeline, I’m going to leverage this example on both of my previous articles, in which we implemented an <a href=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/\" title=\"Mediator Pattern in ASP.NET Core Applications\">endpoint to manage products</a> and introduced both a <a href=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Using Mediator Pipelines in ASP.NET Core Applications\">logging and timeout pipelines</a>.</p>\n<p>The source code is available on <a href=\"https://github.com/gravity00/IntroductionMediatorCQRS\">GitHub</a>.</p>\n<h1 id=\"The-validations\"><a href=\"#The-validations\" class=\"headerlink\" title=\"The validations\"></a>The validations</h1><p>To help us configure the rules we are going to use a very popular and one of my favorites libraries <a href=\"https://fluentvalidation.net/\">FluentValidation</a> by creating classes implementing the interface <code>IValidator&lt;T&gt;</code>.</p>\n<p>These classes will be added to the dependency injection container and used by the pipeline to validate both the commands and events before reaching the handler.</p>\n<p>Lets start by installing the NuGet <code>FluentValidation</code>:</p>\n<img src=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/01_nuget_fluentvalidation.png\" class=\"\">\n\n<p>Create a <code>Validations</code> folder at the project root level, with a subfolder <code>Products</code>.</p>\n<img src=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/02_project_structure.png\" class=\"\">\n\n<p>Inside the <code>Products</code> folder create both a validator for <code>CreateProductCommand</code> and <code>CreatedProductEvent</code> by extending the class <code>AbstractValidator&lt;T&gt;</code> (which itself implementes the interface <code>IValidator&lt;T&gt;</code>) and configure some rules in the constructors:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductCommandValidator</span> : <span class=\"title\">AbstractValidator</span>&lt;<span class=\"title\">CreateProductCommand</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreateProductCommandValidator</span>()</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        RuleFor(e =&gt; e.Code)</span><br><span class=\"line\">            .NotEmpty()</span><br><span class=\"line\">            .Length(<span class=\"number\">8</span>)</span><br><span class=\"line\">            .Matches(<span class=\"string\">&quot;^[0-9a-zA-Z]*$&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        RuleFor(e =&gt; e.Name)</span><br><span class=\"line\">            .NotEmpty()</span><br><span class=\"line\">            .MaximumLength(<span class=\"number\">128</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        RuleFor(e =&gt; e.Price)</span><br><span class=\"line\">            .GreaterThanOrEqualTo(<span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreatedProductEventValidator</span> : <span class=\"title\">AbstractValidator</span>&lt;<span class=\"title\">CreatedProductEvent</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreatedProductEventValidator</span>()</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        RuleFor(e =&gt; e.ExternalId)</span><br><span class=\"line\">            .NotEmpty();</span><br><span class=\"line\"></span><br><span class=\"line\">        RuleFor(e =&gt; e.Code)</span><br><span class=\"line\">            .NotEmpty()</span><br><span class=\"line\">            .Length(<span class=\"number\">8</span>)</span><br><span class=\"line\">            .Matches(<span class=\"string\">&quot;^[0-9a-zA-Z]*$&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        RuleFor(e =&gt; e.Name)</span><br><span class=\"line\">            .NotEmpty()</span><br><span class=\"line\">            .MaximumLength(<span class=\"number\">128</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        RuleFor(e =&gt; e.Price)</span><br><span class=\"line\">            .GreaterThanOrEqualTo(<span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Feel free to create validators for all other commands and events, I’m just focusing on these for simplicity. You can also check the <a href=\"https://docs.fluentvalidation.net/en/latest/\">documentation for supported rules and detailed usage instructions</a>.</p>\n<p>Open the <code>Startup.cs</code> file and register all classes implementing <code>IValidator&lt;T&gt;</code> into the container:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddMediator(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> (<span class=\"function\"><span class=\"keyword\">var</span> implementationType <span class=\"keyword\">in</span> <span class=\"title\">typeof</span>(<span class=\"params\">Startup</span>)</span></span><br><span class=\"line\"><span class=\"function\">            .Assembly</span></span><br><span class=\"line\"><span class=\"function\">            .ExportedTypes</span></span><br><span class=\"line\"><span class=\"function\">            .<span class=\"title\">Where</span>(<span class=\"params\">t =&gt; t.IsClass &amp;&amp; !t.IsAbstract</span>))</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> serviceType <span class=\"keyword\">in</span> implementationType</span><br><span class=\"line\">                .GetInterfaces()</span><br><span class=\"line\">                .Where(i =&gt; i.IsGenericType &amp;&amp; i.GetGenericTypeDefinition() == <span class=\"keyword\">typeof</span>(IValidator&lt;&gt;)))</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                services.Add(<span class=\"keyword\">new</span> ServiceDescriptor(serviceType, implementationType, ServiceLifetime.Transient));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"The-pipeline\"><a href=\"#The-pipeline\" class=\"headerlink\" title=\"The pipeline\"></a>The pipeline</h1><p>Because for this example we are going to enforce validation only on commands and events, since they either mutate or represent the system state at a given point in time, the pipeline will be implemented as follows:</p>\n<ol>\n<li>Intercept any command or event;</li>\n<li>Resolve a required instance of <code>IValidator&lt;TCommand&gt;</code> or <code>IValidator&lt;TEvent&gt;</code> from the container;</li>\n<li>Invoke the method <code>ValidateAndThrowAsync</code>, failing with a <code>ValidationException</code> if something is invalid;</li>\n</ol>\n<p>Inside the <code>Pipelines</code> folder create a <code>ValidationPipeline</code> class extending <code>Pipeline</code> (because we only need some of the methods):</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ValidationPipeline</span> : <span class=\"title\">Pipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IServiceProvider _provider;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ValidationPipeline</span>(<span class=\"params\">IServiceProvider provider</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _provider = provider;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> ValidateAndThrowAsync(cmd, ct);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> ValidateAndThrowAsync(cmd, ct);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnEventAsync</span>&lt;<span class=\"title\">TEvent</span>&gt;(<span class=\"params\">Func&lt;TEvent, CancellationToken, Task&gt; next, TEvent evt, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> ValidateAndThrowAsync(evt, ct);</span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(evt, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">async</span> Task <span class=\"title\">ValidateAndThrowAsync</span>&lt;<span class=\"title\">T</span>&gt;(<span class=\"params\">T instance, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> validator = _provider.GetRequiredService&lt;IValidator&lt;T&gt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">await</span> validator.ValidateAndThrowAsync(instance, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Startup.cs</code> file and add the <code>ValidationPipeline</code> at least after the <code>LoggingPipeline</code> ensuring, in case invalid data is submitted, we can still see it in the logs:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">services.AddMediator(o =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">    o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">    o.AddPipeline&lt;ValidationPipeline();</span><br><span class=\"line\">    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>If you now start the server and try to create a product with invalid data you will receive a <code>ValidationException</code>.</p>\n<img src=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/03_validation_exception.png\" class=\"\">\n\n<p>Because returning an HTTP 500 due to invalid data would be confusing to the client, lets just finish this example by creating an ASP.NET Core middleware converting this exception into a more appropriate code, like HTTP 422.</p>\n<p>Once again, open the <code>Startup.cs</code> file and register the middleware immediately after the developer exception page, catching this exception and returning HTTP 422 with a more detailed JSON representation:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        app.UseDeveloperExceptionPage();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.Use(<span class=\"keyword\">async</span> (ctx, next) =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">await</span> next();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">catch</span> (ValidationException e)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"keyword\">var</span> response = ctx.Response;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (response.HasStarted)</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span>;</span><br><span class=\"line\">                ctx.RequestServices</span><br><span class=\"line\">                    .GetRequiredService&lt;ILogger&lt;Startup&gt;&gt;()</span><br><span class=\"line\">                    .LogWarning(e, <span class=\"string\">&quot;Invalid data has been submitted&quot;</span>);</span><br><span class=\"line\">                response.Clear();</span><br><span class=\"line\">                response.StatusCode = <span class=\"number\">422</span>;</span><br><span class=\"line\">                <span class=\"keyword\">await</span> response.WriteAsync(JsonSerializer.Serialize(<span class=\"keyword\">new</span></span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    Message = <span class=\"string\">&quot;Invalid data has been submitted&quot;</span>,</span><br><span class=\"line\">                    ModelState = e.Errors.ToDictionary(error =&gt; error.ErrorCode, error =&gt; error.ErrorMessage)</span><br><span class=\"line\">                &#125;), Encoding.UTF8, ctx.RequestAborted);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwagger();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwaggerUI(c =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            c.SwaggerEndpoint(<span class=\"string\">&quot;/swagger/v1/swagger.json&quot;</span>, <span class=\"string\">&quot;Mediator ExampleApi V1&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseRouting();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseEndpoints(endpoints =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            endpoints.MapControllers();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Submit invalid data again and a more detailed message should be returned:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /products</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;code&quot;: &quot;-123456&quot;,</span><br><span class=\"line\">  &quot;name&quot;: &quot;&quot;,</span><br><span class=\"line\">  &quot;price&quot;: -1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">HTTP 422</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   &quot;Message&quot;:&quot;Invalid data has been submitted&quot;,</span><br><span class=\"line\">   &quot;ModelState&quot;:&#123;</span><br><span class=\"line\">      &quot;ExactLengthValidator&quot;:&quot;&#x27;Code&#x27; must be 8 characters in length. You entered 7 characters.&quot;,</span><br><span class=\"line\">      &quot;RegularExpressionValidator&quot;:&quot;&#x27;Code&#x27; is not in the correct format.&quot;,</span><br><span class=\"line\">      &quot;NotEmptyValidator&quot;:&quot;&#x27;Name&#x27; must not be empty.&quot;,</span><br><span class=\"line\">      &quot;GreaterThanOrEqualValidator&quot;:&quot;&#x27;Price&#x27; must be greater than or equal to &#x27;0&#x27;.&quot;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Speeding-things-up\"><a href=\"#Speeding-things-up\" class=\"headerlink\" title=\"Speeding things up!\"></a>Speeding things up!</h1><p>If just like me, you can see yourself using a pipeline for validation in most of your projects, there is already a <a href=\"https://www.nuget.org/packages/simplesoft.mediator.microsoft.extensions.validationpipeline\">pipeline available via NuGet</a> that should be configurable to most use cases while also providing a simpler way to register the validators into the container.</p>\n<p>Install <code>SimpleSoft.Mediator.Microsoft.Extensions.ValidationPipeline</code> via NuGet:</p>\n<img src=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/04_nuget_mediator_validation_pipeline.png\" class=\"\">\n\n<p>Use the extension method <code>AddPipelineForValidation</code> and enforce both command and event validations and use the extension method <code>AddValidatorsFromAssemblyOf</code> to scan for all <code>IValidator&lt;T&gt;</code> classes and register them into the container.</p>\n<p>For the current project, the <code>ConfigureServices</code> method would be similar to the following:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddMediator(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">            o.AddPipelineForValidation(options =&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                options.ValidateCommand = <span class=\"literal\">true</span>;</span><br><span class=\"line\">                options.ValidateEvent = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            o.AddValidatorsFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use mediator pipelines to ensure that all your commands, events and even queries are initialized with proper data, either implementing your own pipeline or by using the existing <a href=\"https://www.nuget.org/packages/simplesoft.mediator.microsoft.extensions.validationpipeline\">ValidationPipeline</a> NuGet.</p>\n<p>I also made an article about <a href=\"/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/\" title=\"Transaction Management With Mediator Pipelines in ASP.NET Core\">transaction management with pipelines</a>, you may also find it helpful.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp",
                "patterns"
            ]
        },
        {
            "id": "https://code-corner.dev/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/",
            "url": "https://code-corner.dev/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/",
            "title": "Using Mediator Pipelines in ASP.NET Core Applications",
            "date_published": "2020-11-02T00:00:00.000Z",
            "content_html": "<p>In my <a href=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/\" title=\"Mediator Pattern in ASP.NET Core Applications\">previous article</a> I explained how you could implement <strong>Command Query Responsibility Segregation (CQRS)</strong> and <strong>Event Sourcing (ES)</strong> patterns using a mediator instance from <a href=\"https://www.nuget.org/packages/simplesoft.mediator\">SimpleSoft.Mediator</a> in ASP.NET Core applications.</p>\n<p>This time I’m going to explain how to intercept commands, queries and events, making it possible to apply transversal behavior before they reach the handlers, reducing significantly the amount of boilerplate and duplicated code.</p>\n<p>Transaction management, logging, auditing, caching or validations are some of the good examples where pipelines can be very helpful. Imagine the following chains:</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Commands:</span><br><span class=\"line\">  Mediator</span><br><span class=\"line\">    LoggingPipeline</span><br><span class=\"line\">      ValidationPipeline</span><br><span class=\"line\">        TransactionPipeline</span><br><span class=\"line\">          AuditPipeline</span><br><span class=\"line\">            Handler</span><br><span class=\"line\"></span><br><span class=\"line\">Queries:</span><br><span class=\"line\">  Mediator</span><br><span class=\"line\">    LoggingPipeline</span><br><span class=\"line\">      Handler</span><br><span class=\"line\"></span><br><span class=\"line\">Events:</span><br><span class=\"line\">  Mediator</span><br><span class=\"line\">    LoggingPipeline</span><br><span class=\"line\">      StoragePipeline</span><br><span class=\"line\">        Handler(s)</span><br></pre></td></tr></table></figure>\n\n<p>Not only you can plugin any pipeline at will without changing the handlers implementation, you can also be specific to the entities each pipeline is interested.</p>\n<h1 id=\"Pipelines\"><a href=\"#Pipelines\" class=\"headerlink\" title=\"Pipelines\"></a>Pipelines</h1><p>Mediator pipelines are represented by the interface <code>IPipeline</code> (or the abstract class <code>Pipeline</code>) with methods to intercept each entity type:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">IPipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\">Task <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        Func&lt;TCommand, CancellationToken, Task&gt; next, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TCommand cmd, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TCommand : <span class=\"keyword\">class</span>, ICommand</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TCommand cmd, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TCommand : <span class=\"keyword\">class</span>, <span class=\"title\">ICommand</span>&lt;<span class=\"title\">TResult</span>&gt;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">Task <span class=\"title\">OnEventAsync</span>&lt;<span class=\"title\">TEvent</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        Func&lt;TEvent, CancellationToken, Task&gt; next, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TEvent evt, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TEvent : <span class=\"keyword\">class</span>, IEvent</span>;</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"function\"><span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnQueryAsync</span>&lt;<span class=\"title\">TQuery</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TQuery query, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) <span class=\"keyword\">where</span> TQuery : <span class=\"keyword\">class</span>, IQuery&lt;TResult&gt;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>You receive a delegate for the next pipe and the entity, so the concept is very simple: either do some work before or after invoking the next pipe, or break the chain by returning or throwing an exception.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">IsItMondayAlreadyPipeline</span> : <span class=\"title\">Pipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnQueryAsync</span>&lt;<span class=\"title\">TQuery</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        TQuery query, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        CancellationToken ct</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(DateTime.Now.DayOfWeek == DayOfWeek.Monday)</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">&quot;Today is monday, no data for you!&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> next(query, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><em>Pipelines are executed by the same order they are added to the container so, to be deterministic, don’t scan the assemblies for classes implementing <code>IPipeline</code>.</em></p>\n<h2 id=\"Commands-pipeline\"><a href=\"#Commands-pipeline\" class=\"headerlink\" title=\"Commands pipeline\"></a>Commands pipeline</h2><p>Intercept commands sent into the mediator by implementing the methods <code>OnCommandAsync</code>:</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/01_pipeline_command.png\" class=\"\">\n\n<h2 id=\"Queries-pipeline\"><a href=\"#Queries-pipeline\" class=\"headerlink\" title=\"Queries pipeline\"></a>Queries pipeline</h2><p>Intercept queries being fetched from the mediator by implementing the methods <code>OnQueryAsync</code>:</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/02_pipeline_query.png\" class=\"\">\n\n<h2 id=\"Events-pipeline\"><a href=\"#Events-pipeline\" class=\"headerlink\" title=\"Events pipeline\"></a>Events pipeline</h2><p>Intercept events before being broadcasted by the mediator into all the handlers by implementing the method <code>OnEventAsync</code>:</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/03_pipeline_event.png\" class=\"\">\n\n<hr>\n<h1 id=\"The-project\"><a href=\"#The-project\" class=\"headerlink\" title=\"The project\"></a>The project</h1><p>To make it easier, we are going to leverage on the <a href=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/\" title=\"Mediator Pattern in ASP.NET Core Applications\">previous article</a> and continue from there. As a reminder, we implemented an endpoint to manage products with the following:</p>\n<ul>\n<li>GET &#x2F;products — search for products using some filters (<code>SearchProductsQuery</code>);</li>\n<li>GET &#x2F;products&#x2F;{id} — get a product by its unique identifier (<code>GetProductByIdQuery</code>);</li>\n<li>POST &#x2F;products — create a product (<code>CreateProductCommand</code> and <code>CreatedProductEvent</code>);</li>\n<li>PUT &#x2F;products&#x2F;{id} — update a product by its unique identifier (<code>UpdateProductCommand</code> and <code>UpdatedProductEvent</code>);</li>\n<li>DELETE &#x2F;products&#x2F;{id} — delete a product by its unique identifier (<code>DeleteProductCommand</code> and <code>DeletedProductEvent</code>);</li>\n</ul>\n<p>The complete source code can be found on <a href=\"https://github.com/gravity00/IntroductionMediatorCQRS\">GitHub</a>.</p>\n<h1 id=\"The-pipelines\"><a href=\"#The-pipelines\" class=\"headerlink\" title=\"The pipelines\"></a>The pipelines</h1><p>Since the objective of this article is to show how to implement pipelines in the mediator, the following should be enough:</p>\n<ul>\n<li><strong>LoggingPipeline</strong> — serializes every command, queries, events and results as JSON into the log if <code>Trace</code> is enabled;</li>\n<li><strong>TimeoutPipeline</strong> — cancels the handler execution if it takes more than a given set of time;</li>\n</ul>\n<p>Start by creating a <code>Pipelines</code> folder at the project root level.</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/04_project_structure_pipelines.png\" class=\"\">\n\n<h2 id=\"LoggingPipeline\"><a href=\"#LoggingPipeline\" class=\"headerlink\" title=\"LoggingPipeline\"></a>LoggingPipeline</h2><p>Because we don’t want logging to affect the timeout, this will be the first pipeline to be added to the chain.</p>\n<p>Inside the <code>Pipelines</code> folder, create a <code>LoggingPipeline</code> class implementing <code>IPipeline</code>. This pipeline will receive an <code>ILogger</code> instance and use <code>System.Text.Json</code> to serialize the objects:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">LoggingPipeline</span> : <span class=\"title\">IPipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ILogger&lt;LoggingPipeline&gt; _logger;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> JsonSerializerOptions _serializerOptions = <span class=\"keyword\">new</span> JsonSerializerOptions</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        WriteIndented = <span class=\"literal\">true</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LoggingPipeline</span>(<span class=\"params\">ILogger&lt;LoggingPipeline&gt; logger</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _logger = logger;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TCommand : <span class=\"keyword\">class</span>, ICommand</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Log(<span class=\"string\">&quot;Command: &#123;command&#125;&quot;</span>, cmd);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TCommand : <span class=\"keyword\">class</span>, ICommand&lt;TResult&gt;</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Log(<span class=\"string\">&quot;Command: &#123;command&#125;&quot;</span>, cmd);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> next(cmd, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        Log(<span class=\"string\">&quot;Command.Result: &#123;commandResult&#125;&quot;</span>, result);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnEventAsync</span>&lt;<span class=\"title\">TEvent</span>&gt;(<span class=\"params\">Func&lt;TEvent, CancellationToken, Task&gt; next, TEvent evt, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TEvent : <span class=\"keyword\">class</span>, IEvent</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Log(<span class=\"string\">&quot;Event: &#123;event&#125;&quot;</span>, evt);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(evt, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnQueryAsync</span>&lt;<span class=\"title\">TQuery</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, TQuery query, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TQuery : <span class=\"keyword\">class</span>, IQuery&lt;TResult&gt;</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Log(<span class=\"string\">&quot;Query: &#123;query&#125;&quot;</span>, query);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> next(query, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        Log(<span class=\"string\">&quot;Query.Result: &#123;queryResult&#125;&quot;</span>, result);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">Log</span>&lt;<span class=\"title\">T</span>&gt;(<span class=\"params\"><span class=\"built_in\">string</span> message, T instance</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (_logger.IsEnabled(LogLevel.Trace))</span><br><span class=\"line\">            _logger.LogTrace(message, JsonSerializer.Serialize(instance, _serializerOptions));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Startup.cs</code> file and register the pipeline into the mediator:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">services.AddMediator(o =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">    </span><br><span class=\"line\">    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>appsettings.development.json</code> file and set the default log level to <code>Trace</code>:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;Logging&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;LogLevel&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Default&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Trace&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Microsoft&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Warning&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Microsoft.Hosting.Lifetime&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Information&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>If you now start the server and do some actions in the API, like creating or searching for products, you should start seeing your objects being serialized:</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/05_pipeline_logging_logs.png\" class=\"\">\n\n<p><em>As a note, if you find this helpful for your APIs, you can use the NuGet <a href=\"https://www.nuget.org/packages/simplesoft.mediator.microsoft.extensions.loggingpipeline\">SimpleSoft.Mediator.Microsoft.Extensions.LoggingPipeline</a>. Just give a look at the <code>Startup.cs</code> file in <a href=\"https://github.com/simplesoft-pt/Mediator/blob/master/work/SimpleSoft.Mediator.Example.Api/Startup.cs\">the example API</a>.</em></p>\n<h2 id=\"TimeoutPipeline\"><a href=\"#TimeoutPipeline\" class=\"headerlink\" title=\"TimeoutPipeline\"></a>TimeoutPipeline</h2><p>Inside the <code>Pipelines</code> folder, create a <code>TimeoutPipeline</code> class implementing <code>IPipeline</code>. For simplicity, the timeout value will be fixed, but could be received as an options from the container.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">TimeoutPipeline</span> : <span class=\"title\">IPipeline</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">readonly</span> TimeSpan Timeout = TimeSpan.FromMilliseconds(<span class=\"number\">500</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&gt; next, TCommand cmd, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TCommand : <span class=\"keyword\">class</span>, ICommand</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> cts = CreateCancellationTokenSource(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(cmd, cts.Token);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnCommandAsync</span>&lt;<span class=\"title\">TCommand</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TCommand, CancellationToken, Task&lt;TResult&gt;&gt; next, TCommand cmd, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TCommand : <span class=\"keyword\">class</span>, ICommand&lt;TResult&gt;</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> cts = CreateCancellationTokenSource(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> next(cmd, cts.Token);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnEventAsync</span>&lt;<span class=\"title\">TEvent</span>&gt;(<span class=\"params\">Func&lt;TEvent, CancellationToken, Task&gt; next, TEvent evt, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TEvent : <span class=\"keyword\">class</span>, IEvent</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> cts = CreateCancellationTokenSource(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> next(evt, cts.Token);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> <span class=\"title\">Task</span>&lt;<span class=\"title\">TResult</span>&gt; <span class=\"title\">OnQueryAsync</span>&lt;<span class=\"title\">TQuery</span>, <span class=\"title\">TResult</span>&gt;(<span class=\"params\">Func&lt;TQuery, CancellationToken, Task&lt;TResult&gt;&gt; next, TQuery query, CancellationToken ct</span>) </span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">where</span> TQuery : <span class=\"keyword\">class</span>, IQuery&lt;TResult&gt;</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">using</span> <span class=\"keyword\">var</span> cts = CreateCancellationTokenSource(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> next(query, cts.Token);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> CancellationTokenSource <span class=\"title\">CreateCancellationTokenSource</span>(<span class=\"params\">CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> cts = CancellationTokenSource.CreateLinkedTokenSource(ct);</span><br><span class=\"line\">        cts.CancelAfter(Timeout);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> cts;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Once again, open the <code>Startup.cs</code> file and register the pipeline into the mediator <strong>after</strong> the logging pipe:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">services.AddMediator(o =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">    o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">    </span><br><span class=\"line\">    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>If you now open any of your handlers and add an <code>Task.Delay(1000, ct)</code> into the <code>HandleAsync</code> methods you should receive a <code>TaskCanceledException</code>. I added one when searching for products:</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/06_pipeline_timeout_stacktrace_response.png\" class=\"\">\n\n<p>If you look at the stack trace, you’ll see the invocation order was kept:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ProductsController</span><br><span class=\"line\">    MicrosoftFetcher (internal class used by the mediator)</span><br><span class=\"line\">        LoggingPipeline</span><br><span class=\"line\">            TimeoutPipeline</span><br><span class=\"line\">                SearchProductsQueryHandler</span><br></pre></td></tr></table></figure>\n\n<p>The project structure with pipeline classes:</p>\n<img src=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/07_project_structure_pipelines_impl.png\" class=\"\">\n\n<p>The final <code>Startup.cs</code> file:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddMediator(o =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            o.AddPipeline&lt;LoggingPipeline&gt;();</span><br><span class=\"line\">            o.AddPipeline&lt;TimeoutPipeline&gt;();</span><br><span class=\"line\">            o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        app.UseDeveloperExceptionPage();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwagger();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwaggerUI(c =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            c.SwaggerEndpoint(<span class=\"string\">&quot;/swagger/v1/swagger.json&quot;</span>, <span class=\"string\">&quot;Mediator ExampleApi V1&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseRouting();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseEndpoints(endpoints =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            endpoints.MapControllers();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>I hope this article gave you a good idea about mediator pipelines and how you can use them to empower your solutions, making them more resilient to developer mistakes (like forgetting to save changes into the database).</p>\n<p>For me, this is one of the strongest aspects of the mediator pattern and one of the main reason I always use this pattern even when implementing <strong>minimum viable products</strong>.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp",
                "patterns"
            ]
        },
        {
            "id": "https://code-corner.dev/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/",
            "url": "https://code-corner.dev/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/",
            "title": "Mediator Pattern in ASP.NET Core Applications",
            "date_published": "2020-10-28T00:00:00.000Z",
            "content_html": "<p>For the last few years, <strong>Command Query Responsibility Segregation (CQRS)</strong> and <strong>Event Sourcing (ES)</strong> emerged as patterns that can help implement large scale systems, with some risky complexity, by having different models to read or mutate data while also using events as a single source of truth.</p>\n<p>Since there are already great articles explaining <a href=\"https://martinfowler.com/bliki/CQRS.html\"><strong>CQRS</strong></a> or <a href=\"https://martinfowler.com/eaaDev/EventSourcing.html\"><strong>ES</strong></a> in great depth, I’m going to focus and show how you can decouple your application layers by only knowing POCOs and a mediator instance from <a href=\"https://www.nuget.org/packages/simplesoft.mediator\">SimpleSoft.Mediator</a>.</p>\n<p>Remember that, even if you are not using <strong>CQRS</strong> or <strong>ES</strong> to its full extend, just by ensuring a logical model segregation inside the project can make your life easier in the long run, even when implementing a simple <strong>Backend for Frontend (BFF)</strong> or a <strong>minimum viable product (MVP)</strong>.</p>\n<h1 id=\"Commands-Queries-Events-Handlers-and-Mediator\"><a href=\"#Commands-Queries-Events-Handlers-and-Mediator\" class=\"headerlink\" title=\"Commands, Queries, Events, Handlers and Mediator\"></a>Commands, Queries, Events, Handlers and Mediator</h1><p>Before showing some code, lets make a simple review of some core concepts about these patterns and the library we are going to use:</p>\n<ul>\n<li><strong>Commands</strong> - each action intended to change the system state, by creating, updating or deleting information, should be represented by a class implementing either <code>ICommand</code> or <code>ICommand&lt;TResult&gt;</code>, if you are using the mediator just for in-process decoupling and want to return a result synchronously. Examples: <code>CreateProductCommand</code> or <code>DeleteUserCommand</code>;</li>\n<li><strong>Queries</strong> - classes implementing <code>IQuery&lt;TResult&gt;</code> represent data reads that shouldn’t change the system state or else they must be considered commands. Examples: <code>GetProductByIdQuery</code> or <code>SearchUsersQuery</code>;</li>\n<li><strong>Events</strong> — representing system changes over time, these classes implement <code>IEvent</code>. Examples: <code>ProductCreatedEvent</code> or <code>UpdatedUserEmailEvent</code>;</li>\n<li><strong>Handlers</strong> — responsible for receiving the commands (<code>ICommandHandler</code>), queries (<code>IQueryHandler</code>) or events (<code>IEventHandler</code>), they implement the business behavior to be run. Examples: <code>CreateProductCommandHandler</code> or <code>GetProductByIdQueryHandler</code>;</li>\n<li><strong>Mediator</strong> — decouples the caller from the executor exposing generic methods to send commands, fetch queries or broadcast events, being responsible for finding the correct handler (or handlers, in case of an event) and is represented by the interface <code>IMediator</code>;</li>\n</ul>\n<p>I also made articles <a href=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Using Mediator Pipelines in ASP.NET Core Applications\">explaining how pipelines work</a>, how to enforce <a href=\"/2020/11/04/Validation-with-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Validation with Mediator Pipelines in ASP.NET Core Applications\">validations</a>, how to <a href=\"/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/\" title=\"Transaction Management With Mediator Pipelines in ASP.NET Core\">manage transactions</a> and how to <a href=\"/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/\" title=\"Auditing with Mediator Pipelines in ASP.NET Core\">audit user actions</a>.</p>\n<hr>\n<h1 id=\"The-project\"><a href=\"#The-project\" class=\"headerlink\" title=\"The project\"></a>The project</h1><p>The source code for this article can be found on <a href=\"https://github.com/gravity00/IntroductionMediatorCQRS\">GitHub</a>.</p>\n<p>Start by opening Visual Studio and creating an <strong>ASP.NET Core 3.1 Web Application</strong> with a name and at any location.</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/configure-project.png\" class=\"\">\n\n<p>Choose an empty project since this is just a demo.</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/configure-project-empty.png\" class=\"\">\n\n<p>Install the Nuget <code>Swashbuckle.AspNetCore</code> so we can use Swagger to test the API:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/configure-project-nuget-swagger.png\" class=\"\">\n\n<p>Open the file <code>Startup.cs</code> and configure both MVC and Swagger, making it easier to test our web API.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        services.AddMvc();</span><br><span class=\"line\"></span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        app.UseDeveloperExceptionPage();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwagger();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseSwaggerUI(c =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            c.SwaggerEndpoint(<span class=\"string\">&quot;/swagger/v1/swagger.json&quot;</span>, <span class=\"string\">&quot;Mediator ExampleApi V1&quot;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseRouting();</span><br><span class=\"line\"></span><br><span class=\"line\">        app.UseEndpoints(endpoints =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            endpoints.MapControllers();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"The-web-API\"><a href=\"#The-web-API\" class=\"headerlink\" title=\"The web API\"></a>The web API</h1><p>Since the objective of this article is to show the mediator pattern, a simple endpoint to manage products should be enough:</p>\n<ul>\n<li>GET &#x2F;products — search for products using some filters;</li>\n<li>GET &#x2F;products&#x2F;{id} — get a product by its unique identifier;</li>\n<li>POST &#x2F;products — create a product;</li>\n<li>PUT &#x2F;products&#x2F;{id} — update a product by its unique identifier;</li>\n<li>DELETE &#x2F;products&#x2F;{id} — delete a product by its unique identifier;</li>\n</ul>\n<p>Create a <code>Controllers</code> folder with another <code>Products</code> folder inside, a <code>ProductsController</code> and the following models:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;products&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    [<span class=\"meta\">HttpGet</span>]</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;IEnumerable&lt;ProductModel&gt;&gt; SearchAsync([FromQuery] <span class=\"built_in\">string</span> filterQ, [FromQuery] <span class=\"built_in\">int</span>? skip, [FromQuery] <span class=\"built_in\">int</span>? take, CancellationToken ct)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NotImplementedException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;ProductModel&gt; <span class=\"title\">GetByIdAsync</span>(<span class=\"params\">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NotImplementedException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpPost</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResultModel&gt; <span class=\"title\">CreateAsync</span>(<span class=\"params\">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NotImplementedException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpPut(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">UpdateAsync</span>(<span class=\"params\">[FromRoute] Guid id, [FromBody] UpdateProductModel model, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NotImplementedException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpDelete(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">DeleteAsync</span>(<span class=\"params\">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NotImplementedException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductResultModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">UpdateProductModel</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The project should look as follows:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/web-api-project-structure.png\" class=\"\">\n\n<p>Open the Swagger endpoint (ex: <a href=\"https://localhost:44380/swagger/index.html\">https://localhost:44380/swagger/index.html</a>) and you should see your products endpoint with all the actions:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/web-api-swagger.png\" class=\"\">\n\n<h2 id=\"The-database-model\"><a href=\"#The-database-model\" class=\"headerlink\" title=\"The database model\"></a>The database model</h2><p>For demo purposes we are going to use <strong>Entity Framework Core</strong> with data stored in-memory.</p>\n<p>Install the Nuget <code>Microsoft.EntityFrameworkCore.InMemory</code>:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/database-model-nuget-ef-core-inmemory.png\" class=\"\">\n\n<p>Create a <code>Database</code> folder, the following database context and entities for products and events, to store both the business data and mutations history:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ApiDbContext</span> : <span class=\"title\">DbContext</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ApiDbContext</span>(<span class=\"params\">DbContextOptions&lt;ApiDbContext&gt; options</span>) : <span class=\"title\">base</span>(<span class=\"params\">options</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">OnModelCreating</span>(<span class=\"params\">ModelBuilder builder</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">base</span>.OnModelCreating(builder);</span><br><span class=\"line\"></span><br><span class=\"line\">        builder.Entity&lt;ProductEntity&gt;(cfg =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            cfg.HasKey(e =&gt; e.Id);</span><br><span class=\"line\">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class=\"line\">            cfg.HasIndex(e =&gt; e.Code).IsUnique();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.ExternalId)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Code)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">8</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Name)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Price)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        builder.Entity&lt;EventEntity&gt;(cfg =&gt;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            cfg.HasKey(e =&gt; e.Id);</span><br><span class=\"line\">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class=\"line\">            cfg.HasIndex(e =&gt; e.CreatedOn);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Name)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">            cfg.Property(e =&gt; e.Payload)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedOn)</span><br><span class=\"line\">                .IsRequired();</span><br><span class=\"line\">            cfg.Property(e =&gt; e.CreatedBy)</span><br><span class=\"line\">                .IsRequired()</span><br><span class=\"line\">                .HasMaxLength(<span class=\"number\">128</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">EventEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Payload &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> DateTimeOffset CreatedOn &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> CreatedBy &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductEntity</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">long</span> Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>Startup.cs</code> file and add the context into the container as an in-memory database:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    o.UseInMemoryDatabase(<span class=\"string\">&quot;ApiDbContext&quot;</span>);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>The project should look as follows:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/database-model-project-structure.png\" class=\"\">\n\n<h1 id=\"The-mediator\"><a href=\"#The-mediator\" class=\"headerlink\" title=\"The mediator\"></a>The mediator</h1><p>Now that we have created the demo endpoint, models and database, its time to configure the mediator.</p>\n<p>Install the Nuget <code>SimpleSoft.Mediator.Microsoft.Extensions</code> which is a specialized package for projects using <code>Microsoft.Extensions.*</code>:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/mediator-nuget.png\" class=\"\">\n\n<p>Open the <code>Startup.cs</code> file and add the mediator into the container, scanning the current assembly for all classes implementing <code>ICommandHandler</code>, <code>IQueryHandler</code> and <code>IEventHandler</code>:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">services.AddMediator(o =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    o.AddHandlersFromAssemblyOf&lt;Startup&gt;();</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>ProductsController.cs</code> file and inject into the constructor the <code>IMediator</code> instance:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProductsController</span>(<span class=\"params\">IMediator mediator</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    _mediator = mediator;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"The-handlers\"><a href=\"#The-handlers\" class=\"headerlink\" title=\"The handlers\"></a>The handlers</h1><p>We now have everything we need to start implementing the business logic.</p>\n<p>To keep it simple, we are not going to use the mediator pipelines, only focusing on commands, queries, events and their handlers. As stated before, I made <a href=\"/2020/11/02/Using-Mediator-Pipelines-in-ASP-NET-Core-Applications/\" title=\"Using Mediator Pipelines in ASP.NET Core Applications\">some articles more specific for those use cases</a>.</p>\n<p>Start by creating a folder named <code>Handlers</code> with another inside <code>Products</code> in which we are going to put our POCOs and their handlers.</p>\n<p><em>As a note, remember this is a demo article and this project structure <strong>should not be seen as a valid way to organize your solution</strong> in your private projects. Commands, queries, events and their handlers should be, at minimum, in different folders.</em></p>\n<h2 id=\"CreateProductComand\"><a href=\"#CreateProductComand\" class=\"headerlink\" title=\"CreateProductComand\"></a>CreateProductComand</h2><p>We need data so lets create a command that allows that and will be sent when a request for POST &#x2F;products is received.</p>\n<p>Create a class <code>CreateProductResult</code> that will be returned by the handler with the product unique identifier and a <code>CreateProductCommand</code>, implementing the class <code>Command&lt;CreateProductResult&gt;</code>:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductCommand</span> : <span class=\"title\">Command</span>&lt;<span class=\"title\">CreateProductResult</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductResult</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>ProductsController.cs</code> file and inside the method <code>CreateAsync</code> send the command into the mediator and map its result:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;products&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProductsController</span>(<span class=\"params\">IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpPost</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResultModel&gt; <span class=\"title\">CreateAsync</span>(<span class=\"params\">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.SendAsync(<span class=\"keyword\">new</span> CreateProductCommand</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Code = model.Code,</span><br><span class=\"line\">            Name = model.Name,</span><br><span class=\"line\">            Price = model.Price</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CreateProductResultModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = result.Id</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If we now invoked the endpoint, we would receive an exception saying that no <code>ICommandHandler&lt;CreateProductCommand, CreateProductResult&gt;</code> was found by the container.</p>\n<p>We will fix that by creating the class <code>CreateProductCommandHandler</code> with the business logic for this action. For this demo, an <code>InvalidOperationException</code> with a custom message will be thrown when a duplicated code is received:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductCommandHandler</span> : <span class=\"title\">ICommandHandler</span>&lt;<span class=\"title\">CreateProductCommand</span>, <span class=\"title\">CreateProductResult</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreateProductCommandHandler</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResult&gt; <span class=\"title\">HandleAsync</span>(<span class=\"params\">CreateProductCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">await</span> products.AnyAsync(p =&gt; p.Code == cmd.Code, ct))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">$&quot;Product code &#x27;<span class=\"subst\">&#123;cmd.Code&#125;</span>&#x27; already exists&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> externalId = Guid.NewGuid();</span><br><span class=\"line\">        <span class=\"keyword\">await</span> products.AddAsync(<span class=\"keyword\">new</span> ProductEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId,</span><br><span class=\"line\">            Code = cmd.Code,</span><br><span class=\"line\">            Name = cmd.Name,</span><br><span class=\"line\">            Price = cmd.Price</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CreateProductResult</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = externalId</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If you now try to create a product using the Swagger endpoint, you will receive the response with the unique identifier or an internal server error indicating a duplicated code.</p>\n<p>The project should look as follows:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/handlers-project-structure-01.png\" class=\"\">\n\n<h2 id=\"GetProductByIdQuery\"><a href=\"#GetProductByIdQuery\" class=\"headerlink\" title=\"GetProductByIdQuery\"></a>GetProductByIdQuery</h2><p>Time to return a product when a GET &#x2F;products&#x2F;:id is received by the web API.</p>\n<p>Inside the <code>Handlers/Products</code> folder, create a <code>Product</code>, the <code>GetProductByIdQuery</code> and its corresponding handler, <code>GetProductByIdQueryHandler</code>. Like in the previous handler, for this demo, we are going to throw an <code>InvalidOperationException</code> if the id is unknown:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">GetProductByIdQuery</span> : <span class=\"title\">Query</span>&lt;<span class=\"title\">Product</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ProductId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Product</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid Id &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">GetProductByIdQueryHandler</span> : <span class=\"title\">IQueryHandler</span>&lt;<span class=\"title\">GetProductByIdQuery</span>, <span class=\"title\">Product</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IQueryable&lt;ProductEntity&gt; _products;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">GetProductByIdQueryHandler</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _products = context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;Product&gt; <span class=\"title\">HandleAsync</span>(<span class=\"params\">GetProductByIdQuery query, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> product = <span class=\"keyword\">await</span> _products.SingleOrDefaultAsync(p =&gt; p.ExternalId == query.ProductId, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (product == <span class=\"literal\">null</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">$&quot;Product &#x27;<span class=\"subst\">&#123;query.ProductId&#125;</span>&#x27; not found&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Product</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = product.ExternalId,</span><br><span class=\"line\">            Code = product.Code,</span><br><span class=\"line\">            Name = product.Name,</span><br><span class=\"line\">            Price = product.Price</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>ProductsController.cs</code> file and inside the method <code>GetByIdAsync</code> fetch the query from the mediator and map its result:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;products&quot;</span>)</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">ProductsController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProductsController</span>(<span class=\"params\">IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"meta\">HttpGet(<span class=\"string\">&quot;&#123;id:guid&#125;&quot;</span>)</span>]</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;ProductModel&gt; <span class=\"title\">GetByIdAsync</span>(<span class=\"params\">[FromRoute] Guid id, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> _mediator.FetchAsync(<span class=\"keyword\">new</span> GetProductByIdQuery</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ProductId = id</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ProductModel</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = result.Id,</span><br><span class=\"line\">            Code = result.Code,</span><br><span class=\"line\">            Name = result.Name,</span><br><span class=\"line\">            Price = result.Price</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>If you now try to get a product using the Swagger endpoint, you will receive the product or an internal server error indicating an unknown identifier.</p>\n<h2 id=\"CreatedProductEvent\"><a href=\"#CreatedProductEvent\" class=\"headerlink\" title=\"CreatedProductEvent\"></a>CreatedProductEvent</h2><p>Finally, we are going to create an event that will be broadcast when a product is successfully created.</p>\n<p>Just like the previous ones, create a <code>CreateProductEvent</code> and the handler <code>CreateProductEventHandler</code> that will serialize and store it into the events table.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreatedProductEvent</span> : <span class=\"title\">Event</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Guid ExternalId &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Code &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">decimal</span> Price &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreatedProductEventHandler</span> : <span class=\"title\">IEventHandler</span>&lt;<span class=\"title\">CreatedProductEvent</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreatedProductEventHandler</span>(<span class=\"params\">ApiDbContext context</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">HandleAsync</span>(<span class=\"params\">CreatedProductEvent evt, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.Set&lt;EventEntity&gt;().AddAsync(<span class=\"keyword\">new</span> EventEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = evt.Id,</span><br><span class=\"line\">            Name = <span class=\"keyword\">nameof</span>(CreatedProductEvent),</span><br><span class=\"line\">            Payload = JsonSerializer.Serialize(evt),</span><br><span class=\"line\">            CreatedOn = evt.CreatedOn,</span><br><span class=\"line\">            CreatedBy = evt.CreatedBy</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Open the <code>CreateProductCommandHandler</code> file, inject the <code>IMediator</code> instance and broadcast the event before saving flushing all changes into the database:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CreateProductCommandHandler</span> : <span class=\"title\">ICommandHandler</span>&lt;<span class=\"title\">CreateProductCommand</span>, <span class=\"title\">CreateProductResult</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ApiDbContext _context;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IMediator _mediator;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CreateProductCommandHandler</span>(<span class=\"params\">ApiDbContext context, IMediator mediator</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        _context = context;</span><br><span class=\"line\">        _mediator = mediator;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;CreateProductResult&gt; <span class=\"title\">HandleAsync</span>(<span class=\"params\">CreateProductCommand cmd, CancellationToken ct</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> products = _context.Set&lt;ProductEntity&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">await</span> products.AnyAsync(p =&gt; p.Code == cmd.Code, ct))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidOperationException(<span class=\"string\">$&quot;Product code &#x27;<span class=\"subst\">&#123;cmd.Code&#125;</span>&#x27; already exists&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> externalId = Guid.NewGuid();</span><br><span class=\"line\">        <span class=\"keyword\">await</span> products.AddAsync(<span class=\"keyword\">new</span> ProductEntity</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId,</span><br><span class=\"line\">            Code = cmd.Code,</span><br><span class=\"line\">            Name = cmd.Name,</span><br><span class=\"line\">            Price = cmd.Price</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _mediator.BroadcastAsync(<span class=\"keyword\">new</span> CreatedProductEvent</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ExternalId = externalId,</span><br><span class=\"line\">            Code = cmd.Code,</span><br><span class=\"line\">            Name = cmd.Name,</span><br><span class=\"line\">            Price = cmd.Price</span><br><span class=\"line\">        &#125;, ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> _context.SaveChangesAsync(ct);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CreateProductResult</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Id = externalId</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The project should look as follows:</p>\n<img src=\"/2020/10/28/Mediator-Pattern-in-ASP-NET-Core-Applications/handlers-project-structure-02.png\" class=\"\">\n\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use the mediator to implement the <strong>CQRS</strong> and <strong>ES</strong> patterns even if you are implementing an <strong>MVP</strong> and can’t spend much time thinking about the architecture but you still want something that can be maintained and extended for some time.</p>\n<p>Soon I’ll be explaining more advanced scenarios, like using the mediator pipeline to validate commands before reaching the handler, managing database transactions or even implementing transversal auditing into you application.</p>\n",
            "tags": [
                "dotnetcore",
                "aspnetcore",
                "csharp",
                "patterns"
            ]
        }
    ]
}