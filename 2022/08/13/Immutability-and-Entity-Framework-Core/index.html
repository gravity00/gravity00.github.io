<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-TQKP5TGHJ8"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TQKP5TGHJ8")</script><title>Immutability and Entity Framework Core | code-corner.dev</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="google-adsense-account" content="ca-pub-4671230649342120"><meta name="description" content="Nowadays, when implementing a .NET application that works directly with a database (relational or not), most developers will chose Entity Framework Core to abstract their data layer and work directly"><meta property="og:type" content="article"><meta property="og:title" content="Immutability and Entity Framework Core"><meta property="og:url" content="https://code-corner.dev/2022/08/13/Immutability-and-Entity-Framework-Core/index.html"><meta property="og:site_name" content="code-corner.dev"><meta property="og:description" content="Nowadays, when implementing a .NET application that works directly with a database (relational or not), most developers will chose Entity Framework Core to abstract their data layer and work directly"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://code-corner.dev/2022/08/13/Immutability-and-Entity-Framework-Core/00_header.png"><meta property="article:published_time" content="2022-08-12T23:00:00.000Z"><meta property="article:modified_time" content="2024-04-16T17:31:21.707Z"><meta property="article:author" content="João Simões"><meta property="article:tag" content="dotnetcore"><meta property="article:tag" content="csharp"><meta property="article:tag" content="patterns"><meta property="article:tag" content="efcore"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://code-corner.dev/2022/08/13/Immutability-and-Entity-Framework-Core/00_header.png"><meta name="twitter:creator" content="@JoaoPRSimoes"><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css"><link rel="canonical" href="https://code-corner.dev/2022/08/13/Immutability-and-Entity-Framework-Core/"><meta name="generator" content="Hexo 7.1.1"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml,sitemap.txt"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">code-corner.dev</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">The place to learn about programming</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/gravity00"><span class="fa fa-github"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://twitter.com/JoaoPRSimoes"><span class="fa fa-twitter"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://joaoprsimoes.medium.com/"><span class="fa fa-medium"></span></a> <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a> <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://code-corner.dev"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-Immutability-and-Entity-Framework-Core" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-meta"><a href="/2022/08/13/Immutability-and-Entity-Framework-Core/" class="article-date"><time class="dt-published" datetime="2022-08-12T23:00:00.000Z" itemprop="datePublished">2022-08-13</time></a><div class="article-category"><a class="article-category-link" href="/categories/tutorial/">tutorial</a></div></div><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">Immutability and Entity Framework Core</h1><h2 class="p-name article-subtitle">Using C# records and Entity Framework Core to implement immutable data access layers</h2></header><div class="e-content article-entry" itemprop="articleBody"><a href="https://code-corner.dev/2022/08/13/Immutability-and-Entity-Framework-Core/00_header.png" data-fancybox="gallery" data-caption><img src="https://code-corner.dev/2022/08/13/Immutability-and-Entity-Framework-Core/00_header.png"></a><p>Nowadays, when implementing a .NET application that works directly with a database (relational or not), most developers will chose Entity Framework Core to abstract their data layer and work directly with entity classes.</p><p>It has become an integral part of the .NET ecosystem, just like ASP.NET, and it is extremely rare finding someone that never worked with it. I’ve been using it myself ever since version 4 (along with other ORMs) and I must say that it <em><strong>aged like a fine wine</strong></em>.</p><p>Fully open sourced, with support for multiple databases (not just SQL Server) while offering relatively optimized and extensible conversion from LINQ to database queries, accessing data from a .NET application never been easier. And when it doesn’t support something, <a href="/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/" title="Integrating Dapper with Entity Framework Core">just integrate with some micro ORM and go crazy on that SQL</a>!</p><p>One core feature is the implementation of the unit of work pattern by supporting, what is usually called, a first level cache. Load a bunch of entities from the database, that will be tracked in memory by the context, mutate or delete them, create new ones and then flush everything in a single database access.</p><p>The thing about this feature, despite working fine most of the time, is that it depends on managing internal state with mutable entities. After all, it was originally focused on C# developers that were used to work in a object-oriented way — get an entity, change some properties, request an update.</p><p><strong>But what if you are a C# developer and prefer the advantages provided by immutability?</strong></p><p>Lets look at the most used immutable class in the .NET world — the string.</p><p>We all know that working with text can be memory inefficient if badly managed, but imagine a world were you could initialize a string with the name “Bruce Wayne”, pass it as an argument to some method that was supposed to count how many words were in it, and when you realize, your original string contains the name “Peter Parker” because the strings were mutable and nothing could prevent that?</p><p>In this article I won’t enter into details about the advantages of immutable over mutable objects, and vice versa. There are great articles already explaining both visions and we all know no size fits all, so it kinda depends of your current needs.</p><p>But I’m going to explain how you can use immutable entities directly with Entity Framework Core so you know that not only it is possible but also a viable option.</p><hr><h1 id="Immutable-entities-in-C"><a href="#Immutable-entities-in-C" class="headerlink" title="Immutable entities in C#"></a>Immutable entities in C#</h1><p>Before C# 9 the only way to create an immutable entity was to define a class or structure with <em>getter only properties</em> that were initialized during object construction, ensuring nothing could be changed afterwards.</p><p>As an example, a <code>PersonEntity</code> would look like this:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PersonEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PersonEntity</span>(<span class="params"><span class="built_in">string</span> forename, <span class="built_in">string</span> surname, <span class="built_in">string</span>? middleNames = <span class="literal">null</span>, DateOnly? birthdate = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Forename = forename;</span><br><span class="line">        Surname = surname;</span><br><span class="line">        MiddleNames = middleNames;</span><br><span class="line">        Birthdate = birthdate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Forename &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Surname &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>? MiddleNames &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DateOnly? Birthdate &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>It works as expected but there is one major problem: just by looking at the code, the developer cannot tell which properties are being set unless argument names are used and, if it wants to change something, it must copy every property by hand.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> PersonEntity(</span><br><span class="line">    <span class="string">&quot;Bruce&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Wayne&quot;</span></span><br><span class="line">);</span><br><span class="line">person = <span class="keyword">new</span> PersonEntity(</span><br><span class="line">    person.Forename,</span><br><span class="line">    person.Surname,</span><br><span class="line">    <span class="string">&quot;Thomas&quot;</span>,</span><br><span class="line">    <span class="keyword">new</span> DateOnly(<span class="number">1972</span>, <span class="number">02</span>, <span class="number">19</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>For small POCOs this may not be a problem, but for bigger ones the chances of someone making a mistake increases.</p><p>With this in mind, Microsoft implemented <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/init">init only setters</a> supporting object initializers while still preventing changes afterwards. Couple this with <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/csharp/whats-new/tutorials/records">record types</a>, and creating immutable entities has never been easier in C#.</p><p>The same PersonEntity, but now using both of these features:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title">PersonEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Forename &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Surname &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>? MiddleNames &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DateOnly? Birthdate &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Not only the syntax is more concise by using auto-implemented properties, you can now easily tell which properties are being set during initialization and have a much easier life copying data by using the keyword with and only state which properties must change.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> PersonEntity</span><br><span class="line">&#123;</span><br><span class="line">    Forename = <span class="string">&quot;Bruce&quot;</span>,</span><br><span class="line">    Surname = <span class="string">&quot;Wayne&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line">person = person <span class="keyword">with</span></span><br><span class="line">&#123;</span><br><span class="line">    MiddleNames = <span class="string">&quot;Thomas&quot;</span>,</span><br><span class="line">    Birthdate = <span class="keyword">new</span> DateOnly(<span class="number">1972</span>, <span class="number">02</span>, <span class="number">19</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="Change-Tracking-and-immutability"><a href="#Change-Tracking-and-immutability" class="headerlink" title="Change Tracking and immutability"></a>Change Tracking and immutability</h1><p>Every developer that uses Entity Framework knows it provides a lot of database abstractions to enable working directly with .NET objects.</p><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/ef/core/change-tracking">One core feature is the automatic detection of changes made to entities</a>. This usually means interacting with the context to get an existing entity, change some properties and then invoke <code>SaveChangesAsync</code> which will generate a bunch of instructions and execute them into the database. Under the hood, when the entity is retrieved from the context it will keep a reference to the instance and original values from the database and when the developer requests the context to save changes, all properties of tracked entities will be compared and if anything changed, instructions will be generated and executed.</p><p>This works well for mutable entities but we are implementing immutability, and since no changes will be made to tracked entities, will this cause any issues?</p><p>Let’s imagine the following use case:</p><ul><li>You retrieve our <em>Bruce Wayne</em> from the database using an EF Core context, which internally will keep a reference to it;</li><li>You want to change it’s birthdate, so you clone it while assigning a new date;</li><li>If you invoke <code>SaveChangesAsync</code>, nothing will happen because no changes happened to the original entity;</li><li>If you invoke <code>Update</code>, an <code>InvalidOperationException</code> will be thrown because the context is already tracking an entity with the same primary key;</li></ul><p>Certainly invoking <code>SaveChangesAsync</code> and nothing happening was expected, after all we created a copy of the original instance, which EF Core knows nothing about and would never automatically detect changes, but why the exception when trying to attach the entity to the context?</p><p>This leads to another EF Core feature, called <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/ef/core/change-tracking/identity-resolution">Identity Resolution</a>, strongly correlated to our change tracking.</p><p><em>Identity Resolution</em> ensures the same entity is retrieved for the same primary key while being tracked. This is a requirement when implementing the Unit of Work pattern because EF Core only flushes data when <code>SaveChangesAsync</code> is invoked.</p><p>Again, let’s imagine our <code>PersonEntity</code> was a mutable class:</p><ul><li>You retrieve our <em>Bruce Wayne</em> from the database using an EF Core context, which internally will keep a reference to it, also identified by its primary key;</li><li>You change its birthdate;</li><li>You do some more work;</li><li>You try to get it again from the EF Core context but since that primary key its already being tracked, it returns the same instance instead of going to the database and returning old data for your Unit of Work operation;</li><li>You change more properties;</li><li>Invoke <code>SaveChangesAsync</code>, flushing changes and now both the instance and database have the same data;</li></ul><p>As you can see, <em>Identity Resolution</em> is important for mutable entities, but not so much for our use case and it’s a problem we must solve.</p><hr><h1 id="The-project"><a href="#The-project" class="headerlink" title="The project"></a>The project</h1><p>It seems the only thing preventing an immutable approach to database access while using EF Core is not relying on <em>Change Tracking</em> for mutations while preventing <em>Identity Resolution</em> problems.</p><p>Let’s create a C# console application that will use Entity Framework Core to store data into a SQLite database, using immutable <code>record</code> entities.</p><p>The source code is available on <a target="_blank" rel="noopener" href="https://github.com/gravity00/efcore-immutability">GitHub</a>, feel free to give it a look.</p><h2 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h2><p>Start by opening Visual Studio and creating a <strong>.NET 6.0 Console Application</strong> with a name at any location you prefer.</p><img src="/2022/08/13/Immutability-and-Entity-Framework-Core/01_project_create.png"><p>Install most recent versions of Entity Framework Core for SQLite and Microsoft hosting nugets:</p><ul><li><code>Microsoft.Extensions.Hosting</code></li><li><code>Microsoft.EntityFrameworkCore.Sqlite</code></li></ul><img src="/2022/08/13/Immutability-and-Entity-Framework-Core/02_nugets.png"><p>Create a <code>ProgramHost</code> class implementing <code>IHostedService</code>. This class will run our exemple code, but for now just inject a logger and write something inside the <code>StartAsync</code> method. We’ll do nothing in the <code>StopAsync</code> method, so just return a completed task.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProgramHost</span> : <span class="title">IHostedService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;ProgramHost&gt; _logger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProgramHost</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        ILogger&lt;ProgramHost&gt; logger</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">StartAsync</span>(<span class="params">CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;I&#x27;m alive!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">StopAsync</span>(<span class="params">CancellationToken ct</span>)</span> =&gt; Task.CompletedTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>Program.cs</code> file, build an host with our <code>ProgramHost</code> class registered as a hosted service.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> host = Host.CreateDefaultBuilder()</span><br><span class="line">    .ConfigureServices(services =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        services.AddHostedService&lt;ProgramHost&gt;();</span><br><span class="line">    &#125;)</span><br><span class="line">    .Build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> host.RunAsync();</span><br></pre></td></tr></table></figure><p>If you configured everything correctly and run the application, you should see something like this:</p><img src="/2022/08/13/Immutability-and-Entity-Framework-Core/03_setup_logs.png"><h2 id="The-database-model"><a href="#The-database-model" class="headerlink" title="The database model"></a>The database model</h2><p>For simplicity, we’ll have a single Persons table:</p><ul><li><strong>Id</strong> — identity column to uniquely identify the row (required);</li><li><strong>Forename</strong> — stores the first name (text, required);</li><li><strong>Surname</strong> — stores the last name (text, required);</li><li><strong>MiddleNames</strong> — stores the middle names (text, optional);</li><li><strong>Birthdate</strong> — stores the date of birth (date, optional);</li></ul><p>When representing database entities, I always create a base class containing properties to be defined in all entities (like the unique identifier or some metadata columns), and for the rest I always use positional records syntax for required properties and auto-properties for optional ones, making clear to the developer which ones must be always provided (this also removes compiler warnings if the project is configured for nullable reference types).</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Base class for all database entities</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">record</span> <span class="title">Entity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Unique identifier</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Representation of a person</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Forename&quot;&gt;</span>Person first name<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Surname&quot;&gt;</span>Person last name<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title">PersonEntity</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">string</span> Forename,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">string</span> Surname</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) : Entity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Person middle names, separated by spaces</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>? MiddleNames &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Person date of birth</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> DateOnly? Birthdate &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If you prefer to keep everything more compact, feel free to use <em>positional records</em> with default values for optional properties.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title">PersonEntity</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">string</span> Forename,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">string</span> Surname,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">string</span>? MiddleNames = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    DateOnly? Birthdate = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) : Entity</span>;</span><br></pre></td></tr></table></figure><p>This is the most compact syntax, but be careful when adding new optional properties if your are sharing <em>records</em> across multiple applications. It will also be considered a breaking change unless you define both constructors, effectively losing this compact syntax. That’s the reason I don’t use <em>positional record syntax</em> for everything, but it kinda depends on your needs.</p><p>Now, lets create our EF Core context with <code>Persons</code> table mappings.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SampleDbContext</span> : <span class="title">DbContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SampleDbContext</span>(<span class="params">DbContextOptions&lt;SampleDbContext&gt; options</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">options</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder builder</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnModelCreating(builder);</span><br><span class="line"></span><br><span class="line">        builder.Entity&lt;PersonEntity&gt;(cfg =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            cfg.ToTable(<span class="string">&quot;Persons&quot;</span>);</span><br><span class="line">            cfg.HasKey(e =&gt; e.Id);</span><br><span class="line">            cfg.Property(e =&gt; e.Id)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .ValueGeneratedOnAdd();</span><br><span class="line">            cfg.Property(e =&gt; e.Forename)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .HasMaxLength(<span class="number">64</span>);</span><br><span class="line">            cfg.Property(e =&gt; e.Surname)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .HasMaxLength(<span class="number">64</span>);</span><br><span class="line">            cfg.Property(e =&gt; e.MiddleNames)</span><br><span class="line">                .HasMaxLength(<span class="number">256</span>);</span><br><span class="line">            cfg.Property(e =&gt; e.Birthdate);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>Program.cs</code> file and register the EF Core context into the container. This is a test console, so I’ll use the temporary folder to store the SQLite file but feel free to use any other location and file name.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> host = Host.CreateDefaultBuilder()</span><br><span class="line">    .ConfigureServices(services =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        services.AddDbContext&lt;SampleDbContext&gt;(options =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> connectionString = <span class="keyword">new</span> SqliteConnectionStringBuilder</span><br><span class="line">            &#123;</span><br><span class="line">                DataSource = Path.Combine(</span><br><span class="line">                    Path.GetTempPath(),</span><br><span class="line">                    <span class="string">&quot;efcore-immutability-sample.sqlite3&quot;</span></span><br><span class="line">                )</span><br><span class="line">            &#125;.ConnectionString;</span><br><span class="line">            options.UseSqlite(connectionString);</span><br><span class="line">        &#125;);</span><br><span class="line">        services.AddHostedService&lt;ProgramHost&gt;();</span><br><span class="line">    &#125;)</span><br><span class="line">    .Build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> host.RunAsync();</span><br></pre></td></tr></table></figure><p>Now inject the context into the <code>ProgramHost</code> class and, since this is a test console and we want to freely modify our entities without much thought, change the <code>StartAsync</code> method to always drop and recreate the database on startup.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProgramHost</span> : <span class="title">IHostedService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;ProgramHost&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> SampleDbContext _context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProgramHost</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        ILogger&lt;ProgramHost&gt; logger,</span></span></span><br><span class="line"><span class="params"><span class="function">        SampleDbContext context</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">        _context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">StartAsync</span>(<span class="params">CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Ensuring database is in a clean state&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> _context.Database.EnsureDeletedAsync(ct);</span><br><span class="line">        <span class="keyword">await</span> _context.Database.EnsureCreatedAsync(ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">StopAsync</span>(<span class="params">CancellationToken ct</span>)</span> =&gt; Task.CompletedTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If you run the application and open the SQLite database file (using DB Browser for SQLite or equivalent), both a <code>Persons</code> and <code>sqlite_sequence</code> tables should be defined.</p><img src="/2022/08/13/Immutability-and-Entity-Framework-Core/04_db_setup.png"><h2 id="Configuring-for-immutability"><a href="#Configuring-for-immutability" class="headerlink" title="Configuring for immutability"></a>Configuring for immutability</h2><p>Now that we have a working solution lets recall what we need to achieve to support immutability:</p><ul><li>Not relying on <em>Change Tracking</em> to know which instructions must be executed when <code>SaveChangesAsync</code> is invoked;</li><li>Preventing <em>Identity Resolution</em> exceptions;</li></ul><p>Because <em>Change Tracking</em> is such a core feature in Entity Framework Core, you can only disable it when querying for entities.</p><p>As stated in Microsoft <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/ef/core/querying/tracking">documentation</a>, we can disable it in three ways:</p><ul><li>Using extension method <code>AsNoTracking</code> for each query;</li><li>Setting context property <code>ChangeTracker.QueryTrackingBehavior</code> to <code>NoTracking</code>;</li><li>Global configuration with method <code>UseQueryTrackingBehavior</code>;</li></ul><p>Open <code>Program.cs</code> file and disable it globally, ensuring will never be tracked when queried from the database.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> host = Host.CreateDefaultBuilder()</span><br><span class="line">    .ConfigureServices(services =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        services.AddDbContext&lt;SampleDbContext&gt;(options =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> connectionString = <span class="keyword">new</span> SqliteConnectionStringBuilder</span><br><span class="line">            &#123;</span><br><span class="line">                DataSource = Path.Combine(</span><br><span class="line">                    Path.GetTempPath(),</span><br><span class="line">                    <span class="string">&quot;efcore-immutability-sample.sqlite3&quot;</span></span><br><span class="line">                )</span><br><span class="line">            &#125;.ConnectionString;</span><br><span class="line">            options.UseSqlite(connectionString)</span><br><span class="line">                .UseQueryTrackingBehavior(QueryTrackingBehavior.NoTracking);</span><br><span class="line">        &#125;);</span><br><span class="line">        services.AddHostedService&lt;ProgramHost&gt;();</span><br><span class="line">    &#125;)</span><br><span class="line">    .Build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> host.RunAsync();</span><br></pre></td></tr></table></figure><p>In theory, if you only made a single entity operation per unit of work, like getting a person by unique identifier, changing its middle names and doing an update, this configuration would be enough.</p><p>Sadly we all know development is far from perfect and more complex applications, due to business requirements, may lead to multiple updates to the same data in a single unit of work operation. That’s one of the major reasons behind <em>Change Tracking</em> in EF Core, to implement the unit of work pattern while not relying on database ACID implementations and reducing the time transactions stays open.</p><p>This means every time an entity is added, updated or removed using the context, an internal reference will be kept and <em>Identity Resolution</em> exceptions will be thrown if someone tries to attach an entity with the same id.</p><p>There are multiple ways to solve this problem but the easiest one is to enforce a transaction, flush changes to the database every time a create, update or delete is requested and then detach the entity.</p><p>Since this is a proof of concept application, I’m going to implementing this behavior with extension methods over <code>DbContext</code> instances, but feel free to wrap it into a repository pattern or any way you prefer.</p><p>Create a static class <code>DbContextExtensions</code> and implement a generic extension that will receive an entity and the state to be tracked, returning an updated entity.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">DbContextExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TEntity</span>&gt; <span class="title">SaveEntityStateAsync</span>&lt;<span class="title">TEntity</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">this</span> DbContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">        TEntity entity,</span></span></span><br><span class="line"><span class="params"><span class="function">        EntityState state,</span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) <span class="keyword">where</span> TEntity : Entity</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(context));</span><br><span class="line">        <span class="keyword">if</span> (entity == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(entity));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> entry = context.Entry(entity);</span><br><span class="line">        entry.State = state;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> context.SaveChangesAsync(ct);</span><br><span class="line"></span><br><span class="line">        entry.State = EntityState.Detached;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> entry.Entity;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The method creates an <code>EntityEntry&lt;TEntity&gt;</code>, changes the state to the one provided and immediately requests to flush changes. Because the context is now tracking the entity, it will execute a database instruction based on the entry state (<code>Added|Modified|Deleted</code>). Then, it detaches the entity right before returning to prevent <em>Identity Resolution</em> exceptions on future mutations and returns the entity with the most recent values (usefull to get values generated by the database, like an identity column).</p><p>Open the <code>ProgramHost</code> class and create some test code using the extension method and the immutable <code>PersonEntity</code>. In this case I’m creating <em>Bruce Wayne</em> and then updating both birthdate and middle name.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProgramHost</span> : <span class="title">IHostedService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;ProgramHost&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> SampleDbContext _context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProgramHost</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        ILogger&lt;ProgramHost&gt; logger,</span></span></span><br><span class="line"><span class="params"><span class="function">        SampleDbContext context</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">        _context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">StartAsync</span>(<span class="params">CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Setting database to a clean state&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> _context.Database.EnsureDeletedAsync(ct);</span><br><span class="line">        <span class="keyword">await</span> _context.Database.EnsureCreatedAsync(ct);</span><br><span class="line"></span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Creating an explicit database transaction&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">using</span> <span class="keyword">var</span> tx = <span class="keyword">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class="line"></span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Adding person&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> person = <span class="keyword">await</span> _context.SaveEntityStateAsync(<span class="keyword">new</span> PersonEntity(</span><br><span class="line">            Forename: <span class="string">&quot;Bruce&quot;</span>,</span><br><span class="line">            Surname: <span class="string">&quot;Wayne&quot;</span></span><br><span class="line">        ), EntityState.Added, ct);</span><br><span class="line"></span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Updating person&#x27;s birthdate&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> _context.SaveEntityStateAsync(person <span class="keyword">with</span></span><br><span class="line">        &#123;</span><br><span class="line">            MiddleNames = <span class="string">&quot;Thomas&quot;</span>,</span><br><span class="line">            Birthdate = <span class="keyword">new</span> DateOnly(<span class="number">1972</span>, <span class="number">02</span>, <span class="number">19</span>)</span><br><span class="line">        &#125;, EntityState.Modified, ct);</span><br><span class="line"></span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Commiting database transaction&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> tx.CommitAsync(ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">StopAsync</span>(<span class="params">CancellationToken ct</span>)</span> =&gt; Task.CompletedTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If you execute the code, you’ll see database instructions being sent to SQLite by Entity Framework Core to insert and then update the entity.</p><img src="/2022/08/13/Immutability-and-Entity-Framework-Core/05_logs_entity_mutate.png"><p>Open the SQLite file and you’ll see <em>Bruce Wayne</em> was both created and updated with a birthdate and middle name.</p><img src="/2022/08/13/Immutability-and-Entity-Framework-Core/06_db_persons_table.png"><p>Certainly you don’t want to be writing <code>EntityState.Added|Updated|Deleted</code> every time an entity needs to be manipulated, so lets create dedicated extensions for each operation and update your test code.</p><p>Change the method to <code>private</code> and implement a <code>CreateAsync</code>, <code>UpdateAsync</code> and <code>DeleteAsync</code> extension methods that will reuse the existing one.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">DbContextExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TEntity</span>&gt; <span class="title">CreateAsync</span>&lt;<span class="title">TEntity</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">this</span> DbContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">        TEntity entity,</span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) <span class="keyword">where</span> TEntity : Entity</span> =&gt; <span class="keyword">await</span> context.SaveEntityStateAsync(</span><br><span class="line">        entity,</span><br><span class="line">        EntityState.Added,</span><br><span class="line">        ct</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TEntity</span>&gt; <span class="title">UpdateAsync</span>&lt;<span class="title">TEntity</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">this</span> DbContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">        TEntity entity,</span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) <span class="keyword">where</span> TEntity : Entity</span> =&gt; <span class="keyword">await</span> context.SaveEntityStateAsync(</span><br><span class="line">        entity,</span><br><span class="line">        EntityState.Modified,</span><br><span class="line">        ct</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">DeleteAsync</span>&lt;<span class="title">TEntity</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">this</span> DbContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">        TEntity entity,</span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) <span class="keyword">where</span> TEntity : Entity</span> =&gt; <span class="keyword">await</span> context.SaveEntityStateAsync(</span><br><span class="line">        entity,</span><br><span class="line">        EntityState.Deleted,</span><br><span class="line">        ct</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TEntity</span>&gt; <span class="title">SaveEntityStateAsync</span>&lt;<span class="title">TEntity</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">this</span> DbContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">        TEntity entity,</span></span></span><br><span class="line"><span class="params"><span class="function">        EntityState state,</span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) <span class="keyword">where</span> TEntity : Entity</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(context));</span><br><span class="line">        <span class="keyword">if</span> (entity == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(entity));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> entry = context.Entry(entity);</span><br><span class="line">        entry.State = state;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> context.SaveChangesAsync(ct);</span><br><span class="line"></span><br><span class="line">        entry.State = EntityState.Detached;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> entry.Entity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Use the new methods in our <code>ProgramHost</code> class.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProgramHost</span> : <span class="title">IHostedService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;ProgramHost&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> SampleDbContext _context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProgramHost</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        ILogger&lt;ProgramHost&gt; logger,</span></span></span><br><span class="line"><span class="params"><span class="function">        SampleDbContext context</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">        _context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">StartAsync</span>(<span class="params">CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Setting database to a clean state&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> _context.Database.EnsureDeletedAsync(ct);</span><br><span class="line">        <span class="keyword">await</span> _context.Database.EnsureCreatedAsync(ct);</span><br><span class="line"></span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Creating an explicit database transaction&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">using</span> <span class="keyword">var</span> tx = <span class="keyword">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class="line"></span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Adding person&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> person = <span class="keyword">await</span> _context.CreateAsync(<span class="keyword">new</span> PersonEntity(</span><br><span class="line">            Forename: <span class="string">&quot;Bruce&quot;</span>,</span><br><span class="line">            Surname: <span class="string">&quot;Wayne&quot;</span></span><br><span class="line">        ), ct);</span><br><span class="line"></span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Updating person&#x27;s birthdate&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> _context.UpdateAsync(person <span class="keyword">with</span></span><br><span class="line">        &#123;</span><br><span class="line">            MiddleNames = <span class="string">&quot;Thomas&quot;</span>,</span><br><span class="line">            Birthdate = <span class="keyword">new</span> DateOnly(<span class="number">1972</span>, <span class="number">02</span>, <span class="number">19</span>)</span><br><span class="line">        &#125;, ct);</span><br><span class="line"></span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;Commiting database transaction&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> tx.CommitAsync(ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">StopAsync</span>(<span class="params">CancellationToken ct</span>)</span> =&gt; Task.CompletedTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to use Entity Framework Core to abstract your application from the database while still implementing the immutable design pattern to manage application state.</p><p>There are both advantages and disadvantages of using immutable entities over mutable ones, after all no size fits all, but I think its nice to know you have the option to use it without sacrificing productivity by having to implement database access yourself. As long you ensure <em>Change Tracking</em> is disabled for all queries and every code uses your abstractions to create, update or delete entities, everything will work just fine.</p><p>Just a small note about explicit database transactions. If you are implementing an ASP.NET Core application and using the mediator pattern, some time ago I created a bunch of articles and one of them provided an approach to <a href="/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/" title="Transaction Management With Mediator Pipelines in ASP.NET Core">manage Entity Framework Core transactions globally using a pipeline</a>. I use that approach all the time, you may find it helpful too.</p></div><footer class="article-footer"><a data-url="https://code-corner.dev/2022/08/13/Immutability-and-Entity-Framework-Core/" data-id="clv2o3ycj0006jojh2tcg1r39" data-title="Immutability and Entity Framework Core" class="article-share-link"><span class="fa fa-share">Share</span></a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/efcore/" rel="tag">efcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/patterns/" rel="tag">patterns</a></li></ul></footer></div><nav id="article-nav"><a href="/2023/11/04/Understanding-Flag-Enums-in-C/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">Understanding Flag Enums in C#</div></a><a href="/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Integrating Dapper with Entity Framework Core</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/concepts/">concepts</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/performance/">performance</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tutorial/">tutorial</a><span class="category-list-count">9</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dapper/" rel="tag">dapper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/efcore/" rel="tag">efcore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hangfire/" rel="tag">hangfire</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linq/" rel="tag">linq</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/patterns/" rel="tag">patterns</a><span class="tag-list-count">6</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/aspnetcore/" style="font-size:15.71px">aspnetcore</a> <a href="/tags/csharp/" style="font-size:18.57px">csharp</a> <a href="/tags/dapper/" style="font-size:10px">dapper</a> <a href="/tags/dotnet/" style="font-size:17.14px">dotnet</a> <a href="/tags/dotnetcore/" style="font-size:20px">dotnetcore</a> <a href="/tags/efcore/" style="font-size:12.86px">efcore</a> <a href="/tags/hangfire/" style="font-size:10px">hangfire</a> <a href="/tags/linq/" style="font-size:11.43px">linq</a> <a href="/tags/patterns/" style="font-size:14.29px">patterns</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/05/25/NET-IAsyncEnumerable-utility-extensions/">.NET - IAsyncEnumerable utility extensions</a></li><li><a href="/2024/04/14/NET-9-%E2%80%94-Exception-handling-performance/">.NET 9 — Exception handling performance</a></li><li><a href="/2024/02/29/NET-Hangfire/">.NET - Hangfire</a></li><li><a href="/2024/02/05/NET-%E2%80%94-LinkedList-vs-ToArray/">.NET — LinkedList vs ToArray</a></li><li><a href="/2024/01/19/NET-%E2%80%94-TaskCompletionSource-and-CancellationTokenSource/">.NET — TaskCompletionSource and CancellationTokenSource</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png"></a><br>All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a><br>&copy; 2024 João Simões<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="/js/jquery-3.6.4.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></div></body></html>