<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-TQKP5TGHJ8"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TQKP5TGHJ8")</script><title>Integrating Dapper with Entity Framework Core | code-corner.dev</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="google-adsense-account" content="ca-pub-4671230649342120"><meta name="description" content="Nowadays it is extremely rare to implement an application without using any sort of library for Object-Relational Mapping (ORM) to reduce development time by removing the need to implement a lot of bo"><meta property="og:type" content="article"><meta property="og:title" content="Integrating Dapper with Entity Framework Core"><meta property="og:url" content="https://code-corner.dev/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/index.html"><meta property="og:site_name" content="code-corner.dev"><meta property="og:description" content="Nowadays it is extremely rare to implement an application without using any sort of library for Object-Relational Mapping (ORM) to reduce development time by removing the need to implement a lot of bo"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://code-corner.dev/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/00_header.png"><meta property="article:published_time" content="2021-03-09T00:00:00.000Z"><meta property="article:modified_time" content="2024-04-16T17:31:21.713Z"><meta property="article:author" content="João Simões"><meta property="article:tag" content="dotnetcore"><meta property="article:tag" content="aspnetcore"><meta property="article:tag" content="csharp"><meta property="article:tag" content="efcore"><meta property="article:tag" content="dapper"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://code-corner.dev/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/00_header.png"><meta name="twitter:creator" content="@JoaoPRSimoes"><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css"><link rel="canonical" href="https://code-corner.dev/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/"><meta name="generator" content="Hexo 7.1.1"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml,sitemap.txt"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">code-corner.dev</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">The place to learn about programming</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/gravity00"><span class="fa fa-github"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://twitter.com/JoaoPRSimoes"><span class="fa fa-twitter"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://joaoprsimoes.medium.com/"><span class="fa fa-medium"></span></a> <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a> <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://code-corner.dev"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-Integrating-Dapper-with-Entity-Framework-Core" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-meta"><a href="/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/" class="article-date"><time class="dt-published" datetime="2021-03-09T00:00:00.000Z" itemprop="datePublished">2021-03-09</time></a><div class="article-category"><a class="article-category-link" href="/categories/tutorial/">tutorial</a></div></div><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">Integrating Dapper with Entity Framework Core</h1><h2 class="p-name article-subtitle">Overcoming limitations or performance bottlenecks by executing raw SQL with Dapper</h2></header><div class="e-content article-entry" itemprop="articleBody"><a href="https://code-corner.dev/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/00_header.png" data-fancybox="gallery" data-caption><img src="https://code-corner.dev/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/00_header.png"></a><p>Nowadays it is extremely rare to implement an application without using any sort of library for <em>Object-Relational Mapping (ORM)</em> to reduce development time by removing the need to implement a lot of boilerplate code to access a database. In the .NET world that usually means using <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/ef/core/">Entity Framework Core</a> or <a target="_blank" rel="noopener" href="https://nhibernate.info/">NHibernate</a> both offering strong tooling for CRUD operations, data type conversions, strong typed queries using LINQ with <code>IQueryable</code> and so on.</p><p>Despite the pros of using an ORM there are also some cons that, while may not prevent them to be widely used inside an application, they may need to be replaced in some areas either for performance reasons or limitations. This usually means working directly with <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/ado-net-overview">ADO.NET</a> (oh hell no!) or use Micro ORM libraries, like <a target="_blank" rel="noopener" href="https://github.com/StackExchange/Dapper">Dapper</a>, that are focused on performance and providing a simpler way to map database queries into objects.</p><p>In this article I’m going to demonstrate how Dapper can easily be integrated with Entity Framework Core (and probably with any other ORM) without using <code>TransactionScope</code>, while trying to keep the same contracts via extension methods to <code>DbContext</code> instances and ensuring the SQL is properly logged in a similar way to what EF Core usually does.</p><h1 id="Dapper-Requirements"><a href="#Dapper-Requirements" class="headerlink" title="Dapper Requirements"></a>Dapper Requirements</h1><p>To work with Dapper, the only requirements are a <code>DbConnection</code>, the SQL text, and some optional parameters, like a <code>DbTransaction</code>, command timeout, query parameters and so on. Sometimes is is also necessary to globally register some custom <code>TypeHandler&lt;T&gt;</code> for the when it can’t convert a given database type to its CLR representation.</p><p>Assuming we want to execute a simple <code>SELECT @SomeParameter</code> statement via Dapper, what code we must implement to get everything we need from a <code>DbContext</code>?</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get the underline DbConnection</span></span><br><span class="line"><span class="keyword">var</span> connection = context.Database.GetDbConnection();</span><br><span class="line"></span><br><span class="line"><span class="comment">// get the underline DbTransaction, if any</span></span><br><span class="line"><span class="keyword">var</span> transaction = context.Database.CurrentTransaction?.GetDbTransaction();</span><br><span class="line"></span><br><span class="line"><span class="comment">// get the currently configured command timeout</span></span><br><span class="line"><span class="keyword">var</span> commandTimeout = context.Database.GetCommandTimeout();</span><br><span class="line"></span><br><span class="line"><span class="comment">// create a Dapper CommandDefinition</span></span><br><span class="line"><span class="keyword">var</span> command = <span class="keyword">new</span> CommandDefinition(</span><br><span class="line">    <span class="string">&quot;SELECT @SomeParameter&quot;</span>,</span><br><span class="line">    <span class="keyword">new</span></span><br><span class="line">    &#123;</span><br><span class="line">        SomeParameter = <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    transaction,</span><br><span class="line">    commandTimeout,</span><br><span class="line">    cancellationToken: ct</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ = <span class="keyword">await</span> connection.QueryAsync&lt;<span class="built_in">int</span>&gt;(command);</span><br></pre></td></tr></table></figure><p>As shown, the database facade has everything we need to make Dapper work but there is a caveat that must be properly addressed:</p><p><strong>Dapper always executes the SQL immediately into the database</strong>, which means it won’t detect changes made on tracked entities before <code>SaveChanges</code> is invoked and it won’t wait to flush changes either, so be very careful when managing database access.</p><p>My recommendation is to always open a transaction explicitly via <code>context.Database.BeginTransactionAsync</code> before running any mutation.</p><p>If you are using the mediator pattern, I recommend my previous article that explains <a href="/2020/11/07/Transaction-Management-With-Mediator-Pipelines-in-ASP-NET-Core/" title="Transaction Management With Mediator Pipelines in ASP.NET Core">how to create a mediator pipeline that enforces database transactions when handling commands</a>.</p><p>With all of this in mind, lets implement an example project that showcases what we just talked about.</p><hr><h1 id="The-project"><a href="#The-project" class="headerlink" title="The project"></a>The project</h1><p>The source code for this article can be found on <a target="_blank" rel="noopener" href="https://github.com/gravity00/EntityFrameworkCoreWithDapper">GitHub</a>.</p><p>Start by opening Visual Studio and creating an <strong>ASP.NET Core Web Application</strong> with a name and a location at your preference.</p><img src="/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/01_project_create.png"><p>Choose an <strong>empty project</strong> since this is just a demo and we are going to setup only the required dependencies.</p><img src="/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/02_project_create_aspnet.png"><p>Install the Nuget <code>Swashbuckle.AspNetCore</code>:</p><img src="/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/03_nuget_swagger.png"><p>Open the <code>Startup.cs</code> file and configure both MVC and Swagger so we can use its UI to test our endpoints more easily.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        services.AddMvc();</span><br><span class="line"></span><br><span class="line">        services.AddSwaggerGen();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        app.UseDeveloperExceptionPage();</span><br><span class="line"></span><br><span class="line">        app.UseSwagger();</span><br><span class="line"></span><br><span class="line">        app.UseSwaggerUI(c =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            c.SwaggerEndpoint(<span class="string">&quot;/swagger/v1/swagger.json&quot;</span>, <span class="string">&quot;EF Core with Dapper Example Api V1&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        app.UseRouting();</span><br><span class="line"></span><br><span class="line">        app.UseEndpoints(endpoints =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            endpoints.MapControllers();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="The-Web-API"><a href="#The-Web-API" class="headerlink" title="The Web API"></a>The Web API</h1><p>Since the objective of this article is to show how Dapper can be integrated with Entity Framework Core, we are going to create a simple endpoint to manage products:</p><ul><li>GET &#x2F;products — lists products, including their current price and last date when it has changed;</li><li>POST &#x2F;products — creates a product with a given price;</li></ul><h2 id="The-Database-Model"><a href="#The-Database-Model" class="headerlink" title="The Database Model"></a>The Database Model</h2><p>We need a SQL database to run our queries so, to simplify our setup, we are going to use the SQLite provider for Entity Framework Core and configure it as an in-memory instance.</p><p>Install the Nuget <code>Microsoft.EntityFrameworkCore.Sqlite</code>:</p><img src="/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/04_nuget_efcore_sqlite.png"><p>Create a <code>Database</code> folder and inside create entities for products and price history, both mapped into an Entity Framework context:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ApiDbContext</span> : <span class="title">DbContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApiDbContext</span>(<span class="params">DbContextOptions&lt;ApiDbContext&gt; options</span>) : <span class="title">base</span>(<span class="params">options</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder builder</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnModelCreating(builder);</span><br><span class="line"></span><br><span class="line">        builder.Entity&lt;ProductEntity&gt;(cfg =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            cfg.ToTable(<span class="string">&quot;Product&quot;</span>);</span><br><span class="line">            cfg.HasKey(e =&gt; e.Id);</span><br><span class="line">            cfg.HasAlternateKey(e =&gt; e.ExternalId);</span><br><span class="line">            cfg.HasIndex(e =&gt; e.Code).IsUnique();</span><br><span class="line">            cfg.Property(e =&gt; e.Id)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .ValueGeneratedOnAdd();</span><br><span class="line">            cfg.Property(e =&gt; e.ExternalId)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.Code)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .HasMaxLength(<span class="number">8</span>);</span><br><span class="line">            cfg.Property(e =&gt; e.Name)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .HasMaxLength(<span class="number">128</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        builder.Entity&lt;PriceHistoryEntity&gt;(cfg =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            cfg.ToTable(<span class="string">&quot;PriceHistory&quot;</span>);</span><br><span class="line">            cfg.HasKey(e =&gt; e.Id);</span><br><span class="line">            cfg.HasIndex(e =&gt; e.CreatedOn);</span><br><span class="line">            cfg.Property(e =&gt; e.Id)</span><br><span class="line">                .IsRequired()</span><br><span class="line">                .ValueGeneratedOnAdd();</span><br><span class="line">            cfg.HasOne(e =&gt; e.Product)</span><br><span class="line">                .WithMany(p =&gt; p.PricesHistory)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.Price)</span><br><span class="line">                .IsRequired();</span><br><span class="line">            cfg.Property(e =&gt; e.CreatedOn)</span><br><span class="line">                .IsRequired();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> Guid ExternalId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Code &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> ICollection&lt;PriceHistoryEntity&gt; PricesHistory &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProductEntity</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        PricesHistory = <span class="keyword">new</span> HashSet&lt;PriceHistoryEntity&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PriceHistoryEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> ProductEntity Product &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTime CreatedOn &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>Startup.cs</code> file and add the database context to the container. Because the database is stored in-memory, we must ensure all tables are created when the application starts and at least one connection is always open so the SQLite provider won’t discard it from memory:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> ConnectionString = <span class="string">&quot;Data Source=EntityFrameworkCoreWithDapper;Mode=Memory;Cache=Shared&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SqliteConnection _keepAliveConnection;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.UseSqlite(ConnectionString);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// this ensures at least one connection is open and the database is kept in-memory while the application is running</span></span><br><span class="line">        _keepAliveConnection = <span class="keyword">new</span> SqliteConnection(ConnectionString);</span><br><span class="line">        keepAliveConnection.Open();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> scope = app.ApplicationServices.GetRequiredService&lt;IServiceScopeFactory&gt;().CreateScope())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> ctx = scope.ServiceProvider.GetRequiredService&lt;ApiDbContext&gt;();</span><br><span class="line">            ctx.Database.EnsureCreated();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="The-Products-Controller"><a href="#The-Products-Controller" class="headerlink" title="The Products Controller"></a>The Products Controller</h2><p>Now that we have configured the database, create a <code>Controllers</code> folder, the <code>ProductsController</code> class and its models. For now, we are going to implement our logic using only the Entity Framework context.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;products&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductsController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ApiDbContext _context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProductsController</span>(<span class="params">ApiDbContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpGet</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">IEnumerable</span>&lt;<span class="title">ProductModel</span>&gt;&gt; <span class="title">GetAllAsync</span>(<span class="params">[FromQuery] <span class="built_in">int</span>? skip, [FromQuery] <span class="built_in">int</span>? take, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> (</span><br><span class="line">                <span class="keyword">from</span> p <span class="keyword">in</span> _context.Set&lt;ProductEntity&gt;()</span><br><span class="line">                <span class="keyword">select</span> <span class="keyword">new</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Id = p.ExternalId,</span><br><span class="line">                    p.Code,</span><br><span class="line">                    p.Name,</span><br><span class="line">                    MostRecentPriceHistory = p</span><br><span class="line">                        .PricesHistory</span><br><span class="line">                        .OrderByDescending(ph =&gt; ph.CreatedOn)</span><br><span class="line">                        .First()</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">            .OrderBy(p =&gt; p.Code)</span><br><span class="line">            .Skip(skip ?? <span class="number">0</span>)</span><br><span class="line">            .Take(take ?? <span class="number">20</span>)</span><br><span class="line">            .Select(p =&gt; <span class="keyword">new</span> ProductModel</span><br><span class="line">            &#123;</span><br><span class="line">                Id = p.Id,</span><br><span class="line">                Code = p.Code,</span><br><span class="line">                Name = p.Name,</span><br><span class="line">                Price = p.MostRecentPriceHistory.Price,</span><br><span class="line">                PriceChangedOn = p.MostRecentPriceHistory.CreatedOn</span><br><span class="line">            &#125;)</span><br><span class="line">            .ToListAsync(ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpPost</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;CreateProductResultModel&gt; <span class="title">CreateAsync</span>(<span class="params">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> externalId = Guid.NewGuid();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">using</span> <span class="keyword">var</span> tx = <span class="keyword">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> product = <span class="keyword">new</span> ProductEntity</span><br><span class="line">        &#123;</span><br><span class="line">            ExternalId = externalId,</span><br><span class="line">            Code = model.Code,</span><br><span class="line">            Name = model.Name,</span><br><span class="line">            PricesHistory =</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> PriceHistoryEntity</span><br><span class="line">                &#123;</span><br><span class="line">                    Price = model.Price,</span><br><span class="line">                    CreatedOn = DateTime.UtcNow</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> _context.Set&lt;ProductEntity&gt;().AddAsync(product, ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> _context.SaveChangesAsync(ct);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> tx.CommitAsync(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CreateProductResultModel</span><br><span class="line">        &#123;</span><br><span class="line">            Id = externalId</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateProductModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Code &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTime PriceChangedOn &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateProductResultModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Right now, the project content should look as follows:</p><img src="/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/05_project_structure.png"><h1 id="Dapper-Integration"><a href="#Dapper-Integration" class="headerlink" title="Dapper Integration"></a>Dapper Integration</h1><p>Now that we have a running API that manages products and their prices using Entity Framework Core, we can now integrate Dapper into the solution and apply what we learned at the start of this article.</p><p>Install the Nuget <code>Dapper</code>:</p><img src="/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/06_nuget_dapper.png"><p>Since Dapper uses extension methods over <code>IDbConnection</code> and we can extract everything needed from a <code>DbContext</code> instance (even an <code>ILogger</code> to log our raw SQL), lets keep that philosophy and replicate those extension methods but this time to an Entity Framework Core context.</p><p>Inside the <code>Database</code> folder create a static <code>DapperDbContextExtensions</code> class, that will containing all the extension methods, and a <code>DapperEFCoreCommand</code> structure, used to wrap both logging and Dapper’s <code>CommandDefinition</code>.</p><p>For demo purposes we are only going to expose methods to query a collection of items and to execute commands but feel free to add your owns (like <code>FirstAsync</code>). I also put the <code>CancellationToken</code> at the start since all other parameters are optional and I have my fair share of cancellation tokens being passed as the <code>object parameters</code>, but change them in a way that makes more sense to you.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">DapperDbContextExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">IEnumerable</span>&lt;<span class="title">T</span>&gt;&gt; <span class="title">QueryAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">this</span> DbContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">string</span> text,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">object</span> parameters = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">int</span>? timeout = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        CommandType? type = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> command = <span class="keyword">new</span> DapperEFCoreCommand(</span><br><span class="line">            context,</span><br><span class="line">            text,</span><br><span class="line">            parameters,</span><br><span class="line">            timeout,</span><br><span class="line">            type,</span><br><span class="line">            ct</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> connection = context.Database.GetDbConnection();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> connection.QueryAsync&lt;T&gt;(command.Definition);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;<span class="built_in">int</span>&gt; <span class="title">ExecuteAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">this</span> DbContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">string</span> text,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">object</span> parameters = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">int</span>? timeout = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        CommandType? type = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> command = <span class="keyword">new</span> DapperEFCoreCommand(</span><br><span class="line">            context,</span><br><span class="line">            text,</span><br><span class="line">            parameters,</span><br><span class="line">            timeout,</span><br><span class="line">            type,</span><br><span class="line">            ct</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> connection = context.Database.GetDbConnection();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> connection.ExecuteAsync(command.Definition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">struct</span> DapperEFCoreCommand : IDisposable</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;DapperEFCoreCommand&gt; _logger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DapperEFCoreCommand</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        DbContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">string</span> text,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">object</span> parameters,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">int</span>? timeout,</span></span></span><br><span class="line"><span class="params"><span class="function">        CommandType? type,</span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken ct</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger = context.GetService&lt;ILogger&lt;DapperEFCoreCommand&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> transaction = context.Database.CurrentTransaction?.GetDbTransaction();</span><br><span class="line">        <span class="keyword">var</span> commandType = type ?? CommandType.Text;</span><br><span class="line">        <span class="keyword">var</span> commandTimeout = timeout ?? context.Database.GetCommandTimeout() ?? <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">        Definition = <span class="keyword">new</span> CommandDefinition(</span><br><span class="line">            text,</span><br><span class="line">            parameters,</span><br><span class="line">            transaction,</span><br><span class="line">            commandTimeout,</span><br><span class="line">            commandType,</span><br><span class="line">            cancellationToken: ct</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_logger.IsEnabled(LogLevel.Debug))</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogDebug(</span><br><span class="line">                <span class="string">@&quot;Executing DbCommand [CommandType=&#x27;&#123;commandType&#125;&#x27;, CommandTimeout=&#x27;&#123;commandTimeout&#125;&#x27;]</span></span><br><span class="line"><span class="string">&#123;commandText&#125;&quot;</span>, Definition.CommandType, Definition.CommandTimeout, Definition.CommandText);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CommandDefinition Definition &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_logger.IsEnabled(LogLevel.Information))</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(</span><br><span class="line">                <span class="string">@&quot;Executed DbCommand [CommandType=&#x27;&#123;commandType&#125;&#x27;, CommandTimeout=&#x27;&#123;commandTimeout&#125;&#x27;]</span></span><br><span class="line"><span class="string">&#123;commandText&#125;&quot;</span>, Definition.CommandType, Definition.CommandTimeout, Definition.CommandText);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Since we are using <code>Guid</code> properties in our models but they are stored as <code>TEXT</code> and Dapper doesn’t know how to do the conversion when reading from a SQLite database, we also need to add a global type handler.</p><p>Open the <code>Startup.cs</code> file, create an inner class <code>GuidTypeHandler</code>, that will parse the string into a <code>Guid</code>, and register the handler on application startup:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        SqlMapper.AddTypeHandler(<span class="keyword">new</span> GuidTypeHandler());</span><br><span class="line">        </span><br><span class="line">        services.AddDbContext&lt;ApiDbContext&gt;(o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.UseSqlite(ConnectionString);</span><br><span class="line">        &#125;).AddTransient&lt;ApiDbSqlRunner&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title">GuidTypeHandler</span> : <span class="title">SqlMapper.TypeHandler</span>&lt;<span class="title">Guid</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetValue</span>(<span class="params">IDbDataParameter parameter, Guid <span class="keyword">value</span></span>)</span> =&gt; parameter.Value = <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Guid <span class="title">Parse</span>(<span class="params"><span class="built_in">object</span> <span class="keyword">value</span></span>)</span> =&gt; Guid.Parse((<span class="built_in">string</span>) <span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Optimizations-with-Dapper"><a href="#Optimizations-with-Dapper" class="headerlink" title="Optimizations with Dapper"></a>Optimizations with Dapper</h1><p>As stated before, Entity Framework will usually make it easier to access the database and remove some of the boilerplate code but, like most advanced frameworks, it has some drawbacks, specially performance degradation that sometimes can’t be ignored in critical paths.</p><p>Lets analyse each endpoint and see if we can improve both the generated SQL and the total of database interactions.</p><h2 id="POST-products"><a href="#POST-products" class="headerlink" title="POST &#x2F;products"></a>POST &#x2F;products</h2><p>This endpoint is responsible to create a product with a given initial price. Because prices are stored in a history table, being the most recent entry the current product price, this action has to insert both a line in the products and price history tables.</p><p>If we look at the logs we can see two commands being executed by the Entity Framework with a total of four operations:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">info: Microsoft.EntityFrameworkCore.Database.Command[20101]</span><br><span class="line">      Executed DbCommand (6ms) [Parameters=[@p0=&#x27;?&#x27; (Size = 8), @p1=&#x27;?&#x27;, @p2=&#x27;?&#x27; (Size = 16)], CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class="line">      INSERT INTO &quot;Product&quot; (&quot;Code&quot;, &quot;ExternalId&quot;, &quot;Name&quot;)</span><br><span class="line">      VALUES (@p0, @p1, @p2);</span><br><span class="line">      SELECT &quot;Id&quot;</span><br><span class="line">      FROM &quot;Product&quot;</span><br><span class="line">      WHERE changes() = 1 AND &quot;rowid&quot; = last_insert_rowid();</span><br><span class="line">info: Microsoft.EntityFrameworkCore.Database.Command[20101]</span><br><span class="line">      Executed DbCommand (1ms) [Parameters=[@p3=&#x27;?&#x27;, @p4=&#x27;?&#x27;, @p5=&#x27;?&#x27;], CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class="line">      INSERT INTO &quot;PriceHistory&quot; (&quot;CreatedOn&quot;, &quot;Price&quot;, &quot;ProductId&quot;)</span><br><span class="line">      VALUES (@p3, @p4, @p5);</span><br><span class="line">      SELECT &quot;Id&quot;</span><br><span class="line">      FROM &quot;PriceHistory&quot;</span><br><span class="line">      WHERE changes() = 1 AND &quot;rowid&quot; = last_insert_rowid();</span><br></pre></td></tr></table></figure><p>This happens because Entity Framework and the SQLite provider don’t know what our code needs from each entity after an insert, so the only option is to execute a command that does the insert, selects database generated columns, and update properties of the tracked instances, in this case, the primary keys.</p><p>Since we know our code doesn’t need anything from the database, because we are only returning the product external id that was calculated inside the controller, we can execute a single SQL statement containing both inserts:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO Product (ExternalId, Code, Name)</span><br><span class="line">VALUES (@ExternalId, @Code, @Name);</span><br><span class="line">INSERT INTO PriceHistory (Price, CreatedOn, ProductId)</span><br><span class="line">SELECT @Price, @CreatedOn, Id</span><br><span class="line">FROM Product</span><br><span class="line">WHERE</span><br><span class="line">    rowid = last_insert_rowid();</span><br></pre></td></tr></table></figure><p>Change the <code>CreateAsync</code> action to use the extension method <code>ExecuteAsync</code> with this statement, passing the arguments. Keep in mind that SQLite is case sensitive when parsing the parameter name, so you must ensure the anonymous object property names match with the ones inside the statement:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;products&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductsController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpPost</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;CreateProductResultModel&gt; <span class="title">CreateAsync</span>(<span class="params">[FromBody] CreateProductModel model, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> externalId = Guid.NewGuid();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">using</span> <span class="keyword">var</span> tx = <span class="keyword">await</span> _context.Database.BeginTransactionAsync(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> _context.ExecuteAsync(ct, <span class="string">@&quot;</span></span><br><span class="line"><span class="string">INSERT INTO Product (ExternalId, Code, Name)</span></span><br><span class="line"><span class="string">VALUES (@ExternalId, @Code, @Name);</span></span><br><span class="line"><span class="string">INSERT INTO PriceHistory (Price, CreatedOn, ProductId)</span></span><br><span class="line"><span class="string">SELECT @Price, @CreatedOn, Id</span></span><br><span class="line"><span class="string">FROM Product</span></span><br><span class="line"><span class="string">WHERE</span></span><br><span class="line"><span class="string">    rowid = last_insert_rowid();&quot;</span>, <span class="keyword">new</span></span><br><span class="line">        &#123;</span><br><span class="line">            ExternalId = externalId,</span><br><span class="line">            model.Code,</span><br><span class="line">            model.Name,</span><br><span class="line">            model.Price,</span><br><span class="line">            CreatedOn = DateTime.UtcNow</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> tx.CommitAsync(ct);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CreateProductResultModel</span><br><span class="line">        &#123;</span><br><span class="line">            Id = externalId</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>Remember that, even if we are executing a single command in the database, it contains two instructions so it still must be wrapped by an explicit database transaction.</em></p><p>When creating a new product using the Swagger UI endpoint (<a target="_blank" rel="noopener" href="https://localhost:44310/swagger/index.html">https://localhost:44310/swagger/index.html</a>), if you look at your Visual Studio output console, a log similar to the following should appear showing the custom SQL:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">dbug: EntityFrameworkCoreWithDapper.Database.DapperEFCoreCommand[0]</span><br><span class="line">      Executing DbCommand [CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class="line">      </span><br><span class="line">      INSERT INTO Product (ExternalId, Code, Name)</span><br><span class="line">      VALUES (@ExternalId, @Code, @Name);</span><br><span class="line">      </span><br><span class="line">      INSERT INTO PriceHistory (Price, CreatedOn, ProductId)</span><br><span class="line">      SELECT @Price, @CreatedOn, Id</span><br><span class="line">      FROM Product</span><br><span class="line">      WHERE</span><br><span class="line">          rowid = last_insert_rowid();</span><br><span class="line">info: EntityFrameworkCoreWithDapper.Database.DapperEFCoreCommand[0]</span><br><span class="line">      Executed DbCommand [CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class="line">      </span><br><span class="line">      INSERT INTO Product (ExternalId, Code, Name)</span><br><span class="line">      VALUES (@ExternalId, @Code, @Name);</span><br><span class="line">      </span><br><span class="line">      INSERT INTO PriceHistory (Price, CreatedOn, ProductId)</span><br><span class="line">      SELECT @Price, @CreatedOn, Id</span><br><span class="line">      FROM Product</span><br><span class="line">      WHERE</span><br><span class="line">          rowid = last_insert_rowid();</span><br></pre></td></tr></table></figure><h2 id="GET-products"><a href="#GET-products" class="headerlink" title="GET &#x2F;products"></a>GET &#x2F;products</h2><p>This endpoint is responsible for returning a paginated collections of products with their current price and the timestamp when it was last updated, ordered by product code.</p><p>Lets extract the SQL statement generated by the Entity Framework Core from the logs:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">info: Microsoft.EntityFrameworkCore.Database.Command[20101]</span><br><span class="line">      Executed DbCommand (3ms) [Parameters=[@__p_1=&#x27;?&#x27;, @__p_0=&#x27;?&#x27;], CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class="line">      SELECT &quot;p1&quot;.&quot;ExternalId&quot; AS &quot;Id&quot;, &quot;p1&quot;.&quot;Code&quot;, &quot;p1&quot;.&quot;Name&quot;, (</span><br><span class="line">          SELECT &quot;p&quot;.&quot;Price&quot;</span><br><span class="line">          FROM &quot;PriceHistory&quot; AS &quot;p&quot;</span><br><span class="line">          WHERE &quot;p1&quot;.&quot;Id&quot; = &quot;p&quot;.&quot;ProductId&quot;</span><br><span class="line">          ORDER BY &quot;p&quot;.&quot;CreatedOn&quot; DESC</span><br><span class="line">          LIMIT 1) AS &quot;Price&quot;, (</span><br><span class="line">          SELECT &quot;p0&quot;.&quot;CreatedOn&quot;</span><br><span class="line">          FROM &quot;PriceHistory&quot; AS &quot;p0&quot;</span><br><span class="line">          WHERE &quot;p1&quot;.&quot;Id&quot; = &quot;p0&quot;.&quot;ProductId&quot;</span><br><span class="line">          ORDER BY &quot;p0&quot;.&quot;CreatedOn&quot; DESC</span><br><span class="line">          LIMIT 1) AS &quot;PriceChangedOn&quot;</span><br><span class="line">      FROM &quot;Product&quot; AS &quot;p1&quot;</span><br><span class="line">      ORDER BY &quot;p1&quot;.&quot;Code&quot;</span><br><span class="line">      LIMIT @__p_1 OFFSET @__p_0</span><br></pre></td></tr></table></figure><p>As we can see, because we need both the Price and CreatedOn columns from the most recent price history entry, the SQLite provider decided to create two sub-queries. The database engine is relatively smart to know how to optimize them but lets ensure the engine optimizes the access as follows:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1. order products by code</span><br><span class="line">2. filter products by skip and take</span><br><span class="line">3. join with latest price history entry, grouped by product, using the ROWID for fast access</span><br><span class="line"></span><br><span class="line">SELECT p.ExternalId as Id, p.Code, p.Name, lph.Price, lph.CreatedOn as PriceChangedOn</span><br><span class="line">FROM (</span><br><span class="line">    SELECT Id, ExternalId, Code, Name, RowId</span><br><span class="line">    FROM Product</span><br><span class="line">    ORDER BY Code DESC</span><br><span class="line">    LIMIT @Take OFFSET @Skip</span><br><span class="line">) p</span><br><span class="line">INNER JOIN (</span><br><span class="line">    SELECT ph.ProductId, ph.Price, ph.CreatedOn</span><br><span class="line">    FROM PriceHistory ph</span><br><span class="line">    INNER JOIN (</span><br><span class="line">        SELECT MAX(RowId) RowId</span><br><span class="line">        FROM PriceHistory</span><br><span class="line">        GROUP BY ProductId</span><br><span class="line">    ) phLatest ON ph.RowId = phLatest.RowId</span><br><span class="line">) lph ON p.Id = lph.ProductId</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><em>Note: this may not be the most optimized access but remember, this is for demo purposes.</em></p><p>Change the <code>GetAllAsync</code> action to use the <code>QueryAsync&lt;T&gt;</code> extension method, passing this SQL and both the skip and take as arguments.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;products&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductsController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpGet</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">IEnumerable</span>&lt;<span class="title">ProductModel</span>&gt;&gt; <span class="title">GetAllAsync</span>(<span class="params">[FromQuery] <span class="built_in">int</span>? skip, [FromQuery] <span class="built_in">int</span>? take, CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> _context.QueryAsync&lt;ProductModel&gt;(ct, <span class="string">@&quot;</span></span><br><span class="line"><span class="string">SELECT p.ExternalId as Id, p.Code, p.Name, lph.Price, lph.CreatedOn as PriceChangedOn</span></span><br><span class="line"><span class="string">FROM (</span></span><br><span class="line"><span class="string">    SELECT Id, ExternalId, Code, Name, RowId</span></span><br><span class="line"><span class="string">    FROM Product</span></span><br><span class="line"><span class="string">    ORDER BY Code DESC</span></span><br><span class="line"><span class="string">    LIMIT @Take OFFSET @Skip</span></span><br><span class="line"><span class="string">) p</span></span><br><span class="line"><span class="string">INNER JOIN (</span></span><br><span class="line"><span class="string">    SELECT ph.ProductId, ph.Price, ph.CreatedOn</span></span><br><span class="line"><span class="string">    FROM PriceHistory ph</span></span><br><span class="line"><span class="string">    INNER JOIN (</span></span><br><span class="line"><span class="string">        SELECT MAX(RowId) RowId</span></span><br><span class="line"><span class="string">        FROM PriceHistory</span></span><br><span class="line"><span class="string">        GROUP BY ProductId</span></span><br><span class="line"><span class="string">    ) phLatest ON ph.RowId = phLatest.RowId</span></span><br><span class="line"><span class="string">) lph ON p.Id = lph.ProductId&quot;</span>, <span class="keyword">new</span></span><br><span class="line">        &#123;</span><br><span class="line">            Skip = skip ?? <span class="number">0</span>,</span><br><span class="line">            Take = take ?? <span class="number">20</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Because we globally registered our <code>GuidTypeHandler</code>, Dapper will know how to convert the column <code>ExternalId [TEXT]</code> as a <code>Guid</code> so we can map our result directly as a <code>ProductModel</code> type.</p><p>Once again, if you invoke the endpoint using the Swagger UI, the folowing log should be visible:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">dbug: EntityFrameworkCoreWithDapper.Database.DapperEFCoreCommand[0]</span><br><span class="line">      Executing DbCommand [CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class="line">      </span><br><span class="line">      SELECT p.ExternalId as Id, p.Code, p.Name, lph.Price, lph.CreatedOn as PriceChangedOn</span><br><span class="line">      FROM (</span><br><span class="line">          SELECT Id, ExternalId, Code, Name, RowId</span><br><span class="line">          FROM Product</span><br><span class="line">          ORDER BY Code DESC</span><br><span class="line">          LIMIT @Take OFFSET @Skip</span><br><span class="line">      ) p</span><br><span class="line">      INNER JOIN (</span><br><span class="line">          SELECT ph.ProductId, ph.Price, ph.CreatedOn</span><br><span class="line">          FROM PriceHistory ph</span><br><span class="line">          INNER JOIN (</span><br><span class="line">              SELECT MAX(RowId) RowId</span><br><span class="line">              FROM PriceHistory</span><br><span class="line">              GROUP BY ProductId</span><br><span class="line">          ) phLatest ON ph.RowId = phLatest.RowId</span><br><span class="line">      ) lph ON p.Id = lph.ProductId</span><br><span class="line">info: EntityFrameworkCoreWithDapper.Database.DapperEFCoreCommand[0]</span><br><span class="line">      Executed DbCommand [CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class="line">      </span><br><span class="line">      SELECT p.ExternalId as Id, p.Code, p.Name, lph.Price, lph.CreatedOn as PriceChangedOn</span><br><span class="line">      FROM (</span><br><span class="line">          SELECT Id, ExternalId, Code, Name, RowId</span><br><span class="line">          FROM Product</span><br><span class="line">          ORDER BY Code DESC</span><br><span class="line">          LIMIT @Take OFFSET @Skip</span><br><span class="line">      ) p</span><br><span class="line">      INNER JOIN (</span><br><span class="line">          SELECT ph.ProductId, ph.Price, ph.CreatedOn</span><br><span class="line">          FROM PriceHistory ph</span><br><span class="line">          INNER JOIN (</span><br><span class="line">              SELECT MAX(RowId) RowId</span><br><span class="line">              FROM PriceHistory</span><br><span class="line">              GROUP BY ProductId</span><br><span class="line">          ) phLatest ON ph.RowId = phLatest.RowId</span><br><span class="line">      ) lph ON p.Id = lph.ProductId</span><br></pre></td></tr></table></figure><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope this article gave you a good idea on how to easily integrate Dapper with Entity Framework Core, either to optimize critical paths or to workaround limitations while removing the need to use <code>TransactionScope</code>, usually needed for these use cases.</p><p>Remember that I only implemented a few set of operations, but feel free to extend your own, like <code>FirstOrDefaultAsync</code>, <code>SingleAsync</code> and even their synchronous operations.</p><p>As an extended note, this approach can also be easily applied to any other ORM, like NHibernate, as long you can access the underline <code>DbConnection</code> and current <code>DbTransaction</code> from the context.</p></div><footer class="article-footer"><a data-url="https://code-corner.dev/2021/03/09/Integrating-Dapper-with-Entity-Framework-Core/" data-id="clv2o3ycl0009jojhc26sbyb5" data-title="Integrating Dapper with Entity Framework Core" class="article-share-link"><span class="fa fa-share">Share</span></a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dapper/" rel="tag">dapper</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/efcore/" rel="tag">efcore</a></li></ul></footer></div><nav id="article-nav"><a href="/2022/08/13/Immutability-and-Entity-Framework-Core/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">Immutability and Entity Framework Core</div></a><a href="/2020/11/25/Auditing-with-Mediator-Pipelines-in-ASP-NET-Core/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Auditing with Mediator Pipelines in ASP.NET Core</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/concepts/">concepts</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/performance/">performance</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tutorial/">tutorial</a><span class="category-list-count">9</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dapper/" rel="tag">dapper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/efcore/" rel="tag">efcore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hangfire/" rel="tag">hangfire</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linq/" rel="tag">linq</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/patterns/" rel="tag">patterns</a><span class="tag-list-count">6</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/aspnetcore/" style="font-size:15.71px">aspnetcore</a> <a href="/tags/csharp/" style="font-size:18.57px">csharp</a> <a href="/tags/dapper/" style="font-size:10px">dapper</a> <a href="/tags/dotnet/" style="font-size:17.14px">dotnet</a> <a href="/tags/dotnetcore/" style="font-size:20px">dotnetcore</a> <a href="/tags/efcore/" style="font-size:12.86px">efcore</a> <a href="/tags/hangfire/" style="font-size:10px">hangfire</a> <a href="/tags/linq/" style="font-size:11.43px">linq</a> <a href="/tags/patterns/" style="font-size:14.29px">patterns</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/05/25/NET-IAsyncEnumerable-utility-extensions/">.NET - IAsyncEnumerable utility extensions</a></li><li><a href="/2024/04/14/NET-9-%E2%80%94-Exception-handling-performance/">.NET 9 — Exception handling performance</a></li><li><a href="/2024/02/29/NET-Hangfire/">.NET - Hangfire</a></li><li><a href="/2024/02/05/NET-%E2%80%94-LinkedList-vs-ToArray/">.NET — LinkedList vs ToArray</a></li><li><a href="/2024/01/19/NET-%E2%80%94-TaskCompletionSource-and-CancellationTokenSource/">.NET — TaskCompletionSource and CancellationTokenSource</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png"></a><br>All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a><br>&copy; 2024 João Simões<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="/js/jquery-3.6.4.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></div></body></html>