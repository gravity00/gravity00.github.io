<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-TQKP5TGHJ8"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TQKP5TGHJ8")</script><title>Configuration providers in .NET | code-corner.dev</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="google-adsense-account" content="ca-pub-4671230649342120"><meta name="description" content="One interesting feature of the .NET ecosystem is the ability to configure the application using Microsoft.Extensions.Options library. It allows developers to easily manage and inject application setti"><meta property="og:type" content="article"><meta property="og:title" content="Configuration providers in .NET"><meta property="og:url" content="https://code-corner.dev/2023/12/21/Configuration-providers-in-NET/index.html"><meta property="og:site_name" content="code-corner.dev"><meta property="og:description" content="One interesting feature of the .NET ecosystem is the ability to configure the application using Microsoft.Extensions.Options library. It allows developers to easily manage and inject application setti"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://code-corner.dev/2023/12/21/Configuration-providers-in-NET/00_header.png"><meta property="article:published_time" content="2023-12-21T00:00:00.000Z"><meta property="article:modified_time" content="2024-04-16T17:31:21.701Z"><meta property="article:author" content="João Simões"><meta property="article:tag" content="dotnetcore"><meta property="article:tag" content="aspnetcore"><meta property="article:tag" content="csharp"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://code-corner.dev/2023/12/21/Configuration-providers-in-NET/00_header.png"><meta name="twitter:creator" content="@JoaoPRSimoes"><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css"><link rel="canonical" href="https://code-corner.dev/2023/12/21/Configuration-providers-in-NET/"><meta name="generator" content="Hexo 7.1.1"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml,sitemap.txt"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">code-corner.dev</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">The place to learn about programming</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/gravity00"><span class="fa fa-github"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://twitter.com/JoaoPRSimoes"><span class="fa fa-twitter"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://joaoprsimoes.medium.com/"><span class="fa fa-medium"></span></a> <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a> <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://code-corner.dev"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-Configuration-providers-in-NET" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-meta"><a href="/2023/12/21/Configuration-providers-in-NET/" class="article-date"><time class="dt-published" datetime="2023-12-21T00:00:00.000Z" itemprop="datePublished">2023-12-21</time></a><div class="article-category"><a class="article-category-link" href="/categories/tutorial/">tutorial</a></div></div><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">Configuration providers in .NET</h1><h2 class="p-name article-subtitle">Implementing a provider for Microsoft.Extensions.Options</h2></header><div class="e-content article-entry" itemprop="articleBody"><a href="https://code-corner.dev/2023/12/21/Configuration-providers-in-NET/00_header.png" data-fancybox="gallery" data-caption><img src="https://code-corner.dev/2023/12/21/Configuration-providers-in-NET/00_header.png"></a><p>One interesting feature of the .NET ecosystem is the ability to configure the application using <code>Microsoft.Extensions.Options</code> library. It allows developers to easily manage and inject application settings from different sources, such as <code>appsettings.json</code> files, environment variables, command-line arguments, or even custom sources.</p><p>Using a SQL database as an example, in this article I’m going to explain how to create a custom provider for <code>Microsoft.Extensions.Options</code> that reads key-valued configurations from a table that also ensure values are refreshed in-memory if the table content changes.</p><p>If you want to use an approach for which you don’t have a provider available, like getting configurations from some custom API inside your company, you can easily use this example as a template to implement whatever requirements you may have.</p><h1 id="Solution-setup"><a href="#Solution-setup" class="headerlink" title="Solution setup"></a>Solution setup</h1><p>For starters, we’ll need a SQL database with a table to store the application settings. In this example, <a target="_blank" rel="noopener" href="https://github.com/gravity00/article-dotnet-configuration">which I have available on GitHub</a>, I’m going to use SQL Server (feel free to use your favorite database) and create an <code>ApplicationSettings</code> table with two columns to store the keys and corresponding values.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> ApplicationSettings(</span><br><span class="line">  [Key] nvarchar(<span class="number">256</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key,</span><br><span class="line">  [<span class="keyword">Value</span>] nvarchar(<span class="number">256</span>) <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>To keep things simple, we are going to create a console application and use the NuGet <code>Microsoft.Extensions.Hosting</code> to setup the host (dependency injection, logging and configurations) but this code is fully compatible with any application using ASP.NET Core 2 or later.</p><p>Create a new console application and register the following NuGets:</p><ul><li><code>Microsoft.Extensions.Hosting</code> — for hosting setup;</li><li><code>Microsoft.data.SqlClient</code> — to access our SQL Server database (or another provider if a different database);</li><li><code>Dapper</code> — optional, just to make it easier to map SQL results to C# entities;</li></ul><p>You can also configure the <code>*.csproj</code> file to include the application settings files when publishing.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">&quot;Microsoft.NET.Sdk&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OutputType</span>&gt;</span>Exe<span class="tag">&lt;/<span class="name">OutputType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>net8.0<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImplicitUsings</span>&gt;</span>enable<span class="tag">&lt;/<span class="name">ImplicitUsings</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">None</span> <span class="attr">Include</span>=<span class="string">&quot;*.config;*.json&quot;</span> <span class="attr">CopyToOutputDirectory</span>=<span class="string">&quot;PreserveNewest&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">&quot;Dapper&quot;</span> <span class="attr">Version</span>=<span class="string">&quot;2.1.24&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">&quot;Microsoft.Data.SqlClient&quot;</span> <span class="attr">Version</span>=<span class="string">&quot;5.1.2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">&quot;Microsoft.Extensions.Hosting&quot;</span> <span class="attr">Version</span>=<span class="string">&quot;8.0.0&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Add a new <code>appsettings.json</code> file to the project and include some options, like the connection string to the SQL Server database and some custom settings — in this example we are going to output a simple message to the console.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;ConnectionStrings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ArticleDotNetConfiguration&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Data Source=localhost;Database=ArticleDotNetConfiguration;User Id=sa;Password=abcd1234;Encrypt=false;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Example&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello world, from appsettings.json!&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Create a class representing the example options.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title">ExampleOptions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Message &#123; <span class="keyword">get</span>; <span class="keyword">init</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>Program.cs</code> file, create a host with pre-configured defaults, configure the <code>ExampleOptions</code> and output the message that was loaded from the <code>appsettings.json</code> file.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = Host.CreateApplicationBuilder(args);</span><br><span class="line"></span><br><span class="line">builder.Services.Configure&lt;ExampleOptions&gt;(</span><br><span class="line">    builder.Configuration.GetSection(<span class="string">&quot;Example&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> host = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> options = host.Services.GetRequiredService&lt;IOptions&lt;ExampleOptions&gt;&gt;().Value;</span><br><span class="line">Console.WriteLine(options.Message);</span><br></pre></td></tr></table></figure><p>Running the application, the message stored in the <code>appsettings.json</code> file should be displayed.</p><img src="/2023/12/21/Configuration-providers-in-NET/01_hello_world_appsettings_json.png"><h1 id="Configuration-provider"><a href="#Configuration-provider" class="headerlink" title="Configuration provider"></a>Configuration provider</h1><p>To create a custom configuration provider you need to implement two interfaces:</p><ul><li><code>IConfigurationSource</code> — will be added to the configuration manager and is used to store options (like a connection string) and build provider instances.</li><li><code>IConfigurationProvider</code> — knows how to load the application settings and has methods to get or set configuration values by a given key. Providers usually extend the class <code>ConfigurationProvider</code> which makes it easier to store settings in-memory.</li></ul><p>Create a new class <code>SqlServerConfigurationSource</code>, add a property for the connection string and implement the interface <code>IConfigurationSource</code> without any logic, for now.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlServerConfigurationSource</span> : <span class="title">IConfigurationSource</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ConnectionString &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IConfigurationProvider <span class="title">Build</span>(<span class="params">IConfigurationBuilder builder</span>)</span> =&gt; <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Create a new class <code>SqlServerConfigurationProvider</code>, passing the configuration source as a constructor parameter and extending the class <code>ConfigurationProvider</code>.</p><p>Override the <code>Load</code> method, reading application settings from the SQL table and store the results into the <code>Data</code> dictionary.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlServerConfigurationProvider</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    SqlServerConfigurationSource source</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) : ConfigurationProvider</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Load</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> connection = <span class="keyword">new</span> SqlConnection(source.ConnectionString);</span><br><span class="line">        connection.Open();</span><br><span class="line"></span><br><span class="line">        Data = connection.Query&lt;(<span class="built_in">string</span> Key, <span class="built_in">string</span> Value)&gt;(<span class="string">@&quot;</span></span><br><span class="line"><span class="string">select </span></span><br><span class="line"><span class="string">    [Key],</span></span><br><span class="line"><span class="string">    [Value]</span></span><br><span class="line"><span class="string">from ApplicationSettings&quot;</span>).ToDictionary(e =&gt; e.Key, e =&gt; e.Value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Reopen the <code>SqlServerConfigurationSource.cs</code> file and implement the <code>Build</code> method, returning a new instance of the provider.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlServerConfigurationSource</span> : <span class="title">IConfigurationSource</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ConnectionString &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IConfigurationProvider <span class="title">Build</span>(<span class="params">IConfigurationBuilder builder</span>)</span> =&gt; <span class="keyword">new</span> SqlServerConfigurationProvider(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Open the <code>Program.cs</code> file and add the SQL Server configuration source to the host builder. Don’t forget to read the connection string from the existing sources.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = Host.CreateApplicationBuilder(args);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> connectionString = builder.Configuration.GetConnectionString(<span class="string">&quot;ArticleDotNetConfiguration&quot;</span>);</span><br><span class="line">builder.Configuration.Add&lt;SqlServerConfigurationSource&gt;(source =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    source.ConnectionString = connectionString;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">builder.Services.Configure&lt;ExampleOptions&gt;(</span><br><span class="line">    builder.Configuration.GetSection(<span class="string">&quot;Example&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>Since the SQL Server provider was the last source added to the configuration manager, it will have priority over the existing ones. Let’s try to override the message by adding the key <code>Example:Message</code> with a value like <code>Hello world, from database!</code>.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ApplicationSettings <span class="keyword">values</span> (</span><br><span class="line">  <span class="string">&#x27;Example:Message&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;Hello world, from database!&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>Running the application, the message stored in the <code>ApplicationSettings</code> table should be displayed.</p><img src="/2023/12/21/Configuration-providers-in-NET/02_hello_world_database.png"><h1 id="Reloading-data"><a href="#Reloading-data" class="headerlink" title="Reloading data"></a>Reloading data</h1><p>In our previous code, we were getting an <code>IOptions</code> from the container to get the application settings. This is fine but what if the developer is using an <code>IOptionsMonitor</code> to always get the latest configurations?</p><p>The current provider implementation never updates the <code>Data</code> property after the initial load, so we let’s change that.</p><p>There are multiple ways to detect data changes from a SQL Server database, but for simplicity we are going to implement a simple worker that will be constantly loading application settings, compare what’s in memory and if changes are detected, invoke the base method <code>OnReload</code> that will trigger a refresh in all listeners.</p><p>Let’s start by changing the <code>Program.cs</code> file and create a task that will be writing the message at intervals so we’ll see a different message when we update the table. Don’t forget to use an <code>IOptionsMonitor</code> instead of an <code>IOptions</code>.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = Host.CreateApplicationBuilder(args);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> connectionString = builder.Configuration.GetConnectionString(<span class="string">&quot;ArticleDotNetConfiguration&quot;</span>);</span><br><span class="line">builder.Configuration.Add&lt;SqlServerConfigurationSource&gt;(source =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    source.ConnectionString = connectionString;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">builder.Services.Configure&lt;ExampleOptions&gt;(</span><br><span class="line">    builder.Configuration.GetSection(<span class="string">&quot;Example&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> host = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> appOptions = host.Services.GetRequiredService&lt;IOptionsMonitor&lt;ExampleOptions&gt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> Task.Run(<span class="keyword">async</span> () =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> options = appOptions.CurrentValue;</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(options.Message);</span><br><span class="line">        <span class="keyword">await</span> Task.Delay(<span class="number">5</span>_000);</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Open the provider class and do the following changes:</p><ul><li>Add a private <code>CancellationTokenSource</code> variable that will be used to cancel the worker execution;</li><li>Add a private <code>Task</code> variable that will be the responsible to refresh the application settings when they change;</li><li>Extract the logic that loads the data into a private method, so both Load method and worker can use that logic — change it to asynchronous code and do a comparison with previous loaded data, so method <code>OnReload</code> can be triggered;</li><li>Change the <code>Load</code> method to use the extracted logic and create a worker that will refresh data at intervals — don’t forget to add some exception handling code;</li><li>Implement the disposable pattern to release unmanaged resources;</li></ul><p>The <code>SqlServerConfigurationProvider</code> should now be as follows:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlServerConfigurationProvider</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    SqlServerConfigurationSource source</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) : ConfigurationProvider, IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> CancellationTokenSource _cts;</span><br><span class="line">    <span class="keyword">private</span> Task _refreshWorker;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> IDisposable</span></span><br><span class="line"></span><br><span class="line">    ~SqlServerConfigurationProvider() =&gt; Dispose(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Dispose(<span class="literal">true</span>);</span><br><span class="line">        GC.SuppressFinalize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="built_in">bool</span> disposing</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (disposing)</span><br><span class="line">        &#123;</span><br><span class="line">            _cts?.Cancel();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_refreshWorker <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _refreshWorker.ConfigureAwait(<span class="literal">false</span>)</span><br><span class="line">                        .GetAwaiter().GetResult();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (OperationCanceledException)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// expected exception due to cancellation</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.WriteLine(<span class="string">$&quot;Unhandled exception when waiting for the worker to stop: <span class="subst">&#123;e&#125;</span>&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _cts?.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _refreshWorker = <span class="literal">null</span>;</span><br><span class="line">        _cts = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Load</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        LoadAsync(CancellationToken.None).ConfigureAwait(<span class="literal">false</span>)</span><br><span class="line">            .GetAwaiter().GetResult();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_cts <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>) </span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        _cts = <span class="keyword">new</span> CancellationTokenSource();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> ct = _cts.Token;</span><br><span class="line">        _refreshWorker ??= Task.Run(<span class="keyword">async</span> () =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> Task.Delay(<span class="number">15</span>_000, ct);</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> LoadAsync(ct);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.WriteLine(<span class="string">$&quot;Unhandled exception when refreshing database settings: <span class="subst">&#123;e&#125;</span>&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (!ct.IsCancellationRequested);</span><br><span class="line">        &#125;, ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">LoadAsync</span>(<span class="params">CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; currentData;</span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">using</span> (<span class="keyword">var</span> connection = <span class="keyword">new</span> SqlConnection(source.ConnectionString))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> connection.OpenAsync(ct);</span><br><span class="line"></span><br><span class="line">            currentData = (<span class="keyword">await</span> connection.QueryAsync&lt;(<span class="built_in">string</span> Key, <span class="built_in">string</span> Value)&gt;(<span class="keyword">new</span> CommandDefinition(<span class="string">@&quot;</span></span><br><span class="line"><span class="string">select </span></span><br><span class="line"><span class="string">    [Key],</span></span><br><span class="line"><span class="string">    [Value]</span></span><br><span class="line"><span class="string">from ApplicationSettings&quot;</span>, cancellationToken: ct))).ToDictionary(e =&gt; e.Key, e =&gt; e.Value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (HasSameData(currentData))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        Data = currentData;</span><br><span class="line"></span><br><span class="line">        OnReload();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">HasSameData</span>(<span class="params">Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; currentData</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Data.Count != currentData.Count)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> (key, <span class="keyword">value</span>) <span class="keyword">in</span> currentData)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!Data.TryGetValue(key, <span class="keyword">out</span> <span class="keyword">var</span> previousValue) || previousValue != <span class="keyword">value</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If you now start the application and update or delete the value while running, you should see the task writing different messages.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- update the settings</span></span><br><span class="line"><span class="keyword">update</span> ApplicationSettings</span><br><span class="line"><span class="keyword">set</span></span><br><span class="line">  [<span class="keyword">Value</span>] <span class="operator">=</span> <span class="string">&#x27;Hello world, from DB!&#x27;</span></span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">  [Key] <span class="operator">=</span> <span class="string">&#x27;Example:Message&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- or delete them</span></span><br><span class="line"><span class="keyword">delete</span> ApplicationSettings</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">  [Key] <span class="operator">=</span> <span class="string">&#x27;Example:Message&#x27;</span>;</span><br></pre></td></tr></table></figure><img src="/2023/12/21/Configuration-providers-in-NET/03_hell_world_final.png"><h1 id="Reusing-the-provider"><a href="#Reusing-the-provider" class="headerlink" title="Reusing the provider"></a>Reusing the provider</h1><p>We now have a provider ready to read application settings from a SQL Server database, but I’m sure you are thinking it clearly could be more generic and just work with any SQL database.</p><p>Your line of thought is correct, we can easily do that just by changing the options from a connection string to having a connection factory, adding a property for the SQL code and even a <code>TimeSpan</code> for refresh interval. We should also add an exception handling callback (instead of writing into the debugger) and create extension methods to make registration into the configuration manager more readable.</p><p>The final code, <a target="_blank" rel="noopener" href="https://github.com/gravity00/article-dotnet-configuration">which is available on GitHub</a>, could be the as follows:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlExceptionContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Exception Exception &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SqlConfigurationProvider Provider &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">SqlConfigurationBuilderExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> SqlExceptionHandlerKey = <span class="string">&quot;SqlExceptionHandler&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IConfigurationBuilder <span class="title">AddSql</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">this</span> IConfigurationBuilder builder,</span></span></span><br><span class="line"><span class="params"><span class="function">        Func&lt;DbConnection&gt; connectionFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">string</span> sql = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        TimeSpan? refreshInterval = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ArgumentNullException.ThrowIfNull(builder);</span><br><span class="line">        ArgumentNullException.ThrowIfNull(connectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder.Add&lt;SqlConfigurationSource&gt;(source =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            source.ConnectionFactory = connectionFactory;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(sql <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">                source.Sql = sql;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (refreshInterval <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">                source.RefreshInterval = refreshInterval.Value;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IConfigurationBuilder <span class="title">SetSqlExceptionHandler</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">this</span> IConfigurationBuilder builder,</span></span></span><br><span class="line"><span class="params"><span class="function">        Action&lt;SqlExceptionContext&gt; handler</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ArgumentNullException.ThrowIfNull(builder);</span><br><span class="line"></span><br><span class="line">        builder.Properties[SqlExceptionHandlerKey] = handler;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Action&lt;SqlExceptionContext&gt; <span class="title">GetSqlExceptionHandler</span>(<span class="params"><span class="keyword">this</span> IConfigurationBuilder builder</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ArgumentNullException.ThrowIfNull(builder);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder.Properties.TryGetValue(SqlExceptionHandlerKey, <span class="keyword">out</span> <span class="keyword">var</span> <span class="keyword">value</span>)</span><br><span class="line">            ? <span class="keyword">value</span> <span class="keyword">as</span> Action&lt;SqlExceptionContext&gt;</span><br><span class="line">            : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlConfigurationSource</span> : <span class="title">IConfigurationSource</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Func&lt;DbConnection&gt; ConnectionFactory &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Sql &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">@&quot;</span></span><br><span class="line"><span class="string">select </span></span><br><span class="line"><span class="string">    [Key],</span></span><br><span class="line"><span class="string">    [Value]</span></span><br><span class="line"><span class="string">from ApplicationSettings&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> TimeSpan RefreshInterval &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = TimeSpan.FromSeconds(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IConfigurationProvider <span class="title">Build</span>(<span class="params">IConfigurationBuilder builder</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> exceptionHandler = builder.GetSqlExceptionHandler() ?? (ctx =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.WriteLine(<span class="string">$&quot;Unhandled SQL exception: <span class="subst">&#123;ctx.Exception&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlConfigurationProvider(<span class="keyword">this</span>, exceptionHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlConfigurationProvider</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    SqlConfigurationSource source,</span></span></span><br><span class="line"><span class="params"><span class="function">    Action&lt;SqlExceptionContext&gt; exceptionHandler</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) : ConfigurationProvider, IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> CancellationTokenSource _cts;</span><br><span class="line">    <span class="keyword">private</span> Task _refreshWorker;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> IDisposable</span></span><br><span class="line"></span><br><span class="line">    ~SqlConfigurationProvider() =&gt; Dispose(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Dispose(<span class="literal">true</span>);</span><br><span class="line">        GC.SuppressFinalize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="built_in">bool</span> disposing</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (disposing)</span><br><span class="line">        &#123;</span><br><span class="line">            _cts?.Cancel();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_refreshWorker <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _refreshWorker.ConfigureAwait(<span class="literal">false</span>)</span><br><span class="line">                        .GetAwaiter().GetResult();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (OperationCanceledException)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// expected exception due to cancellation</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    exceptionHandler(<span class="keyword">new</span> SqlExceptionContext</span><br><span class="line">                    &#123;</span><br><span class="line">                        Exception = e,</span><br><span class="line">                        Provider = <span class="keyword">this</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _cts?.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _refreshWorker = <span class="literal">null</span>;</span><br><span class="line">        _cts = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Load</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        LoadAsync(CancellationToken.None).ConfigureAwait(<span class="literal">false</span>)</span><br><span class="line">            .GetAwaiter().GetResult();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_cts <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        _cts = <span class="keyword">new</span> CancellationTokenSource();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> ct = _cts.Token;</span><br><span class="line">        _refreshWorker ??= Task.Run(<span class="keyword">async</span> () =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> Task.Delay(source.RefreshInterval, ct);</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> LoadAsync(ct);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    exceptionHandler(<span class="keyword">new</span> SqlExceptionContext</span><br><span class="line">                    &#123;</span><br><span class="line">                        Exception = e,</span><br><span class="line">                        Provider = <span class="keyword">this</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (!ct.IsCancellationRequested);</span><br><span class="line">        &#125;, ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">LoadAsync</span>(<span class="params">CancellationToken ct</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; currentData;</span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">using</span> (<span class="keyword">var</span> connection = source.ConnectionFactory())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> connection.OpenAsync(ct);</span><br><span class="line"></span><br><span class="line">            currentData = (<span class="keyword">await</span> connection.QueryAsync&lt;(<span class="built_in">string</span> Key, <span class="built_in">string</span> Value)&gt;(</span><br><span class="line">                <span class="keyword">new</span> CommandDefinition(source.Sql, cancellationToken: ct)</span><br><span class="line">            )).ToDictionary(e =&gt; e.Key, e =&gt; e.Value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (HasSameData(currentData))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        Data = currentData;</span><br><span class="line"></span><br><span class="line">        OnReload();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">HasSameData</span>(<span class="params">Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; currentData</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Data.Count != currentData.Count)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> (key, <span class="keyword">value</span>) <span class="keyword">in</span> currentData)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!Data.TryGetValue(key, <span class="keyword">out</span> <span class="keyword">var</span> previousValue) || previousValue != <span class="keyword">value</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>In this article I explained how to create a custom configuration provider for the <code>Microsoft.Extensions.Options</code> library, that could be used in any .NET application that uses <code>Microsoft.Extensions.Hosting</code>, including ASP.NET Core applications.</p><p>I used a SQL Server database as an example, but could be easily anything, like getting settings from an internal API and even Windows registry.</p></div><footer class="article-footer"><a data-url="https://code-corner.dev/2023/12/21/Configuration-providers-in-NET/" data-id="clv2o3yci0004jojh81oj1y9i" data-title="Configuration providers in .NET" class="article-share-link"><span class="fa fa-share">Share</span></a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a></li></ul></footer></div><nav id="article-nav"><a href="/2023/12/28/Syntax-sugar-we-don%E2%80%99t-even-think-about-in-C/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">Syntax sugar we don’t even think about in C#</div></a><a href="/2023/12/14/C-%E2%80%98is-null%E2%80%99-vs-%E2%80%98-null%E2%80%99/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">C# ‘is null’ vs ‘== null’</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/concepts/">concepts</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/performance/">performance</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tutorial/">tutorial</a><span class="category-list-count">9</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dapper/" rel="tag">dapper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/efcore/" rel="tag">efcore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hangfire/" rel="tag">hangfire</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linq/" rel="tag">linq</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/patterns/" rel="tag">patterns</a><span class="tag-list-count">6</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/aspnetcore/" style="font-size:15px">aspnetcore</a> <a href="/tags/csharp/" style="font-size:18.33px">csharp</a> <a href="/tags/dapper/" style="font-size:10px">dapper</a> <a href="/tags/dotnet/" style="font-size:16.67px">dotnet</a> <a href="/tags/dotnetcore/" style="font-size:20px">dotnetcore</a> <a href="/tags/efcore/" style="font-size:11.67px">efcore</a> <a href="/tags/hangfire/" style="font-size:10px">hangfire</a> <a href="/tags/linq/" style="font-size:11.67px">linq</a> <a href="/tags/patterns/" style="font-size:13.33px">patterns</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/06/19/NET-9-ToList-vs-ToArray/">.NET 9 — ToList vs ToArray</a></li><li><a href="/2024/05/25/NET-IAsyncEnumerable-utility-extensions/">.NET — IAsyncEnumerable utility extensions</a></li><li><a href="/2024/04/14/NET-9-%E2%80%94-Exception-handling-performance/">.NET 9 — Exception handling performance</a></li><li><a href="/2024/02/29/NET-Hangfire/">.NET — Hangfire</a></li><li><a href="/2024/02/05/NET-%E2%80%94-LinkedList-vs-ToArray/">.NET — LinkedList vs ToArray</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png"></a><br>All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a><br>&copy; 2024 João Simões<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="/js/jquery-3.6.4.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></div></body></html>