<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-TQKP5TGHJ8"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TQKP5TGHJ8")</script><title>.NET 8 — FrozenDictionary performance | code-corner.dev</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="google-adsense-account" content="ca-pub-4671230649342120"><meta name="description" content="Microsoft’s upcoming release of .NET 8 will introduce a lot of new features that will certainly be welcomed by the developer community, making it an even stronger framework for application development"><meta property="og:type" content="article"><meta property="og:title" content=".NET 8 — FrozenDictionary performance"><meta property="og:url" content="https://code-corner.dev/2023/11/08/NET-8-%E2%80%94-FrozenDictionary-performance/index.html"><meta property="og:site_name" content="code-corner.dev"><meta property="og:description" content="Microsoft’s upcoming release of .NET 8 will introduce a lot of new features that will certainly be welcomed by the developer community, making it an even stronger framework for application development"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://code-corner.dev/2023/11/08/NET-8-%E2%80%94-FrozenDictionary-performance/00_header.png"><meta property="article:published_time" content="2023-11-08T00:00:00.000Z"><meta property="article:modified_time" content="2024-04-16T17:31:21.729Z"><meta property="article:author" content="João Simões"><meta property="article:tag" content="dotnetcore"><meta property="article:tag" content="csharp"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://code-corner.dev/2023/11/08/NET-8-%E2%80%94-FrozenDictionary-performance/00_header.png"><meta name="twitter:creator" content="@JoaoPRSimoes"><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css"><link rel="canonical" href="https://code-corner.dev/2023/11/08/NET-8-—-FrozenDictionary-performance/"><meta name="generator" content="Hexo 7.1.1"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml,sitemap.txt"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">code-corner.dev</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">The place to learn about programming</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/gravity00"><span class="fa fa-github"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://twitter.com/JoaoPRSimoes"><span class="fa fa-twitter"></span></a> <a class="nav-icon" target="_blank" rel="noopener" href="https://joaoprsimoes.medium.com/"><span class="fa fa-medium"></span></a> <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a> <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://code-corner.dev"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-NET-8-—-FrozenDictionary-performance" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-meta"><a href="/2023/11/08/NET-8-%E2%80%94-FrozenDictionary-performance/" class="article-date"><time class="dt-published" datetime="2023-11-08T00:00:00.000Z" itemprop="datePublished">2023-11-08</time></a><div class="article-category"><a class="article-category-link" href="/categories/performance/">performance</a></div></div><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">.NET 8 — FrozenDictionary performance</h1><h2 class="p-name article-subtitle">Comparison between Frozen, Immutable and Dictionary</h2></header><div class="e-content article-entry" itemprop="articleBody"><a href="https://code-corner.dev/2023/11/08/NET-8-%E2%80%94-FrozenDictionary-performance/00_header.png" data-fancybox="gallery" data-caption><img src="https://code-corner.dev/2023/11/08/NET-8-%E2%80%94-FrozenDictionary-performance/00_header.png"></a><p>Microsoft’s upcoming release of .NET 8 will introduce a lot of <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/core/whats-new/dotnet-8">new features</a> that will certainly be welcomed by the developer community, making it an even stronger framework for application development.</p><p>One of those features is the namespace <code>System.Collections.Frozen</code> that introduces two new collections: <code>FrozenDictionary</code> and <code>FrozenSet</code>. These new types, <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/core/whats-new/dotnet-8#performance-focused-types">as stated by Microsoft</a>, are focused in reducing the time of read operations at the expense of increasing initialization time of immutable collections. This makes them perfect for shared data that only needs to be populated a single time, like application configurations or cached data in-memory.</p><p>In this article I’m going to benchmark the performance gains that can be achieved by using a <code>FrozenDictionary</code> instead of a <code>Dictionary</code> or an <code>ImmutableDictionary</code> to store shared data.</p><p>I’m going to use the well known C# library <code>BenchmarkDotNet</code> to run the tests and the environment will be the following:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BenchmarkDotNet v0.13.10, Windows 11 (10.0.22621.2428/22H2/2022Update/SunValley2)</span><br><span class="line">AMD Ryzen 7 3700X, 1 CPU, 16 logical and 8 physical cores</span><br><span class="line">.NET SDK 8.0.100-rc.2.23502.2</span><br><span class="line">  [Host]   : .NET 8.0.0 (8.0.23.47906), X64 RyuJIT AVX2</span><br><span class="line">  .NET 8.0 : .NET 8.0.0 (8.0.23.47906), X64 RyuJIT AVX2</span><br></pre></td></tr></table></figure><p>For the tests, I’m going to benchmark the method <code>TryGetValue</code>, with one for 100% key hits and another for 100% key misses, which should give the performance for both perfect and worse scenarios. The collections <code>FrozenDictionary</code>, <code>ImmutableDictionary</code> and <code>Dictionary</code> will be used with a parameter setting the size.</p><hr><h1 id="Scenario-1-—-all-keys-are-found"><a href="#Scenario-1-—-all-keys-are-found" class="headerlink" title="Scenario 1 — all keys are found"></a>Scenario 1 — all keys are found</h1><p>For this scenario I’m going to initialize a collection of unique keys, populate all three dictionaries accordingly and then run the <code>TryGetValue</code> for all keys returning the latest found using the <code>Dictionary</code> test as the baseline.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">SimpleJob(RuntimeMoniker.Net80)</span>]</span><br><span class="line">[<span class="meta">MemoryDiagnoser</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TryGetValueAllKeysFound</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Params(10, 100, 1000, 10000, 100000)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span>[] _keys;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt; _dictionary;</span><br><span class="line">    <span class="keyword">private</span> ImmutableDictionary&lt;<span class="built_in">int</span>,<span class="built_in">int</span>&gt; _immutableDictionary;</span><br><span class="line">    <span class="keyword">private</span> FrozenDictionary&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt; _frozenDictionary;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">GlobalSetup</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Setup</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> random = <span class="keyword">new</span> Random(<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> uniqueKeys = <span class="keyword">new</span> HashSet&lt;<span class="built_in">int</span>&gt;(Size);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; Size; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> key;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                key = random.Next();</span><br><span class="line">            &#125; <span class="keyword">while</span> (uniqueKeys.Contains(key));</span><br><span class="line"></span><br><span class="line">            uniqueKeys.Add(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _dictionary = uniqueKeys.Select((key, idx) =&gt; (key, idx)).ToDictionary(e =&gt; e.key, e =&gt; e.idx);</span><br><span class="line">        _immutableDictionary = uniqueKeys.Select((key, idx) =&gt; (key, idx)).ToImmutableDictionary(e =&gt; e.key, e =&gt; e.idx);</span><br><span class="line">        _frozenDictionary = uniqueKeys.Select((key, idx) =&gt; (key, idx)).ToFrozenDictionary(e =&gt; e.key, e =&gt; e.idx);</span><br><span class="line"></span><br><span class="line">        _keys = uniqueKeys.ToArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Benchmark(Baseline = true)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Dictionary</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> latestValue = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> key <span class="keyword">in</span> _keys)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_dictionary.TryGetValue(key, <span class="keyword">out</span> <span class="keyword">var</span> <span class="keyword">value</span>))</span><br><span class="line">                latestValue = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> latestValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Benchmark</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">ImmutableDictionary</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> latestValue = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> key <span class="keyword">in</span> _keys)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_immutableDictionary.TryGetValue(key, <span class="keyword">out</span> <span class="keyword">var</span> <span class="keyword">value</span>))</span><br><span class="line">                latestValue = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> latestValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Benchmark</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">FrozenDictionary</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> latestValue = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> key <span class="keyword">in</span> _keys)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_frozenDictionary.TryGetValue(key, <span class="keyword">out</span> <span class="keyword">var</span> <span class="keyword">value</span>))</span><br><span class="line">                latestValue = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> latestValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The benchmark results are the following:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">| Method              | Size   | Mean             | Error          | StdDev        | Ratio | RatioSD | Allocated | Alloc Ratio |</span><br><span class="line">|-------------------- |------- |-----------------:|---------------:|--------------:|------:|--------:|----------:|------------:|</span><br><span class="line">| Dictionary          | 10     |         46.29 ns |       0.300 ns |      0.251 ns |  1.00 |    0.00 |         - |          NA |</span><br><span class="line">| ImmutableDictionary | 10     |         35.53 ns |       0.320 ns |      0.283 ns |  0.77 |    0.01 |         - |          NA |</span><br><span class="line">| FrozenDictionary    | 10     |         85.47 ns |       1.779 ns |      5.244 ns |  1.86 |    0.13 |         - |          NA |</span><br><span class="line">|                     |        |                  |                |               |       |         |           |             |</span><br><span class="line">| Dictionary          | 100    |        470.00 ns |       2.253 ns |      2.108 ns |  1.00 |    0.00 |         - |          NA |</span><br><span class="line">| ImmutableDictionary | 100    |        736.28 ns |      14.637 ns |     31.820 ns |  1.57 |    0.07 |         - |          NA |</span><br><span class="line">| FrozenDictionary    | 100    |        263.18 ns |       2.898 ns |      2.569 ns |  0.56 |    0.01 |         - |          NA |</span><br><span class="line">|                     |        |                  |                |               |       |         |           |             |</span><br><span class="line">| Dictionary          | 1000   |      4,993.04 ns |      27.440 ns |     22.913 ns |  1.00 |    0.00 |         - |          NA |</span><br><span class="line">| ImmutableDictionary | 1000   |     29,174.27 ns |     493.738 ns |    461.843 ns |  5.85 |    0.10 |         - |          NA |</span><br><span class="line">| FrozenDictionary    | 1000   |      2,841.24 ns |      30.283 ns |     28.326 ns |  0.57 |    0.01 |         - |          NA |</span><br><span class="line">|                     |        |                  |                |               |       |         |           |             |</span><br><span class="line">| Dictionary          | 10000  |     77,394.04 ns |     295.972 ns |    247.150 ns |  1.00 |    0.00 |         - |          NA |</span><br><span class="line">| ImmutableDictionary | 10000  |    630,488.18 ns |   3,040.379 ns |  2,695.216 ns |  8.15 |    0.05 |       1 B |          NA |</span><br><span class="line">| FrozenDictionary    | 10000  |     43,957.48 ns |     274.398 ns |    256.672 ns |  0.57 |    0.00 |         - |          NA |</span><br><span class="line">|                     |        |                  |                |               |       |         |           |             |</span><br><span class="line">| Dictionary          | 100000 |  1,126,207.11 ns |   5,941.069 ns |  5,266.603 ns |  1.00 |    0.00 |       1 B |        1.00 |</span><br><span class="line">| ImmutableDictionary | 100000 | 11,194,516.67 ns | 106,626.230 ns | 99,738.242 ns |  9.94 |    0.12 |      12 B |       12.00 |</span><br><span class="line">| FrozenDictionary    | 100000 |    806,004.77 ns |   5,670.946 ns |  5,304.606 ns |  0.72 |    0.01 |       1 B |        1.00 |</span><br></pre></td></tr></table></figure><p>As you can see, except for very small collections, the <code>FrozenDictionary</code> is about 43% faster than using a <code>Dictionary</code>, much faster than an <code>ImmutableDictionary</code>, without allocating more memory.</p><h1 id="Scenario-2-—-no-keys-are-found"><a href="#Scenario-2-—-no-keys-are-found" class="headerlink" title="Scenario 2 — no keys are found"></a>Scenario 2 — no keys are found</h1><p>For this scenario I’m going to initialize a collection of unique keys, populate all three dictionaries accordingly, convert all keys to negative numbers to ensure the lookups are all different but will never match, and then run the <code>TryGetValue</code> for all returning the latest found using the <code>Dictionary</code> test as the baseline.</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">SimpleJob(RuntimeMoniker.Net80)</span>]</span><br><span class="line">[<span class="meta">MemoryDiagnoser</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TryGetValueNoKeysFound</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Params(10, 100, 1000, 10000, 100000)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span>[] _keys;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt; _dictionary;</span><br><span class="line">    <span class="keyword">private</span> ImmutableDictionary&lt;<span class="built_in">int</span>,<span class="built_in">int</span>&gt; _immutableDictionary;</span><br><span class="line">    <span class="keyword">private</span> FrozenDictionary&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt; _frozenDictionary;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">GlobalSetup</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Setup</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> random = <span class="keyword">new</span> Random(<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> uniqueKeys = <span class="keyword">new</span> HashSet&lt;<span class="built_in">int</span>&gt;(Size);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; Size; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> key;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                key = random.Next();</span><br><span class="line">            &#125; <span class="keyword">while</span> (uniqueKeys.Contains(key));</span><br><span class="line"></span><br><span class="line">            uniqueKeys.Add(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _dictionary = uniqueKeys.Select((key, idx) =&gt; (key, idx)).ToDictionary(e =&gt; e.key, e =&gt; e.idx);</span><br><span class="line">        _immutableDictionary = uniqueKeys.Select((key, idx) =&gt; (key, idx)).ToImmutableDictionary(e =&gt; e.key, e =&gt; e.idx);</span><br><span class="line">        _frozenDictionary = uniqueKeys.Select((key, idx) =&gt; (key, idx)).ToFrozenDictionary(e =&gt; e.key, e =&gt; e.idx);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// convert all keys to negative numbers to ensure no matches</span></span><br><span class="line">        _keys = uniqueKeys.Select(key =&gt; -key).ToArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Benchmark(Baseline = true)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Dictionary</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> latestValue = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> key <span class="keyword">in</span> _keys)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_dictionary.TryGetValue(key, <span class="keyword">out</span> <span class="keyword">var</span> <span class="keyword">value</span>))</span><br><span class="line">                latestValue = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> latestValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Benchmark</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">ImmutableDictionary</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> latestValue = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> key <span class="keyword">in</span> _keys)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_immutableDictionary.TryGetValue(key, <span class="keyword">out</span> <span class="keyword">var</span> <span class="keyword">value</span>))</span><br><span class="line">                latestValue = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> latestValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Benchmark</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">FrozenDictionary</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> latestValue = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> key <span class="keyword">in</span> _keys)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_frozenDictionary.TryGetValue(key, <span class="keyword">out</span> <span class="keyword">var</span> <span class="keyword">value</span>))</span><br><span class="line">                latestValue = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> latestValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The benchmark results are the following:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">| Method              | Size   | Mean            | Error        | StdDev       | Ratio | RatioSD | Allocated | Alloc Ratio |</span><br><span class="line">|-------------------- |------- |----------------:|-------------:|-------------:|------:|--------:|----------:|------------:|</span><br><span class="line">| Dictionary          | 10     |        37.13 ns |     0.740 ns |     0.823 ns |  1.00 |    0.00 |         - |          NA |</span><br><span class="line">| ImmutableDictionary | 10     |        33.81 ns |     0.629 ns |     0.588 ns |  0.91 |    0.03 |         - |          NA |</span><br><span class="line">| FrozenDictionary    | 10     |        19.16 ns |     0.129 ns |     0.114 ns |  0.51 |    0.01 |         - |          NA |</span><br><span class="line">|                     |        |                 |              |              |       |         |           |             |</span><br><span class="line">| Dictionary          | 100    |       396.11 ns |     2.697 ns |     2.522 ns |  1.00 |    0.00 |         - |          NA |</span><br><span class="line">| ImmutableDictionary | 100    |       488.48 ns |     2.480 ns |     2.198 ns |  1.23 |    0.01 |         - |          NA |</span><br><span class="line">| FrozenDictionary    | 100    |       218.70 ns |     1.530 ns |     1.431 ns |  0.55 |    0.00 |         - |          NA |</span><br><span class="line">|                     |        |                 |              |              |       |         |           |             |</span><br><span class="line">| Dictionary          | 1000   |     4,019.84 ns |    38.187 ns |    35.720 ns |  1.00 |    0.00 |         - |          NA |</span><br><span class="line">| ImmutableDictionary | 1000   |     6,708.41 ns |    14.893 ns |    13.931 ns |  1.67 |    0.02 |         - |          NA |</span><br><span class="line">| FrozenDictionary    | 1000   |     2,372.01 ns |    15.113 ns |    13.398 ns |  0.59 |    0.00 |         - |          NA |</span><br><span class="line">|                     |        |                 |              |              |       |         |           |             |</span><br><span class="line">| Dictionary          | 10000  |    83,803.51 ns |   232.996 ns |   206.545 ns |  1.00 |    0.00 |         - |          NA |</span><br><span class="line">| ImmutableDictionary | 10000  |    88,593.46 ns |   763.681 ns |   714.347 ns |  1.06 |    0.01 |         - |          NA |</span><br><span class="line">| FrozenDictionary    | 10000  |    29,071.40 ns |    85.885 ns |    76.135 ns |  0.35 |    0.00 |         - |          NA |</span><br><span class="line">|                     |        |                 |              |              |       |         |           |             |</span><br><span class="line">| Dictionary          | 100000 | 1,293,765.26 ns | 3,587.916 ns | 3,356.139 ns |  1.00 |    0.00 |       1 B |        1.00 |</span><br><span class="line">| ImmutableDictionary | 100000 | 1,145,366.16 ns | 4,726.433 ns | 4,421.108 ns |  0.89 |    0.00 |       1 B |        1.00 |</span><br><span class="line">| FrozenDictionary    | 100000 |   475,573.09 ns | 2,445.081 ns | 2,167.501 ns |  0.37 |    0.00 |         - |        0.00 |</span><br></pre></td></tr></table></figure><p>As you can see, the <code>FrozenDictionary</code> is on average 47% faster than a <code>Dictionary</code> for all sizes and even uses less memory for bigger collections. The <code>ImmutableDictionary</code>, once again, is the worse performer.</p><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Microsoft with the release of .NET 8 is, once again, providing a lot of performance improvements that developers can use in their applications.</p><p>For this article in particular, if you are storing key-value reference data that is immutable, populated a single time and can be shared across your application, the <code>FrozenDictionary</code> may be a good option if performance is of concern.</p><p>Soon I’ll also do a benchmark for <code>FrozenSet</code> which I expect should demonstrate similar results.</p></div><footer class="article-footer"><a data-url="https://code-corner.dev/2023/11/08/NET-8-%E2%80%94-FrozenDictionary-performance/" data-id="clv2o3yco000gjojh301z0ekv" data-title=".NET 8 — FrozenDictionary performance" class="article-share-link"><span class="fa fa-share">Share</span></a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a></li></ul></footer></div><nav id="article-nav"><a href="/2023/11/09/NET-%E2%80%94-ToList-vs-ToArray/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">.NET — ToList vs ToArray</div></a><a href="/2023/11/04/Understanding-Flag-Enums-in-C/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Understanding Flag Enums in C#</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/concepts/">concepts</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/performance/">performance</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tutorial/">tutorial</a><span class="category-list-count">9</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dapper/" rel="tag">dapper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotnetcore/" rel="tag">dotnetcore</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/efcore/" rel="tag">efcore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hangfire/" rel="tag">hangfire</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linq/" rel="tag">linq</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/patterns/" rel="tag">patterns</a><span class="tag-list-count">6</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/aspnetcore/" style="font-size:15px">aspnetcore</a> <a href="/tags/csharp/" style="font-size:18.33px">csharp</a> <a href="/tags/dapper/" style="font-size:10px">dapper</a> <a href="/tags/dotnet/" style="font-size:16.67px">dotnet</a> <a href="/tags/dotnetcore/" style="font-size:20px">dotnetcore</a> <a href="/tags/efcore/" style="font-size:11.67px">efcore</a> <a href="/tags/hangfire/" style="font-size:10px">hangfire</a> <a href="/tags/linq/" style="font-size:11.67px">linq</a> <a href="/tags/patterns/" style="font-size:13.33px">patterns</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/06/19/NET-9-ToList-vs-ToArray/">.NET 9 — ToList vs ToArray</a></li><li><a href="/2024/05/25/NET-IAsyncEnumerable-utility-extensions/">.NET — IAsyncEnumerable utility extensions</a></li><li><a href="/2024/04/14/NET-9-%E2%80%94-Exception-handling-performance/">.NET 9 — Exception handling performance</a></li><li><a href="/2024/02/29/NET-Hangfire/">.NET — Hangfire</a></li><li><a href="/2024/02/05/NET-%E2%80%94-LinkedList-vs-ToArray/">.NET — LinkedList vs ToArray</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png"></a><br>All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a><br>&copy; 2024 João Simões<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="/js/jquery-3.6.4.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></div></body></html>